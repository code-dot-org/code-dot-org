# This workflow uses actions that are not certified by GitHub.  They are
# provided by a third-party and are governed by separate terms of service,
# privacy policy, and support documentation.
#
# This workflow will install a prebuilt Ruby version, install dependencies, and
# run tests and linters.
name: "Ruby on Rails CI"
on:
  push:
    branches: [ "staging" ]
  pull_request:
    branches: [ "staging" ]
jobs:
  test:
    runs-on: ubuntu-latest
    env:
      CI: true
      RAILS_ENV: test
      RACK_ENV: test
      DISABLE_SPRING: 1
      ImageOS: ubuntu20
    container:
      image: codedotorg/code-dot-org:1.3
      volumes:
        - rbenv:/home/circleci/.rbenv
        - mysql:/var/lib/mysql
    steps:
      - name: Start MySQL
        run: sudo /etc/init.d/mysql start

      - name: Checkout code
        run: |
          git clone --branch ${{ github.head_ref }}  --depth 20 ${{ github.repositoryUrl }}
          git remote set-branches --add origin staging
          git fetch --depth 10 origin staging
          git config user.name "Drone"
          git config user.email "drone-fake-user@code.org"
          git merge origin/staging


      - name: Run unit tests
        run: |
          sudo chown -R circleci:circleci .
          export CIRCLE_SHA1=${{ github.sha }}
          /entrypoint.sh docker/unit_tests.sh
