#!/usr/bin/env ruby

# This script fetches weather forecast data from api.openweathermap and uploads to the shared firebase channel.
require_relative '../../../deployment'
require 'cdo/only_one'
require 'json'
require 'ostruct'
require 'csv'
require_relative '../../../shared/middleware/helpers/firebase_helper'

def number?(num)
  !Float(num).nil? rescue false
end

def parse_csv(filename)
  records = {}
  id = 1
  table = CSV.parse(File.read(filename), headers: true)
  table.each do |row|
    record = OpenStruct.new
    record.id = id
    table.headers.each do |col|
      value = (number? row[col]) ? row[col].to_f : row[col]
      record[col] = value
    end
    records[id] = record.to_h.to_json
    id += 1
  end
  return records, table.headers.unshift('id')
end

def main
  fb = FirebaseHelper.new('shared')
  records, columns = parse_csv ARGV[0]
  fb.delete_shared_table(ARGV[1])
  fb.upload_shared_table(ARGV[1], records, columns)
end

main if only_one_running?(__FILE__)
