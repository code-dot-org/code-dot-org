#!/usr/bin/env ruby

require_relative '../../../dashboard/config/environment'
require 'aws-sdk'
require 'fileutils'
require 'tempfile'

s3_bucket = 'cdo-nces'
s3_key = '2013-2014/ccd/sc132a.txt'

tmp_file = Tempfile.new(["#{File.basename(__FILE__)}.", ".dat"])
err_file = "#{tmp_file.path}.err"

start_time = Time.now

puts "Downloading #{s3_key} from #{s3_bucket}..."

client = Aws::S3::Client.new
open(tmp_file.path, 'wb') do |file|
  client.get_object(bucket: s3_bucket, key: s3_key) do |chunk|
    file.write(chunk)
  end
end

puts "Downloaded to #{tmp_file.path} in #{Time.now - start_time} second(s)."

start_time = Time.now

puts "Updating schools..."

success_count = 0
failure_count = 0

open(err_file, 'w') do |err|
  CSV.foreach(tmp_file.path, {col_sep: "\t", headers: true, quote_char: "\x00"}) do |row|
    school = School.find_by_id(row['NCESSCH'].to_i.to_s)
    next if school.nil?
    begin
      school[:address_line1] = row['LSTREE']
      school.save!
      success_count += 1
    rescue
      err << row
      failure_count += 1
    end
  end
end

puts "Updated #{success_count} school(s) in #{Time.now - start_time} second(s)."

if failure_count > 0
  puts "Rejected #{failure_count} rows due to bad data, please check: #{err_file}"
end
