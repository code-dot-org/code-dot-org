require 'phantomjs'
require 'cdo/tempfile'
require 'cdo/yaml'
require 'shellwords'

def bash(command)
  system 'bash', '-c', command
end

module PDF
  def self.get_local_pdf_paths(collate_file)
    _, paths = parse_collate_file(collate_file)
    existing_files remove_urls paths
  end

  def self.remove_urls(array)
    array.reject {|string| string_is_url(string)}
  end

  def self.existing_files(paths)
    paths.select {|f| File.exist?(f)}
  end

  def self.get_local_markdown_paths(collate_file)
    existing_files(get_local_pdf_paths(collate_file).map {|f| f.sub('.pdf', '.md')})
  end

  def self.string_is_url(filename)
    ['http', 'https'].include?(URI.parse(filename).scheme)
  end

  # Reads collate file, outputs array of fully qualified PDF paths and URLs
  def self.parse_collate_file(collate_file)
    options, body = YAML.parse_yaml_header(File.read(collate_file))
    all_paths = body.each_line.map(&:strip).
      reject {|s| s.nil? || s == ''}.
      map do |filename|
        next filename if string_is_url(filename)
        File.expand_path(filename, File.dirname(collate_file))
      end
    return [options, all_paths]
  end

  def self.merge_pdfs(output_file, *filenames)
    temp_file_handles = []

    filenames.map! do |filename|
      next filename unless string_is_url(filename)
      begin
        local_file = Tempfile.from_url(filename)
      rescue Exception => exception
        puts "Error downloading PDF file #{filename} for output file #{output_file}. Aborting"
        puts "Error message: #{exception}"
        raise
      end
      temp_file_handles << local_file
      local_file.path
    end

    merge_local_pdfs(output_file, *filenames)

    temp_file_handles.each(&:unlink)
  end

  def self.merge_local_pdfs(output_file, *filenames)
    escaped_filenames = filenames.map {|f| Shellwords.escape(f)}
    gs_command = "gs -q -dNOPAUSE -dBATCH -sDEVICE=pdfwrite -sOutputFile=#{Shellwords.escape(output_file)} #{escaped_filenames.join(' ')}"

    output = `#{gs_command}`
    status = $?.exitstatus

    unless status == 0
      puts output
      raise "Ghostscript error: non-zero status of #{status}"
    end
  end

  # PDFs generated by puppeteer and then combined using ghostscript tended to have
  # missing fonts which would make them unreadable in some PDF viewers.  This issue
  # also was inconsistent between what machine the PDF was generated on.  This post
  # describes the issue: https://stackoverflow.com/questions/52350486/rename-pdf-embedded-font/52352156#52352156

  # Puppeteer generates PDFs with embedded font names that can be the same between
  # different PDFs, leading to problems when we try to merge the resulting PDFs.
  # Whereas ghostscript adds a unique hash to each embedding, allowing for a seamless
  # merge.

  # This method regenerates the PDF using ghostscript to fix the missing font issue.
  # In the future we should consider generating PDFs with ghostscript instead of puppeteer.
  def self.regenerate_pdf_with_ghostscript(new_path, path)
    gs_command = "gs -sDEVICE=pdfwrite -dNOPAUSE -dBATCH -dQUIET -sOutputFile=#{new_path} #{path}"
    system(gs_command)
    return new_path
  end

  # Numbers PDFs using
  #   1. pdftk to get a page count
  #   2. enscript and ps2pdf to generate and place a page count header
  # Based off of response from http://stackoverflow.com/a/9033109/136134
  # "Center bottom" of page margin differs slightly between OS X and Ubuntu.
  #    OS X:   --margin=0:298:800:0
  #    Ubuntu: --margin=0:298:750:0
  def self.number_pdf(input, output)
    margin = RUBY_PLATFORM.include?('linux') ? '0:298:750:0' : '0:298:800:0'
    page_count = `pdftk "#{input}" dump_data | grep "NumberOfPages" | cut -d":" -f2`.strip
    bash "enscript --quiet -L1 --margin=#{margin} --header-font \"Helvetica@15\" --header='|| $%' --output - < <(for i in $(seq \"#{page_count}\"); do echo; done) | ps2pdf - | pdftk \"#{input}\" multistamp - output #{output}"
  end
end
