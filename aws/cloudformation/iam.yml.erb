---
AWSTemplateFormatVersion: 2010-09-09
Description: IAM layer including roles and access permissions for Code.org infrastructure.
Resources:
  FrontendRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Effect: Allow
            Principal:
              Service: [ec2.amazonaws.com]
            Action: ['sts:AssumeRole']
      Path: '/'
      Policies:
        - PolicyName: instance
          PolicyDocument:
            Statement:
              - Effect: Allow
                Action: ['s3:GetObject']
                Resource: 'arn:aws:s3:::<%=s3_bucket%>/*'
              - Effect: Allow
                Action:
                  - 'cloudformation:SignalResource'
                  - 'cloudformation:DescribeStackResources'
                  - 'autoscaling:CompleteLifecycleAction'
                  - 'ec2:DescribeImages'
                  - 'cloudwatch:PutMetricData'
                Resource: '*'
  StandaloneFrontendRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Effect: Allow
            Principal:
              Service: [ec2.amazonaws.com]
            Action: ['sts:AssumeRole']
      Path: '/'
      Policies:
        - PolicyName: instance
          PolicyDocument:
            Statement:
              - Effect: Allow
                Action: ['s3:GetObject']
                Resource: 'arn:aws:s3:::*'
              - Effect: Allow
                Action:
                  - 'cloudformation:SignalResource'
                  - 'cloudformation:DescribeStackResources'
                  - 'autoscaling:CompleteLifecycleAction'
                  - 'ec2:DescribeImages'
                  - 'logs:Create*'
                  - 'logs:PutLogEvents'
                  - 'logs:PutRetentionPolicy'
                  - 'cloudwatch:PutMetricData'
                Resource: '*'
              - Effect: Allow
                Action:
                  - 'dynamodb:*'
                Resource:
                  - {'Fn::Join': [':',['arn:aws:dynamodb',{Ref: 'AWS::Region'},{Ref: 'AWS::AccountId'},
                    table/adhoc_tables
                  ]]}
                  - {'Fn::Join': [':',['arn:aws:dynamodb',{Ref: 'AWS::Region'},{Ref: 'AWS::AccountId'},
                    table/adhoc_properties
                  ]]}
  StandaloneRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Effect: Allow
            Principal:
              Service: [ec2.amazonaws.com]
            Action: ['sts:AssumeRole']
      Path: '/'
      Policies:
        - PolicyName: instance
          PolicyDocument:
            Statement:
              - Effect: Allow
                Action: ['s3:GetObject']
                Resource: 'arn:aws:s3:::*'
              - Effect: Allow
                Action:
                  - 'cloudformation:SignalResource'
                  - 'cloudformation:DescribeStackResources'
                  - 'autoscaling:CompleteLifecycleAction'
                  - 'ec2:DescribeImages'
                  - 'logs:Create*'
                  - 'logs:PutLogEvents'
                  - 'logs:PutRetentionPolicy'
                  - 'cloudwatch:PutMetricData'
                Resource: '*'
              - Effect: Allow
                Action:
                  - 'dynamodb:*'
                Resource:
                  - {'Fn::Join': [':',['arn:aws:dynamodb',{Ref: 'AWS::Region'},{Ref: 'AWS::AccountId'},
                    table/adhoc_tables
                  ]]}
                  - {'Fn::Join': [':',['arn:aws:dynamodb',{Ref: 'AWS::Region'},{Ref: 'AWS::AccountId'},
                    table/adhoc_properties
                  ]]}
              - Effect: Allow
                Action:
                  - 's3:PutObject'
                  - 's3:PutObjectAcl'
                  - 's3:PutObjectVersionAcl'
                Resource:
                  - 'arn:aws:s3:::cdo-dist/adhoc/*'
                  - 'arn:aws:s3:::cdo-build-logs/*'
  FrontendInstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      Path: '/'
      Roles: [Ref: FrontendRole]
  ProductionInstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      Path: '/'
      Roles: [Ref: FrontendRole]
  StagingInstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      Path: '/'
      Roles: [Ref: FrontendRole]
  StandaloneInstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      Path: '/'
      Roles: [Ref: StandaloneRole]
  StandaloneFrontendInstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      Path: '/'
      Roles: [Ref: StandaloneFrontendRole]
  LifecycleHookRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Effect: Allow
            Principal:
              Service: [autoscaling.amazonaws.com]
            Action: ['sts:AssumeRole']
      Path: '/'
      Policies:
        - PolicyName: root
          PolicyDocument:
            Statement:
              - Effect: Allow
                Action: ['sns:Publish']
                Resource: '*'
Outputs:
  FrontendInstanceProfile:
    Description: Frontend Instance Profile
    Value: {Ref: FrontendInstanceProfile}
  StandaloneFrontendInstanceProfile:
    Description: Standalone Frontend Instance Profile
    Value: {Ref: StandaloneFrontendInstanceProfile}
  LifecycleHookRoleARN:
    Description: Auto Scaling Lifecycle Hook Role
    Value: {'Fn::GetAtt': [LifecycleHookRole, Arn]}
