---
AWSTemplateFormatVersion: 2010-09-09
Description: IAM layer including roles and access permissions for Code.org infrastructure.
Resources:
  FrontendRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Statement:
        - Effect: Allow
          Principal:
            Service: [ec2.amazonaws.com]
          Action: ['sts:AssumeRole']
      Path: /
      Policies:
      - PolicyName: instance
        PolicyDocument:
          Statement:
          - Effect: Allow
            Action: ['s3:GetObject']
            Resource: 'arn:aws:s3:::<%=s3_bucket%>/*'
          - Effect: Allow
            Action:
            - 'cloudformation:SignalResource'
            - 'cloudformation:DescribeStackResources'
            - 'autoscaling:CompleteLifecycleAction'
            - 'ec2:DescribeImages'
            - 'ec2:DescribeTags'
            - 'cloudwatch:PutMetricData'
            Resource: '*'
      - PolicyName: ServiceAccess
        PolicyDocument:
          Statement:
          - Effect: Allow
            Action:
            - 's3:*'
            - 'dynamodb:*'
            - 'sqs:*'
  StandaloneFrontendRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Statement:
        - Effect: Allow
          Principal:
            Service: [ec2.amazonaws.com]
          Action: ['sts:AssumeRole']
      Path: '/'
      Policies:
      - PolicyName: instance
        PolicyDocument:
          Statement:
          - Effect: Allow
            Action: ['s3:GetObject']
            Resource: 'arn:aws:s3:::*'
          - Effect: Allow
            Action:
            - 'cloudformation:SignalResource'
            - 'cloudformation:DescribeStackResources'
            - 'autoscaling:CompleteLifecycleAction'
            - 'ec2:DescribeImages'
            - 'logs:Create*'
            - 'logs:PutLogEvents'
            - 'logs:PutRetentionPolicy'
            - 'cloudwatch:PutMetricData'
            Resource: '*'
          - Effect: Allow
            Action:
            - 'dynamodb:*'
            Resource:
            - !Sub "arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/adhoc_tables"
            - !Sub "arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/adhoc_properties"
  StandaloneRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Statement:
        - Effect: Allow
          Principal: {Service: [ec2.amazonaws.com]}
          Action: ['sts:AssumeRole']
      Path: /
      Policies:
      - PolicyName: instance
        PolicyDocument:
          Statement:
          - Effect: Allow
            Action: ['s3:GetObject']
            Resource: 'arn:aws:s3:::*'
          - Effect: Allow
            Action:
            - "cloudformation:SignalResource"
            - "cloudformation:DescribeStackResources"
            - "autoscaling:CompleteLifecycleAction"
            - "ec2:DescribeImages"
            - "logs:Create*"
            - "logs:PutLogEvents"
            - "logs:PutRetentionPolicy"
            - "cloudwatch:PutMetricData"
            Resource: "*"
          - Effect: Allow
            Action: ["dynamodb:*"]
            Resource:
            - !Sub "arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/adhoc_tables"
            - !Sub "arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/adhoc_properties"
          - Effect: Allow
            Action:
            - "s3:PutObject"
            - "s3:PutObjectAcl"
            - "s3:PutObjectVersionAcl"
            Resource:
            - "arn:aws:s3:::cdo-dist/adhoc/*"
            - "arn:aws:s3:::cdo-build-logs/*"
  DaemonRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Statement:
        - Effect: Allow
          Principal:
            Service: [ec2.amazonaws.com]
          Action: ['sts:AssumeRole']
      Path: /
      Policies:
      - PolicyName: Daemon
        PolicyDocument:
          Statement:
          - Effect: Allow
            NotAction: ['iam:*', 'organizations:*']
            Resource: '*'
          - Effect: Allow
            Action:
            - 'iam:GetServerCertificate'
            Resource: '*'
  FrontendInstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      Path: '/'
      Roles: [!Ref FrontendRole]
  StandaloneInstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      Path: /
      Roles: [!Ref StandaloneRole]
  StandaloneFrontendInstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      Path: '/'
      Roles: [!Ref StandaloneFrontendRole]
  ProductionInstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      Path: '/'
      Roles: [!Ref DaemonRole]
  StagingInstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      Path: '/'
      Roles: [!Ref DaemonRole]
  LifecycleHookRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Statement:
        - Effect: Allow
          Principal:
            Service: [autoscaling.amazonaws.com]
          Action: ['sts:AssumeRole']
      Path: '/'
      Policies:
      - PolicyName: root
        PolicyDocument:
          Statement:
          - Effect: Allow
            Action: ['sns:Publish']
            Resource: '*'
Outputs:
  FrontendInstanceProfile:
    Description: Frontend Instance Profile
    Value: !Ref FrontendInstanceProfile
  StandaloneFrontendInstanceProfile:
    Description: Standalone Frontend Instance Profile
    Value: !Ref StandaloneFrontendInstanceProfile
  LifecycleHookRoleARN:
    Description: Auto Scaling Lifecycle Hook Role
    Value: !GetAtt LifecycleHookRole.Arn
