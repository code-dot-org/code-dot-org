// Uses API key from HONEYBADGER_API_KEY env variable
const Honeybadger = require("honeybadger");

const handler = async (event, context) => {
  try {
    const message = JSON.parse(event.Records[0].Sns.Message);
    if ("AlarmName" in message) {
      // Case 1: Message was generated by a cloudwatch alarm
      Honeybadger.notify({
        name: "Cloudwatch Alarm fired: " + message.AlarmName,
        message: "See context for details",
        context: {
          fullMessage: message
        }
      });
    } else {
      // Case 2: Message was generated by some other source. In this case, we pass through all parameters
      Honeybadger.notify({
        ...message,
        context: {
          fullMessage: message
        }
      });
    }
  } catch (error) {
    console.error(
      "Failed to parse and notify honeybadger; attempting to notify honeybadger of this failure",
      error
    );
    Honeybadger.notify(error, {
      name: "Honeybadger Lambda failed to notify",
      context: {
        fullEvent: JSON.stringify(event)
      }
    });
  }

  return "success";
};

exports.handler = Honeybadger.lambdaHandler(handler);
