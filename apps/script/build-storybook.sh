#!/bin/bash
set -e # Exit on error

echo "Going to build and deploy storybook to cdo-styleguide gh-pages repo"

DIR_TO_DEPLOY=build/storybook-deploy
if [ -z "$CDO_STYLEGUIDE_REPO_TOKEN" ]
then
    REPO="git@github.com:code-dot-org/cdo-styleguide.git"
else
    REPO="https://${CDO_STYLEGUIDE_REPO_TOKEN}@github.com/code-dot-org/cdo-styleguide.git"
fi
SHA=`git rev-parse --verify HEAD`

# get rid of old build if it is still around for some reason
rm -rf $DIR_TO_DEPLOY

# fetch most recent version of compiled css (application.css)
# and file that loads fonts (font-awesome.css) that are generated by rails
echo "Compiling application.css using rails asset pipeline"
pushd ../dashboard
bundle install
bundle exec rake assets:precompile
MOST_RECENT_APPLICATION_CSS=$(ls -t public/assets/application-*.css | head -1)
MOST_RECENT_FONT_AWESOME_CSS=$(ls -t public/assets/font-awesome-*.css | head -1)
cp $MOST_RECENT_APPLICATION_CSS ../apps/build/package/css/application.css
cp $MOST_RECENT_FONT_AWESOME_CSS ../apps/build/package/css/font-awesome.css
popd

# build the static storybook site
echo "Building the static storybook site"
NODE_OPTIONS="--max-old-space-size=4096" npx storybook build -o $DIR_TO_DEPLOY

# manually copy over static files
echo "Copying static files"
mkdir -p $DIR_TO_DEPLOY/js
cp -R build/package/css $DIR_TO_DEPLOY
cp -R build/package/js/en_us $DIR_TO_DEPLOY/js
