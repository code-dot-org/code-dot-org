# HoC 2023 Script Files

## Quickstart

Run the `HoC2023AiGenerateWeights.py` to generate the associated output weights contained in files like cached_background_effects_map.json that are used to calculate final effects output for the HoC 2023 activity using the following command from the code-dot-org root directory:
`python apps/script/HoC2023ScriptFiles/HoC2023AiGenerateWeights.py`

Before running the script, make sure to adjust your local parameters based off the current model being used. Previous iterations have leveraged spaCy and OpenAI's Ada models and it is not unreasonable to anticipate that the model "vendor" may change again in the future.

As of 01/08/2024, this script uses AWS's Titan v1 LLM through their Bedrock API.

## Script Outputs

The script generates/updates 3 files in apps/static/dance/ai/model:

- cached_background_effects_map.json
- cached_foreground_effects_map.json
- cached_palettes_map.json

These files store association values measuring the similarity between an emoji and each output using embeddings generated by a LLM.
An embedding is a vector (list) of floating point numbers, and embeddings are used to
measure the relatedness of text strings. The distance between two vectors measures
their relatedness. https://developers.google.com/machine-learning/crash-course/embeddings/video-lecture
These embeddings are stored in caches files as pickle files, python's native way to serialize data.

## Architecture and Background

At runtime, DanceAI will use the three maps to lookup the scores for each output type and take the top three indexes of (MAX(SUM(Input1Scores, Input2Scores, Input3Scores))) to select a final palette/foreground/background to display to the user. These maps are stored as a local cache rather than generated at runtime to remove the costs associated with querying a LLM and improve runtime performance.

The maps themselves are generated with the following pieces of intuition and underlying assumptions:

1. We can approximate the associated "mood" of an abstract concept (e.g. the relationship between Fire <-> Warm Color Palette) by calculating the similarity/co-occurrence of the pair together in text
2. LLMs trained on sufficiently large amounts of data should be able to provide embeddings for #1
3. Each input should only have a strong association with a small number of outputs rather than all outputs

To aid in ensuring point #3 occurs, many of the inputs and possible outputs have been renamed from their base unicode or blockly_id identifiers to try to provide more feature rich information for the embedding that the LLM will produce. These names are both listed below and stored within constants.py and apps/static/dance/ai/ai-inputs.json for outputs and emoji inputs respectively.

A simple flow diagram of how data/parameters move through the script would be:
(constants.py + ai-inputs.json) -> HoC2023AiGenerateWeights.py -> Hoc2023AiHelperFunctions.py -> [LLM of Choice] -> HoC2023AiGenerateWeights.py -> Final Map Output

## AWS Titan Setup and Quirks

To be blunt, setting up AWS is challenging and the guidance/code samples change frequently. It is highly suggested to check their documentation at https://docs.aws.amazon.com/bedrock/latest/userguide/model-access.html, https://github.com/aws-samples/amazon-bedrock-workshop, and https://github.com/aws-samples/amazon-bedrock-workshop/blob/main/00_Intro/bedrock_boto3_setup.ipynb and do your best to follow along.

Additionally, make sure to reach out to the Infrastructure team for best practices related to IAM permissions and role creation you will need to get Bedrock model access. Previously, we opted to utilize the recommended SageMaker service and role to streamline permissions issues but better options (for both cost and organization) might have since been determined.

## Output Evaluation

There isn't a strict numeric threshold for quality that the model must meet compared outside of ensuring that the final results meet the required format for DanceAI to reference later. However, we established the following desired characteristics for the distribution of model outputs as of 01/08/2024:

1. Low standard deviation for each output category (e.g. roughly equal chance for any particular palette option to be chosen given infinite arbitrary input combinations)
2. All output options are represented (e.g. if there are 29 total backgrounds, all 29 should have the potential of be chosen given infinite arbitrary input combinations)
3. Sniff test - do the generated outputs match your intuitions on what that input should make?

To aide in evaluating whether changes to the model/descriptive phrases are working towards or away from the above, see the Hoc2023GeneratorPerformanceEval.ipynb and associated hoc2023_prompt_performance_records.csv. Note that you might have to adjust file paths/names for HoC2023GeneratorPerformanceEval.ipynb to work on your local environment and that the evaluation criterion presented in the notebook have since been altered to the above.

## Output Reference Lists

Below are palettes, background effects, and foreground effects in the order that they appear in the dropdowns as of 01/08/2024. When this file is run and the three cached data files are replaced in apps/static/dance/ai/model, please update the lists below with the output from this script.

PALETTES  
model_descriptive_name | blockly_id | blockly_user_facing_name  
fall leaves | autumn | Autumn  
black and white | rave | Black and White  
cool | cool | Cool  
electronic | electronic | Electronic  
black and white grayscale | grayscale | Grayscale  
ice cream pastel | iceCream | Ice Cream  
rainbow pastel | default | Light  
neon | neon | Neon  
ocean water | ocean | Ocean  
rainbow stripes | rainbow | Rainbow  
roses romantic warm | roses | Roses  
sky sunrise | sky | Sky  
spring green plants | spring | Spring  
summer flower | summer | Summer  
sunrise cozy | sunrise | Sunrise  
sunset cozy | sunset | Sunset  
sweet candy | tropical | Tropical  
fire warm | twinkling | Twinkling  
groovy | vintage | Vintage  
warm hot red orange | warm | Warm  
winter icy blue | winter | Winter  
BACKGROUND_EFFECTS  
model_descriptive_name | blockly_id | blockly_user_facing_name  
geometric shapes | quads | Angles  
flower petals | blooming_petals | Blooming Petals  
round circle geometric | circles | Circles  
clouds | clouds | Clouds  
simple | color_cycle | Colors  
diamonds | diamonds | Diamonds  
disco | disco_ball | Disco Ball  
explosion celebration | fireworks | Fireworks  
flowers plants | flowers | Flowers  
light grid | frosted_grid | Frosted Grid  
stars | growing_stars | Growing Stars  
groovy | higher_power | Higher Power  
swirl twist | swirl | Hypno  
kaleidoscope | kaleidoscope | Kaleidoscope  
electronic | lasers | Laser Dance Floor  
paint splatter | splatter | Paint Splatter  
rainbow stripes | rainbow | Rainbow  
dots geometric pattern | ripples_random | Random Ripples  
round shapes geometric | ripples | Ripples  
snow | snowflakes | Snow  
words song music | text | Song Names  
galaxy space | galaxy | Space  
bright | sparkles | Sparkles  
spiral twisty | spiral | Spiral  
grid geometric | disco | Squares  
squiggles | squiggles | Squiggles  
starburst | starburst | Starburst  
twinkle | stars | Stars  
music wave geometric | music_wave | Waves  
FOREGROUND_EFFECTS  
model_descriptive_name | blockly_id | blockly_user_facing_name  
bubbles | bubbles | Bubbles  
hearts | hearts_colorful | Colorful Hearts  
party confetti | confetti | Confetti  
happy silly faces emojis | emojis | Emojis  
red hearts | hearts_red | Hearts  
music notes sound | music_notes | Music Notes  
rainbow lines | paint_drip | Paint Drip  
pineapple sweet food | pineapples | Pineapples  
pizza food | pizzas | Pizzas  
poop stinky | smiling_poop | Poop  
rain water | rain | Rain  
happy | floating_rainbows | Rainbows  
happy emojis faces | smile_face | Smiles  
spot light focus | spotlight | Spotlight  
stage lights | color_lights | Stage Lights  
stars | exploding_stars | Starburst  
taco food | raining_tacos | Tacos
