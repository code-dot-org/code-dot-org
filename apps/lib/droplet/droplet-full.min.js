/* Droplet. | (c) 2020 Anthony Bau. | MIT License.
 */
!function(a){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=a();else if("function"==typeof define&&define.amd)define([],a);else{var b;b="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this,b.droplet=a()}}(function(){var a;return function a(b,c,d){function e(g,h){if(!c[g]){if(!b[g]){var i="function"==typeof require&&require;if(!h&&i)return i(g,!0);if(f)return f(g,!0);var j=new Error("Cannot find module '"+g+"'");throw j.code="MODULE_NOT_FOUND",j}var k=c[g]={exports:{}};b[g][0].call(k.exports,function(a){var c=b[g][1][a];return e(c||a)},k,k.exports,a,b,c,d)}return c[g].exports}for(var f="function"==typeof require&&require,g=0;g<d.length;g++)e(d[g]);return e}({1:[function(a,b,c){!function(a){"use strict";function b(a){var b=a.charCodeAt(0);return b===f||b===k?62:b===g||b===l?63:b<h?-1:b<h+10?b-h+26+26:b<j+26?b-j:b<i+26?b-i+26:void 0}function c(a){function c(a){j[l++]=a}var d,f,g,h,i,j;if(a.length%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var k=a.length;i="="===a.charAt(k-2)?2:"="===a.charAt(k-1)?1:0,j=new e(3*a.length/4-i),g=i>0?a.length-4:a.length;var l=0;for(d=0,f=0;d<g;d+=4,f+=3)h=b(a.charAt(d))<<18|b(a.charAt(d+1))<<12|b(a.charAt(d+2))<<6|b(a.charAt(d+3)),c((16711680&h)>>16),c((65280&h)>>8),c(255&h);return 2===i?(h=b(a.charAt(d))<<2|b(a.charAt(d+1))>>4,c(255&h)):1===i&&(h=b(a.charAt(d))<<10|b(a.charAt(d+1))<<4|b(a.charAt(d+2))>>2,c(h>>8&255),c(255&h)),j}function d(a){function b(a){return"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(a)}var c,d,e,f=a.length%3,g="";for(c=0,e=a.length-f;c<e;c+=3)d=(a[c]<<16)+(a[c+1]<<8)+a[c+2],g+=function(a){return b(a>>18&63)+b(a>>12&63)+b(a>>6&63)+b(63&a)}(d);switch(f){case 1:d=a[a.length-1],g+=b(d>>2),g+=b(d<<4&63),g+="==";break;case 2:d=(a[a.length-2]<<8)+a[a.length-1],g+=b(d>>10),g+=b(d>>4&63),g+=b(d<<2&63),g+="="}return g}var e="undefined"!=typeof Uint8Array?Uint8Array:Array,f="+".charCodeAt(0),g="/".charCodeAt(0),h="0".charCodeAt(0),i="a".charCodeAt(0),j="A".charCodeAt(0),k="-".charCodeAt(0),l="_".charCodeAt(0);a.toByteArray=c,a.fromByteArray=d}(void 0===c?this.base64js={}:c)},{}],2:[function(a,b,c){},{}],3:[function(a,b,c){arguments[4][2][0].apply(c,arguments)},{dup:2}],4:[function(a,b,c){(function(b){"use strict";function d(){return e.TYPED_ARRAY_SUPPORT?2147483647:1073741823}function e(a){return this instanceof e?(e.TYPED_ARRAY_SUPPORT||(this.length=0,this.parent=void 0),"number"==typeof a?f(this,a):"string"==typeof a?g(this,a,arguments.length>1?arguments[1]:"utf8"):h(this,a)):arguments.length>1?new e(a,arguments[1]):new e(a)}function f(a,b){if(a=o(a,b<0?0:0|p(b)),!e.TYPED_ARRAY_SUPPORT)for(var c=0;c<b;c++)a[c]=0;return a}function g(a,b,c){return"string"==typeof c&&""!==c||(c="utf8"),a=o(a,0|r(b,c)),a.write(b,c),a}function h(a,b){if(e.isBuffer(b))return i(a,b);if(X(b))return j(a,b);if(null==b)throw new TypeError("must start with number, buffer, array or string");if("undefined"!=typeof ArrayBuffer){if(b.buffer instanceof ArrayBuffer)return k(a,b);if(b instanceof ArrayBuffer)return l(a,b)}return b.length?m(a,b):n(a,b)}function i(a,b){var c=0|p(b.length);return a=o(a,c),b.copy(a,0,0,c),a}function j(a,b){var c=0|p(b.length);a=o(a,c);for(var d=0;d<c;d+=1)a[d]=255&b[d];return a}function k(a,b){var c=0|p(b.length);a=o(a,c);for(var d=0;d<c;d+=1)a[d]=255&b[d];return a}function l(a,b){return e.TYPED_ARRAY_SUPPORT?(b.byteLength,a=e._augment(new Uint8Array(b))):a=k(a,new Uint8Array(b)),a}function m(a,b){var c=0|p(b.length);a=o(a,c);for(var d=0;d<c;d+=1)a[d]=255&b[d];return a}function n(a,b){var c,d=0;"Buffer"===b.type&&X(b.data)&&(c=b.data,d=0|p(c.length)),a=o(a,d);for(var e=0;e<d;e+=1)a[e]=255&c[e];return a}function o(a,b){return e.TYPED_ARRAY_SUPPORT?(a=e._augment(new Uint8Array(b)),a.__proto__=e.prototype):(a.length=b,a._isBuffer=!0),0!==b&&b<=e.poolSize>>>1&&(a.parent=Y),a}function p(a){if(a>=d())throw new RangeError("Attempt to allocate Buffer larger than maximum size: 0x"+d().toString(16)+" bytes");return 0|a}function q(a,b){if(!(this instanceof q))return new q(a,b);var c=new e(a,b);return delete c.parent,c}function r(a,b){"string"!=typeof a&&(a=""+a);var c=a.length;if(0===c)return 0;for(var d=!1;;)switch(b){case"ascii":case"binary":case"raw":case"raws":return c;case"utf8":case"utf-8":return Q(a).length;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return 2*c;case"hex":return c>>>1;case"base64":return T(a).length;default:if(d)return Q(a).length;b=(""+b).toLowerCase(),d=!0}}function s(a,b,c){var d=!1;if(b|=0,c=void 0===c||c===1/0?this.length:0|c,a||(a="utf8"),b<0&&(b=0),c>this.length&&(c=this.length),c<=b)return"";for(;;)switch(a){case"hex":return E(this,b,c);case"utf8":case"utf-8":return A(this,b,c);case"ascii":return C(this,b,c);case"binary":return D(this,b,c);case"base64":return z(this,b,c);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return F(this,b,c);default:if(d)throw new TypeError("Unknown encoding: "+a);a=(a+"").toLowerCase(),d=!0}}function t(a,b,c,d){c=Number(c)||0;var e=a.length-c;d?(d=Number(d))>e&&(d=e):d=e;var f=b.length;if(f%2!=0)throw new Error("Invalid hex string");d>f/2&&(d=f/2);for(var g=0;g<d;g++){var h=parseInt(b.substr(2*g,2),16);if(isNaN(h))throw new Error("Invalid hex string");a[c+g]=h}return g}function u(a,b,c,d){return U(Q(b,a.length-c),a,c,d)}function v(a,b,c,d){return U(R(b),a,c,d)}function w(a,b,c,d){return v(a,b,c,d)}function x(a,b,c,d){return U(T(b),a,c,d)}function y(a,b,c,d){return U(S(b,a.length-c),a,c,d)}function z(a,b,c){return 0===b&&c===a.length?V.fromByteArray(a):V.fromByteArray(a.slice(b,c))}function A(a,b,c){c=Math.min(a.length,c);for(var d=[],e=b;e<c;){var f=a[e],g=null,h=f>239?4:f>223?3:f>191?2:1;if(e+h<=c){var i,j,k,l;switch(h){case 1:f<128&&(g=f);break;case 2:i=a[e+1],128==(192&i)&&(l=(31&f)<<6|63&i)>127&&(g=l);break;case 3:i=a[e+1],j=a[e+2],128==(192&i)&&128==(192&j)&&(l=(15&f)<<12|(63&i)<<6|63&j)>2047&&(l<55296||l>57343)&&(g=l);break;case 4:i=a[e+1],j=a[e+2],k=a[e+3],128==(192&i)&&128==(192&j)&&128==(192&k)&&(l=(15&f)<<18|(63&i)<<12|(63&j)<<6|63&k)>65535&&l<1114112&&(g=l)}}null===g?(g=65533,h=1):g>65535&&(g-=65536,d.push(g>>>10&1023|55296),g=56320|1023&g),d.push(g),e+=h}return B(d)}function B(a){var b=a.length;if(b<=Z)return String.fromCharCode.apply(String,a);for(var c="",d=0;d<b;)c+=String.fromCharCode.apply(String,a.slice(d,d+=Z));return c}function C(a,b,c){var d="";c=Math.min(a.length,c);for(var e=b;e<c;e++)d+=String.fromCharCode(127&a[e]);return d}function D(a,b,c){var d="";c=Math.min(a.length,c);for(var e=b;e<c;e++)d+=String.fromCharCode(a[e]);return d}function E(a,b,c){var d=a.length;(!b||b<0)&&(b=0),(!c||c<0||c>d)&&(c=d);for(var e="",f=b;f<c;f++)e+=P(a[f]);return e}function F(a,b,c){for(var d=a.slice(b,c),e="",f=0;f<d.length;f+=2)e+=String.fromCharCode(d[f]+256*d[f+1]);return e}function G(a,b,c){if(a%1!=0||a<0)throw new RangeError("offset is not uint");if(a+b>c)throw new RangeError("Trying to access beyond buffer length")}function H(a,b,c,d,f,g){if(!e.isBuffer(a))throw new TypeError("buffer must be a Buffer instance");if(b>f||b<g)throw new RangeError("value is out of bounds");if(c+d>a.length)throw new RangeError("index out of range")}function I(a,b,c,d){b<0&&(b=65535+b+1);for(var e=0,f=Math.min(a.length-c,2);e<f;e++)a[c+e]=(b&255<<8*(d?e:1-e))>>>8*(d?e:1-e)}function J(a,b,c,d){b<0&&(b=4294967295+b+1);for(var e=0,f=Math.min(a.length-c,4);e<f;e++)a[c+e]=b>>>8*(d?e:3-e)&255}function K(a,b,c,d,e,f){if(b>e||b<f)throw new RangeError("value is out of bounds");if(c+d>a.length)throw new RangeError("index out of range");if(c<0)throw new RangeError("index out of range")}function L(a,b,c,d,e){return e||K(a,b,c,4,3.4028234663852886e38,-3.4028234663852886e38),W.write(a,b,c,d,23,4),c+4}function M(a,b,c,d,e){return e||K(a,b,c,8,1.7976931348623157e308,-1.7976931348623157e308),W.write(a,b,c,d,52,8),c+8}function N(a){if(a=O(a).replace(_,""),a.length<2)return"";for(;a.length%4!=0;)a+="=";return a}function O(a){return a.trim?a.trim():a.replace(/^\s+|\s+$/g,"")}function P(a){return a<16?"0"+a.toString(16):a.toString(16)}function Q(a,b){b=b||1/0;for(var c,d=a.length,e=null,f=[],g=0;g<d;g++){if((c=a.charCodeAt(g))>55295&&c<57344){if(!e){if(c>56319){(b-=3)>-1&&f.push(239,191,189);continue}if(g+1===d){(b-=3)>-1&&f.push(239,191,189);continue}e=c;continue}if(c<56320){(b-=3)>-1&&f.push(239,191,189),e=c;continue}c=65536+(e-55296<<10|c-56320)}else e&&(b-=3)>-1&&f.push(239,191,189);if(e=null,c<128){if((b-=1)<0)break;f.push(c)}else if(c<2048){if((b-=2)<0)break;f.push(c>>6|192,63&c|128)}else if(c<65536){if((b-=3)<0)break;f.push(c>>12|224,c>>6&63|128,63&c|128)}else{if(!(c<1114112))throw new Error("Invalid code point");if((b-=4)<0)break;f.push(c>>18|240,c>>12&63|128,c>>6&63|128,63&c|128)}}return f}function R(a){for(var b=[],c=0;c<a.length;c++)b.push(255&a.charCodeAt(c));return b}function S(a,b){for(var c,d,e,f=[],g=0;g<a.length&&!((b-=2)<0);g++)c=a.charCodeAt(g),d=c>>8,e=c%256,f.push(e),f.push(d);return f}function T(a){return V.toByteArray(N(a))}function U(a,b,c,d){for(var e=0;e<d&&!(e+c>=b.length||e>=a.length);e++)b[e+c]=a[e];return e}var V=a("base64-js"),W=a("ieee754"),X=a("isarray");c.Buffer=e,c.SlowBuffer=q,c.INSPECT_MAX_BYTES=50,e.poolSize=8192;var Y={};e.TYPED_ARRAY_SUPPORT=void 0!==b.TYPED_ARRAY_SUPPORT?b.TYPED_ARRAY_SUPPORT:function(){function a(){}try{var b=new Uint8Array(1);return b.foo=function(){return 42},b.constructor=a,42===b.foo()&&b.constructor===a&&"function"==typeof b.subarray&&0===b.subarray(1,1).byteLength}catch(a){return!1}}(),e.TYPED_ARRAY_SUPPORT?(e.prototype.__proto__=Uint8Array.prototype,e.__proto__=Uint8Array):(e.prototype.length=void 0,e.prototype.parent=void 0),e.isBuffer=function(a){return!(null==a||!a._isBuffer)},e.compare=function(a,b){if(!e.isBuffer(a)||!e.isBuffer(b))throw new TypeError("Arguments must be Buffers");if(a===b)return 0;for(var c=a.length,d=b.length,f=0,g=Math.min(c,d);f<g&&a[f]===b[f];)++f;return f!==g&&(c=a[f],d=b[f]),c<d?-1:d<c?1:0},e.isEncoding=function(a){switch(String(a).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"binary":case"base64":case"raw":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return!0;default:return!1}},e.concat=function(a,b){if(!X(a))throw new TypeError("list argument must be an Array of Buffers.");if(0===a.length)return new e(0);var c;if(void 0===b)for(b=0,c=0;c<a.length;c++)b+=a[c].length;var d=new e(b),f=0;for(c=0;c<a.length;c++){var g=a[c];g.copy(d,f),f+=g.length}return d},e.byteLength=r,e.prototype.toString=function(){var a=0|this.length;return 0===a?"":0===arguments.length?A(this,0,a):s.apply(this,arguments)},e.prototype.equals=function(a){if(!e.isBuffer(a))throw new TypeError("Argument must be a Buffer");return this===a||0===e.compare(this,a)},e.prototype.inspect=function(){var a="",b=c.INSPECT_MAX_BYTES;return this.length>0&&(a=this.toString("hex",0,b).match(/.{2}/g).join(" "),this.length>b&&(a+=" ... ")),"<Buffer "+a+">"},e.prototype.compare=function(a){if(!e.isBuffer(a))throw new TypeError("Argument must be a Buffer");return this===a?0:e.compare(this,a)},e.prototype.indexOf=function(a,b){function c(a,b,c){for(var d=-1,e=0;c+e<a.length;e++)if(a[c+e]===b[-1===d?0:e-d]){if(-1===d&&(d=e),e-d+1===b.length)return c+d}else d=-1;return-1}if(b>2147483647?b=2147483647:b<-2147483648&&(b=-2147483648),b>>=0,0===this.length)return-1;if(b>=this.length)return-1;if(b<0&&(b=Math.max(this.length+b,0)),"string"==typeof a)return 0===a.length?-1:String.prototype.indexOf.call(this,a,b);if(e.isBuffer(a))return c(this,a,b);if("number"==typeof a)return e.TYPED_ARRAY_SUPPORT&&"function"===Uint8Array.prototype.indexOf?Uint8Array.prototype.indexOf.call(this,a,b):c(this,[a],b);throw new TypeError("val must be string, number or Buffer")},e.prototype.get=function(a){return console.log(".get() is deprecated. Access using array indexes instead."),this.readUInt8(a)},e.prototype.set=function(a,b){return console.log(".set() is deprecated. Access using array indexes instead."),this.writeUInt8(a,b)},e.prototype.write=function(a,b,c,d){if(void 0===b)d="utf8",c=this.length,b=0;else if(void 0===c&&"string"==typeof b)d=b,c=this.length,b=0;else if(isFinite(b))b|=0,isFinite(c)?(c|=0,void 0===d&&(d="utf8")):(d=c,c=void 0);else{var e=d;d=b,b=0|c,c=e}var f=this.length-b;if((void 0===c||c>f)&&(c=f),a.length>0&&(c<0||b<0)||b>this.length)throw new RangeError("attempt to write outside buffer bounds");d||(d="utf8");for(var g=!1;;)switch(d){case"hex":return t(this,a,b,c);case"utf8":case"utf-8":return u(this,a,b,c);case"ascii":return v(this,a,b,c);case"binary":return w(this,a,b,c);case"base64":return x(this,a,b,c);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return y(this,a,b,c);default:if(g)throw new TypeError("Unknown encoding: "+d);d=(""+d).toLowerCase(),g=!0}},e.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}};var Z=4096;e.prototype.slice=function(a,b){var c=this.length;a=~~a,b=void 0===b?c:~~b,a<0?(a+=c)<0&&(a=0):a>c&&(a=c),b<0?(b+=c)<0&&(b=0):b>c&&(b=c),b<a&&(b=a);var d;if(e.TYPED_ARRAY_SUPPORT)d=e._augment(this.subarray(a,b));else{var f=b-a;d=new e(f,void 0);for(var g=0;g<f;g++)d[g]=this[g+a]}return d.length&&(d.parent=this.parent||this),d},e.prototype.readUIntLE=function(a,b,c){a|=0,b|=0,c||G(a,b,this.length);for(var d=this[a],e=1,f=0;++f<b&&(e*=256);)d+=this[a+f]*e;return d},e.prototype.readUIntBE=function(a,b,c){a|=0,b|=0,c||G(a,b,this.length);for(var d=this[a+--b],e=1;b>0&&(e*=256);)d+=this[a+--b]*e;return d},e.prototype.readUInt8=function(a,b){return b||G(a,1,this.length),this[a]},e.prototype.readUInt16LE=function(a,b){return b||G(a,2,this.length),this[a]|this[a+1]<<8},e.prototype.readUInt16BE=function(a,b){return b||G(a,2,this.length),this[a]<<8|this[a+1]},e.prototype.readUInt32LE=function(a,b){return b||G(a,4,this.length),(this[a]|this[a+1]<<8|this[a+2]<<16)+16777216*this[a+3]},e.prototype.readUInt32BE=function(a,b){return b||G(a,4,this.length),16777216*this[a]+(this[a+1]<<16|this[a+2]<<8|this[a+3])},e.prototype.readIntLE=function(a,b,c){a|=0,b|=0,c||G(a,b,this.length);for(var d=this[a],e=1,f=0;++f<b&&(e*=256);)d+=this[a+f]*e;return e*=128,d>=e&&(d-=Math.pow(2,8*b)),d},e.prototype.readIntBE=function(a,b,c){a|=0,b|=0,c||G(a,b,this.length);for(var d=b,e=1,f=this[a+--d];d>0&&(e*=256);)f+=this[a+--d]*e;return e*=128,f>=e&&(f-=Math.pow(2,8*b)),f},e.prototype.readInt8=function(a,b){return b||G(a,1,this.length),128&this[a]?-1*(255-this[a]+1):this[a]},e.prototype.readInt16LE=function(a,b){b||G(a,2,this.length);var c=this[a]|this[a+1]<<8;return 32768&c?4294901760|c:c},e.prototype.readInt16BE=function(a,b){b||G(a,2,this.length);var c=this[a+1]|this[a]<<8;return 32768&c?4294901760|c:c},e.prototype.readInt32LE=function(a,b){return b||G(a,4,this.length),this[a]|this[a+1]<<8|this[a+2]<<16|this[a+3]<<24},e.prototype.readInt32BE=function(a,b){return b||G(a,4,this.length),this[a]<<24|this[a+1]<<16|this[a+2]<<8|this[a+3]},e.prototype.readFloatLE=function(a,b){return b||G(a,4,this.length),W.read(this,a,!0,23,4)},e.prototype.readFloatBE=function(a,b){return b||G(a,4,this.length),W.read(this,a,!1,23,4)},e.prototype.readDoubleLE=function(a,b){return b||G(a,8,this.length),W.read(this,a,!0,52,8)},e.prototype.readDoubleBE=function(a,b){return b||G(a,8,this.length),W.read(this,a,!1,52,8)},e.prototype.writeUIntLE=function(a,b,c,d){a=+a,b|=0,c|=0,d||H(this,a,b,c,Math.pow(2,8*c),0);var e=1,f=0;for(this[b]=255&a;++f<c&&(e*=256);)this[b+f]=a/e&255;return b+c},e.prototype.writeUIntBE=function(a,b,c,d){a=+a,b|=0,c|=0,d||H(this,a,b,c,Math.pow(2,8*c),0);var e=c-1,f=1;for(this[b+e]=255&a;--e>=0&&(f*=256);)this[b+e]=a/f&255;return b+c},e.prototype.writeUInt8=function(a,b,c){return a=+a,b|=0,c||H(this,a,b,1,255,0),e.TYPED_ARRAY_SUPPORT||(a=Math.floor(a)),this[b]=255&a,b+1},e.prototype.writeUInt16LE=function(a,b,c){return a=+a,b|=0,c||H(this,a,b,2,65535,0),e.TYPED_ARRAY_SUPPORT?(this[b]=255&a,this[b+1]=a>>>8):I(this,a,b,!0),b+2},e.prototype.writeUInt16BE=function(a,b,c){return a=+a,b|=0,c||H(this,a,b,2,65535,0),e.TYPED_ARRAY_SUPPORT?(this[b]=a>>>8,this[b+1]=255&a):I(this,a,b,!1),b+2},e.prototype.writeUInt32LE=function(a,b,c){return a=+a,b|=0,c||H(this,a,b,4,4294967295,0),e.TYPED_ARRAY_SUPPORT?(this[b+3]=a>>>24,this[b+2]=a>>>16,this[b+1]=a>>>8,this[b]=255&a):J(this,a,b,!0),b+4},e.prototype.writeUInt32BE=function(a,b,c){return a=+a,b|=0,c||H(this,a,b,4,4294967295,0),e.TYPED_ARRAY_SUPPORT?(this[b]=a>>>24,this[b+1]=a>>>16,this[b+2]=a>>>8,this[b+3]=255&a):J(this,a,b,!1),b+4},e.prototype.writeIntLE=function(a,b,c,d){if(a=+a,b|=0,!d){var e=Math.pow(2,8*c-1);H(this,a,b,c,e-1,-e)}var f=0,g=1,h=a<0?1:0;for(this[b]=255&a;++f<c&&(g*=256);)this[b+f]=(a/g>>0)-h&255;return b+c},e.prototype.writeIntBE=function(a,b,c,d){if(a=+a,b|=0,!d){var e=Math.pow(2,8*c-1);H(this,a,b,c,e-1,-e)}var f=c-1,g=1,h=a<0?1:0;for(this[b+f]=255&a;--f>=0&&(g*=256);)this[b+f]=(a/g>>0)-h&255;return b+c},e.prototype.writeInt8=function(a,b,c){return a=+a,b|=0,c||H(this,a,b,1,127,-128),e.TYPED_ARRAY_SUPPORT||(a=Math.floor(a)),a<0&&(a=255+a+1),this[b]=255&a,b+1},e.prototype.writeInt16LE=function(a,b,c){return a=+a,b|=0,c||H(this,a,b,2,32767,-32768),e.TYPED_ARRAY_SUPPORT?(this[b]=255&a,this[b+1]=a>>>8):I(this,a,b,!0),b+2},e.prototype.writeInt16BE=function(a,b,c){return a=+a,b|=0,c||H(this,a,b,2,32767,-32768),e.TYPED_ARRAY_SUPPORT?(this[b]=a>>>8,this[b+1]=255&a):I(this,a,b,!1),b+2},e.prototype.writeInt32LE=function(a,b,c){return a=+a,b|=0,c||H(this,a,b,4,2147483647,-2147483648),e.TYPED_ARRAY_SUPPORT?(this[b]=255&a,this[b+1]=a>>>8,this[b+2]=a>>>16,this[b+3]=a>>>24):J(this,a,b,!0),b+4},e.prototype.writeInt32BE=function(a,b,c){return a=+a,b|=0,c||H(this,a,b,4,2147483647,-2147483648),a<0&&(a=4294967295+a+1),e.TYPED_ARRAY_SUPPORT?(this[b]=a>>>24,this[b+1]=a>>>16,this[b+2]=a>>>8,this[b+3]=255&a):J(this,a,b,!1),b+4},e.prototype.writeFloatLE=function(a,b,c){return L(this,a,b,!0,c)},e.prototype.writeFloatBE=function(a,b,c){return L(this,a,b,!1,c)},e.prototype.writeDoubleLE=function(a,b,c){return M(this,a,b,!0,c)},e.prototype.writeDoubleBE=function(a,b,c){return M(this,a,b,!1,c)},e.prototype.copy=function(a,b,c,d){if(c||(c=0),d||0===d||(d=this.length),b>=a.length&&(b=a.length),b||(b=0),d>0&&d<c&&(d=c),d===c)return 0;if(0===a.length||0===this.length)return 0;if(b<0)throw new RangeError("targetStart out of bounds");if(c<0||c>=this.length)throw new RangeError("sourceStart out of bounds");if(d<0)throw new RangeError("sourceEnd out of bounds");d>this.length&&(d=this.length),a.length-b<d-c&&(d=a.length-b+c);var f,g=d-c;if(this===a&&c<b&&b<d)for(f=g-1;f>=0;f--)a[f+b]=this[f+c];else if(g<1e3||!e.TYPED_ARRAY_SUPPORT)for(f=0;f<g;f++)a[f+b]=this[f+c];else a._set(this.subarray(c,c+g),b);return g},e.prototype.fill=function(a,b,c){if(a||(a=0),b||(b=0),c||(c=this.length),c<b)throw new RangeError("end < start");if(c!==b&&0!==this.length){if(b<0||b>=this.length)throw new RangeError("start out of bounds");if(c<0||c>this.length)throw new RangeError("end out of bounds");var d;if("number"==typeof a)for(d=b;d<c;d++)this[d]=a;else{var e=Q(a.toString()),f=e.length;for(d=b;d<c;d++)this[d]=e[d%f]}return this}},e.prototype.toArrayBuffer=function(){if("undefined"!=typeof Uint8Array){if(e.TYPED_ARRAY_SUPPORT)return new e(this).buffer;for(var a=new Uint8Array(this.length),b=0,c=a.length;b<c;b+=1)a[b]=this[b];return a.buffer}throw new TypeError("Buffer.toArrayBuffer not supported in this browser")};var $=e.prototype;e._augment=function(a){return a.constructor=e,a._isBuffer=!0,a._set=a.set,a.get=$.get,a.set=$.set,a.write=$.write,a.toString=$.toString,a.toLocaleString=$.toString,a.toJSON=$.toJSON,a.equals=$.equals,a.compare=$.compare,a.indexOf=$.indexOf,a.copy=$.copy,a.slice=$.slice,a.readUIntLE=$.readUIntLE,a.readUIntBE=$.readUIntBE,a.readUInt8=$.readUInt8,a.readUInt16LE=$.readUInt16LE,a.readUInt16BE=$.readUInt16BE,a.readUInt32LE=$.readUInt32LE,a.readUInt32BE=$.readUInt32BE,a.readIntLE=$.readIntLE,a.readIntBE=$.readIntBE,a.readInt8=$.readInt8,a.readInt16LE=$.readInt16LE,a.readInt16BE=$.readInt16BE,a.readInt32LE=$.readInt32LE,a.readInt32BE=$.readInt32BE,a.readFloatLE=$.readFloatLE,a.readFloatBE=$.readFloatBE,a.readDoubleLE=$.readDoubleLE,a.readDoubleBE=$.readDoubleBE,a.writeUInt8=$.writeUInt8,a.writeUIntLE=$.writeUIntLE,a.writeUIntBE=$.writeUIntBE,a.writeUInt16LE=$.writeUInt16LE,a.writeUInt16BE=$.writeUInt16BE,a.writeUInt32LE=$.writeUInt32LE,a.writeUInt32BE=$.writeUInt32BE,a.writeIntLE=$.writeIntLE,a.writeIntBE=$.writeIntBE,a.writeInt8=$.writeInt8,a.writeInt16LE=$.writeInt16LE,a.writeInt16BE=$.writeInt16BE,a.writeInt32LE=$.writeInt32LE,a.writeInt32BE=$.writeInt32BE,a.writeFloatLE=$.writeFloatLE,a.writeFloatBE=$.writeFloatBE,a.writeDoubleLE=$.writeDoubleLE,a.writeDoubleBE=$.writeDoubleBE,a.fill=$.fill,a.inspect=$.inspect,a.toArrayBuffer=$.toArrayBuffer,a};var _=/[^+\/0-9A-Za-z-_]/g}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"base64-js":1,ieee754:8,isarray:5}],5:[function(a,b,c){var d={}.toString;b.exports=Array.isArray||function(a){return"[object Array]"==d.call(a)}},{}],6:[function(a,b,c){(function(a){function b(a){return Array.isArray?Array.isArray(a):"[object Array]"===q(a)}function d(a){return"boolean"==typeof a}function e(a){return null===a}function f(a){return null==a}function g(a){return"number"==typeof a}function h(a){return"string"==typeof a}function i(a){return"symbol"==typeof a}function j(a){return void 0===a}function k(a){return"[object RegExp]"===q(a)}function l(a){return"object"==typeof a&&null!==a}function m(a){return"[object Date]"===q(a)}function n(a){return"[object Error]"===q(a)||a instanceof Error}function o(a){return"function"==typeof a}function p(a){return null===a||"boolean"==typeof a||"number"==typeof a||"string"==typeof a||"symbol"==typeof a||void 0===a}function q(a){return Object.prototype.toString.call(a)}c.isArray=b,c.isBoolean=d,c.isNull=e,c.isNullOrUndefined=f,c.isNumber=g,c.isString=h,c.isSymbol=i,c.isUndefined=j,c.isRegExp=k,c.isObject=l,c.isDate=m,c.isError=n,c.isFunction=o,c.isPrimitive=p,c.isBuffer=a.isBuffer}).call(this,{isBuffer:a("../../is-buffer/index.js")})},{"../../is-buffer/index.js":10}],7:[function(a,b,c){function d(){this._events=this._events||{},this._maxListeners=this._maxListeners||void 0}function e(a){return"function"==typeof a}function f(a){return"number"==typeof a}function g(a){return"object"==typeof a&&null!==a}function h(a){return void 0===a}b.exports=d,d.EventEmitter=d,d.prototype._events=void 0,d.prototype._maxListeners=void 0,d.defaultMaxListeners=10,d.prototype.setMaxListeners=function(a){if(!f(a)||a<0||isNaN(a))throw TypeError("n must be a positive number");return this._maxListeners=a,this},d.prototype.emit=function(a){var b,c,d,f,i,j;if(this._events||(this._events={}),"error"===a&&(!this._events.error||g(this._events.error)&&!this._events.error.length)){if((b=arguments[1])instanceof Error)throw b;throw TypeError('Uncaught, unspecified "error" event.')}if(c=this._events[a],h(c))return!1;if(e(c))switch(arguments.length){case 1:c.call(this);break;case 2:c.call(this,arguments[1]);break;case 3:c.call(this,arguments[1],arguments[2]);break;default:for(d=arguments.length,f=new Array(d-1),i=1;i<d;i++)f[i-1]=arguments[i];c.apply(this,f)}else if(g(c)){for(d=arguments.length,f=new Array(d-1),i=1;i<d;i++)f[i-1]=arguments[i];for(j=c.slice(),d=j.length,i=0;i<d;i++)j[i].apply(this,f)}return!0},d.prototype.addListener=function(a,b){var c;if(!e(b))throw TypeError("listener must be a function");if(this._events||(this._events={}),this._events.newListener&&this.emit("newListener",a,e(b.listener)?b.listener:b),this._events[a]?g(this._events[a])?this._events[a].push(b):this._events[a]=[this._events[a],b]:this._events[a]=b,g(this._events[a])&&!this._events[a].warned){var c;c=h(this._maxListeners)?d.defaultMaxListeners:this._maxListeners,c&&c>0&&this._events[a].length>c&&(this._events[a].warned=!0,console.error("(node) warning: possible EventEmitter memory leak detected. %d listeners added. Use emitter.setMaxListeners() to increase limit.",this._events[a].length),"function"==typeof console.trace&&console.trace())}return this},d.prototype.on=d.prototype.addListener,d.prototype.once=function(a,b){function c(){this.removeListener(a,c),d||(d=!0,b.apply(this,arguments))}if(!e(b))throw TypeError("listener must be a function");var d=!1;return c.listener=b,this.on(a,c),this},d.prototype.removeListener=function(a,b){var c,d,f,h;if(!e(b))throw TypeError("listener must be a function");if(!this._events||!this._events[a])return this;if(c=this._events[a],f=c.length,d=-1,c===b||e(c.listener)&&c.listener===b)delete this._events[a],this._events.removeListener&&this.emit("removeListener",a,b);else if(g(c)){for(h=f;h-- >0;)if(c[h]===b||c[h].listener&&c[h].listener===b){d=h;break}if(d<0)return this;1===c.length?(c.length=0,delete this._events[a]):c.splice(d,1),this._events.removeListener&&this.emit("removeListener",a,b)}return this},d.prototype.removeAllListeners=function(a){var b,c;if(!this._events)return this;if(!this._events.removeListener)return 0===arguments.length?this._events={}:this._events[a]&&delete this._events[a],this;if(0===arguments.length){for(b in this._events)"removeListener"!==b&&this.removeAllListeners(b);return this.removeAllListeners("removeListener"),this._events={},this}if(c=this._events[a],e(c))this.removeListener(a,c);else for(;c.length;)this.removeListener(a,c[c.length-1]);return delete this._events[a],this},d.prototype.listeners=function(a){return this._events&&this._events[a]?e(this._events[a])?[this._events[a]]:this._events[a].slice():[]},d.listenerCount=function(a,b){return a._events&&a._events[b]?e(a._events[b])?1:a._events[b].length:0}},{}],8:[function(a,b,c){c.read=function(a,b,c,d,e){var f,g,h=8*e-d-1,i=(1<<h)-1,j=i>>1,k=-7,l=c?e-1:0,m=c?-1:1,n=a[b+l];for(l+=m,f=n&(1<<-k)-1,n>>=-k,k+=h;k>0;f=256*f+a[b+l],l+=m,k-=8);for(g=f&(1<<-k)-1,f>>=-k,k+=d;k>0;g=256*g+a[b+l],l+=m,k-=8);if(0===f)f=1-j;else{if(f===i)return g?NaN:1/0*(n?-1:1);g+=Math.pow(2,d),f-=j}return(n?-1:1)*g*Math.pow(2,f-d)},c.write=function(a,b,c,d,e,f){var g,h,i,j=8*f-e-1,k=(1<<j)-1,l=k>>1,m=23===e?Math.pow(2,-24)-Math.pow(2,-77):0,n=d?0:f-1,o=d?1:-1,p=b<0||0===b&&1/b<0?1:0;for(b=Math.abs(b),isNaN(b)||b===1/0?(h=isNaN(b)?1:0,g=k):(g=Math.floor(Math.log(b)/Math.LN2),b*(i=Math.pow(2,-g))<1&&(g--,i*=2),b+=g+l>=1?m/i:m*Math.pow(2,1-l),b*i>=2&&(g++,i/=2),g+l>=k?(h=0,g=k):g+l>=1?(h=(b*i-1)*Math.pow(2,e),g+=l):(h=b*Math.pow(2,l-1)*Math.pow(2,e),g=0));e>=8;a[c+n]=255&h,n+=o,h/=256,e-=8);for(g=g<<e|h,j+=e;j>0;a[c+n]=255&g,n+=o,g/=256,j-=8);a[c+n-o]|=128*p}},{}],9:[function(a,b,c){"function"==typeof Object.create?b.exports=function(a,b){b&&(a.super_=b,a.prototype=Object.create(b.prototype,{constructor:{value:a,enumerable:!1,writable:!0,configurable:!0}}))}:b.exports=function(a,b){if(b){a.super_=b;var c=function(){};c.prototype=b.prototype,a.prototype=new c,a.prototype.constructor=a}}},{}],10:[function(a,b,c){function d(a){return!!a.constructor&&"function"==typeof a.constructor.isBuffer&&a.constructor.isBuffer(a)}function e(a){return"function"==typeof a.readFloatLE&&"function"==typeof a.slice&&d(a.slice(0,0))}b.exports=function(a){return null!=a&&(d(a)||e(a)||!!a._isBuffer)}},{}],11:[function(a,b,c){b.exports=Array.isArray||function(a){return"[object Array]"==Object.prototype.toString.call(a)}},{}],12:[function(a,b,c){function d(){throw new Error("setTimeout has not been defined")}function e(){throw new Error("clearTimeout has not been defined")}function f(a){if(l===setTimeout)return setTimeout(a,0);if((l===d||!l)&&setTimeout)return l=setTimeout,setTimeout(a,0);try{return l(a,0)}catch(b){try{return l.call(null,a,0)}catch(b){return l.call(this,a,0)}}}function g(a){if(m===clearTimeout)return clearTimeout(a);if((m===e||!m)&&clearTimeout)return m=clearTimeout,clearTimeout(a);try{return m(a)}catch(b){try{return m.call(null,a)}catch(b){return m.call(this,a)}}}function h(){q&&o&&(q=!1,o.length?p=o.concat(p):r=-1,p.length&&i())}function i(){if(!q){var a=f(h);q=!0;for(var b=p.length;b;){for(o=p,p=[];++r<b;)o&&o[r].run();r=-1,b=p.length}o=null,q=!1,g(a)}}function j(a,b){this.fun=a,this.array=b}function k(){}var l,m,n=b.exports={};!function(){try{l="function"==typeof setTimeout?setTimeout:d}catch(a){l=d}try{m="function"==typeof clearTimeout?clearTimeout:e}catch(a){m=e}}();var o,p=[],q=!1,r=-1;n.nextTick=function(a){var b=new Array(arguments.length-1);if(arguments.length>1)for(var c=1;c<arguments.length;c++)b[c-1]=arguments[c];p.push(new j(a,b)),1!==p.length||q||f(i)},j.prototype.run=function(){this.fun.apply(null,this.array)},n.title="browser",n.browser=!0,n.env={},n.argv=[],n.version="",n.versions={},n.on=k,n.addListener=k,n.once=k,n.off=k,n.removeListener=k,n.removeAllListeners=k,n.emit=k,n.prependListener=k,n.prependOnceListener=k,n.listeners=function(a){return[]},n.binding=function(a){throw new Error("process.binding is not supported")},n.cwd=function(){return"/"},n.chdir=function(a){throw new Error("process.chdir is not supported")},n.umask=function(){return 0}},{}],13:[function(a,b,c){b.exports=a("./lib/_stream_duplex.js")},{"./lib/_stream_duplex.js":14}],14:[function(a,b,c){(function(c){function d(a){if(!(this instanceof d))return new d(a);h.call(this,a),i.call(this,a),a&&!1===a.readable&&(this.readable=!1),a&&!1===a.writable&&(this.writable=!1),this.allowHalfOpen=!0,a&&!1===a.allowHalfOpen&&(this.allowHalfOpen=!1),this.once("end",e)}function e(){this.allowHalfOpen||this._writableState.ended||c.nextTick(this.end.bind(this))}b.exports=d;var f=Object.keys||function(a){var b=[];for(var c in a)b.push(c);return b},g=a("core-util-is");g.inherits=a("inherits");var h=a("./_stream_readable"),i=a("./_stream_writable");g.inherits(d,h),function(a,b){for(var c=0,d=a.length;c<d;c++)b(a[c],c)}(f(i.prototype),function(a){d.prototype[a]||(d.prototype[a]=i.prototype[a])})}).call(this,a("_process"))},{"./_stream_readable":16,"./_stream_writable":18,_process:12,"core-util-is":6,inherits:9}],15:[function(a,b,c){function d(a){if(!(this instanceof d))return new d(a);e.call(this,a)}b.exports=d;var e=a("./_stream_transform"),f=a("core-util-is");f.inherits=a("inherits"),f.inherits(d,e),d.prototype._transform=function(a,b,c){c(null,a)}},{"./_stream_transform":17,"core-util-is":6,inherits:9}],16:[function(a,b,c){(function(c){function d(b,c){var d=a("./_stream_duplex");b=b||{};var e=b.highWaterMark,f=b.objectMode?16:16384;this.highWaterMark=e||0===e?e:f,this.highWaterMark=~~this.highWaterMark,this.buffer=[],this.length=0,this.pipes=null,this.pipesCount=0,this.flowing=null,this.ended=!1,this.endEmitted=!1,this.reading=!1,this.sync=!0,this.needReadable=!1,this.emittedReadable=!1,this.readableListening=!1,this.objectMode=!!b.objectMode,c instanceof d&&(this.objectMode=this.objectMode||!!b.readableObjectMode),this.defaultEncoding=b.defaultEncoding||"utf8",this.ranOut=!1,this.awaitDrain=0,this.readingMore=!1,this.decoder=null,this.encoding=null,b.encoding&&(C||(C=a("string_decoder/").StringDecoder),this.decoder=new C(b.encoding),this.encoding=b.encoding)}function e(b){a("./_stream_duplex");if(!(this instanceof e))return new e(b);this._readableState=new d(b,this),this.readable=!0,A.call(this)}function f(a,b,c,d,e){var f=j(b,c);if(f)a.emit("error",f);else if(B.isNullOrUndefined(c))b.reading=!1,b.ended||k(a,b);else if(b.objectMode||c&&c.length>0)if(b.ended&&!e){var h=new Error("stream.push() after EOF");a.emit("error",h)}else if(b.endEmitted&&e){var h=new Error("stream.unshift() after end event");a.emit("error",h)}else!b.decoder||e||d||(c=b.decoder.write(c)),e||(b.reading=!1),b.flowing&&0===b.length&&!b.sync?(a.emit("data",c),a.read(0)):(b.length+=b.objectMode?1:c.length,e?b.buffer.unshift(c):b.buffer.push(c),b.needReadable&&l(a)),n(a,b);else e||(b.reading=!1);return g(b)}function g(a){return!a.ended&&(a.needReadable||a.length<a.highWaterMark||0===a.length)}function h(a){if(a>=E)a=E;else{a--;for(var b=1;b<32;b<<=1)a|=a>>b;a++}return a}function i(a,b){
return 0===b.length&&b.ended?0:b.objectMode?0===a?0:1:isNaN(a)||B.isNull(a)?b.flowing&&b.buffer.length?b.buffer[0].length:b.length:a<=0?0:(a>b.highWaterMark&&(b.highWaterMark=h(a)),a>b.length?b.ended?b.length:(b.needReadable=!0,0):a)}function j(a,b){var c=null;return B.isBuffer(b)||B.isString(b)||B.isNullOrUndefined(b)||a.objectMode||(c=new TypeError("Invalid non-string/buffer chunk")),c}function k(a,b){if(b.decoder&&!b.ended){var c=b.decoder.end();c&&c.length&&(b.buffer.push(c),b.length+=b.objectMode?1:c.length)}b.ended=!0,l(a)}function l(a){var b=a._readableState;b.needReadable=!1,b.emittedReadable||(D("emitReadable",b.flowing),b.emittedReadable=!0,b.sync?c.nextTick(function(){m(a)}):m(a))}function m(a){D("emit readable"),a.emit("readable"),s(a)}function n(a,b){b.readingMore||(b.readingMore=!0,c.nextTick(function(){o(a,b)}))}function o(a,b){for(var c=b.length;!b.reading&&!b.flowing&&!b.ended&&b.length<b.highWaterMark&&(D("maybeReadMore read 0"),a.read(0),c!==b.length);)c=b.length;b.readingMore=!1}function p(a){return function(){var b=a._readableState;D("pipeOnDrain",b.awaitDrain),b.awaitDrain&&b.awaitDrain--,0===b.awaitDrain&&z.listenerCount(a,"data")&&(b.flowing=!0,s(a))}}function q(a,b){b.resumeScheduled||(b.resumeScheduled=!0,c.nextTick(function(){r(a,b)}))}function r(a,b){b.resumeScheduled=!1,a.emit("resume"),s(a),b.flowing&&!b.reading&&a.read(0)}function s(a){var b=a._readableState;if(D("flow",b.flowing),b.flowing)do{var c=a.read()}while(null!==c&&b.flowing)}function t(a,b){var c,d=b.buffer,e=b.length,f=!!b.decoder,g=!!b.objectMode;if(0===d.length)return null;if(0===e)c=null;else if(g)c=d.shift();else if(!a||a>=e)c=f?d.join(""):y.concat(d,e),d.length=0;else if(a<d[0].length){var h=d[0];c=h.slice(0,a),d[0]=h.slice(a)}else if(a===d[0].length)c=d.shift();else{c=f?"":new y(a);for(var i=0,j=0,k=d.length;j<k&&i<a;j++){var h=d[0],l=Math.min(a-i,h.length);f?c+=h.slice(0,l):h.copy(c,i,0,l),l<h.length?d[0]=h.slice(l):d.shift(),i+=l}}return c}function u(a){var b=a._readableState;if(b.length>0)throw new Error("endReadable called on non-empty stream");b.endEmitted||(b.ended=!0,c.nextTick(function(){b.endEmitted||0!==b.length||(b.endEmitted=!0,a.readable=!1,a.emit("end"))}))}function v(a,b){for(var c=0,d=a.length;c<d;c++)b(a[c],c)}function w(a,b){for(var c=0,d=a.length;c<d;c++)if(a[c]===b)return c;return-1}b.exports=e;var x=a("isarray"),y=a("buffer").Buffer;e.ReadableState=d;var z=a("events").EventEmitter;z.listenerCount||(z.listenerCount=function(a,b){return a.listeners(b).length});var A=a("stream"),B=a("core-util-is");B.inherits=a("inherits");var C,D=a("util");D=D&&D.debuglog?D.debuglog("stream"):function(){},B.inherits(e,A),e.prototype.push=function(a,b){var c=this._readableState;return B.isString(a)&&!c.objectMode&&(b=b||c.defaultEncoding)!==c.encoding&&(a=new y(a,b),b=""),f(this,c,a,b,!1)},e.prototype.unshift=function(a){return f(this,this._readableState,a,"",!0)},e.prototype.setEncoding=function(b){return C||(C=a("string_decoder/").StringDecoder),this._readableState.decoder=new C(b),this._readableState.encoding=b,this};var E=8388608;e.prototype.read=function(a){D("read",a);var b=this._readableState,c=a;if((!B.isNumber(a)||a>0)&&(b.emittedReadable=!1),0===a&&b.needReadable&&(b.length>=b.highWaterMark||b.ended))return D("read: emitReadable",b.length,b.ended),0===b.length&&b.ended?u(this):l(this),null;if(0===(a=i(a,b))&&b.ended)return 0===b.length&&u(this),null;var d=b.needReadable;D("need readable",d),(0===b.length||b.length-a<b.highWaterMark)&&(d=!0,D("length less than watermark",d)),(b.ended||b.reading)&&(d=!1,D("reading or ended",d)),d&&(D("do read"),b.reading=!0,b.sync=!0,0===b.length&&(b.needReadable=!0),this._read(b.highWaterMark),b.sync=!1),d&&!b.reading&&(a=i(c,b));var e;return e=a>0?t(a,b):null,B.isNull(e)&&(b.needReadable=!0,a=0),b.length-=a,0!==b.length||b.ended||(b.needReadable=!0),c!==a&&b.ended&&0===b.length&&u(this),B.isNull(e)||this.emit("data",e),e},e.prototype._read=function(a){this.emit("error",new Error("not implemented"))},e.prototype.pipe=function(a,b){function d(a){D("onunpipe"),a===l&&f()}function e(){D("onend"),a.end()}function f(){D("cleanup"),a.removeListener("close",i),a.removeListener("finish",j),a.removeListener("drain",q),a.removeListener("error",h),a.removeListener("unpipe",d),l.removeListener("end",e),l.removeListener("end",f),l.removeListener("data",g),!m.awaitDrain||a._writableState&&!a._writableState.needDrain||q()}function g(b){D("ondata"),!1===a.write(b)&&(D("false write response, pause",l._readableState.awaitDrain),l._readableState.awaitDrain++,l.pause())}function h(b){D("onerror",b),k(),a.removeListener("error",h),0===z.listenerCount(a,"error")&&a.emit("error",b)}function i(){a.removeListener("finish",j),k()}function j(){D("onfinish"),a.removeListener("close",i),k()}function k(){D("unpipe"),l.unpipe(a)}var l=this,m=this._readableState;switch(m.pipesCount){case 0:m.pipes=a;break;case 1:m.pipes=[m.pipes,a];break;default:m.pipes.push(a)}m.pipesCount+=1,D("pipe count=%d opts=%j",m.pipesCount,b);var n=(!b||!1!==b.end)&&a!==c.stdout&&a!==c.stderr,o=n?e:f;m.endEmitted?c.nextTick(o):l.once("end",o),a.on("unpipe",d);var q=p(l);return a.on("drain",q),l.on("data",g),a._events&&a._events.error?x(a._events.error)?a._events.error.unshift(h):a._events.error=[h,a._events.error]:a.on("error",h),a.once("close",i),a.once("finish",j),a.emit("pipe",l),m.flowing||(D("pipe resume"),l.resume()),a},e.prototype.unpipe=function(a){var b=this._readableState;if(0===b.pipesCount)return this;if(1===b.pipesCount)return a&&a!==b.pipes?this:(a||(a=b.pipes),b.pipes=null,b.pipesCount=0,b.flowing=!1,a&&a.emit("unpipe",this),this);if(!a){var c=b.pipes,d=b.pipesCount;b.pipes=null,b.pipesCount=0,b.flowing=!1;for(var e=0;e<d;e++)c[e].emit("unpipe",this);return this}var e=w(b.pipes,a);return-1===e?this:(b.pipes.splice(e,1),b.pipesCount-=1,1===b.pipesCount&&(b.pipes=b.pipes[0]),a.emit("unpipe",this),this)},e.prototype.on=function(a,b){var d=A.prototype.on.call(this,a,b);if("data"===a&&!1!==this._readableState.flowing&&this.resume(),"readable"===a&&this.readable){var e=this._readableState;if(!e.readableListening)if(e.readableListening=!0,e.emittedReadable=!1,e.needReadable=!0,e.reading)e.length&&l(this);else{var f=this;c.nextTick(function(){D("readable nexttick read 0"),f.read(0)})}}return d},e.prototype.addListener=e.prototype.on,e.prototype.resume=function(){var a=this._readableState;return a.flowing||(D("resume"),a.flowing=!0,a.reading||(D("resume read 0"),this.read(0)),q(this,a)),this},e.prototype.pause=function(){return D("call pause flowing=%j",this._readableState.flowing),!1!==this._readableState.flowing&&(D("pause"),this._readableState.flowing=!1,this.emit("pause")),this},e.prototype.wrap=function(a){var b=this._readableState,c=!1,d=this;a.on("end",function(){if(D("wrapped end"),b.decoder&&!b.ended){var a=b.decoder.end();a&&a.length&&d.push(a)}d.push(null)}),a.on("data",function(e){if(D("wrapped data"),b.decoder&&(e=b.decoder.write(e)),e&&(b.objectMode||e.length)){d.push(e)||(c=!0,a.pause())}});for(var e in a)B.isFunction(a[e])&&B.isUndefined(this[e])&&(this[e]=function(b){return function(){return a[b].apply(a,arguments)}}(e));return v(["error","close","destroy","pause","resume"],function(b){a.on(b,d.emit.bind(d,b))}),d._read=function(b){D("wrapped _read",b),c&&(c=!1,a.resume())},d},e._fromList=t}).call(this,a("_process"))},{"./_stream_duplex":14,_process:12,buffer:4,"core-util-is":6,events:7,inherits:9,isarray:11,stream:24,"string_decoder/":25,util:2}],17:[function(a,b,c){function d(a,b){this.afterTransform=function(a,c){return e(b,a,c)},this.needTransform=!1,this.transforming=!1,this.writecb=null,this.writechunk=null}function e(a,b,c){var d=a._transformState;d.transforming=!1;var e=d.writecb;if(!e)return a.emit("error",new Error("no writecb in Transform class"));d.writechunk=null,d.writecb=null,i.isNullOrUndefined(c)||a.push(c),e&&e(b);var f=a._readableState;f.reading=!1,(f.needReadable||f.length<f.highWaterMark)&&a._read(f.highWaterMark)}function f(a){if(!(this instanceof f))return new f(a);h.call(this,a),this._transformState=new d(a,this);var b=this;this._readableState.needReadable=!0,this._readableState.sync=!1,this.once("prefinish",function(){i.isFunction(this._flush)?this._flush(function(a){g(b,a)}):g(b)})}function g(a,b){if(b)return a.emit("error",b);var c=a._writableState,d=a._transformState;if(c.length)throw new Error("calling transform done when ws.length != 0");if(d.transforming)throw new Error("calling transform done when still transforming");return a.push(null)}b.exports=f;var h=a("./_stream_duplex"),i=a("core-util-is");i.inherits=a("inherits"),i.inherits(f,h),f.prototype.push=function(a,b){return this._transformState.needTransform=!1,h.prototype.push.call(this,a,b)},f.prototype._transform=function(a,b,c){throw new Error("not implemented")},f.prototype._write=function(a,b,c){var d=this._transformState;if(d.writecb=c,d.writechunk=a,d.writeencoding=b,!d.transforming){var e=this._readableState;(d.needTransform||e.needReadable||e.length<e.highWaterMark)&&this._read(e.highWaterMark)}},f.prototype._read=function(a){var b=this._transformState;i.isNull(b.writechunk)||!b.writecb||b.transforming?b.needTransform=!0:(b.transforming=!0,this._transform(b.writechunk,b.writeencoding,b.afterTransform))}},{"./_stream_duplex":14,"core-util-is":6,inherits:9}],18:[function(a,b,c){(function(c){function d(a,b,c){this.chunk=a,this.encoding=b,this.callback=c}function e(b,c){var d=a("./_stream_duplex");b=b||{};var e=b.highWaterMark,f=b.objectMode?16:16384;this.highWaterMark=e||0===e?e:f,this.objectMode=!!b.objectMode,c instanceof d&&(this.objectMode=this.objectMode||!!b.writableObjectMode),this.highWaterMark=~~this.highWaterMark,this.needDrain=!1,this.ending=!1,this.ended=!1,this.finished=!1;var g=!1===b.decodeStrings;this.decodeStrings=!g,this.defaultEncoding=b.defaultEncoding||"utf8",this.length=0,this.writing=!1,this.corked=0,this.sync=!0,this.bufferProcessing=!1,this.onwrite=function(a){n(c,a)},this.writecb=null,this.writelen=0,this.buffer=[],this.pendingcb=0,this.prefinished=!1,this.errorEmitted=!1}function f(b){var c=a("./_stream_duplex");if(!(this instanceof f||this instanceof c))return new f(b);this._writableState=new e(b,this),this.writable=!0,x.call(this)}function g(a,b,d){var e=new Error("write after end");a.emit("error",e),c.nextTick(function(){d(e)})}function h(a,b,d,e){var f=!0;if(!(w.isBuffer(d)||w.isString(d)||w.isNullOrUndefined(d)||b.objectMode)){var g=new TypeError("Invalid non-string/buffer chunk");a.emit("error",g),c.nextTick(function(){e(g)}),f=!1}return f}function i(a,b,c){return!a.objectMode&&!1!==a.decodeStrings&&w.isString(b)&&(b=new v(b,c)),b}function j(a,b,c,e,f){c=i(b,c,e),w.isBuffer(c)&&(e="buffer");var g=b.objectMode?1:c.length;b.length+=g;var h=b.length<b.highWaterMark;return h||(b.needDrain=!0),b.writing||b.corked?b.buffer.push(new d(c,e,f)):k(a,b,!1,g,c,e,f),h}function k(a,b,c,d,e,f,g){b.writelen=d,b.writecb=g,b.writing=!0,b.sync=!0,c?a._writev(e,b.onwrite):a._write(e,f,b.onwrite),b.sync=!1}function l(a,b,d,e,f){d?c.nextTick(function(){b.pendingcb--,f(e)}):(b.pendingcb--,f(e)),a._writableState.errorEmitted=!0,a.emit("error",e)}function m(a){a.writing=!1,a.writecb=null,a.length-=a.writelen,a.writelen=0}function n(a,b){var d=a._writableState,e=d.sync,f=d.writecb;if(m(d),b)l(a,d,e,b,f);else{var g=r(a,d);g||d.corked||d.bufferProcessing||!d.buffer.length||q(a,d),e?c.nextTick(function(){o(a,d,g,f)}):o(a,d,g,f)}}function o(a,b,c,d){c||p(a,b),b.pendingcb--,d(),t(a,b)}function p(a,b){0===b.length&&b.needDrain&&(b.needDrain=!1,a.emit("drain"))}function q(a,b){if(b.bufferProcessing=!0,a._writev&&b.buffer.length>1){for(var c=[],d=0;d<b.buffer.length;d++)c.push(b.buffer[d].callback);b.pendingcb++,k(a,b,!0,b.length,b.buffer,"",function(a){for(var d=0;d<c.length;d++)b.pendingcb--,c[d](a)}),b.buffer=[]}else{for(var d=0;d<b.buffer.length;d++){var e=b.buffer[d],f=e.chunk,g=e.encoding,h=e.callback,i=b.objectMode?1:f.length;if(k(a,b,!1,i,f,g,h),b.writing){d++;break}}d<b.buffer.length?b.buffer=b.buffer.slice(d):b.buffer.length=0}b.bufferProcessing=!1}function r(a,b){return b.ending&&0===b.length&&!b.finished&&!b.writing}function s(a,b){b.prefinished||(b.prefinished=!0,a.emit("prefinish"))}function t(a,b){var c=r(a,b);return c&&(0===b.pendingcb?(s(a,b),b.finished=!0,a.emit("finish")):s(a,b)),c}function u(a,b,d){b.ending=!0,t(a,b),d&&(b.finished?c.nextTick(d):a.once("finish",d)),b.ended=!0}b.exports=f;var v=a("buffer").Buffer;f.WritableState=e;var w=a("core-util-is");w.inherits=a("inherits");var x=a("stream");w.inherits(f,x),f.prototype.pipe=function(){this.emit("error",new Error("Cannot pipe. Not readable."))},f.prototype.write=function(a,b,c){var d=this._writableState,e=!1;return w.isFunction(b)&&(c=b,b=null),w.isBuffer(a)?b="buffer":b||(b=d.defaultEncoding),w.isFunction(c)||(c=function(){}),d.ended?g(this,d,c):h(this,d,a,c)&&(d.pendingcb++,e=j(this,d,a,b,c)),e},f.prototype.cork=function(){this._writableState.corked++},f.prototype.uncork=function(){var a=this._writableState;a.corked&&(a.corked--,a.writing||a.corked||a.finished||a.bufferProcessing||!a.buffer.length||q(this,a))},f.prototype._write=function(a,b,c){c(new Error("not implemented"))},f.prototype._writev=null,f.prototype.end=function(a,b,c){var d=this._writableState;w.isFunction(a)?(c=a,a=null,b=null):w.isFunction(b)&&(c=b,b=null),w.isNullOrUndefined(a)||this.write(a,b),d.corked&&(d.corked=1,this.uncork()),d.ending||d.finished||u(this,d,c)}}).call(this,a("_process"))},{"./_stream_duplex":14,_process:12,buffer:4,"core-util-is":6,inherits:9,stream:24}],19:[function(a,b,c){b.exports=a("./lib/_stream_passthrough.js")},{"./lib/_stream_passthrough.js":15}],20:[function(a,b,c){(function(d){c=b.exports=a("./lib/_stream_readable.js"),c.Stream=a("stream"),c.Readable=c,c.Writable=a("./lib/_stream_writable.js"),c.Duplex=a("./lib/_stream_duplex.js"),c.Transform=a("./lib/_stream_transform.js"),c.PassThrough=a("./lib/_stream_passthrough.js"),d.browser||"disable"!==d.env.READABLE_STREAM||(b.exports=a("stream"))}).call(this,a("_process"))},{"./lib/_stream_duplex.js":14,"./lib/_stream_passthrough.js":15,"./lib/_stream_readable.js":16,"./lib/_stream_transform.js":17,"./lib/_stream_writable.js":18,_process:12,stream:24}],21:[function(a,b,c){b.exports=a("./lib/_stream_transform.js")},{"./lib/_stream_transform.js":17}],22:[function(a,b,c){b.exports=a("./lib/_stream_writable.js")},{"./lib/_stream_writable.js":18}],23:[function(a,b,c){(function(b){!function(c){function d(a,b){if(!(this instanceof d))return new d(a,b);var e=this;f(e),e.q=e.c="",e.bufferCheckPosition=c.MAX_BUFFER_LENGTH,e.opt=b||{},e.opt.lowercase=e.opt.lowercase||e.opt.lowercasetags,e.looseCase=e.opt.lowercase?"toLowerCase":"toUpperCase",e.tags=[],e.closed=e.closedRoot=e.sawRoot=!1,e.tag=e.error=null,e.strict=!!a,e.noscript=!(!a&&!e.opt.noscript),e.state=R.BEGIN,e.strictEntities=e.opt.strictEntities,e.ENTITIES=e.strictEntities?Object.create(c.XML_ENTITIES):Object.create(c.ENTITIES),e.attribList=[],e.opt.xmlns&&(e.ns=Object.create(O)),e.trackPosition=!1!==e.opt.position,e.trackPosition&&(e.position=e.line=e.column=0),n(e,"onready")}function e(a){for(var b=Math.max(c.MAX_BUFFER_LENGTH,10),d=0,e=0,f=B.length;e<f;e++){var g=a[B[e]].length;if(g>b)switch(B[e]){case"textNode":p(a);break;case"cdata":o(a,"oncdata",a.cdata),a.cdata="";break;case"script":o(a,"onscript",a.script),a.script="";break;default:r(a,"Max buffer length exceeded: "+B[e])}d=Math.max(d,g)}a.bufferCheckPosition=c.MAX_BUFFER_LENGTH-d+a.position}function f(a){for(var b=0,c=B.length;b<c;b++)a[B[b]]=""}function g(a){p(a),""!==a.cdata&&(o(a,"oncdata",a.cdata),a.cdata=""),""!==a.script&&(o(a,"onscript",a.script),a.script="")}function h(a,b){return new i(a,b)}function i(a,b){if(!(this instanceof i))return new i(a,b);C.apply(this),this._parser=new d(a,b),this.writable=!0,this.readable=!0;var c=this;this._parser.onend=function(){c.emit("end")},this._parser.onerror=function(a){c.emit("error",a),c._parser.error=null},this._decoder=null,D.forEach(function(a){Object.defineProperty(c,"on"+a,{get:function(){return c._parser["on"+a]},set:function(b){if(!b)return c.removeAllListeners(a),c._parser["on"+a]=b;c.on(a,b)},enumerable:!0,configurable:!1})})}function j(a){return a.split("").reduce(function(a,b){return a[b]=!0,a},{})}function k(a){return"[object RegExp]"===Object.prototype.toString.call(a)}function l(a,b){return k(a)?!!b.match(a):a[b]}function m(a,b){return!l(a,b)}function n(a,b,c){a[b]&&a[b](c)}function o(a,b,c){a.textNode&&p(a),n(a,b,c)}function p(a){a.textNode=q(a.opt,a.textNode),a.textNode&&n(a,"ontext",a.textNode),a.textNode=""}function q(a,b){return a.trim&&(b=b.trim()),a.normalize&&(b=b.replace(/\s+/g," ")),b}function r(a,b){return p(a),a.trackPosition&&(b+="\nLine: "+a.line+"\nColumn: "+a.column+"\nChar: "+a.c),b=new Error(b),a.error=b,n(a,"onerror",b),a}function s(a){return a.sawRoot&&!a.closedRoot&&t(a,"Unclosed root tag"),a.state!==R.BEGIN&&a.state!==R.BEGIN_WHITESPACE&&a.state!==R.TEXT&&r(a,"Unexpected end"),p(a),a.c="",a.closed=!0,n(a,"onend"),d.call(a,a.strict,a.opt),a}function t(a,b){if("object"!=typeof a||!(a instanceof d))throw new Error("bad call to strictFail");a.strict&&r(a,b)}function u(a){a.strict||(a.tagName=a.tagName[a.looseCase]());var b=a.tags[a.tags.length-1]||a,c=a.tag={name:a.tagName,attributes:{}};a.opt.xmlns&&(c.ns=b.ns),a.attribList.length=0}function v(a,b){var c=a.indexOf(":"),d=c<0?["",a]:a.split(":"),e=d[0],f=d[1];return b&&"xmlns"===a&&(e="xmlns",f=""),{prefix:e,local:f}}function w(a){if(a.strict||(a.attribName=a.attribName[a.looseCase]()),-1!==a.attribList.indexOf(a.attribName)||a.tag.attributes.hasOwnProperty(a.attribName))return a.attribName=a.attribValue="";if(a.opt.xmlns){var b=v(a.attribName,!0),c=b.prefix,d=b.local;if("xmlns"===c)if("xml"===d&&a.attribValue!==M)t(a,"xml: prefix must be bound to "+M+"\nActual: "+a.attribValue);else if("xmlns"===d&&a.attribValue!==N)t(a,"xmlns: prefix must be bound to "+N+"\nActual: "+a.attribValue);else{var e=a.tag,f=a.tags[a.tags.length-1]||a;e.ns===f.ns&&(e.ns=Object.create(f.ns)),e.ns[d]=a.attribValue}a.attribList.push([a.attribName,a.attribValue])}else a.tag.attributes[a.attribName]=a.attribValue,o(a,"onattribute",{name:a.attribName,value:a.attribValue});a.attribName=a.attribValue=""}function x(a,b){if(a.opt.xmlns){var c=a.tag,d=v(a.tagName);c.prefix=d.prefix,c.local=d.local,c.uri=c.ns[d.prefix]||"",c.prefix&&!c.uri&&(t(a,"Unbound namespace prefix: "+JSON.stringify(a.tagName)),c.uri=d.prefix);var e=a.tags[a.tags.length-1]||a;c.ns&&e.ns!==c.ns&&Object.keys(c.ns).forEach(function(b){o(a,"onopennamespace",{prefix:b,uri:c.ns[b]})});for(var f=0,g=a.attribList.length;f<g;f++){var h=a.attribList[f],i=h[0],j=h[1],k=v(i,!0),l=k.prefix,m=k.local,n=""==l?"":c.ns[l]||"",p={name:i,value:j,prefix:l,local:m,uri:n};l&&"xmlns"!=l&&!n&&(t(a,"Unbound namespace prefix: "+JSON.stringify(l)),p.uri=l),a.tag.attributes[i]=p,o(a,"onattribute",p)}a.attribList.length=0}a.tag.isSelfClosing=!!b,a.sawRoot=!0,a.tags.push(a.tag),o(a,"onopentag",a.tag),b||(a.noscript||"script"!==a.tagName.toLowerCase()?a.state=R.TEXT:a.state=R.SCRIPT,a.tag=null,a.tagName=""),a.attribName=a.attribValue="",a.attribList.length=0}function y(a){if(!a.tagName)return t(a,"Weird empty close tag."),a.textNode+="</>",void(a.state=R.TEXT);if(a.script){if("script"!==a.tagName)return a.script+="</"+a.tagName+">",a.tagName="",void(a.state=R.SCRIPT);o(a,"onscript",a.script),a.script=""}var b=a.tags.length,c=a.tagName;a.strict||(c=c[a.looseCase]());for(var d=c;b--;){if(a.tags[b].name===d)break;t(a,"Unexpected close tag")}if(b<0)return t(a,"Unmatched closing tag: "+a.tagName),a.textNode+="</"+a.tagName+">",void(a.state=R.TEXT);a.tagName=c;for(var e=a.tags.length;e-- >b;){var f=a.tag=a.tags.pop();a.tagName=a.tag.name,o(a,"onclosetag",a.tagName);var g={};for(var h in f.ns)g[h]=f.ns[h];var i=a.tags[a.tags.length-1]||a;a.opt.xmlns&&f.ns!==i.ns&&Object.keys(f.ns).forEach(function(b){var c=f.ns[b];o(a,"onclosenamespace",{prefix:b,uri:c})})}0===b&&(a.closedRoot=!0),a.tagName=a.attribValue=a.attribName="",a.attribList.length=0,a.state=R.TEXT}function z(a){var b,c=a.entity,d=c.toLowerCase(),e="";return a.ENTITIES[c]?a.ENTITIES[c]:a.ENTITIES[d]?a.ENTITIES[d]:(c=d,"#"===c.charAt(0)&&("x"===c.charAt(1)?(c=c.slice(2),b=parseInt(c,16),e=b.toString(16)):(c=c.slice(1),b=parseInt(c,10),e=b.toString(10))),c=c.replace(/^0+/,""),e.toLowerCase()!==c?(t(a,"Invalid character entity"),"&"+a.entity+";"):String.fromCodePoint(b))}function A(a){var b=this;if(this.error)throw this.error;if(b.closed)return r(b,"Cannot write after close. Assign an onready handler.");if(null===a)return s(b);for(var c=0,d="";b.c=d=a.charAt(c++);)switch(b.trackPosition&&(b.position++,"\n"===d?(b.line++,b.column=0):b.column++),b.state){case R.BEGIN:if(b.state=R.BEGIN_WHITESPACE,"\ufeff"===d)continue;case R.BEGIN_WHITESPACE:"<"===d?(b.state=R.OPEN_WAKA,b.startTagPosition=b.position):m(E,d)&&(t(b,"Non-whitespace before first tag."),b.textNode=d,b.state=R.TEXT);continue;case R.TEXT:if(b.sawRoot&&!b.closedRoot){for(var f=c-1;d&&"<"!==d&&"&"!==d;)(d=a.charAt(c++))&&b.trackPosition&&(b.position++,"\n"===d?(b.line++,b.column=0):b.column++);b.textNode+=a.substring(f,c-1)}"<"!==d||b.sawRoot&&b.closedRoot&&!b.strict?(!m(E,d)||b.sawRoot&&!b.closedRoot||t(b,"Text data outside of root node."),"&"===d?b.state=R.TEXT_ENTITY:b.textNode+=d):(b.state=R.OPEN_WAKA,b.startTagPosition=b.position);continue;case R.SCRIPT:"<"===d?b.state=R.SCRIPT_ENDING:b.script+=d;continue;case R.SCRIPT_ENDING:"/"===d?b.state=R.CLOSE_TAG:(b.script+="<"+d,b.state=R.SCRIPT);continue;case R.OPEN_WAKA:if("!"===d)b.state=R.SGML_DECL,b.sgmlDecl="";else if(l(E,d));else if(l(P,d))b.state=R.OPEN_TAG,b.tagName=d;else if("/"===d)b.state=R.CLOSE_TAG,b.tagName="";else if("?"===d)b.state=R.PROC_INST,b.procInstName=b.procInstBody="";else{if(t(b,"Unencoded <"),b.startTagPosition+1<b.position){var g=b.position-b.startTagPosition;d=new Array(g).join(" ")+d}b.textNode+="<"+d,b.state=R.TEXT}continue;case R.SGML_DECL:(b.sgmlDecl+d).toUpperCase()===K?(o(b,"onopencdata"),b.state=R.CDATA,b.sgmlDecl="",b.cdata=""):b.sgmlDecl+d==="--"?(b.state=R.COMMENT,b.comment="",b.sgmlDecl=""):(b.sgmlDecl+d).toUpperCase()===L?(b.state=R.DOCTYPE,(b.doctype||b.sawRoot)&&t(b,"Inappropriately located doctype declaration"),b.doctype="",b.sgmlDecl=""):">"===d?(o(b,"onsgmldeclaration",b.sgmlDecl),b.sgmlDecl="",b.state=R.TEXT):l(H,d)?(b.state=R.SGML_DECL_QUOTED,b.sgmlDecl+=d):b.sgmlDecl+=d;continue;case R.SGML_DECL_QUOTED:d===b.q&&(b.state=R.SGML_DECL,b.q=""),b.sgmlDecl+=d;continue;case R.DOCTYPE:">"===d?(b.state=R.TEXT,o(b,"ondoctype",b.doctype),b.doctype=!0):(b.doctype+=d,"["===d?b.state=R.DOCTYPE_DTD:l(H,d)&&(b.state=R.DOCTYPE_QUOTED,b.q=d));continue;case R.DOCTYPE_QUOTED:b.doctype+=d,d===b.q&&(b.q="",b.state=R.DOCTYPE);continue;case R.DOCTYPE_DTD:b.doctype+=d,"]"===d?b.state=R.DOCTYPE:l(H,d)&&(b.state=R.DOCTYPE_DTD_QUOTED,b.q=d);continue;case R.DOCTYPE_DTD_QUOTED:b.doctype+=d,d===b.q&&(b.state=R.DOCTYPE_DTD,b.q="");continue;case R.COMMENT:"-"===d?b.state=R.COMMENT_ENDING:b.comment+=d;continue;case R.COMMENT_ENDING:"-"===d?(b.state=R.COMMENT_ENDED,b.comment=q(b.opt,b.comment),b.comment&&o(b,"oncomment",b.comment),b.comment=""):(b.comment+="-"+d,b.state=R.COMMENT);continue;case R.COMMENT_ENDED:">"!==d?(t(b,"Malformed comment"),b.comment+="--"+d,b.state=R.COMMENT):b.state=R.TEXT;continue;case R.CDATA:"]"===d?b.state=R.CDATA_ENDING:b.cdata+=d;continue;case R.CDATA_ENDING:"]"===d?b.state=R.CDATA_ENDING_2:(b.cdata+="]"+d,b.state=R.CDATA);continue;case R.CDATA_ENDING_2:">"===d?(b.cdata&&o(b,"oncdata",b.cdata),o(b,"onclosecdata"),b.cdata="",b.state=R.TEXT):"]"===d?b.cdata+="]":(b.cdata+="]]"+d,b.state=R.CDATA);continue;case R.PROC_INST:"?"===d?b.state=R.PROC_INST_ENDING:l(E,d)?b.state=R.PROC_INST_BODY:b.procInstName+=d;continue;case R.PROC_INST_BODY:if(!b.procInstBody&&l(E,d))continue;"?"===d?b.state=R.PROC_INST_ENDING:b.procInstBody+=d;continue;case R.PROC_INST_ENDING:">"===d?(o(b,"onprocessinginstruction",{name:b.procInstName,body:b.procInstBody}),b.procInstName=b.procInstBody="",b.state=R.TEXT):(b.procInstBody+="?"+d,b.state=R.PROC_INST_BODY);continue;case R.OPEN_TAG:l(Q,d)?b.tagName+=d:(u(b),">"===d?x(b):"/"===d?b.state=R.OPEN_TAG_SLASH:(m(E,d)&&t(b,"Invalid character in tag name"),b.state=R.ATTRIB));continue;case R.OPEN_TAG_SLASH:">"===d?(x(b,!0),y(b)):(t(b,"Forward-slash in opening tag not followed by >"),b.state=R.ATTRIB);continue;case R.ATTRIB:if(l(E,d))continue;">"===d?x(b):"/"===d?b.state=R.OPEN_TAG_SLASH:l(P,d)?(b.attribName=d,b.attribValue="",b.state=R.ATTRIB_NAME):t(b,"Invalid attribute name");continue;case R.ATTRIB_NAME:"="===d?b.state=R.ATTRIB_VALUE:">"===d?(t(b,"Attribute without value"),b.attribValue=b.attribName,w(b),x(b)):l(E,d)?b.state=R.ATTRIB_NAME_SAW_WHITE:l(Q,d)?b.attribName+=d:t(b,"Invalid attribute name");continue;case R.ATTRIB_NAME_SAW_WHITE:if("="===d)b.state=R.ATTRIB_VALUE;else{if(l(E,d))continue;t(b,"Attribute without value"),b.tag.attributes[b.attribName]="",b.attribValue="",o(b,"onattribute",{name:b.attribName,value:""}),b.attribName="",">"===d?x(b):l(P,d)?(b.attribName=d,b.state=R.ATTRIB_NAME):(t(b,"Invalid attribute name"),b.state=R.ATTRIB)}continue;case R.ATTRIB_VALUE:if(l(E,d))continue;l(H,d)?(b.q=d,b.state=R.ATTRIB_VALUE_QUOTED):(t(b,"Unquoted attribute value"),b.state=R.ATTRIB_VALUE_UNQUOTED,b.attribValue=d);continue;case R.ATTRIB_VALUE_QUOTED:if(d!==b.q){"&"===d?b.state=R.ATTRIB_VALUE_ENTITY_Q:b.attribValue+=d;continue}w(b),b.q="",b.state=R.ATTRIB_VALUE_CLOSED;continue;case R.ATTRIB_VALUE_CLOSED:l(E,d)?b.state=R.ATTRIB:">"===d?x(b):"/"===d?b.state=R.OPEN_TAG_SLASH:l(P,d)?(t(b,"No whitespace between attributes"),b.attribName=d,b.attribValue="",b.state=R.ATTRIB_NAME):t(b,"Invalid attribute name");continue;case R.ATTRIB_VALUE_UNQUOTED:if(m(J,d)){"&"===d?b.state=R.ATTRIB_VALUE_ENTITY_U:b.attribValue+=d;continue}w(b),">"===d?x(b):b.state=R.ATTRIB;continue;case R.CLOSE_TAG:if(b.tagName)">"===d?y(b):l(Q,d)?b.tagName+=d:b.script?(b.script+="</"+b.tagName,b.tagName="",b.state=R.SCRIPT):(m(E,d)&&t(b,"Invalid tagname in closing tag"),b.state=R.CLOSE_TAG_SAW_WHITE);else{if(l(E,d))continue;m(P,d)?b.script?(b.script+="</"+d,b.state=R.SCRIPT):t(b,"Invalid tagname in closing tag."):b.tagName=d}continue;case R.CLOSE_TAG_SAW_WHITE:if(l(E,d))continue;">"===d?y(b):t(b,"Invalid characters in closing tag");continue;case R.TEXT_ENTITY:case R.ATTRIB_VALUE_ENTITY_Q:case R.ATTRIB_VALUE_ENTITY_U:switch(b.state){case R.TEXT_ENTITY:var h=R.TEXT,i="textNode";break;case R.ATTRIB_VALUE_ENTITY_Q:var h=R.ATTRIB_VALUE_QUOTED,i="attribValue";break;case R.ATTRIB_VALUE_ENTITY_U:var h=R.ATTRIB_VALUE_UNQUOTED,i="attribValue"}";"===d?(b[i]+=z(b),b.entity="",b.state=h):l(I,d)?b.entity+=d:(t(b,"Invalid character entity"),b[i]+="&"+b.entity+d,b.entity="",b.state=h);continue;default:throw new Error(b,"Unknown state: "+b.state)}return b.position>=b.bufferCheckPosition&&e(b),b}c.parser=function(a,b){return new d(a,b)},c.SAXParser=d,c.SAXStream=i,c.createStream=h,c.MAX_BUFFER_LENGTH=65536;var B=["comment","sgmlDecl","textNode","tagName","doctype","procInstName","procInstBody","entity","attribName","attribValue","cdata","script"];c.EVENTS=["text","processinginstruction","sgmldeclaration","doctype","comment","attribute","opentag","closetag","opencdata","cdata","closecdata","error","end","ready","script","opennamespace","closenamespace"],Object.create||(Object.create=function(a){function b(){this.__proto__=a}return b.prototype=a,new b}),Object.getPrototypeOf||(Object.getPrototypeOf=function(a){return a.__proto__}),Object.keys||(Object.keys=function(a){var b=[];for(var c in a)a.hasOwnProperty(c)&&b.push(c);return b}),d.prototype={end:function(){s(this)},write:A,resume:function(){return this.error=null,this},close:function(){return this.write(null)},flush:function(){g(this)}};try{var C=a("stream").Stream}catch(a){var C=function(){}}var D=c.EVENTS.filter(function(a){return"error"!==a&&"end"!==a});i.prototype=Object.create(C.prototype,{constructor:{value:i}}),i.prototype.write=function(c){if("function"==typeof b&&"function"==typeof b.isBuffer&&b.isBuffer(c)){if(!this._decoder){var d=a("string_decoder").StringDecoder;this._decoder=new d("utf8")}c=this._decoder.write(c)}return this._parser.write(c.toString()),this.emit("data",c),!0},i.prototype.end=function(a){return a&&a.length&&this.write(a),this._parser.end(),!0},i.prototype.on=function(a,b){var c=this;return c._parser["on"+a]||-1===D.indexOf(a)||(c._parser["on"+a]=function(){var b=1===arguments.length?[arguments[0]]:Array.apply(null,arguments);b.splice(0,0,a),c.emit.apply(c,b)}),C.prototype.on.call(c,a,b)};var E="\r\n\t ",F="0124356789",G="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ",H="'\"",I=F+G+"#",J=E+">",K="[CDATA[",L="DOCTYPE",M="http://www.w3.org/XML/1998/namespace",N="http://www.w3.org/2000/xmlns/",O={xml:M,xmlns:N};E=j(E),F=j(F),G=j(G);var P=/[:_A-Za-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD]/,Q=/[:_A-Za-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD\u00B7\u0300-\u036F\u203F-\u2040\.\d-]/;H=j(H),I=j(I),J=j(J);var R=0;c.STATE={BEGIN:R++,BEGIN_WHITESPACE:R++,TEXT:R++,TEXT_ENTITY:R++,OPEN_WAKA:R++,SGML_DECL:R++,SGML_DECL_QUOTED:R++,DOCTYPE:R++,DOCTYPE_QUOTED:R++,DOCTYPE_DTD:R++,DOCTYPE_DTD_QUOTED:R++,COMMENT_STARTING:R++,COMMENT:R++,COMMENT_ENDING:R++,COMMENT_ENDED:R++,CDATA:R++,CDATA_ENDING:R++,CDATA_ENDING_2:R++,PROC_INST:R++,PROC_INST_BODY:R++,PROC_INST_ENDING:R++,OPEN_TAG:R++,OPEN_TAG_SLASH:R++,ATTRIB:R++,ATTRIB_NAME:R++,ATTRIB_NAME_SAW_WHITE:R++,ATTRIB_VALUE:R++,ATTRIB_VALUE_QUOTED:R++,ATTRIB_VALUE_CLOSED:R++,ATTRIB_VALUE_UNQUOTED:R++,ATTRIB_VALUE_ENTITY_Q:R++,ATTRIB_VALUE_ENTITY_U:R++,CLOSE_TAG:R++,CLOSE_TAG_SAW_WHITE:R++,SCRIPT:R++,SCRIPT_ENDING:R++},c.XML_ENTITIES={amp:"&",gt:">",lt:"<",quot:'"',apos:"'"},c.ENTITIES={amp:"&",gt:">",lt:"<",quot:'"',apos:"'",AElig:198,Aacute:193,Acirc:194,Agrave:192,Aring:197,Atilde:195,Auml:196,Ccedil:199,ETH:208,Eacute:201,Ecirc:202,Egrave:200,Euml:203,Iacute:205,Icirc:206,Igrave:204,Iuml:207,Ntilde:209,Oacute:211,Ocirc:212,Ograve:210,Oslash:216,Otilde:213,Ouml:214,THORN:222,Uacute:218,Ucirc:219,Ugrave:217,Uuml:220,Yacute:221,aacute:225,acirc:226,aelig:230,agrave:224,aring:229,atilde:227,auml:228,ccedil:231,eacute:233,ecirc:234,egrave:232,eth:240,euml:235,iacute:237,icirc:238,igrave:236,iuml:239,ntilde:241,oacute:243,ocirc:244,ograve:242,oslash:248,otilde:245,ouml:246,szlig:223,thorn:254,uacute:250,ucirc:251,ugrave:249,uuml:252,yacute:253,yuml:255,copy:169,reg:174,nbsp:160,iexcl:161,cent:162,pound:163,curren:164,yen:165,brvbar:166,sect:167,uml:168,ordf:170,laquo:171,not:172,shy:173,macr:175,deg:176,plusmn:177,sup1:185,sup2:178,sup3:179,acute:180,micro:181,para:182,middot:183,cedil:184,ordm:186,raquo:187,frac14:188,frac12:189,frac34:190,iquest:191,times:215,divide:247,OElig:338,oelig:339,Scaron:352,scaron:353,Yuml:376,fnof:402,circ:710,tilde:732,Alpha:913,Beta:914,Gamma:915,Delta:916,Epsilon:917,Zeta:918,Eta:919,Theta:920,Iota:921,Kappa:922,Lambda:923,Mu:924,Nu:925,Xi:926,Omicron:927,Pi:928,Rho:929,Sigma:931,Tau:932,Upsilon:933,Phi:934,Chi:935,Psi:936,Omega:937,alpha:945,beta:946,gamma:947,delta:948,epsilon:949,zeta:950,eta:951,theta:952,iota:953,kappa:954,lambda:955,mu:956,nu:957,xi:958,omicron:959,pi:960,rho:961,sigmaf:962,sigma:963,tau:964,upsilon:965,phi:966,chi:967,psi:968,omega:969,thetasym:977,upsih:978,piv:982,ensp:8194,emsp:8195,thinsp:8201,zwnj:8204,zwj:8205,lrm:8206,rlm:8207,ndash:8211,mdash:8212,lsquo:8216,rsquo:8217,sbquo:8218,ldquo:8220,rdquo:8221,bdquo:8222,dagger:8224,Dagger:8225,bull:8226,hellip:8230,permil:8240,prime:8242,Prime:8243,lsaquo:8249,rsaquo:8250,oline:8254,frasl:8260,euro:8364,image:8465,weierp:8472,real:8476,trade:8482,alefsym:8501,larr:8592,uarr:8593,rarr:8594,darr:8595,harr:8596,crarr:8629,lArr:8656,uArr:8657,rArr:8658,dArr:8659,
hArr:8660,forall:8704,part:8706,exist:8707,empty:8709,nabla:8711,isin:8712,notin:8713,ni:8715,prod:8719,sum:8721,minus:8722,lowast:8727,radic:8730,prop:8733,infin:8734,ang:8736,and:8743,or:8744,cap:8745,cup:8746,int:8747,there4:8756,sim:8764,cong:8773,asymp:8776,ne:8800,equiv:8801,le:8804,ge:8805,sub:8834,sup:8835,nsub:8836,sube:8838,supe:8839,oplus:8853,otimes:8855,perp:8869,sdot:8901,lceil:8968,rceil:8969,lfloor:8970,rfloor:8971,lang:9001,rang:9002,loz:9674,spades:9824,clubs:9827,hearts:9829,diams:9830},Object.keys(c.ENTITIES).forEach(function(a){var b=c.ENTITIES[a],d="number"==typeof b?String.fromCharCode(b):b;c.ENTITIES[a]=d});for(var R in c.STATE)c.STATE[c.STATE[R]]=R;R=c.STATE,String.fromCodePoint||function(){var a=String.fromCharCode,b=Math.floor,c=function(){var c,d,e=[],f=-1,g=arguments.length;if(!g)return"";for(var h="";++f<g;){var i=Number(arguments[f]);if(!isFinite(i)||i<0||i>1114111||b(i)!=i)throw RangeError("Invalid code point: "+i);i<=65535?e.push(i):(i-=65536,c=55296+(i>>10),d=i%1024+56320,e.push(c,d)),(f+1==g||e.length>16384)&&(h+=a.apply(null,e),e.length=0)}return h};Object.defineProperty?Object.defineProperty(String,"fromCodePoint",{value:c,configurable:!0,writable:!0}):String.fromCodePoint=c}()}(void 0===c?sax={}:c)}).call(this,a("buffer").Buffer)},{buffer:4,stream:24,string_decoder:25}],24:[function(a,b,c){function d(){e.call(this)}b.exports=d;var e=a("events").EventEmitter;a("inherits")(d,e),d.Readable=a("readable-stream/readable.js"),d.Writable=a("readable-stream/writable.js"),d.Duplex=a("readable-stream/duplex.js"),d.Transform=a("readable-stream/transform.js"),d.PassThrough=a("readable-stream/passthrough.js"),d.Stream=d,d.prototype.pipe=function(a,b){function c(b){a.writable&&!1===a.write(b)&&j.pause&&j.pause()}function d(){j.readable&&j.resume&&j.resume()}function f(){k||(k=!0,a.end())}function g(){k||(k=!0,"function"==typeof a.destroy&&a.destroy())}function h(a){if(i(),0===e.listenerCount(this,"error"))throw a}function i(){j.removeListener("data",c),a.removeListener("drain",d),j.removeListener("end",f),j.removeListener("close",g),j.removeListener("error",h),a.removeListener("error",h),j.removeListener("end",i),j.removeListener("close",i),a.removeListener("close",i)}var j=this;j.on("data",c),a.on("drain",d),a._isStdio||b&&!1===b.end||(j.on("end",f),j.on("close",g));var k=!1;return j.on("error",h),a.on("error",h),j.on("end",i),j.on("close",i),a.on("close",i),a.emit("pipe",j),a}},{events:7,inherits:9,"readable-stream/duplex.js":13,"readable-stream/passthrough.js":19,"readable-stream/readable.js":20,"readable-stream/transform.js":21,"readable-stream/writable.js":22}],25:[function(a,b,c){function d(a){if(a&&!i(a))throw new Error("Unknown encoding: "+a)}function e(a){return a.toString(this.encoding)}function f(a){this.charReceived=a.length%2,this.charLength=this.charReceived?2:0}function g(a){this.charReceived=a.length%3,this.charLength=this.charReceived?3:0}var h=a("buffer").Buffer,i=h.isEncoding||function(a){switch(a&&a.toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":case"raw":return!0;default:return!1}},j=c.StringDecoder=function(a){switch(this.encoding=(a||"utf8").toLowerCase().replace(/[-_]/,""),d(a),this.encoding){case"utf8":this.surrogateSize=3;break;case"ucs2":case"utf16le":this.surrogateSize=2,this.detectIncompleteChar=f;break;case"base64":this.surrogateSize=3,this.detectIncompleteChar=g;break;default:return void(this.write=e)}this.charBuffer=new h(6),this.charReceived=0,this.charLength=0};j.prototype.write=function(a){for(var b="";this.charLength;){var c=a.length>=this.charLength-this.charReceived?this.charLength-this.charReceived:a.length;if(a.copy(this.charBuffer,this.charReceived,0,c),this.charReceived+=c,this.charReceived<this.charLength)return"";a=a.slice(c,a.length),b=this.charBuffer.slice(0,this.charLength).toString(this.encoding);var d=b.charCodeAt(b.length-1);if(!(d>=55296&&d<=56319)){if(this.charReceived=this.charLength=0,0===a.length)return b;break}this.charLength+=this.surrogateSize,b=""}this.detectIncompleteChar(a);var e=a.length;this.charLength&&(a.copy(this.charBuffer,0,a.length-this.charReceived,e),e-=this.charReceived),b+=a.toString(this.encoding,0,e);var e=b.length-1,d=b.charCodeAt(e);if(d>=55296&&d<=56319){var f=this.surrogateSize;return this.charLength+=f,this.charReceived+=f,this.charBuffer.copy(this.charBuffer,f,0,f),a.copy(this.charBuffer,0,0,f),b.substring(0,e)}return b},j.prototype.detectIncompleteChar=function(a){for(var b=a.length>=3?3:a.length;b>0;b--){var c=a[a.length-b];if(1==b&&c>>5==6){this.charLength=2;break}if(b<=2&&c>>4==14){this.charLength=3;break}if(b<=3&&c>>3==30){this.charLength=4;break}}this.charReceived=b},j.prototype.end=function(a){var b="";if(a&&a.length&&(b=this.write(a)),this.charReceived){var c=this.charReceived,d=this.charBuffer,e=this.encoding;b+=d.slice(0,c).toString(e)}return b}},{buffer:4}],26:[function(a,b,c){var d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H,I,J,K,L,M,N,O,P,Q,R,S,T,U,V,W,X,Y,Z,$,_,aa,ba,ca,da,ea,fa,ga,ha,ia,ja,ka,la,ma,na,oa,pa=[].indexOf||function(a){for(var b=0,c=this.length;b<c;b++)if(b in this&&this[b]===a)return b;return-1};_=a("./helper.coffee"),W=a("./draw.coffee"),ga=a("./model.coffee"),oa=a("./view.coffee"),H=a("../vendor/quadtree.js"),ha=a("./modes.coffee"),G=5,F=5,C=1,E=5,D=2,A=100,g=3,f=.5,j=!1,p=17,o=10,m=8,n=10,l=50,d=8,M=9,r=13,z=37,Q=38,I=39,k=40,S=90,R=89,B=[91,92,93,223,224],e=[17,162,163],y=5,x="rgba(256, 256, 256, 0.5)",w="#AAA",ma="","undefined"!=typeof window&&(null!=(ja=window.navigator)?ja.userAgent:void 0)&&(ma=window.navigator.userAgent),ba=/OS X/.test(ma),U=ba?B:e,V=function(a){return ba?a.metaKey:a.ctrlKey},la={populate:[],resize:[],resize_palette:[],redraw_main:[],redraw_palette:[],rebuild_palette:[],mousedown:[],mousemove:[],mouseup:[],dblclick:[],keydown:[],keyup:[]},X={},K=_.SVG_STANDARD,q='<svg xlmns="'+K+'">\n  <filter id="dropShadow" x="0" y="0" width="200%" height="200%">\n    <feOffset result="offOut" in="SourceAlpha" dx="5" dy="5" />\n    <feGaussianBlur result="blurOut" in="offOut" stdDeviation="1" />\n    <feBlend in="SourceGraphic" in2="blurOut" out="blendOut" mode="normal" />\n    <feComposite in="blendOut" in2="SourceGraphic" k2="0.5" k3="0.5" operator="arithmetic" />\n  </filter>\n</svg>',aa=function(a,b,c){return la[a].push({priority:b,fn:c})},L=function(){function a(a,b,c,d,e){var f,g,h,j,k,l,m,n,o,p;this.options=d,this.readOnly=!1,this.paletteGroups=this.options.palette,this.showPaletteInTextMode=null!=(h=this.options.showPaletteInTextMode)&&h,this.paletteEnabled=null==(j=this.options.enablePaletteAtStart)||j,this.dropIntoAceAtLineStart=null!=(k=this.options.dropIntoAceAtLineStart)&&k,this.allowFloatingBlocks=null==(l=this.options.allowFloatingBlocks)||l,null==(f=this.options).preserveEmpty&&(f.preserveEmpty=!0),this.options.mode=this.options.mode.replace(/$\/ace\/mode\//,""),this.options.mode in ha?this.mode=new ha[this.options.mode](this.options.modeOptions):this.mode=null,this.view=new oa.View(a,_.extend(e,null!=(m=this.options.viewSettings)?m:{})),this.paletteView=new oa.View(b,_.extend({},e,null!=(n=this.options.viewSettings)?n:{},{showDropdowns:null!=(o=this.options.showDropdownInPalette)&&o})),this.dragView=new oa.View(c,_.extend({},e,null!=(p=this.options.viewSettings)?p:{})),this.tree=new ga.Document(this.rootContext),this.markedLines={},this.markedBlocks={},this.nextMarkedBlockId=0,this.extraMarks={},this.undoStack=[],this.redoStack=[],this.changeEventVersion=0,this.floatingBlocks=[],this.cursor=new i(0,new ga.Location(0,"documentStart")),this.viewports={main:new W.Rectangle(0,0,0,0),palette:new W.Rectangle(0,0,0,0)},this.currentlyUsingBlocks=!0,this.fontSize=15,this.fontFamily="Courier New",g=_.fontMetrics(this.fontFamily,this.fontSize),this.fontAscent=g.prettytop,this.fontDescent=g.descent,this.fontWidth=this.view.draw.measureCtx.measureText(" ").width,this.rememberedSockets=[]}return a}(),c.Editor=s=function(){function a(a,b){var c,d,e,f,g,h,i,j,k,l,m,n,o;for(this.aceEditor=a,this.options=b,this.debugging=!0,this.options=_.deepCopy(this.options),this.dropletElement=document.createElement("div"),this.dropletElement.className="droplet-wrapper-div",this.dropletElement.innerHTML=q,this.dropletElement.tabIndex=0,this.measureCanvas=document.createElement("canvas"),this.measureCtx=this.measureCanvas.getContext("2d"),this.mainCanvas=document.createElementNS(K,"svg"),this.mainCanvas.setAttribute("class","droplet-main-canvas"),this.mainCanvas.setAttribute("shape-rendering","optimizeSpeed"),this.sideScroller=document.createElement("div"),this.sideScroller.className="droplet-side-scroller",this.sideScroller.style.overflowY="hidden",this.sideScroller.style.position="absolute",this.sideScroller.style.top=0,this.sideScroller.style.left=0,this.paletteWrapper=document.createElement("div"),this.paletteWrapper.className="droplet-palette-wrapper",this.paletteElement=document.createElement("div"),this.paletteElement.className="droplet-palette-element",this.paletteWrapper.appendChild(this.paletteElement),this.paletteCanvas=this.paletteCtx=document.createElementNS(K,"svg"),this.paletteCanvas.setAttribute("class","droplet-palette-canvas"),this.paletteWrapper.style.position="absolute",this.paletteWrapper.style.left="0px",this.paletteWrapper.style.top="0px",this.paletteWrapper.style.bottom="0px",this.paletteWrapper.style.width="270px",this.dragCanvas=this.dragCtx=document.createElementNS(K,"svg"),this.dragCanvas.setAttribute("class","droplet-drag-canvas"),this.dragCanvas.style.left="0px",this.dragCanvas.style.top="0px",this.dragCanvas.style.transform="translate(-9999px,-9999px)",this.draw=new W.Draw(this.mainCanvas),this.dropletElement.style.left=this.paletteWrapper.clientWidth+"px",this.dropletElement.style.zIndex=1,this.draw.refreshFontCapital(),this.standardViewSettings={padding:5,indentWidth:20,textHeight:_.getFontHeight("Courier New",15),indentTongueHeight:20,tabOffset:10,tabWidth:15,tabHeight:4,tabSideWidth:.25,dropAreaHeight:20,indentDropAreaMinWidth:50,emptySocketWidth:20,emptyLineHeight:25,highlightAreaHeight:10,shadowBlur:5,ctx:this.measureCtx,draw:this.draw},this.aceEditor instanceof Node?(this.wrapperElement=this.aceEditor,this.wrapperElement.style.position="absolute",this.wrapperElement.style.right=this.wrapperElement.style.left=this.wrapperElement.style.top=this.wrapperElement.style.bottom="0px",this.aceElement=document.createElement("div"),this.aceElement.className="droplet-ace",this.wrapperElement.appendChild(this.aceElement),this.aceEditor=ace.edit(this.aceElement),this.aceEditor.setTheme("ace/theme/chrome"),this.aceEditor.setFontSize(15),c=this.options.mode,"coffeescript"===c&&(c="coffee"),this.aceEditor.getSession().setMode("ace/mode/"+c),this.aceEditor.getSession().setTabSize(2)):(this.wrapperElement=document.createElement("div"),this.wrapperElement.style.position="absolute",this.wrapperElement.style.right=this.wrapperElement.style.left=this.wrapperElement.style.top=this.wrapperElement.style.bottom="0px",this.aceElement=this.aceEditor.container,this.aceElement.className+=" droplet-ace",this.aceEditor.container.parentElement.appendChild(this.wrapperElement),this.wrapperElement.appendChild(this.aceEditor.container)),this.aceElement.style.zIndex=1,this.wrapperElement.appendChild(this.dropletElement),this.wrapperElement.appendChild(this.paletteWrapper),this.wrapperElement.style.backgroundColor="#FFF",this.currentlyAnimating=!1,this.transitionContainer=document.createElement("div"),this.transitionContainer.className="droplet-transition-container",this.dropletElement.appendChild(this.transitionContainer),null!=this.options?(this.session=new L(this.mainCanvas,this.paletteCanvas,this.dragCanvas,this.options,this.standardViewSettings),this.sessions=new _.PairDict([[this.aceEditor.getSession(),this.session]])):(this.session=null,this.sessions=new _.PairDict([]),this.options={extraBottomHeight:10}),this.aceEditor.on("changeSession",function(a){return function(b){return a.sessions.contains(b.session)?a.updateNewSession(a.sessions.get(b.session)):null!=b.session._dropletSession?(a.updateNewSession(b.session._dropletSession),a.sessions.set(b.session,b.session._dropletSession)):(a.updateNewSession(null),a.setEditorState(!1))}}(this)),this.bindings={},[],l=X.populate,j=0,k=l.length;j<k;j++)d=l[j],d.call(this);window.addEventListener("resize",function(a){return function(){return a.resizeBlockMode()}}(this)),f=function(a){return function(b){var c,d,e,f,g,h;if(("mousemove"===b.type||1===b.which)&&b.target!==a.mainScroller){for(h=new a.draw.Point(b.clientX,b.clientY),g={},f=X[b.type],d=0,e=f.length;d<e;d++)c=f[d],c.call(a,h,b,g);return"mousedown"===b.type?("function"==typeof b.preventDefault&&b.preventDefault(),b.returnValue=!1,!1):void 0}}}(this),e=function(a){return function(b){var c,d,e,f,g,h;for(h={},f=X[b.type],g=[],d=0,e=f.length;d<e;d++)c=f[d],g.push(c.call(a,b,h));return g}}(this),m={keydown:[this.dropletElement,this.paletteElement],keyup:[this.dropletElement,this.paletteElement],mousedown:[this.dropletElement,this.paletteElement,this.dragCover],dblclick:[this.dropletElement,this.paletteElement,this.dragCover],mouseup:[window],mousemove:[window]},i=function(a){return function(a,b){var c,d,g,h;for(h=[],d=0,g=b.length;d<g;d++)c=b[d],/^key/.test(a)?h.push(c.addEventListener(a,e)):h.push(c.addEventListener(a,f));return h}}();for(h in m)g=m[h],i(h,g);return this.resizeBlockMode(),this.redrawMain(),this.rebuildPalette(),o=null!=(null!=(n=this.session)?n.mode:void 0)&&!this.options.textModeAtStart,this.setEditorState(o),this}return a.prototype.setMode=function(a,b){var c;return c=ha[a],c?(this.options.mode=a,this.session.mode=new c(b)):(this.options.mode=null,this.session.mode=null),this.setValue(this.getValue())},a.prototype.getMode=function(){return this.options.mode},a.prototype.setReadOnly=function(a){return this.session.readOnly=a,this.aceEditor.setReadOnly(a)},a.prototype.getReadOnly=function(){return this.session.readOnly},a.prototype.resizeTextMode=function(){this.resizeAceElement(),this.aceEditor.resize(!0),null!=this.session&&this.resizePalette()},a.prototype.resizeBlockMode=function(){var a;if(null!=this.session)return this.resizeTextMode(),(null!=(a=this.session)?a.currentlyUsingBlocks:void 0)?this.dropletElement.style.bottom="0px":this.dropletElement.style.bottom="9999px",this.session.paletteEnabled?this.dropletElement.style.left=this.paletteWrapper.clientWidth+"px":this.dropletElement.style.left="0px",this.dropletElement.style.right="0px",this.session.viewports.main.height=this.dropletElement.clientHeight,this.session.viewports.main.width=this.dropletElement.clientWidth-this.gutter.clientWidth,this.mainCanvas.style.left=this.gutter.clientWidth+"px",this.transitionContainer.style.left=this.gutter.clientWidth+"px",this.resizePalette(),this.resizePaletteHighlight(),this.resizeNubby(),this.resizeMainScroller(),this.resizeDragCanvas(),this.session.viewports.main.y=this.mainScroller.scrollTop,this.session.viewports.main.x=this.mainScroller.scrollLeft},a.prototype.resizePalette=function(){var a,b,c,d;for(d=X.resize_palette,b=0,c=d.length;b<c;b++)a=d[b],a.call(this);return this.rebuildPalette()},a.prototype.resize=function(){var a;return(null!=(a=this.session)?a.currentlyUsingBlocks:void 0)?this.resizeBlockMode():this.resizeTextMode()},a.prototype.updateNewSession=function(a){var b,c;if(this.session.view.clearFromCanvas(),this.session.paletteView.clearFromCanvas(),this.session.dragView.clearFromCanvas(),this.session=a,null!=a)return c=this.session.viewports.main.y,b=this.session.viewports.main.x,this.setEditorState(this.session.currentlyUsingBlocks),this.redrawMain(),this.mainScroller.scrollTop=c,this.mainScroller.scrollLeft=b,this.setPalette(this.session.paletteGroups)},a.prototype.hasSessionFor=function(a){return this.sessions.contains(a)},a.prototype.bindNewSession=function(a){var b;if(this.sessions.contains(this.aceEditor.getSession()))throw new ArgumentError("Cannot bind a new session where one already exists.");return b=new L(this.mainCanvas,this.paletteCanvas,this.dragCanvas,a,this.standardViewSettings),this.sessions.set(this.aceEditor.getSession(),b),this.session=b,this.aceEditor.getSession()._dropletSession=this.session,this.session.currentlyUsingBlocks=!1,this.setValue_raw(this.getAceValue()),this.setPalette(this.session.paletteGroups),b},a}(),s.prototype.clearCanvas=function(a){},s.prototype.clearMain=function(a){},s.prototype.setTopNubbyStyle=function(a,b,c){var d,e;return null==a&&(a=10),null==b&&(b="#EBEBEB"),null==c&&(c=0),this.nubbyHeight=Math.max(0,a),this.nubbyColor=b,null==this.topNubbyPath&&(this.topNubbyPath=new this.draw.Path([],!0)),this.topNubbyPath.activate(),this.topNubbyPath.setParent(this.mainCanvas),e=[],d=this.computeMainCanvasWidth(c),e.push(new this.draw.Point(d,-5)),e.push(new this.draw.Point(d,a)),e.push(new this.draw.Point(this.session.view.opts.tabOffset+this.session.view.opts.tabWidth,a)),e.push(new this.draw.Point(this.session.view.opts.tabOffset+this.session.view.opts.tabWidth*(1-this.session.view.opts.tabSideWidth),this.session.view.opts.tabHeight+a)),e.push(new this.draw.Point(this.session.view.opts.tabOffset+this.session.view.opts.tabWidth*this.session.view.opts.tabSideWidth,this.session.view.opts.tabHeight+a)),e.push(new this.draw.Point(this.session.view.opts.tabOffset,a)),e.push(new this.draw.Point(this.session.view.opts.bevelClip,a)),e.push(new this.draw.Point(0,a+this.session.view.opts.bevelClip)),e.push(new this.draw.Point(-5,a+this.session.view.opts.bevelClip)),e.push(new this.draw.Point(-5,-5)),this.topNubbyPath.setPoints(e),this.topNubbyPath.style.fillColor=b,this.redrawMain({addedWidth:c})},s.prototype.resizeNubby=function(a){return this.setTopNubbyStyle(this.nubbyHeight,this.nubbyColor,a)},s.prototype.initializeFloatingBlock=function(a,b){var c,d,e,f;for(a.renderGroup=new this.session.view.draw.Group,a.grayBox=new this.session.view.draw.NoRectangle,a.grayBoxPath=new this.session.view.draw.Path([],!1,{fillColor:x,strokeColor:w,lineWidth:4,dotted:"8 5",cssClass:"droplet-floating-container"}),a.startText=new this.session.view.draw.Text(new this.session.view.draw.Point(0,0),this.session.mode.startComment),a.endText=new this.session.view.draw.Text(new this.session.view.draw.Point(0,0),this.session.mode.endComment),f=[a.grayBoxPath,a.startText,a.endText],d=0,e=f.length;d<e;d++)c=f[d],c.setParent(a.renderGroup),c.activate();return this.session.view.getViewNodeFor(a.block).group.setParent(a.renderGroup),a.renderGroup.activate(),b<this.session.floatingBlocks.length?this.mainCanvas.insertBefore(a.renderGroup.element,this.session.floatingBlocks[b].renderGroup.element):this.mainCanvas.appendChild(a.renderGroup)},s.prototype.drawFloatingBlock=function(a,b,c,d,e){var f,g,h,i,j,k,l,m;return f=this.session.view.getViewNodeFor(a.block),f.layout(a.position.x,a.position.y),j=new this.session.view.draw.Rectangle,j.copy(f.totalBounds),j.x-=y,j.y-=y,j.width+=2*y,j.height+=2*y,g=f.totalBounds.bottom()-f.distanceToBase[f.lineLength-1].below-this.session.fontSize,f.totalBounds.width-f.bounds[f.bounds.length-1].width<c&&(f.lineLength>1?(j.height+=this.session.fontSize,g=j.bottom()-this.session.fontSize-5):j.width+=c),j.equals(a.grayBox)||(a.grayBox=j,h=null!=(k=null!=(l=a.grayBoxPath)&&"function"==typeof l.bounds?l.bounds():void 0)?k:new this.session.view.draw.NoRectangle,m=f.bounds[0].height+10,i=[],i.push(new this.session.view.draw.Point(j.right()-5,j.y)),i.push(new this.session.view.draw.Point(j.right(),j.y+5)),i.push(new this.session.view.draw.Point(j.right(),j.bottom()-5)),i.push(new this.session.view.draw.Point(j.right()-5,j.bottom())),f.lineLength>1?(i.push(new this.session.view.draw.Point(j.x+5,j.bottom())),i.push(new this.session.view.draw.Point(j.x,j.bottom()-5))):i.push(new this.session.view.draw.Point(j.x,j.bottom())),i.push(new this.session.view.draw.Point(j.x,j.y+m)),i.push(new this.session.view.draw.Point(j.x-b+5,j.y+m)),i.push(new this.session.view.draw.Point(j.x-b,j.y+m-5)),i.push(new this.session.view.draw.Point(j.x-b,j.y+5)),i.push(new this.session.view.draw.Point(j.x-b+5,j.y)),i.push(new this.session.view.draw.Point(j.x,j.y)),a.grayBoxPath.setPoints(i),null==e.boundingRectangle)?(a.grayBoxPath.update(),a.startText.point.x=f.totalBounds.x-b,a.startText.point.y=f.totalBounds.y+f.distanceToBase[0].above-this.session.fontSize,a.startText.update(),a.endText.point.x=a.grayBox.right()-c-5,a.endText.point.y=g,a.endText.update(),f.draw(d,{grayscale:!1,selected:!1,noText:!1})):(e.boundingRectangle.unite(path.bounds()),e.boundingRectangle.unite(h),this.redrawMain(e))},aa("populate",0,function(){return this.currentlyDrawnFloatingBlocks=[]}),s.prototype.computeMainCanvasWidth=function(a){return null==a&&(a=0),Math.max(this.session.view.getViewNodeFor(this.session.tree).totalBounds.width,this.dropletElement.clientWidth+a-this.gutter.clientWidth)},s.prototype.redrawMain=function(a){var b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w;if(null==a&&(a={}),null!=this.session&&!this.currentlyAnimating_suprressRedraw){for(this.session.view.beginDraw(),this.clearMain(a),this.topNubbyPath.update(),o=this.session.viewports.main,m={grayscale:!1,selected:!1,noText:null!=(p=a.noText)&&p},i=this.session.view.getViewNodeFor(this.session.tree).layout(0,this.nubbyHeight),this.session.view.getViewNodeFor(this.session.tree).draw(o,m),this.session.view.getViewNodeFor(this.session.tree).root(),this.mainCanvas.setAttribute("width",this.computeMainCanvasWidth(null!=(q=a.addedWidth)?q:0)),r=this.currentlyDrawnFloatingBlocks,e=f=0,j=r.length;f<j;e=++f)c=r[e],s=c.record,pa.call(this.session.floatingBlocks,s)<0&&(c.record.grayBoxPath.destroy(),c.record.startText.destroy(),c.record.endText.destroy());for(this.currentlyDrawnFloatingBlocks=[],w=this.session.mode.startComment.length*this.session.fontWidth,d=this.session.mode.endComment.length*this.session.fontWidth,t=this.session.floatingBlocks,g=0,k=t.length;g<k;g++)n=t[g],this.drawFloatingBlock(n,w,d,o,a),this.currentlyDrawnFloatingBlocks.push({record:n});for(this.redrawCursors(),this.redrawHighlights(),this.resizeGutter(),u=X.redraw_main,h=0,l=u.length;h<l;h++)b=u[h],b.call(this,i);return this.session.changeEventVersion!==this.session.tree.version&&(this.session.changeEventVersion=this.session.tree.version,(null!=(v=this.session)?v.currentlyUsingBlocks:void 0)&&this.setAceValue(this.getValue()),this.fireEvent("change",[])),this.session.view.cleanupDraw(),this.alreadyScheduledCleanup||(this.alreadyScheduledCleanup=!0,setTimeout(function(a){return function(){if(a.alreadyScheduledCleanup=!1,null!=a.session)return a.session.view.garbageCollect()}}(this),0)),null}},s.prototype.redrawHighlights=function(){if(this.redrawCursors(),this.redrawLassoHighlight(),null!=this.draggingBlock&&this.inDisplay(this.draggingBlock))return this.session.view.getViewNodeFor(this.draggingBlock).draw(new this.draw.Rectangle(this.session.viewports.main.x,this.session.viewports.main.y,this.session.viewports.main.width,this.session.viewports.main.height),{grayscale:!0})},s.prototype.clearCursorCanvas=function(){return this.textCursorPath.deactivate(),this.cursorPath.deactivate()},s.prototype.redrawCursors=function(){if(null!=this.session)return this.clearCursorCanvas(),this.cursorAtSocket()?this.redrawTextHighlights():null==this.lassoSelection?this.drawCursor():void 0},s.prototype.drawCursor=function(){return this.strokeCursor(this.determineCursorPosition())},s.prototype.clearPalette=function(){},s.prototype.clearPaletteHighlightCanvas=function(){},s.prototype.redrawPalette=function(){var a,b,c,d,e,f,g,h,i,j,k,l,m,n;if(null!=(null!=(k=this.session)?k.currentPaletteBlocks:void 0)){for(this.clearPalette(),this.session.paletteView.beginDraw(),f=G,l=this.session.currentPaletteBlocks,d=0,g=l.length;d<g;d++)c=l[d],j=this.session.paletteView.getViewNodeFor(c.block),j.layout(E,f),j.draw(),j.group.setParent(this.paletteCtx),b=document.createElementNS(K,"title"),b.innerHTML=null!=(m=c.title)?m:c.block.stringify(),j.group.element.appendChild(b),j.group.element.setAttribute("data-id",c.id),i=j.group.element.getAttribute("class")||"",i.indexOf("droplet-hover-div")>-1||j.group.element.setAttribute("class",i+" droplet-hover-div"),j.group.element.setAttribute("title",c.title),f=j.getBounds().bottom()+F;for(n=X.redraw_palette,e=0,h=n.length;e<h;e++)a=n[e],a.call(this);return this.paletteCanvas.style.height=f+"px",this.session.paletteView.garbageCollect()}},s.prototype.rebuildPalette=function(){var a,b,c,d,e,f;if(null!=(null!=(d=this.session)?d.currentPaletteBlocks:void 0)){for(this.redrawPalette(),e=X.rebuild_palette,f=[],b=0,c=e.length;b<c;b++)a=e[b],f.push(a.call(this));return f}},s.prototype.absoluteOffset=function(a){var b;for(b=new this.draw.Point(a.offsetLeft,a.offsetTop),a=a.offsetParent;a!==document.body&&null!=a;)b.x+=a.offsetLeft-a.scrollLeft,b.y+=a.offsetTop-a.scrollTop,a=a.offsetParent;return b},s.prototype.trackerPointToMain=function(a){var b;return null==this.mainCanvas.parentNode?new this.draw.Point(NaN,NaN):(b=this.mainCanvas.getBoundingClientRect(),new this.draw.Point(a.x-b.left,a.y-b.top))},s.prototype.trackerPointToPalette=function(a){var b;return null==this.paletteCanvas.parentNode?new this.draw.Point(NaN,NaN):(b=this.paletteCanvas.getBoundingClientRect(),new this.draw.Point(a.x-b.left,a.y-b.top))},s.prototype.trackerPointIsInElement=function(a,b){var c;return null!=this.session&&!this.session.readOnly&&(null!=b.parentNode&&(c=b.getBoundingClientRect(),a.x>=c.left&&a.x<c.right&&a.y>=c.top&&a.y<c.bottom))},s.prototype.trackerPointIsInMain=function(a){return this.trackerPointIsInElement(a,this.mainCanvas)},s.prototype.trackerPointIsInMainScroller=function(a){return this.trackerPointIsInElement(a,this.mainScroller)},s.prototype.trackerPointIsInGutter=function(a){return this.trackerPointIsInElement(a,this.gutter)},s.prototype.trackerPointIsInPalette=function(a){return this.trackerPointIsInElement(a,this.paletteCanvas)},s.prototype.trackerPointIsInAceScrollRegion=function(a){var b;return null!=this.session&&!this.session.readOnly&&(null!=this.aceElement.parentNode&&(b=this.aceElement.getBoundingClientRect(),a.x>=b.left-l&&a.x<b.right+l))},s.prototype.trackerPointIsInScrollRegion=function(a,b){var c;if(null==this.session||this.session.readOnly)return!1;if(null==this.mainScroller.parentNode)return!1;switch(c=this.mainScroller.getBoundingClientRect(),b){case"down":return a.x>=c.left&&a.x<c.right&&a.y>=c.bottom-o;case"up":return a.x>=c.left&&a.x<c.right&&a.y<=c.top+o;case"left":return a.x<=c.left+o&&a.y>=c.top&&a.y<c.bottom;case"right":return a.x>=c.right-o&&a.y>=c.top&&a.y<c.bottom;default:return!1}},s.prototype.hitTest=function(a,b,c){var d,e,f;if(null==c&&(c=this.session.view),this.session.readOnly)return null;for(d=b.start,f=b.end,e=null;d!==f;)"blockStart"===d.type&&c.getViewNodeFor(d.container).path.contains(a)&&(e=d.container,f=d.container.end),d=d.next;return e},aa("mousedown",10,function(){var a,b;return a=document.body.scrollLeft,b=document.body.scrollTop,this.dropletElement.focus(),window.scrollTo(a,b)}),s.prototype.removeBlankLines=function(){var a,b;for(a=b=this.session.tree.end.prev;"newline"===(null!=a?a.type:void 0);)a=a.prev;if("newline"===a.type)return this.spliceOut(new ga.List(a,b))},aa("keydown",0,function(a,b){return a.which===S&&a.shiftKey&&V(a)?this.redo():a.which===S&&V(a)?this.undo():a.which===R&&V(a)?this.redo():void 0}),t=function(){function a(a,b){this.root=a,this.floats=b}return a.prototype.equals=function(a){var b,c,d,e,f;if(this.root!==a.root||this.floats.length!==a.floats.length)return!1;for(f=this.floats,c=d=0,e=f.length;d<e;c=++d)if(b=f[c],!b.position.equals(a.floats[c].position)||b.string!==a.floats[c].string)return!1;return!0},a.prototype.toString=function(){return JSON.stringify({root:this.root,floats:this.floats})},a}(),s.prototype.getSerializedEditorState=function(){return new t(this.session.tree.stringify(),this.session.floatingBlocks.map(function(a){return{position:a.position,string:a.block.stringify()}}))},s.prototype.clearUndoStack=function(){if(null!=this.session)return this.session.undoStack.length=0,this.session.redoStack.length=0},s.prototype.undo=function(){var a,b;if(null!=this.session){for(this.setCursor(this.session.cursor,function(a){return"socketStart"!==a.type}),a=this.getSerializedEditorState();!(0===this.session.undoStack.length||this.session.undoStack[this.session.undoStack.length-1]instanceof h&&!this.getSerializedEditorState().equals(a));)b=this.popUndo(),b instanceof v?this.performFloatingOperation(b,"backward"):b instanceof h||this.getDocument(b.document).perform(b.operation,"backward",this.getPreserves(b.document));this.session.undoStack[this.session.undoStack.length-1]instanceof h&&(this.session.rememberedSockets=this.session.undoStack[this.session.undoStack.length-1].rememberedSockets.map(function(a){return a.clone()})),this.popUndo(),this.correctCursor(),this.redrawMain()}},s.prototype.pushUndo=function(a){return this.session.redoStack.length=0,this.session.undoStack.push(a)},s.prototype.popUndo=function(){var a;return a=this.session.undoStack.pop(),null!=a&&this.session.redoStack.push(a),a},s.prototype.popRedo=function(){var a;return a=this.session.redoStack.pop(),null!=a&&this.session.undoStack.push(a),a},s.prototype.redo=function(){var a,b;for(a=this.getSerializedEditorState();!(0===this.session.redoStack.length||this.session.redoStack[this.session.redoStack.length-1]instanceof h&&!this.getSerializedEditorState().equals(a));)b=this.popRedo(),b instanceof v?this.performFloatingOperation(b,"forward"):b instanceof h||this.getDocument(b.document).perform(b.operation,"forward",this.getPreserves(b.document));this.session.undoStack[this.session.undoStack.length-1]instanceof h&&(this.session.rememberedSockets=this.session.undoStack[this.session.undoStack.length-1].rememberedSockets.map(function(a){return a.clone()})),this.popRedo(),this.redrawMain()},s.prototype.undoCapture=function(){return this.pushUndo(new h(this.session.rememberedSockets))},h=function(){function a(a){this.rememberedSockets=a.map(function(a){return a.clone()})}return a}(),s.prototype.getPreserves=function(a){var b;return a instanceof ga.Document&&(a=this.documentIndex(a)),b=[this.session.cursor],b=b.concat(this.session.rememberedSockets.map(function(a){return a.socket})),b.filter(function(b){return b.document===a}).map(function(a){return a.location})},s.prototype.spliceOut=function(a,b){var c,d,e,f,g,h,i,j,k,l,m,n,o,p,q;if(null==b&&(b=null),a instanceof ga.List||(a=new ga.List(a,a)),k=null,c=a.getDocument(),l=a.parent,null!=c){if(k=a.getDocument().remove(a,this.getPreserves(c)),this.pushUndo({operation:k,document:this.getDocuments().indexOf(c)}),"socket"===(null!=l?l.type:void 0)&&"blockStart"===a.start.type)for(n=this.session.rememberedSockets,d=e=0,h=n.length;e<h;d=++e)if(q=n[d],this.fromCrossDocumentLocation(q.socket)===l){this.session.rememberedSockets.splice(d,0),this.populateSocket(l,q.text);break}if(c.start.next===c.end)for(o=this.session.floatingBlocks,d=f=0,i=o.length;f<i;d=++f)if(m=o[d],m.block===c){for(this.pushUndo(new v(d,m.block,m.position,"delete")),this.session.cursor.document===d+1&&this.setCursor(this.session.tree.start),this.session.cursor.document>d+1&&(this.session.cursor.document-=1),this.session.floatingBlocks.splice(d,1),p=this.session.rememberedSockets,g=0,j=p.length;g<j;g++)q=p[g],q.socket.document>d&&(q.socket.document-=1);break}}else null!=b&&b.remove(a);return this.prepareNode(a,null),this.correctCursor(),k},s.prototype.spliceIn=function(a,b){var c,d,e,f;return c=null!=(f=b.container)?f:b.parent,"block"===c.type?c=c.parent:"socket"===c.type&&c.start.next!==c.end&&(-1!==this.documentIndex(c)&&this.session.rememberedSockets.push(new J(this.toCrossDocumentLocation(c),c.textContent())),this.spliceOut(new ga.List(c.start.next,c.end.prev),c)),d=b.getDocument(),this.prepareNode(a,c),null!=d?(e=d.insert(b,a,this.getPreserves(d)),this.pushUndo({operation:e,
document:this.getDocuments().indexOf(d)}),this.correctCursor(),e):(c.insert(b,a),null)},J=function(){function a(a,b){this.socket=a,this.text=b}return a.prototype.clone=function(){return new a(this.socket.clone(),this.text)},a}(),s.prototype.replace=function(a,b,c){var d,e;return null==c&&(c=[]),d=a.start.getDocument(),null!=d?(e=d.replace(a,b,c.concat(this.getPreserves(d))),this.pushUndo({operation:e,document:this.documentIndex(d)}),this.correctCursor(),e):null},s.prototype.adjustPosToLineStart=function(a){var b;return b=this.aceEditor.session.getLine(a.row),a.row===this.aceEditor.session.getLength()-1?a.column=a.column>=b.length/2?b.length:0:a.column=0,a},s.prototype.correctCursor=function(){var a;if(a=this.fromCrossDocumentLocation(this.session.cursor),!this.validCursorPosition(a)){for(;!(null==a||this.validCursorPosition(a)&&"socketStart"!==a.type);)a=a.next;for(null==a&&(a=this.fromCrossDocumentLocation(this.session.cursor));!(null==a||this.validCursorPosition(a)&&"socketStart"!==a.type);)a=a.prev;return this.session.cursor=this.toCrossDocumentLocation(a)}},s.prototype.prepareNode=function(a,b){var c,d,e,f;if(a instanceof ga.Container)return c=a.getLeadingText(),f=a.start.next===a.end.prev?null:a.getTrailingText(),e=this.session.mode.parens(c,f,a.getReader(),null!=(d=null!=b&&"function"==typeof b.getReader?b.getReader():void 0)?d:null),c=e[0],f=e[1],e[2],a.setLeadingText(c),a.setTrailingText(f)},aa("populate",0,function(){return this.clickedPoint=null,this.clickedBlock=null,this.clickedBlockPaletteEntry=null,this.draggingBlock=null,this.draggingOffset=null,this.lastHighlight=this.lastHighlightPath=null,this.highlightCanvas=this.highlightCtx=document.createElementNS(K,"g"),this.wrapperElement.appendChild(this.dragCanvas),this.mainCanvas.appendChild(this.highlightCanvas)}),s.prototype.clearHighlightCanvas=function(){var a,b,c,d,e;for(d=[this.textCursorPath],e=[],a=0,b=d.length;a<b;a++)c=d[a],e.push(c.deactivate());return e},s.prototype.clearDrag=function(){return this.clearHighlightCanvas()},s.prototype.resizeDragCanvas=function(){return this.dragCanvas.style.width="0px",this.dragCanvas.style.height="0px",this.highlightCanvas.style.width=this.dropletElement.clientWidth-this.gutter.clientWidth+"px",this.highlightCanvas.style.height=this.dropletElement.clientHeight+"px",this.highlightCanvas.style.left=this.mainCanvas.offsetLeft+"px"},s.prototype.getDocuments=function(){var a,b,c,d,e,f;for(a=[this.session.tree],f=this.session.floatingBlocks,c=d=0,e=f.length;d<e;c=++d)b=f[c],a.push(b.block);return a},s.prototype.getDocument=function(a){return 0===a?this.session.tree:this.session.floatingBlocks[a-1].block},s.prototype.documentIndex=function(a){return this.getDocuments().indexOf(a.getDocument())},s.prototype.fromCrossDocumentLocation=function(a){return this.getDocument(a.document).getFromLocation(a.location)},s.prototype.toCrossDocumentLocation=function(a){return new i(this.documentIndex(a),a.getLocation())},aa("mousedown",1,function(a,b,c){var d,e,f,g,h,i,j,k,l,m,n,o,p;if(!c.consumedHitTest&&this.trackerPointIsInMain(a))for(l=this.trackerPointToMain(a),o=this.getDocuments(),g=h=o.length-1;h>=0;g=h+=-1){if(e=o[g],this.handleTextInputClick(l,e))return void(c.consumedHitTest=!0);if(this.session.cursor.document===g&&this.cursorAtSocket()&&this.setCursor(this.session.cursor,function(a){return"socketStart"!==a.type}),f=this.hitTest(l,e),this.debugging&&b.shiftKey){for(k=null,m=this.session.view.getViewNodeFor(f),p=m.bounds,g=i=0,j=p.length;i<j;g=++i)if(d=p[g],d.contains(l)){k=g;break}this.dumpNodeForDebug(f,k)}if(null!=f)return this.clickedBlock=f,this.clickedBlockPaletteEntry=null,this.setCursor(this.clickedBlock.start.next),this.clickedPoint=a,void(c.consumedHitTest=!0);if(g>0&&(n=this.session.floatingBlocks[g-1],null!=n.grayBoxPath&&n.grayBoxPath.contains(this.trackerPointToMain(a))))return this.clickedBlock=new ga.List(n.block.start.next,n.block.end.prev),this.clickedPoint=a,this.session.view.getViewNodeFor(this.clickedBlock).absorbCache(),c.consumedHitTest=!0,void this.redrawMain()}}),aa("mousedown",4,function(a,b,c){var d,e,f,g,h;if(!c.consumedHitTest&&this.trackerPointIsInMain(a)&&(g=this.trackerPointToMain(a),(null==this.lassoSelection||null==this.hitTest(g,this.lassoSelection))&&null!=(e=this.hitTest(g,this.session.tree)))){if(d=this.session.view.getViewNodeFor(e),h=e.stringifyInPlace(),null!=d.addButtonRect&&d.addButtonRect.contains(g))return f=this.session.mode.handleButton(h,"add-button",e.getReader()),(null!=f?f.length:void 0)>=0&&(this.populateBlock(e,f),this.redrawMain()),c.consumedHitTest=!0;if(null!=d.subtractButtonRect&&d.subtractButtonRect.contains(g))return f=this.session.mode.handleButton(h,"subtract-button",e.getReader()),(null!=f?f.length:void 0)>=0&&(this.populateBlock(e,f),this.redrawMain()),c.consumedHitTest=!0}}),aa("mouseup",0,function(a,b,c){if(null!=this.clickedBlock)return this.clickedBlock=null,this.clickedPoint=null}),s.prototype.drawDraggingBlock=function(){var a;return this.session.dragView.clearCache(),a=this.session.dragView.getViewNodeFor(this.draggingBlock),a.layout(1,1),this.dragCanvas.width=Math.min(a.totalBounds.width+10,window.screen.width),this.dragCanvas.height=Math.min(a.totalBounds.height+10,window.screen.height),a.draw(new this.draw.Rectangle(0,0,this.dragCanvas.width,this.dragCanvas.height))},s.prototype.checkForScrollWhileDragging=function(){var a;if(null!=this.draggingBlock&&null!=this.session&&(setTimeout(function(a){return function(){return a.checkForScrollWhileDragging()}}(this),n),this.draggingOffset)){if(a=new this.draw.Point(this.lastDraggingPoint.x+this.draggingOffset.x,this.lastDraggingPoint.y+this.draggingOffset.y),this.trackerPointIsInScrollRegion(a,"down"))this.mainScroller.scrollTop=this.mainScroller.scrollTop+m;else if(this.trackerPointIsInScrollRegion(a,"up"))this.mainScroller.scrollTop=this.mainScroller.scrollTop-m;else if(this.trackerPointIsInScrollRegion(a,"left"))this.sideScroller.scrollLeft=this.sideScroller.scrollLeft-m;else{if(!this.trackerPointIsInScrollRegion(a,"right"))return;this.sideScroller.scrollLeft=this.sideScroller.scrollLeft+m}return this.handleDragContinue(this.lastDraggingPoint,this.lastDraggingEvent)}},s.prototype.wouldDelete=function(a){var b;return b=this.trackerPointToMain(a),this.trackerPointToPalette(a),!this.lastHighlight&&!this.session.viewports.main.contains(b)},aa("mousemove",1,function(a,b,c){var d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y;if(null!=this.session&&(this.lastDraggingPoint=a,this.lastDraggingEvent=b,!c.capturedPickup&&null!=this.clickedBlock&&a.from(this.clickedPoint).magnitude()>C)){if(this.draggingBlock=this.clickedBlock,this.dragReplacing=!1,this.checkForScrollWhileDragging(),this.clickedBlockPaletteEntry)this.draggingOffset=this.session.paletteView.getViewNodeFor(this.draggingBlock).bounds[0].upperLeftCorner().from(this.trackerPointToPalette(this.clickedPoint)),j=this.clickedBlockPaletteEntry.expansion,"function"==typeof j&&(j=j()),j&&(j=ia(this.session.mode,j,this.clickedBlockPaletteEntry.context)),this.draggingBlock=(j||this.draggingBlock).clone(),"function"==typeof this.clickedBlockPaletteEntry.expansion&&(pa.call(this.draggingBlock.classes,"mostly-value")>=0&&this.draggingBlock.classes.push("any-drop"),this.draggingBlock.lastExpansionText=j,this.draggingBlock.expansion=this.clickedBlockPaletteEntry.expansion);else{for(s=this.trackerPointToMain(this.clickedPoint),y=this.session.view.getViewNodeFor(this.draggingBlock),this.draggingBlock instanceof ga.List&&!(this.draggingBlock instanceof ga.Container)&&y.absorbCache(),this.draggingOffset=null,v=y.bounds,r=m=0,p=v.length;m<p;r=++m)if(f=v[r],f.contains(s)){this.draggingOffset=f.upperLeftCorner().from(s),this.draggingOffset.y+=y.bounds[0].y-f.y;break}null==this.draggingOffset&&(this.draggingOffset=y.bounds[0].upperLeftCorner().from(s))}for(this.session.dragView.beginDraw(),g=this.session.dragView.getViewNodeFor(this.draggingBlock),g.layout(1,1),g.root(),g.draw(),this.session.dragView.garbageCollect(),this.dragCanvas.style.width=Math.min(g.totalBounds.width+10,window.screen.width)+"px",this.dragCanvas.style.height=Math.min(g.totalBounds.height+10,window.screen.height)+"px",t=new this.draw.Point(a.x+this.draggingOffset.x,a.y+this.draggingOffset.y),this.dropPointQuadTree=H.init({x:this.session.viewports.main.x,y:this.session.viewports.main.y,w:this.session.viewports.main.width,h:this.session.viewports.main.height}),w=this.getDocuments(),n=0,q=w.length;n<q;n++)for(i=w[n],k=i.start,this.draggingBlock.start.prev===k&&(k=k.next);k!==i.end;){if(k===this.draggingBlock.start&&(k=this.draggingBlock.end),k instanceof ga.StartToken&&(d=this.getAcceptLevel(this.draggingBlock,k.container))!==_.FORBID&&null!=(h=this.session.view.getViewNodeFor(k.container).dropPoint)){for(e=!0,x=this.session.floatingBlocks,l=o=x.length-1;o>=0&&(u=x[l],u.block!==i);l=o+=-1)if(u.grayBoxPath.contains(h)){e=!1;break}e&&this.dropPointQuadTree.insert({x:h.x,y:h.y,w:0,h:0,acceptLevel:d,_droplet_node:k.container})}k=k.next}return this.dragCanvas.style.transform="translate("+(t.x+Z(this.dropletElement))+"px,"+(t.y+$(this.dropletElement))+"px)",this.clickedPoint=this.clickedBlock=null,this.clickedBlockPaletteEntry=null,this.begunTrash=this.wouldDelete(t),this.redrawMain()}}),s.prototype.getClosestDroppableBlock=function(a,b){var c,d;return c=null,d=Infinity,this.dropPointQuadTree?(this.dropPointQuadTree.retrieve({x:a.x-A,y:a.y-A,w:2*A,h:2*A},function(e){return function(f){var g;if((f.acceptLevel!==_.DISCOURAGE||b)&&(g=a.from(f),g.y*=2,(g=g.magnitude())<d&&a.from(f).magnitude()<A&&null!=e.session.view.getViewNodeFor(f._droplet_node).highlightArea))return c=f._droplet_node,d=g}}(this)),c):null},s.prototype.getClosestDroppableBlockFromPosition=function(a,b){var c;return this.session.currentlyUsingBlocks?(c=this.trackerPointToMain(a),this.getClosestDroppableBlock(c,b)):null},s.prototype.getAcceptLevel=function(a,b){var c,d;return"socket"===b.type?"list"===a.type||pa.call(b.classes,"__comment__")>=0?_.FORBID:this.session.mode.drop(a.getReader(),b.getReader(),null,null):"list"===a.type?(c=_.ENCOURAGE,a.traverseOneLevel(function(a){return function(d){if(d instanceof ga.Container)return c=Math.min(c,a.getAcceptLevel(d,b))}}(this)),c):"block"===b.type?"socket"===b.parent.type?_.FORBID:(d=b.nextSibling(),this.session.mode.drop(a.getReader(),b.parent.getReader(),b.getReader(),null!=d&&"function"==typeof d.getReader?d.getReader():void 0)):(d=b.firstChild(),this.session.mode.drop(a.getReader(),b.getReader(),b.getReader(),null!=d&&"function"==typeof d.getReader?d.getReader():void 0))},aa("mousemove",0,function(a,b,c){return this.handleDragContinue(a,b)}),s.prototype.handleDragContinue=function(a,b){var c,d,e,f,g,h,i,j,k,l,m,n;if(this.lastDraggingPoint=a,this.lastDraggingEvent=b,null!=this.draggingBlock){for(i=new this.draw.Point(a.x+this.draggingOffset.x,a.y+this.draggingOffset.y),this.draggingBlock.expansion&&(d=this.draggingBlock.expansion(this.getClosestDroppableBlockFromPosition(i,b.shiftKey)))!==this.draggingBlock.lastExpansionText&&(g=ia(this.session.mode,d),g.lastExpansionText=d,g.expansion=this.draggingBlock.expansion,pa.call(this.draggingBlock.classes,"any-drop")>=0&&g.classes.push("any-drop"),this.draggingBlock=g,this.drawDraggingBlock()),this.session.currentlyUsingBlocks||(this.trackerPointIsInAceScrollRegion(i)?(h=this.aceEditor.renderer.screenToTextCoordinates(i.x,i.y),this.session.dropIntoAceAtLineStart&&(h=this.adjustPosToLineStart(h)),this.aceEditor.focus(),this.aceEditor.session.selection.moveToPosition(h)):this.aceEditor.blur()),j=this.wrapperElement.getBoundingClientRect(),this.dragCanvas.style.transform="translate("+(i.x-j.left)+"px,"+(i.y-j.top)+"px)",f=this.trackerPointToMain(i),e=this.session.tree.start.next;"newline"===(k=e.type)||"cursor"===k||"text"===e.type&&""===e.value;)e=e.next;return e===this.session.tree.end&&0===this.session.floatingBlocks.length&&this.session.viewports.main.right()>(l=f.x)&&l>this.session.viewports.main.x-this.gutter.clientWidth&&this.session.viewports.main.bottom()>(m=f.y)&&m>this.session.viewports.main.y&&this.getAcceptLevel(this.draggingBlock,this.session.tree)===_.ENCOURAGE?(this.session.view.getViewNodeFor(this.session.tree).highlightArea.update(),this.lastHighlight=this.session.tree):(this.hitTest(f,this.draggingBlock)?(this.dragReplacing=!0,c=null):this.trackerPointIsInMainScroller(i)?(this.dragReplacing=!1,c=this.getClosestDroppableBlock(f,b.shiftKey)):(this.dragReplacing=!1,c=null),c!==this.lastHighlight&&(this.redrawHighlights(),null!=(n=this.lastHighlightPath)&&"function"==typeof n.deactivate&&n.deactivate(),null!=c&&(this.lastHighlightPath=this.session.view.getViewNodeFor(c).highlightArea,this.lastHighlightPath.update(),this.qualifiedFocus(c,this.lastHighlightPath)),this.lastHighlight=c)),this.trackerPointToPalette(i),this.wouldDelete(i)?this.begunTrash?this.dragCanvas.style.opacity=.85:this.dragCanvas.style.opacity=.3:(this.dragCanvas.style.opacity=.85,this.begunTrash=!1)}},s.prototype.qualifiedFocus=function(a,b){var c;return c=this.documentIndex(a),c<this.session.floatingBlocks.length?(b.activate(),this.mainCanvas.insertBefore(b.element,this.session.floatingBlocks[c].renderGroup.element)):(b.activate(),this.mainCanvas.appendChild(b.element))},aa("mouseup",1,function(a,b,c){var d,e,f,g,h,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A;if(this.dragReplacing&&this.endDrag(),null!=this.draggingBlock)if(this.session.currentlyUsingBlocks){if(null!=this.lastHighlight){switch(this.undoCapture(),x=this.spliceRememberedSocketOffsets(this.draggingBlock),h="text"===this.draggingBlock.start.next.type,this.spliceOut(this.draggingBlock),this.draggingBlock.expansion=null,this.draggingBlock.lastExpansionText=null,this.clearHighlightCanvas(),this.fireEvent("sound",[this.lastHighlight.type]),this.lastHighlight.type){case"indent":case"socket":this.spliceIn(this.draggingBlock,this.lastHighlight.start);break;case"block":this.spliceIn(this.draggingBlock,this.lastHighlight.end);break;default:"document"===this.lastHighlight.type&&this.spliceIn(this.draggingBlock,this.lastHighlight.start)}for(j="text"===this.draggingBlock.start.next.type,h&&!j?x.forEach(function(a){return a.offset-=1}):j&&!h&&x.forEach(function(a){return a.offset+=1}),g=this.toCrossDocumentLocation(this.draggingBlock.start),"socket"===this.lastHighlight.type&&this.reparse(this.draggingBlock.parent.parent),this.endDrag(),null!=g&&this.setCursor(g),q=g.location.count,r=g.document,k=m=0,o=x.length;m<o;k=++m)d=x[k],this.session.rememberedSockets.push(new J(new i(r,new ga.Location(d.offset+q,"socket")),d.text));return this.fireEvent("block-click")}}else if(u=new this.draw.Point(a.x+this.draggingOffset.x,a.y+this.draggingOffset.y),this.trackerPointIsInAceScrollRegion(u))return n=/^(\s*)/,t=this.aceEditor.renderer.screenToTextCoordinates(u.x,u.y),p=this.aceEditor.session.getLine(t.row),l=n.exec(p)[0],y=!0,v="",z="",this.session.dropIntoAceAtLineStart?(f=/\S/,e=f.exec(p),e&&"}"===e[0]&&(w=this.aceEditor.session.getLine(t.row-1),l=n.exec(w)[0]),t=this.adjustPosToLineStart(t),y=!1,0===t.column?z="\n":v="\n"):l.length===p.length||l.length===t.column?z="\n"+l:t.column===p.length&&(v="\n",y=!1,s=this.aceEditor.session.getLine(t.row+1),l=n.exec(s)[0]),this.prepareNode(this.draggingBlock,null),A=this.draggingBlock.stringify(this.session.mode),A=A.split("\n").map(function(a){return function(a,b){return(0===b&&y?"":l)+a}}()).join("\n"),A=v+A+z,this.aceEditor.onTextInput(A)}),s.prototype.spliceRememberedSocketOffsets=function(a){var b,c,d,e,f,g,h,i;if(null!=a.getDocument()){for(b=a.start.getLocation().count,h=[],g=[],i=this.session.rememberedSockets,d=e=0,f=i.length;e<f;d=++e)c=i[d],a.contains(this.fromCrossDocumentLocation(c.socket))?h.push({offset:c.socket.location.count-b,text:c.text}):g.push(c);return this.session.rememberedSockets=g,h}return[]},u=function(){function a(a,b){this.block=a,this.position=b}return a}(),s.prototype.inTree=function(a){var b;return(null!=(b=a.container)?b:a).getDocument()===this.session.tree},s.prototype.inDisplay=function(a){var b,c;return b=(null!=(c=a.container)?c:a).getDocument(),pa.call(this.getDocuments(),b)>=0},aa("mouseup",0,function(a,b,c){var d,e,f,g,h,j,k,l,m,n,o,p,q,r,s,t;if(null!=this.draggingBlock&&null==this.lastHighlight&&!this.dragReplacing){if(k=this.draggingBlock.parent,t=new this.draw.Point(a.x+this.draggingOffset.x,a.y+this.draggingOffset.y),s=this.trackerPointToMain(t),this.trackerPointToPalette(t),r=!0,d=!0,this.session.viewports.main.right()>(m=s.x)&&m>this.session.viewports.main.x-this.gutter.clientWidth&&this.session.viewports.main.bottom()>(n=s.y)&&n>this.session.viewports.main.y?(s.x-this.session.viewports.main.x<0&&(s.x=this.session.viewports.main.x),this.session.allowFloatingBlocks||(d=!1,r=!1)):(this.draggingBlock===this.lassoSelection&&(this.lassoSelection=null),d=!1),r&&(this.undoCapture(),q=this.spliceRememberedSocketOffsets(this.draggingBlock),this.spliceOut(this.draggingBlock)),!d)return void this.endDrag();for(s.x-this.session.viewports.main.x<0&&(s.x=this.session.viewports.main.x),j=new ga.Document(null!=(o=null!=k?k.parseContext:void 0)?o:this.session.mode.rootContext,{roundedSingletons:!0}),j.insert(j.start,this.draggingBlock),this.pushUndo(new v(this.session.floatingBlocks.length,j,s,"create")),this.session.floatingBlocks.push(l=new u(j,s)),this.initializeFloatingBlock(l,this.session.floatingBlocks.length-1),this.setCursor(this.draggingBlock.start),f=g=0,h=q.length;g<h;f=++g)e=q[f],this.session.rememberedSockets.push(new J(new i(this.session.floatingBlocks.length,new ga.Location(e.offset+1,"socket")),e.text));return this.clearDrag(),this.draggingBlock=null,this.draggingOffset=null,null!=(p=this.lastHighlightPath)&&"function"==typeof p.destroy&&p.destroy(),this.lastHighlight=this.lastHighlightPath=null,this.redrawMain()}}),s.prototype.performFloatingOperation=function(a,b){var c,d,e,f,g,h,i,j;if("create"===a.type==("forward"===b)){for(this.session.cursor.document>a.index&&(this.session.cursor.document+=1),h=this.session.rememberedSockets,c=0,e=h.length;c<e;c++)j=h[c],j.socket.document>a.index&&(j.socket.document+=1);return this.session.floatingBlocks.splice(a.index,0,g=new u(a.block.clone(),a.position)),this.initializeFloatingBlock(g,a.index)}for(this.session.cursor.document===a.index+1&&this.setCursor(this.session.tree.start),i=this.session.rememberedSockets,d=0,f=i.length;d<f;d++)j=i[d],j.socket.document>a.index+1&&(j.socket.document-=1);return this.session.floatingBlocks.splice(a.index,1)},v=function(){function a(a,b,c,d){this.index=a,this.block=b,this.position=c,this.type=d,this.block=this.block.clone()}return a.prototype.toString=function(){return JSON.stringify({index:this.index,block:this.block.stringify(),position:this.position.toString(),type:this.type})},a}(),aa("populate",0,function(){if(this.paletteHeader=document.createElement("div"),this.paletteHeader.className="droplet-palette-header",this.paletteElement.appendChild(this.paletteHeader),null!=this.session)return this.setPalette(this.session.paletteGroups)}),ia=function(a){return function(a,b,c){var d;return null==c&&(c=null),d=a.parse(b,{context:c}).start.next.container,d.start.prev=d.end.next=null,d.setParent(null),d}}(),s.prototype.setPalette=function(a){var b,c,d,e,f,g,h;for(this.paletteHeader.innerHTML="",this.session.paletteGroups=a,this.session.currentPaletteBlocks=[],this.session.currentPaletteMetadata=[],g=null,h=this.session.paletteGroups,b=function(a){return function(b,c){var d,e,f,h,i,j,k,l,m,n;for(c%2==0&&(g=document.createElement("div"),g.className="droplet-palette-header-row",a.paletteHeader.appendChild(g),1!==a.session.paletteGroups.length||b.name||(g.style.height=0)),l=b.header=document.createElement("div"),l.className="droplet-palette-group-header",b.id&&(l.id="droplet-palette-group-header-"+b.id),l.innerText=l.textContent=l.textContent=b.name,b.color&&(l.className+=" "+b.color),g.appendChild(l),k=[],m=b.blocks,h=0,i=m.length;h<i;h++)e=m[h],j=ia(a.session.mode,e.block,e.context),f=e.expansion||null,k.push({block:j,expansion:f,context:e.context,title:e.title,id:e.id});if(b.parsedBlocks=k,n=function(){return a.changePaletteGroup(b)},d=function(){return n()},l.addEventListener("click",d),l.addEventListener("touchstart",d),0===c)return n()}}(this),c=d=0,e=h.length;d<e;c=++d)f=h[c],b(f,c);return this.resizePalette(),this.resizePaletteHighlight()},s.prototype.changePaletteGroup=function(a){var b,c,d,e,f,g,h;for(g=this.session.paletteGroups,c=d=0,e=g.length;d<e;c=++d)if(b=g[c],a===b||a===b.id||a===b.name){f=b;break}if(f)return this.session.currentPaletteGroup=f.name,this.session.currentPaletteBlocks=f.parsedBlocks,this.session.currentPaletteMetadata=f.parsedBlocks,null!=(h=this.session.currentPaletteGroupHeader)&&(h.className=this.session.currentPaletteGroupHeader.className.replace(/\s[-\w]*-selected\b/,"")),this.session.currentPaletteGroupHeader=f.header,this.currentPaletteIndex=c,this.session.currentPaletteGroupHeader.className+=" droplet-palette-group-header-selected",this.rebuildPalette(),this.fireEvent("selectpalette",[f.name])},aa("mousedown",6,function(a,b,c){var d,e,f,g,h;if(!c.consumedHitTest&&this.trackerPointIsInPalette(a)){if(g=this.trackerPointToPalette(a),this.session.viewports.palette.contains(g)){if(this.handleTextInputClickInPalette(g))return void(c.consumedHitTest=!0);for(h=this.session.currentPaletteBlocks,e=0,f=h.length;e<f;e++)if(d=h[e],null!=this.hitTest(g,d.block,this.session.paletteView))return this.clickedBlock=d.block,this.clickedPoint=a,this.clickedBlockPaletteEntry=d,c.consumedHitTest=!0,void this.fireEvent("pickblock",[d.id])}return this.clickedBlockPaletteEntry=null}}),aa("populate",1,function(){return this.paletteHighlightCanvas=this.paletteHighlightCtx=document.createElementNS(K,"svg"),this.paletteHighlightCanvas.setAttribute("class","droplet-palette-highlight-canvas"),this.paletteHighlightPath=null,this.currentHighlightedPaletteBlock=null,this.paletteElement.appendChild(this.paletteHighlightCanvas)}),s.prototype.resizePaletteHighlight=function(){return this.paletteHighlightCanvas.style.top=this.paletteHeader.clientHeight+"px",this.paletteHighlightCanvas.style.width=this.paletteScroller.clientWidth+"px",this.paletteHighlightCanvas.style.height=this.paletteScroller.clientHeight+"px"},aa("redraw_palette",0,function(){if(this.clearPaletteHighlightCanvas(),null!=this.currentHighlightedPaletteBlock)return this.paletteHighlightPath.update()}),aa("populate",1,function(){var a,b,c,d,e;for(this.hiddenInput=document.createElement("textarea"),this.hiddenInput.className="droplet-hidden-input",this.hiddenInput.addEventListener("focus",function(a){return function(){if(a.cursorAtSocket())return a.session.view.getViewNodeFor(a.getCursor()).bounds[0]}}(this)),this.dropletElement.appendChild(this.hiddenInput),this.textInputAnchor=null,this.textInputSelecting=!1,this.oldFocusValue=null,this.hiddenInput.addEventListener("keydown",function(a){return function(b){var c;if(8===b.keyCode&&a.hiddenInput.value.length>1&&a.hiddenInput.value[0]===a.hiddenInput.value[a.hiddenInput.value.length-1]&&("'"===(c=a.hiddenInput.value[0])||'"'===c)&&1===a.hiddenInput.selectionEnd)return b.preventDefault()}}(this)),d=["input","keyup","keydown","select"],e=[],b=0,c=d.length;b<c;b++)a=d[b],e.push(this.hiddenInput.addEventListener(a,function(a){return function(){if(a.highlightFlashShow(),a.cursorAtSocket()&&(a.redrawTextInput(),a.dropdownVisible))return a.formatDropdown()}}(this)));return e}),s.prototype.resizeAceElement=function(){var a,b,c,d,e;return e=this.wrapperElement.clientWidth,a=0,(null!=(b=this.session)?b.showPaletteInTextMode:void 0)&&(null!=(c=this.session)?c.paletteEnabled:void 0)&&(e-=this.paletteWrapper.clientWidth,a=this.paletteWrapper.clientWidth),this.aceElement.style.left=a+"px",this.aceElement.style.right="0px",(null!=(d=this.session)?d.currentlyUsingBlocks:void 0)?this.aceElement.style.bottom="9999px":this.aceElement.style.bottom="0px"},ea=function(a){return a[a.length-1]},s.prototype.redrawTextInput=function(){var a,b,c,d,e,f,g;if(null!=this.session){if(e=this.getCursor().stringify().split("\n").length===this.hiddenInput.value.split("\n").length,a=this.getCursor().getDocument(),this.populateSocket(this.getCursor(),this.hiddenInput.value),this.session.view.getViewNodeFor(this.getCursor()),f=this.getCursor().stringify().slice(0,this.hiddenInput.selectionStart).split("\n").length-1,b=this.getCursor().stringify().slice(0,this.hiddenInput.selectionEnd).split("\n").length-1,e&&f===b){for(d=b,c=this.getCursor().start;c!==a.start;)c=c.prev,"newline"===c.type&&d++;return g=this.session.view.getViewNodeFor(a),_.deepCopy([g.glue[d-1],g.glue[d],g.bounds[d].height]),g.layout(),_.deepCopy([g.glue[d-1],g.glue[d],g.bounds[d].height]),this.redrawMain()}return this.redrawMain()}},s.prototype.redrawTextHighlights=function(a){var b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q;if(null==a&&(a=!1),this.clearHighlightCanvas(),null!=this.session&&this.cursorAtSocket()){if(q=this.session.view.getViewNodeFor(this.getCursor()),p=this.getCursor().stringify().slice(0,this.hiddenInput.selectionStart).split("\n").length-1,d=this.getCursor().stringify().slice(0,this.hiddenInput.selectionEnd).split("\n").length-1,this.getCursor().stringify().split("\n"),o=q.bounds[p].x+this.session.view.opts.textPadding+this.session.fontWidth*ea(this.getCursor().stringify().slice(0,this.hiddenInput.selectionStart).split("\n")).length+(this.getCursor().hasDropdown()?_.DROPDOWN_ARROW_WIDTH:0),c=q.bounds[d].x+this.session.view.opts.textPadding+this.session.fontWidth*ea(this.getCursor().stringify().slice(0,this.hiddenInput.selectionEnd).split("\n")).length+(this.getCursor().hasDropdown()?_.DROPDOWN_ARROW_WIDTH:0),this.hiddenInput.selectionStart===this.hiddenInput.selectionEnd)this.qualifiedFocus(this.getCursor(),this.textCursorPath),j=[new this.session.view.draw.Point(o,q.bounds[p].y+this.session.view.opts.textPadding),new this.session.view.draw.Point(o,q.bounds[p].y+this.session.view.opts.textPadding+this.session.view.opts.textHeight)],this.textCursorPath.setPoints(j),this.textCursorPath.style.strokeColor="#000",this.textCursorPath.update(),this.qualifiedFocus(this.getCursor(),this.textCursorPath),this.textInputHighlighted=!1;else{if(this.textInputHighlighted=!0,k=[],p===d)k.push(new this.session.view.draw.Rectangle(o,q.bounds[p].y+this.session.view.opts.textPadding,c-o,this.session.view.opts.textHeight));else{for(k.push(new this.session.view.draw.Rectangle(o,q.bounds[p].y+this.session.view.opts.textPadding,q.bounds[p].right()-this.session.view.opts.textPadding-o,this.session.view.opts.textHeight)),e=f=l=p+1,m=d;l<=m?f<m:f>m;e=l<=m?++f:--f)k.push(new this.session.view.draw.Rectangle(q.bounds[e].x,q.bounds[e].y+this.session.view.opts.textPadding,q.bounds[e].width,this.session.view.opts.textHeight));k.push(new this.session.view.draw.Rectangle(q.bounds[d].x,q.bounds[d].y+this.session.view.opts.textPadding,c-q.bounds[d].x,this.session.view.opts.textHeight))}for(h=[],n=[],e=g=0,i=k.length;g<i;e=++g)b=k[e],h.push(new this.session.view.draw.Point(b.x,b.y)),h.push(new this.session.view.draw.Point(b.x,b.bottom())),n.push(new this.session.view.draw.Point(b.right(),b.y)),n.push(new this.session.view.draw.Point(b.right(),b.bottom()));this.textCursorPath.setPoints(h.concat(n.reverse())),this.textCursorPath.style.strokeColor="none",this.textCursorPath.update(),this.qualifiedFocus(this.getCursor(),this.textCursorPath)}return a&&c>this.session.viewports.main.x+this.mainCanvas.clientWidth?this.mainScroller.scrollLeft=c-this.mainCanvas.clientWidth+this.session.view.opts.padding:void 0}},aa("mousedown",7,function(){return this.hideDropdown()}),s.prototype.reparse=function(a,b,c,d){var e,f,g,h,i,j,k;if(null==c&&(c=[]),null==d&&(d=a),"socketStart"===a.start.type){if(a.start.next===a.end)return;return g=a.textContent(),h=c.map(function(a){return{count:a.count,type:a.type}}),null!=this.session.mode.stringFixer&&this.populateSocket(a,this.session.mode.stringFixer(a.textContent())),void(this.reparse(a.parent,b,c,d)||(this.populateSocket(a,g),h.forEach(function(a,b){return c[b].count=a.count,c[b].type=a.type}),this.reparse(a.parent,b,c,d)))}i=a.start.parent,e="indent"===(null!=i?i.type:void 0)&&null==(null!=(j=a.start.container)?j.parseContext:void 0)?i.parseContext:(null!=(k=a.start.container)?k:a.start.parent).parseContext;try{f=this.session.mode.parse(a.stringifyInPlace(),{wrapAtRoot:"socket"!==(null!=i?i.type:void 0),context:e})}catch(g){g;try{f=this.session.mode.parse(b(a.stringifyInPlace()),{wrapAtRoot:"socket"!==(null!=i?i.type:void 0),context:e})}catch(a){for(a;null!=i&&"socket"===i.type;)i=i.parent;return null!=i?this.reparse(i,b,c,d):(this.session.view.getViewNodeFor(d).mark({color:"#F00"}),!1)}}if(f.start.next!==f.end)return f=new ga.List(f.start.next,f.end.prev),f.traverseOneLevel(function(a){return function(b){return a.prepareNode(b,i)}}(this)),this.replace(a,f,c),this.redrawMain(),!0},s.prototype.setTextSelectionRange=function(a,b){var c;return null!=a&&null==b&&(b=a),this.cursorAtSocket()&&(this.hiddenInput.focus(),null!=a&&null!=b?this.hiddenInput.setSelectionRange(a,b):this.hiddenInput.value[0]!==this.hiddenInput.value[this.hiddenInput.value.length-1]||"'"!==(c=this.hiddenInput.value[0])&&'"'!==c?this.hiddenInput.setSelectionRange(0,this.hiddenInput.value.length):this.hiddenInput.setSelectionRange(1,this.hiddenInput.value.length-1),this.redrawTextInput()),this.redrawMain(),this.redrawTextInput()},s.prototype.cursorAtSocket=function(){return"socket"===this.getCursor().type},s.prototype.populateSocket=function(a,b){var c,d,e,f,g,h,i;if(a.textContent()!==b){for(i=b.split("\n"),a.start.next!==a.end&&this.spliceOut(new ga.List(a.start.next,a.end.prev)),c=f=new ga.TextToken(i[0]),d=e=0,g=i.length;e<g;d=++e)h=i[d],d>0&&(f=_.connect(f,new ga.NewlineToken),f=_.connect(f,new ga.TextToken(h)));return this.spliceIn(new ga.List(c,f),a.start)}},s.prototype.populateBlock=function(a,b){var c,d,e;if(c=this.session.mode.parse(b,{wrapAtRoot:!1}).start.next.container){for(d=a.start.prev;"newline"===(null!=d?d.type:void 0)&&("indentStart"!==(null!=(e=d.prev)?e.type:void 0)||d.prev.container.end!==a.end.next);)d=d.prev;return this.spliceOut(a),this.spliceIn(c,d),!0}return!1},s.prototype.hitTestTextInput=function(a,b){var c;for(c=b.start;null!=c;){if("socketStart"===c.type&&c.container.isDroppable()&&this.session.view.getViewNodeFor(c.container).path.contains(a))return c.container;c=c.next}return null},s.prototype.getTextPosition=function(a){var b,c,d,e;return e=this.session.view.getViewNodeFor(this.getCursor()),d=Math.floor((a.y-e.bounds[0].y)/(this.session.fontSize+2*this.session.view.opts.padding)),d=Math.max(d,0),d=Math.min(d,e.lineLength-1),b=Math.max(0,Math.round((a.x-e.bounds[d].x-this.session.view.opts.textPadding-(this.getCursor().hasDropdown()?_.DROPDOWN_ARROW_WIDTH:0))/this.session.fontWidth)),c=this.getCursor().stringify().split("\n").slice(0,+d+1||9e9),c[c.length-1]=c[c.length-1].slice(0,b),c.join("\n").length},s.prototype.setTextInputAnchor=function(a){return this.textInputAnchor=this.textInputHead=this.getTextPosition(a),this.hiddenInput.setSelectionRange(this.textInputAnchor,this.textInputHead)},s.prototype.selectDoubleClick=function(a){var b,c,d,e,f,g,h;return d=this.getTextPosition(a),c=null!=(e=null!=(f=this.getCursor().stringify().slice(0,d).match(/\w*$/)[0])?f.length:void 0)?e:0,b=null!=(g=null!=(h=this.getCursor().stringify().slice(d).match(/^\w*/)[0])?h.length:void 0)?g:0,this.textInputAnchor=d-c,this.textInputHead=d+b,this.hiddenInput.setSelectionRange(this.textInputAnchor,this.textInputHead)},s.prototype.setTextInputHead=function(a){return this.textInputHead=this.getTextPosition(a),this.hiddenInput.setSelectionRange(Math.min(this.textInputAnchor,this.textInputHead),Math.max(this.textInputAnchor,this.textInputHead))},s.prototype.handleTextInputClick=function(a,b){var c;return null!=(c=this.hitTestTextInput(a,b))&&(c!==this.getCursor()?(c.editable()&&(this.undoCapture(),this.setCursor(c),this.redrawMain(),
c=this.hitTestTextInput(a,b)),null!=c&&c.hasDropdown()&&(!c.editable()||a.x-this.session.view.getViewNodeFor(c).bounds[0].x<_.DROPDOWN_ARROW_WIDTH)&&this.showDropdown(c),this.textInputSelecting=!1):(this.getCursor().hasDropdown()&&a.x-this.session.view.getViewNodeFor(c).bounds[0].x<_.DROPDOWN_ARROW_WIDTH&&this.showDropdown(),this.setTextInputAnchor(a),this.redrawTextInput(),this.textInputSelecting=!0),this.hiddenInput.focus(),!0)},s.prototype.hitTestTextInputInPalette=function(a,b){var c;for(c=b.start;null!=c;){if("socketStart"===c.type&&c.container.isDroppable()&&this.session.paletteView.getViewNodeFor(c.container).path.contains(a))return c.container;c=c.next}return null},s.prototype.handleTextInputClickInPalette=function(a){var b,c,d,e,f;for(f=this.session.currentPaletteBlocks,d=0,e=f.length;d<e;d++)if(b=f[d],null!=(c=this.hitTestTextInputInPalette(a,b.block))&&c.hasDropdown())return this.showDropdown(c,!0),!0;return!1},aa("populate",0,function(){return this.dropdownElement=document.createElement("div"),this.dropdownElement.className="droplet-dropdown",this.wrapperElement.appendChild(this.dropdownElement),this.dropdownElement.innerHTML="",this.dropdownElement.style.display="inline-block",this.dropdownVisible=!1}),s.prototype.formatDropdown=function(a,b){return null==a&&(a=this.getCursor()),null==b&&(b=this.session.view),this.dropdownElement.style.fontFamily=this.session.fontFamily,this.dropdownElement.style.fontSize=this.session.fontSize,this.dropdownElement.style.minWidth=b.getViewNodeFor(a).bounds[0].width},s.prototype.getDropdownList=function(a){var b,c,d,e;d=a.dropdown,d.generate&&(d=d.generate),d="function"==typeof d?d.apply(a):a.dropdown,d.options&&(d=d.options),c=[];for(b in d)e=d[b],c.push("string"==typeof e?{text:e,display:e}:e);return c},s.prototype.showDropdown=function(a,b){var c,d,e,f,g,h,i;for(null==a&&(a=this.getCursor()),null==b&&(b=!1),this.dropdownVisible=!0,c=[],this.dropdownElement.innerHTML="",this.dropdownElement.style.display="inline-block",this.formatDropdown(a,b?this.session.paletteView:this.session.view),i=this.getDropdownList(a),e=function(d){return function(e){var f,g;return f=document.createElement("div"),f.innerHTML=e.display,f.className="droplet-dropdown-item",c.push(f),f.style.paddingLeft=_.DROPDOWN_ARROW_WIDTH,g=function(c){if(d.undoCapture(),"none"!==d.dropdownElement.style.display){if(b)d.populateSocket(a,c),d.redrawPalette();else if(a.editable()){if(!d.cursorAtSocket())return;d.populateSocket(d.getCursor(),c),d.hiddenInput.value=c,d.redrawMain()}else d.populateSocket(a,c),d.redrawMain();return d.hideDropdown()}},f.addEventListener("mouseup",function(){return e.click?e.click(g):g(e.text)}),d.dropdownElement.appendChild(f)}}(this),f=g=0,h=i.length;g<h;f=++g)d=i[f],e(d);return this.dropdownElement.style.top="-9999px",this.dropdownElement.style.left="-9999px",setTimeout(function(e){return function(){var f,g,h,i;if(e.dropdownElement.clientHeight<e.dropdownElement.scrollHeight)for(g=0,h=c.length;g<h;g++)d=c[g],d.style.paddingRight=p;return b?(i=e.session.paletteView.getViewNodeFor(a).bounds[0],e.dropdownElement.style.left=i.x-e.session.viewports.palette.x+e.paletteCanvas.clientLeft+"px",e.dropdownElement.style.minWidth=i.width+"px",f=i.y+e.session.fontSize-e.session.viewports.palette.y+e.paletteCanvas.clientTop,f+e.dropdownElement.clientHeight>e.paletteElement.clientHeight&&(f-=e.session.fontSize+e.dropdownElement.clientHeight),e.dropdownElement.style.top=f+"px"):(a=e.getCursor(),i=e.session.view.getViewNodeFor(a).bounds[0],e.dropdownElement.style.left=i.x-e.session.viewports.main.x+e.dropletElement.offsetLeft+e.gutter.clientWidth+"px",e.dropdownElement.style.minWidth=i.width+"px",f=i.y+e.session.fontSize-e.session.viewports.main.y,f+e.dropdownElement.clientHeight>e.dropletElement.clientHeight&&(f-=e.session.fontSize+e.dropdownElement.clientHeight),e.dropdownElement.style.top=f+"px")}}(this),0)},s.prototype.hideDropdown=function(){return this.dropdownVisible=!1,this.dropdownElement.style.display="none",this.dropletElement.focus()},aa("dblclick",0,function(a,b,c){var d,e,f,g,h;if(!c.consumedHitTest)for(h=this.getDocuments(),e=0,f=h.length;e<f;e++)if(h[e],g=this.trackerPointToMain(a),d=this.hitTestTextInput(g,this.session.tree),d!==this.getCursor()&&null!=d&&d.editable()&&(this.redrawMain(),d=this.hitTestTextInput(g,this.session.tree)),null!=d&&d.editable())return this.setCursor(d),this.redrawMain(),setTimeout(function(a){return function(){return a.selectDoubleClick(g),a.redrawTextInput(),a.textInputSelecting=!1}}(this),0),void(c.consumedHitTest=!0)}),aa("mousemove",0,function(a,b,c){var d;if(this.textInputSelecting)return this.cursorAtSocket()?(d=this.trackerPointToMain(a),this.setTextInputHead(d),this.redrawTextInput()):void(this.textInputSelecting=!1)}),aa("mouseup",0,function(a,b,c){var d;if(this.textInputSelecting)return d=this.trackerPointToMain(a),this.setTextInputHead(d),this.redrawTextInput(),this.textInputSelecting=!1}),aa("populate",0,function(){return this.lassoSelectRect=document.createElementNS(K,"rect"),this.lassoSelectRect.setAttribute("stroke","#00f"),this.lassoSelectRect.setAttribute("fill","none"),this.lassoSelectAnchor=null,this.lassoSelection=null,this.mainCanvas.appendChild(this.lassoSelectRect)}),s.prototype.clearLassoSelection=function(){return this.lassoSelection=null,this.redrawHighlights()},aa("mousedown",0,function(a,b,c){if(c.clickedLassoSelection||this.clearLassoSelection(),!c.consumedHitTest&&!c.suppressLassoSelect&&this.trackerPointIsInMain(a)&&!this.trackerPointIsInPalette(a))return this.trackerPointToMain(a).from(this.session.viewports.main),this.trackerPointToPalette(a).from(this.session.viewports.palette),this.lassoSelectAnchor=this.trackerPointToMain(a)}),aa("mousemove",0,function(a,b,c){var d,e,f,g,h,i,j,k;if(null!=this.lassoSelectAnchor&&(i=this.trackerPointToMain(a),g=new this.draw.Rectangle(Math.min(this.lassoSelectAnchor.x,i.x),Math.min(this.lassoSelectAnchor.y,i.y),Math.abs(this.lassoSelectAnchor.x-i.x),Math.abs(this.lassoSelectAnchor.y-i.y)),e=function(a){return function(b){var c,d,e;for(c=b.start;!(null==c||"blockStart"===c.type&&a.session.view.getViewNodeFor(c.container).path.intersects(g));)c=c.next;for(d=b.end;!(null==d||"blockEnd"===d.type&&a.session.view.getViewNodeFor(d.container).path.intersects(g));)d=d.prev;return a.clearHighlightCanvas(),a.mainCanvas.appendChild(a.lassoSelectRect),a.lassoSelectRect.style.display="block",a.lassoSelectRect.setAttribute("x",g.x),a.lassoSelectRect.setAttribute("y",g.y),a.lassoSelectRect.setAttribute("width",g.width),a.lassoSelectRect.setAttribute("height",g.height),c&&null!=d?(e=na(b,c,d),c=e[0],d=e[1],a.lassoSelection=new ga.List(c,d),a.redrawLassoHighlight(),!0):(a.lassoSelection=null,a.redrawLassoHighlight(),!1)}}(this),null==this.lassoSelectionDocument||!e(this.lassoSelectionDocument))){for(j=this.getDocuments(),k=[],f=0,h=j.length;f<h;f++){if(d=j[f],e(d)){this.lassoSelectionDocument=d;break}k.push(void 0)}return k}}),s.prototype.redrawLassoHighlight=function(){var a,b,c,d,e,f;if(null!=this.session){for(f=this.getDocuments(),c=0,e=f.length;c<e;c++)a=f[c],b=this.session.view.getViewNodeFor(a),b.draw(this.session.viewports.main,{selected:!1,noText:this.currentlyAnimating});return null!=this.lassoSelection?(d=this.session.view.getViewNodeFor(this.lassoSelection),d.absorbCache(),d.draw(this.session.viewports.main,{selected:!0})):void 0}},na=function(a,b,c){var d,e;for(e=[],d=b;d!==c.next;)(d instanceof ga.StartToken||d instanceof ga.EndToken)&&(e.push(d.container.start),e.push(d.container.end)),d=d.next;for(b=a.start;pa.call(e,b)<0;)b=b.next;for(c=a.end;pa.call(e,c)<0;)c=c.prev;for(;"blockStart"!==b.type;)b=b.prev,"blockEnd"===b.type&&(b=b.container.start.prev);for(;"blockEnd"!==c.type;)c=c.next,"blockStart"===c.type&&(c=c.container.end.next);return[b,c]},aa("mouseup",0,function(a,b,c){return null!=this.lassoSelectAnchor&&(null!=this.lassoSelection&&this.setCursor(this.lassoSelection.end),this.lassoSelectAnchor=null,this.lassoSelectRect.style.display="none",this.redrawHighlights()),this.lassoSelectionDocument=null}),aa("mousedown",3,function(a,b,c){if(!c.consumedHitTest)return null!=this.lassoSelection&&null!=this.hitTest(this.trackerPointToMain(a),this.lassoSelection)?(this.clickedBlock=this.lassoSelection,this.clickedBlockPaletteEntry=null,this.clickedPoint=a,c.consumedHitTest=!0,c.clickedLassoSelection=!0):void 0}),i=function(){function a(a,b){this.document=a,this.location=b}return a.prototype.is=function(a){return this.location.is(a.location)&&this.document===a.document},a.prototype.clone=function(){return new a(this.document,this.location.clone())},a}(),s.prototype.validCursorPosition=function(a){var b,c;return"documentStart"===(b=a.type)||"indentStart"===b||"blockEnd"===a.type&&("document"===(c=a.parent.type)||"indent"===c)||"socketStart"===a.type&&a.container.editable()},s.prototype.setCursor=function(a,b,c){var d,e,f,g,h;if(null==b&&(b=function(){return!0}),null==c&&(c="after"),null!=a&&a instanceof i&&(a=this.fromCrossDocumentLocation(a)),null!=a&&this.inDisplay(a)){for(a instanceof ga.Container&&(a=a.start);!this.validCursorPosition(a)||!b(a);)if(null==(a="after"===c?a.next:a.prev))return;return a=this.toCrossDocumentLocation(a),this.cursorAtSocket()&&!this.session.cursor.is(a)&&(g=this.getCursor(),this.reparse(g,null,a.document===this.session.cursor.document?[a.location]:[]),this.hiddenInput.blur(),this.dropletElement.focus()),this.session.cursor=a,this.correctCursor(),this.redrawMain(),this.highlightFlashShow(),this.cursorAtSocket()?((null!=(e=this.getCursor())?e.id:void 0)in this.session.extraMarks&&delete this.session.extraMarks["undefined"!=typeof focus&&null!==focus?focus.id:void 0],this.undoCapture(),this.hiddenInput.value=this.getCursor().textContent(),this.hiddenInput.focus(),f=this.session.mode.getDefaultSelectionRange(this.hiddenInput.value),h=f.start,d=f.end,this.setTextSelectionRange(h,d)):void 0}},s.prototype.determineCursorPosition=function(){var a,b,c;return this.session.view.getViewNodeFor(this.session.tree).layout(0,this.nubbyHeight),b=this.getCursor(),"documentStart"===b.type?(a=this.session.view.getViewNodeFor(b.container).bounds[0],new this.draw.Point(a.x,a.y)):"indentStart"===b.type?(c="newline"===b.next.type?1:0,a=this.session.view.getViewNodeFor(b.container).bounds[c],new this.draw.Point(a.x,a.y)):(c=this.getCursor().getTextLocation().row-b.parent.getTextLocation().row,a=this.session.view.getViewNodeFor(b.parent).bounds[c],new this.draw.Point(a.x,a.bottom()))},s.prototype.getCursor=function(){var a;return a=this.fromCrossDocumentLocation(this.session.cursor),"socketStart"===a.type?a.container:a},s.prototype.scrollCursorIntoPosition=function(){var a;return a=this.determineCursorPosition().y,a<this.session.viewports.main.y?this.mainScroller.scrollTop=a:a>this.session.viewports.main.bottom()&&(this.mainScroller.scrollTop=a-this.session.viewports.main.height),this.mainScroller.scrollLeft=0},s.prototype.scrollCursorToEndOfDocument=function(){var a;if(this.session.currentlyUsingBlocks){for(a=this.session.tree.end;a&&!this.validCursorPosition(a);)a=a.prev;return this.setCursor(a),this.scrollCursorIntoPosition()}return this.aceEditor.scrollToLine(this.aceEditor.session.getLength())},aa("keydown",0,function(a,b){var c,d,e,f,g,h,i,j,l,m;return a.which===Q?(this.clearLassoSelection(),d=null!=(e=this.getCursor().prev)?e:null!=(f=this.getCursor().start)?f.prev:void 0,this.setCursor(d,function(a){return"socketStart"!==a.type},"before"),this.scrollCursorIntoPosition()):a.which===k?(this.clearLassoSelection(),c=null!=(g=this.getCursor().next)?g:null!=(h=this.getCursor().end)?h.next:void 0,this.setCursor(c,function(a){return"socketStart"!==a.type},"after"),this.scrollCursorIntoPosition()):a.which!==I||this.cursorAtSocket()&&this.hiddenInput.selectionStart!==this.hiddenInput.value.length?a.which!==z||this.cursorAtSocket()&&0!==this.hiddenInput.selectionEnd?void 0:(this.clearLassoSelection(),d=null!=(l=this.getCursor().prev)?l:null!=(m=this.getCursor().start)?m.prev:void 0,this.setCursor(d,null,"before"),this.scrollCursorIntoPosition(),a.preventDefault()):(this.clearLassoSelection(),c=null!=(i=this.getCursor().next)?i:null!=(j=this.getCursor().end)?j.next:void 0,this.setCursor(c,null,"after"),this.scrollCursorIntoPosition(),a.preventDefault())}),aa("keydown",0,function(a,b){var c,d,e,f,g,h;if(a.which===M)return a.shiftKey?(d=null!=(e=this.getCursor().prev)?e:null!=(f=this.getCursor().start)?f.prev:void 0,this.setCursor(d,function(a){return"socketStart"===a.type},"before")):(c=null!=(g=this.getCursor().next)?g:null!=(h=this.getCursor().end)?h.next:void 0,this.setCursor(c,function(a){return"socketStart"===a.type},"after")),a.preventDefault()}),s.prototype.deleteAtCursor=function(){var a;if("blockEnd"===this.getCursor().type)a=this.getCursor().container;else{if("indentStart"!==this.getCursor().type)return;a=this.getCursor().parent}return this.setCursor(a.start,null,"before"),this.undoCapture(),this.spliceOut(a),this.redrawMain()},aa("keydown",0,function(a,b){if(null!=this.session&&!this.session.readOnly&&a.which===d&&!b.capturedBackspace)return null!=this.lassoSelection?(this.deleteLassoSelection(),a.preventDefault(),!1):!(!this.cursorAtSocket()||0===this.hiddenInput.value.length&&this.getCursor().handwritten)||(this.deleteAtCursor(),b.capturedBackspace=!0,a.preventDefault(),!1)}),s.prototype.deleteLassoSelection=function(){var a;if(null==this.lassoSelection){if(j)throw new Error("Cannot delete nonexistent lasso segment");return null}return a=this.lassoSelection.start.prev,this.spliceOut(this.lassoSelection),this.lassoSelection=null,this.setCursor(a),this.redrawMain()},aa("keydown",0,function(a,b){var c,d,e,f,g;if(null!=this.session&&!this.session.readOnly&&a.which===r){if(!(this.cursorAtSocket()||a.shiftKey||a.ctrlKey||a.metaKey)){for(d=new ga.Block,e=new ga.Socket("",Infinity,!0),e.setParent(d),_.connect(d.start,e.start),_.connect(e.end,d.end),c=this.getCursor();"newline"===c.type;)c=c.prev;return e.parseContext=c.parent.parseContext,this.spliceIn(d,c),this.redrawMain(),this.newHandwrittenSocket=e}if(this.cursorAtSocket()&&!a.shiftKey&&(g=this.getCursor(),this.hiddenInput.blur(),this.dropletElement.focus(),this.setCursor(this.session.cursor,function(a){return"socketStart"!==a.type}),this.redrawMain(),pa.call(g.classes,"__comment__")>=0&&this.session.mode.startSingleLineComment)){for(d=new ga.Block(0,"blank",_.ANY_DROP),d.classes=["__comment__","block-only"],d.socketLevel=_.BLOCK_ONLY,f=new ga.TextToken(this.session.mode.startSingleLineComment),f.setParent(d),e=new ga.Socket("",0,!0),e.classes=["__comment__"],e.setParent(d),_.connect(d.start,f),_.connect(f,e.start),_.connect(e.end,d.end),c=this.getCursor();"newline"===c.type;)c=c.prev;return this.spliceIn(d,c),this.redrawMain(),this.newHandwrittenSocket=e}}}),aa("keyup",0,function(a,b){if(null!=this.session&&!this.session.readOnly)return a.which===r&&null!=this.newHandwrittenSocket?(this.setCursor(this.newHandwrittenSocket),this.newHandwrittenSocket=null):void 0}),s.prototype.copyAceEditor=function(){return this.gutter.style.width=this.aceEditor.renderer.$gutterLayer.gutterWidth+"px",this.resizeBlockMode(),this.setValue_raw(this.getAceValue())},$=function(a){var b;for(b=a.offsetTop;null!=(a=a.offsetParent);)b+=a.offsetTop;return b},Z=function(a){var b;for(b=a.offsetLeft;null!=(a=a.offsetParent);)b+=a.offsetLeft;return b},s.prototype.computePlaintextTranslationVectors=function(){var a,b,c,d,e,f,g,h,i;for(g=[],h=[],d=this.session.tree.start,a=this.aceEditor.session,f={x:this.aceEditor.container.getBoundingClientRect().left-this.aceElement.getBoundingClientRect().left+this.aceEditor.renderer.$gutterLayer.gutterWidth-this.gutter.clientWidth+5,y:this.aceEditor.container.getBoundingClientRect().top-this.aceElement.getBoundingClientRect().top-a.getScrollTop(),indent:0,lineHeight:this.aceEditor.renderer.layerConfig.lineHeight,leftEdge:this.aceEditor.container.getBoundingClientRect().left-Z(this.aceElement)+this.aceEditor.renderer.$gutterLayer.gutterWidth-this.gutter.clientWidth+5},this.measureCtx.font=this.aceFontSize()+" "+this.session.fontFamily,c=this.measureCtx.measureText(" ").width,e=0;d!==this.session.tree.end;){switch(d.type){case"text":b=this.session.view.getViewNodeFor(d).bounds[0].upperLeftCorner(),b.x-=this.session.viewports.main.x,b.y-=this.session.viewports.main.y,h.push(new this.draw.Point(f.x,f.y).from(b)),g.push(this.session.view.getViewNodeFor(d)),f.x+=c*d.value.length;break;case"socketStart":(d.next===d.container.end||"text"===d.next.type&&""===d.next.value)&&(f.x+=c*d.container.emptyString.length);break;case"newline":i=Math.max(1,a.documentToScreenRow(e+1,0)-a.documentToScreenRow(e,0)),e+=1,f.y+=f.lineHeight*i,null!=d.specialIndent?f.x=f.leftEdge+c*d.specialIndent.length:f.x=f.leftEdge+f.indent*c;break;case"indentStart":f.indent+=d.container.depth;break;case"indentEnd":f.indent-=d.container.depth}d=d.next}return{textElements:g,translationVectors:h}},s.prototype.checkAndHighlightEmptySockets=function(){var a,b;for(a=this.session.tree.start,b=!0;a!==this.session.tree.end;)("socketStart"===a.type&&a.next===a.container.end||"socketStart"===a.type&&"text"===a.next.type&&""===a.next.value)&&""!==a.container.emptyString&&(this.markBlock(a.container,{color:"#F00"}),b=!1),a=a.next;return b},s.prototype.performMeltAnimation=function(a,b,c){var d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x;if(null==a&&(a=500),null==b&&(b=1e3),null==c&&(c=function(){}),this.session.currentlyUsingBlocks&&!this.currentlyAnimating){if(!this.session.options.preserveEmpty&&!this.checkAndHighlightEmptySockets())return void this.redrawMain();for(this.hideDropdown(),this.fireEvent("statechange",[!1]),this.setAceValue(this.getValue()),u=this.findLineNumberAtCoordinate(this.session.viewports.main.y),this.aceEditor.scrollToLine(u),this.aceEditor.resize(!0),this.redrawMain({noText:!0}),this.sideScroller.scrollWidth>this.sideScroller.clientWidth?this.sideScroller.style.overflowX="scroll":this.sideScroller.style.overflowX="hidden",this.mainScroller.style.overflowY="hidden",this.dropletElement.style.right="0px",this.session.currentlyUsingBlocks=!1,this.currentlyAnimating=this.currentlyAnimating_suppressRedraw=!0,p=this.computePlaintextTranslationVectors(),t=p.textElements,w=p.translationVectors,v=[],g=function(b){return function(c,d,e,f){return setTimeout(function(){return c.style.left=d.bounds[0].x-b.session.viewports.main.x+e[f].x+"px",c.style.top=d.bounds[0].y-b.session.viewports.main.y+e[f].y+"px",c.style.fontSize=b.aceFontSize()},a)}}(this),i=j=0,l=t.length;j<l;i=++j)s=t[i],0<s.bounds[0].bottom()-this.session.viewports.main.y+w[i].y&&s.bounds[0].y-this.session.viewports.main.y+w[i].y<this.session.viewports.main.height&&(f=document.createElement("div"),f.style.whiteSpace="pre",f.innerText=f.textContent=s.model.value,f.style.font=this.session.fontSize+"px "+this.session.fontFamily,f.style.left=s.bounds[0].x-this.session.viewports.main.x+"px",f.style.top=s.bounds[0].y-this.session.viewports.main.y-this.session.fontAscent+"px",f.className="droplet-transitioning-element",f.style.transition="left "+b+"ms, top "+b+"ms, font-size "+b+"ms",v.push(f),this.transitionContainer.appendChild(f),g(f,s,w,i));for(u=Math.max(this.aceEditor.getFirstVisibleRow(),0),e=Math.min(this.aceEditor.getLastVisibleRow(),this.session.view.getViewNodeFor(this.session.tree).lineLength-1),d=this.aceEditor.session.getScrollTop(),x=this.session.view.getViewNodeFor(this.session.tree),n=this.aceEditor.renderer.layerConfig.lineHeight,h=function(b){return function(c,e){return setTimeout(function(){return c.style.left="0px",c.style.top=b.aceEditor.session.documentToScreenRow(e,0)*n-d+"px",c.style.fontSize=b.aceFontSize()},a)}}(this),m=k=q=u,r=e;q<=r?k<=r:k>=r;m=q<=r?++k:--k)f=document.createElement("div"),f.style.whiteSpace="pre",f.innerText=f.textContent=m+1,f.style.left=0,f.style.top=x.bounds[m].y+x.distanceToBase[m].above-this.session.view.opts.textHeight-this.session.fontAscent-this.session.viewports.main.y+"px",f.style.font=this.session.fontSize+"px "+this.session.fontFamily,f.style.width=this.gutter.clientWidth+"px",v.push(f),f.className="droplet-transitioning-element droplet-transitioning-gutter droplet-gutter-line",null!=this.annotations[m]&&(f.className+=" droplet_"+Y(this.annotations[m])),f.style.transition="left "+b+"ms, top "+b+"ms, font-size "+b+"ms",this.dropletElement.appendChild(f),h(f,m);return this.lineNumberWrapper.style.display="none",this.mainCanvas.style.transition=this.highlightCanvas.style.transition="opacity "+a+"ms linear",this.mainCanvas.style.opacity=0,o=this.session.paletteEnabled&&!this.session.showPaletteInTextMode,o&&(this.paletteHeader.style.zIndex=0,setTimeout(function(a){return function(){return a.dropletElement.style.transition="left "+b+"ms",a.dropletElement.style.left="0px"}}(this),a)),setTimeout(function(a){return function(){var b,d;for(a.dropletElement.style.transition="",a.aceElement.style.top=a.aceElement.style.right=a.aceElement.style.bottom="0px",a.session.showPaletteInTextMode&&a.session.paletteEnabled?a.aceElement.style.left=a.paletteWrapper.clientWidth+"px":a.aceElement.style.left="0px",a.dropletElement.style.top=a.dropletElement.style.left="-9999px",a.dropletElement.style.bottom=a.dropletElement.style.right="9999px",a.currentlyAnimating=!1,a.showScrollbars(),b=0,d=v.length;b<d;b++)f=v[b],f.parentNode.removeChild(f);if(a.fireEvent("toggledone",[a.session.currentlyUsingBlocks]),null!=c)return c()}}(this),a+b),{success:!0}}},s.prototype.aceFontSize=function(){return parseFloat(this.aceEditor.getFontSize())+"px"},s.prototype.showScrollbars=function(a){return null==a&&(a=!0),this.mainScroller.style.overflowY=a?"auto":"hidden",this.sideScroller.style.overflowX=a?"auto":"hidden"},s.prototype.performFreezeAnimation=function(a,b,c){var d;if(null==a&&(a=500),null==b&&(b=500),null==c&&(c=function(){}),null!=this.session)return this.session.currentlyUsingBlocks||this.currentlyAnimating?void 0:(+new Date,d=this.copyAceEditor(),+new Date,d.success?(0===this.aceEditor.getFirstVisibleRow()?this.mainScroller.scrollTop=0:this.mainScroller.scrollTop=this.session.view.getViewNodeFor(this.session.tree).bounds[this.aceEditor.getFirstVisibleRow()].y,this.session.currentlyUsingBlocks=!0,this.currentlyAnimating=!0,this.fireEvent("statechange",[!0]),setTimeout(function(d){return function(){var e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y;for(d.showScrollbars(!1),d.dropletElement.style.right="0px",d.redrawMain({noText:!0}),d.currentlyAnimating_suppressRedraw=!0,d.aceElement.style.top=d.aceElement.style.left="-9999px",d.aceElement.style.bottom=d.aceElement.style.right="9999px",p=d.session.paletteEnabled&&!d.session.showPaletteInTextMode,p&&(d.paletteWrapper.style.top="0px",d.paletteHeader.style.zIndex=0),d.dropletElement.style.top=d.dropletElement.style.right=d.dropletElement.style.bottom="0px",d.session.paletteEnabled&&!p?d.dropletElement.style.left=d.paletteWrapper.clientWidth+"px":d.dropletElement.style.left="0px",q=d.computePlaintextTranslationVectors(),u=q.textElements,x=q.translationVectors,w=[],h=function(a,b){return setTimeout(function(){return a.style.left=b.bounds[0].x-d.session.viewports.main.x+"px",a.style.top=b.bounds[0].y-d.session.viewports.main.y-d.session.fontAscent+"px",a.style.fontSize=d.session.fontSize+"px"},0)},j=k=0,m=u.length;k<m;j=++k)t=u[j],0<t.bounds[0].bottom()-d.session.viewports.main.y+x[j].y&&t.bounds[0].y-d.session.viewports.main.y+x[j].y<d.session.viewports.main.height&&(g=document.createElement("div"),g.style.whiteSpace="pre",g.innerText=g.textContent=t.model.value,g.style.font=d.aceFontSize()+" "+d.session.fontFamily,g.style.position="absolute",g.style.left=t.bounds[0].x-d.session.viewports.main.x+x[j].x+"px",g.style.top=t.bounds[0].y-d.session.viewports.main.y+x[j].y+"px",g.className="droplet-transitioning-element",g.style.transition="left "+b+"ms, top "+b+"ms, font-size "+b+"ms",w.push(g),d.transitionContainer.appendChild(g),h(g,t));for(v=Math.max(d.aceEditor.getFirstVisibleRow(),0),f=Math.min(d.aceEditor.getLastVisibleRow(),d.session.view.getViewNodeFor(d.session.tree).lineLength-1),y=d.session.view.getViewNodeFor(d.session.tree),o=d.aceEditor.renderer.layerConfig.lineHeight,e=d.aceEditor.session.getScrollTop(),i=function(a,b){return setTimeout(function(){return a.style.left=0,a.style.top=y.bounds[b].y+y.distanceToBase[b].above-d.session.view.opts.textHeight-d.session.fontAscent-d.session.viewports.main.y+"px",a.style.fontSize=d.session.fontSize+"px"},0)},n=l=r=v,s=f;r<=s?l<=s:l>=s;n=r<=s?++l:--l)g=document.createElement("div"),g.style.whiteSpace="pre",g.innerText=g.textContent=n+1,g.style.font=d.aceFontSize()+" "+d.session.fontFamily,g.style.width=d.aceEditor.renderer.$gutter.clientWidth+"px",g.style.left=0,g.style.top=d.aceEditor.session.documentToScreenRow(n,0)*o-e+"px",g.className="droplet-transitioning-element droplet-transitioning-gutter droplet-gutter-line",null!=d.annotations[n]&&(g.className+=" droplet_"+Y(d.annotations[n])),g.style.transition="left "+b+"ms, top "+b+"ms, font-size "+b+"ms",w.push(g),d.dropletElement.appendChild(g),i(g,n);return d.mainCanvas.style.opacity=0,setTimeout(function(){return d.mainCanvas.style.transition="opacity "+a+"ms linear",d.mainCanvas.style.opacity=1},b),d.dropletElement.style.transition="left "+a+"ms",p&&(d.dropletElement.style.left=d.paletteWrapper.clientWidth+"px",d.paletteWrapper.style.left="0px"),setTimeout(function(){var a,b;for(d.dropletElement.style.transition="",d.showScrollbars(),d.currentlyAnimating=!1,d.lineNumberWrapper.style.display="block",d.redrawMain(),d.paletteHeader.style.zIndex=257,a=0,b=w.length;a<b;a++)g=w[a],g.parentNode.removeChild(g);if(d.resizeBlockMode(),d.fireEvent("toggledone",[d.session.currentlyUsingBlocks]),null!=c)return c()},b+a)}}(this),0),{success:!0}):(d.error&&this.fireEvent("parseerror",[d.error]),d))},s.prototype.enablePalette=function(a){var b;if(!this.currentlyAnimating&&this.session.paletteEnabled!==a)return this.session.paletteEnabled=a,this.currentlyAnimating=!0,b=this.session.currentlyUsingBlocks?this.dropletElement:this.aceElement,this.session.paletteEnabled?(this.paletteWrapper.style.top="0px",this.paletteHeader.style.zIndex=257,setTimeout(function(a){return function(){return b.style.transition="left 500ms",b.style.left=a.paletteWrapper.clientWidth+"px",a.paletteWrapper.style.left="0px",setTimeout(function(){return b.style.transition="",a.resize(),a.currentlyAnimating=!1,a.resizeNubby(),a.fireEvent("palettetoggledone",[a.session.paletteEnabled])},500)}}(this),0)):(b.style.transition="left 500ms",b.style.left="0px",this.paletteHeader.style.zIndex=0,this.resize(),this.resizeNubby(this.paletteWrapper.clientWidth),setTimeout(function(a){return function(){return b.style.transition="",a.currentlyAnimating=!1,a.resize(),a.resizeNubby(),a.fireEvent("palettetoggledone",[a.session.paletteEnabled])}}(this),500))};s.prototype.toggleBlocks=function(a){return this.session.currentlyUsingBlocks?this.performMeltAnimation(500,1e3,a):this.performFreezeAnimation(500,500,a)},aa("populate",2,function(){return this.mainScroller=document.createElement("div"),this.mainScroller.className="droplet-main-scroller",this.mainScroller.style.overflowX="hidden",this.mainScrollerIntermediary=document.createElement("div"),this.mainScrollerIntermediary.className="droplet-main-scroller-intermediary",this.mainScrollerStuffing=document.createElement("div"),this.mainScrollerStuffing.className="droplet-main-scroller-stuffing",this.mainScroller.appendChild(this.sideScroller),this.sideScroller.appendChild(this.mainCanvas),this.dropletElement.appendChild(this.mainScroller),this.wrapperElement.addEventListener("scroll",function(a){return function(){return a.wrapperElement.scrollTop=a.wrapperElement.scrollLeft=0}}(this)),this.mainScroller.addEventListener("scroll",function(a){return function(){return a.session.viewports.main.y=a.mainScroller.scrollTop,a.redrawMain()}}(this)),this.sideScroller.addEventListener("scroll",function(a){return function(){return a.session.viewports.main.x=a.sideScroller.scrollLeft,a.resizeNubby()}}(this)),this.paletteScroller=document.createElement("div"),this.paletteScroller.className="droplet-palette-scroller",this.paletteScroller.appendChild(this.paletteCanvas),this.paletteScrollerStuffing=document.createElement("div"),this.paletteScrollerStuffing.className="droplet-palette-scroller-stuffing",this.paletteScroller.appendChild(this.paletteScrollerStuffing),this.paletteElement.appendChild(this.paletteScroller),this.paletteScroller.addEventListener("scroll",function(a){return function(){return a.session.viewports.palette.y=a.paletteScroller.scrollTop,a.session.viewports.palette.x=a.paletteScroller.scrollLeft}}(this))}),s.prototype.resizeMainScroller=function(){return this.mainScroller.style.right="0px",this.sideScroller.style.right="0px"},aa("resize_palette",0,function(){return this.paletteScroller.style.top=this.paletteHeader.clientHeight+D+"px",this.session.viewports.palette.height=this.paletteScroller.clientHeight,this.session.viewports.palette.width=this.paletteScroller.clientWidth}),s.prototype.computeMainCanvasHeight=function(){var a,b;return a=this.session.view.getViewNodeFor(this.session.tree).getBounds(),Math.max(a.bottom()+(null!=(b=this.options.extraBottomHeight)?b:this.session.fontSize),this.dropletElement.clientHeight)},aa("redraw_main",1,function(){var a,b,c,d,e,f;for(a=this.session.view.getViewNodeFor(this.session.tree).getBounds(),f=this.session.floatingBlocks,c=0,d=f.length;c<d;c++)e=f[c],a.unite(this.session.view.getViewNodeFor(e.block).getBounds());if((b=this.computeMainCanvasHeight())!==this.lastHeight)return this.lastHeight=b,this.mainCanvas.setAttribute("height",b),this.mainCanvas.style.height=b+"px",this.sideScroller.style.height=b+"px"}),aa("redraw_palette",0,function(){var a,b,c,d,e;for(a=new this.draw.NoRectangle,e=this.session.currentPaletteBlocks,c=0,d=e.length;c<d;c++)b=e[c],a.unite(this.session.paletteView.getViewNodeFor(b.block).getBounds());return this.paletteScrollerStuffing.style.height=a.bottom()+"px"}),aa("populate",0,function(){var a;return this.session.fontSize=15,this.session.fontFamily="Courier New",this.measureCtx.font="15px Courier New",this.session.fontWidth=this.measureCtx.measureText(" ").width,a=_.fontMetrics(this.session.fontFamily,this.session.fontSize),this.session.fontAscent=a.prettytop,this.session.fontDescent=a.descent}),s.prototype.setFontSize_raw=function(a){var b;if(this.session.fontSize!==a)return this.measureCtx.font=a+" px "+this.session.fontFamily,this.session.fontWidth=this.measureCtx.measureText(" ").width,this.session.fontSize=a,this.paletteHeader.style.fontSize=a+"px",this.gutter.style.fontSize=a+"px",this.tooltipElement.style.fontSize=a+"px",this.session.view.opts.textHeight=this.session.paletteView.opts.textHeight=this.session.dragView.opts.textHeight=_.getFontHeight(this.session.fontFamily,this.session.fontSize),b=_.fontMetrics(this.session.fontFamily,this.session.fontSize),this.session.fontAscent=b.prettytop,this.session.fontDescent=b.descent,this.session.view.clearCache(),this.session.paletteView.clearCache(),this.session.dragView.clearCache(),this.session.view.draw.setGlobalFontSize(this.session.fontSize),this.session.paletteView.draw.setGlobalFontSize(this.session.fontSize),this.session.dragView.draw.setGlobalFontSize(this.session.fontSize),this.gutter.style.width=this.aceEditor.renderer.$gutterLayer.gutterWidth+"px",this.redrawMain(),this.rebuildPalette()},s.prototype.setFontFamily=function(a){return this.measureCtx.font=this.session.fontSize+"px "+a,this.draw.setGlobalFontFamily(a),this.session.fontFamily=a,this.session.view.opts.textHeight=_.getFontHeight(this.session.fontFamily,this.session.fontSize),this.session.fontAscent=_.fontMetrics(this.session.fontFamily,this.session.fontSize).prettytop,this.session.view.clearCache(),this.session.dragView.clearCache(),this.gutter.style.fontFamily=a,this.tooltipElement.style.fontFamily=a,this.redrawMain(),this.rebuildPalette()},
s.prototype.setFontSize=function(a){return this.setFontSize_raw(a),this.resizeBlockMode()},s.prototype.getHighlightPath=function(a,b,c){var d;return null==c&&(c=this.session.view),d=c.getViewNodeFor(a).path.clone(),d.style.fillColor=null,d.style.strokeColor=b.color,d.style.lineWidth=3,d.noclip=!0,d.bevel=!1,d},s.prototype.markLine=function(a,b){var c;if(null!=this.session)return c=this.session.tree.getBlockOnLine(a),this.session.view.getViewNodeFor(c).mark(b)},s.prototype.markBlock=function(a,b){if(null!=this.session)return this.session.view.getViewNodeFor(a).mark(b)},s.prototype.mark=function(a,b){var c,d;if(null!=this.session)return c=this.session.tree.getFromTextLocation(a),c=null!=(d=c.container)?d:c,this.session.view.getViewNodeFor(c).mark(b),this.redrawHighlights()},s.prototype.clearLineMarks=function(){return this.session.view.clearMarks(),this.redrawHighlights()},aa("populate",0,function(){return this.lastHoveredLine=null}),aa("mousemove",0,function(a,b,c){var d,e,f;if(null==this.draggingBlock&&null==this.clickedBlock&&this.hasEvent("linehover")){if(!this.trackerPointIsInMainScroller(a))return;if(e=this.trackerPointToMain(a),f=this.session.view.getViewNodeFor(this.session.tree),null!=this.lastHoveredLine&&null!=f.bounds[this.lastHoveredLine]&&f.bounds[this.lastHoveredLine].contains(e))return;if(d=this.findLineNumberAtCoordinate(e.y),f.bounds[d].contains(e)||(d=null),d!==this.lastHoveredLine)return this.fireEvent("linehover",[{line:this.lastHoveredLine=d}])}}),aa("populate",0,function(){return this.trimWhitespace=!1}),s.prototype.setTrimWhitespace=function(a){return this.trimWhitespace=a},s.prototype.setValue_raw=function(a){var b,c,d;try{return this.trimWhitespace&&(a=a.trim()),c=this.session.mode.parse(a,{wrapAtRoot:!0,preserveEmpty:this.session.options.preserveEmpty}),this.session.tree.start.next!==this.session.tree.end&&(d=new ga.List(this.session.tree.start.next,this.session.tree.end.prev),this.spliceOut(d)),c.start.next!==c.end&&this.spliceIn(new ga.List(c.start.next,c.end.prev),this.session.tree.start),this.removeBlankLines(),this.redrawMain(),{success:!0}}catch(a){return b=a,{success:!1,error:b}}},s.prototype.setValue=function(a){var b,c;return null==this.session?this.aceEditor.setValue(a):(b=this.aceEditor.session.getScrollTop(),this.setAceValue(a),this.resizeTextMode(),this.aceEditor.session.setScrollTop(b),this.session.currentlyUsingBlocks&&(c=this.setValue_raw(a),!1===c.success&&(this.setEditorState(!1),this.aceEditor.setValue(a),c.error))?this.fireEvent("parseerror",[c.error]):void 0)},s.prototype.addEmptyLine=function(a){return 0===a.length||"\n"===a[a.length-1]?a:a+"\n"},s.prototype.getValue=function(){var a;return(null!=(a=this.session)?a.currentlyUsingBlocks:void 0)?this.addEmptyLine(this.session.tree.stringify({preserveEmpty:this.session.options.preserveEmpty})):this.getAceValue()},s.prototype.getAceValue=function(){var a;return a=this.aceEditor.getValue(),this.lastAceSeenValue=a},s.prototype.setAceValue=function(a){if(a!==this.lastAceSeenValue)return this.aceEditor.setValue(a,1),this.lastAceSeenValue=a},s.prototype.on=function(a,b){return this.bindings[a]=b},s.prototype.once=function(a,b){return this.bindings[a]=function(){return b.apply(this,arguments),this.bindings[a]=null}},s.prototype.fireEvent=function(a,b){if(a in this.bindings)return this.bindings[a].apply(this,b)},s.prototype.hasEvent=function(a){return a in this.bindings&&null!=this.bindings[a]},s.prototype.setEditorState=function(a){var b,c,d,e,f;if(this.mainCanvas.style.transition=this.highlightCanvas.style.transition="",a){if(null==this.session)throw new ArgumentError("cannot switch to blocks if a session has not been set up.");return this.session.currentlyUsingBlocks||this.setValue_raw(this.getAceValue()),this.dropletElement.style.top=this.dropletElement.style.right=this.dropletElement.style.bottom="0px",this.session.paletteEnabled?(this.paletteWrapper.style.top=this.paletteWrapper.style.left="0px",this.dropletElement.style.left=this.paletteWrapper.clientWidth+"px"):(this.paletteWrapper.style.top="0px",this.dropletElement.style.left="0px"),this.aceElement.style.top=this.aceElement.style.left="-9999px",this.aceElement.style.bottom=this.aceElement.style.right="9999px",this.session.currentlyUsingBlocks=!0,this.lineNumberWrapper.style.display="block",this.mainCanvas.style.opacity=this.highlightCanvas.style.opacity=1,this.resizeBlockMode(),this.redrawMain()}return null==this.session||this.session.options.preserveEmpty||this.checkAndHighlightEmptySockets()?(this.hideDropdown(),c=(null!=(d=this.session)?d.paletteEnabled:void 0)&&this.session.showPaletteInTextMode,b=this.aceEditor.session.getScrollTop(),(null!=(e=this.session)?e.currentlyUsingBlocks:void 0)&&this.setAceValue(this.getValue()),this.aceEditor.resize(!0),this.aceEditor.session.setScrollTop(b),this.dropletElement.style.top=this.dropletElement.style.left="-9999px",this.dropletElement.style.bottom=this.dropletElement.style.right="9999px",this.paletteWrapper.style.top=this.paletteWrapper.style.left="0px",this.aceElement.style.top=this.aceElement.style.right=this.aceElement.style.bottom="0px",this.aceElement.style.left=c?this.paletteWrapper.clientWidth+"px":"0px",null!=(f=this.session)&&(f.currentlyUsingBlocks=!1),this.lineNumberWrapper.style.display="none",this.mainCanvas.style.opacity=this.highlightCanvas.style.opacity=0,this.resizeBlockMode()):void this.redrawMain()},aa("populate",0,function(){return this.dragCover=document.createElement("div"),this.dragCover.className="droplet-drag-cover",this.dragCover.style.display="none",document.body.appendChild(this.dragCover)}),aa("mousedown",-1,function(){if(null!=this.clickedBlock)return this.dragCover.style.display="block"}),aa("mouseup",0,function(){return this.dragCanvas.style.transform="translate(-9999px, -9999px)",this.dragCover.style.display="none"}),aa("mousedown",10,function(){if(null!=this.draggingBlock)return this.endDrag()}),s.prototype.endDrag=function(){var a;this.cursorAtSocket()&&this.setCursor(this.session.cursor,function(a){return"socketStart"!==a.type}),this.clearDrag(),this.draggingBlock=null,this.draggingOffset=null,null!=(a=this.lastHighlightPath)&&"function"==typeof a.deactivate&&a.deactivate(),this.lastHighlight=this.lastHighlightPath=null,this.redrawMain()},aa("rebuild_palette",0,function(){return this.fireEvent("changepalette",[])}),N=1e3,s.prototype.touchEventToPoint=function(a,b){return new this.draw.Point(a.changedTouches[b].clientX,a.changedTouches[b].clientY)},s.prototype.queueLassoMousedown=function(a,b){return this.lassoSelectStartTimeout=setTimeout(function(c){return function(){var d,e,f,g,h,i;for(i={},g=X.mousedown,h=[],e=0,f=g.length;e<f;e++)d=g[e],h.push(d.call(c,a,b,i));return h}}(this),N)},aa("populate",0,function(){return this.touchScrollAnchor=new this.draw.Point(0,0),this.lassoSelectStartTimeout=null,this.wrapperElement.addEventListener("touchstart",function(a){return function(b){var c,d,e,f,g,h;for(clearTimeout(a.lassoSelectStartTimeout),h=a.touchEventToPoint(b,0),g={suppressLassoSelect:!0},f=X.mousedown,d=0,e=f.length;d<e;d++)c=f[d],c.call(a,h,b,g);return g.consumedHitTest?b.preventDefault():a.queueLassoMousedown(h,b)}}(this)),this.wrapperElement.addEventListener("touchmove",function(a){return function(b){var c,d,e,f,g,h;for(clearTimeout(a.lassoSelectStartTimeout),h=a.touchEventToPoint(b,0),null==a.clickedBlock&&null==a.draggingBlock&&a.queueLassoMousedown(h,b),g={},f=X.mousemove,d=0,e=f.length;d<e;d++)c=f[d],c.call(a,h,b,g);if(null!=a.clickedBlock||null!=a.draggingBlock||null!=a.lassoSelectAnchor||a.textInputSelecting)return b.preventDefault()}}(this)),this.wrapperElement.addEventListener("touchend",function(a){return function(b){var c,d,e,f,g,h;for(clearTimeout(a.lassoSelectStartTimeout),h=a.touchEventToPoint(b,0),g={},f=X.mouseup,d=0,e=f.length;d<e;d++)c=f[d],c.call(a,h,b,g);return b.preventDefault()}}(this))}),aa("populate",0,function(){var a;return this.cursorCtx=document.createElementNS(K,"g"),this.textCursorPath=new this.session.view.draw.Path([],!1,{strokeColor:"#000",lineWidth:"2",fillColor:"rgba(0, 0, 256, 0.3)",cssClass:"droplet-cursor-path"}),this.textCursorPath.setParent(this.mainCanvas),a=document.createElementNS(K,"path"),a.setAttribute("fill","none"),a.setAttribute("stroke","#000"),a.setAttribute("stroke-width","3"),a.setAttribute("stroke-linecap","round"),a.setAttribute("d","M"+(this.session.view.opts.tabOffset+g/2)+" 0 Q"+(this.session.view.opts.tabOffset+this.session.view.opts.tabWidth/2)+" "+this.session.view.opts.tabHeight+" "+(this.session.view.opts.tabOffset+this.session.view.opts.tabWidth-g/2)+" 0"),this.cursorPath=new this.session.view.draw.ElementWrapper(a),this.cursorPath.setParent(this.mainCanvas),this.mainCanvas.appendChild(this.cursorCtx)}),s.prototype.strokeCursor=function(a){if(null!=a)return this.cursorPath.element.setAttribute("transform","translate("+a.x+", "+a.y+")"),this.qualifiedFocus(this.getCursor(),this.cursorPath)},s.prototype.highlightFlashShow=function(){if(null!=this.session)return null!=this.flashTimeout&&clearTimeout(this.flashTimeout),this.cursorAtSocket()?this.textCursorPath.activate():this.cursorPath.activate(),this.highlightsCurrentlyShown=!0,this.flashTimeout=setTimeout(function(a){return function(){return a.flash()}}(this),500)},s.prototype.highlightFlashHide=function(){if(null!=this.session)return null!=this.flashTimeout&&clearTimeout(this.flashTimeout),this.cursorAtSocket()?this.textCursorPath.deactivate():this.cursorPath.deactivate(),this.highlightsCurrentlyShown=!1,this.flashTimeout=setTimeout(function(a){return function(){return a.flash()}}(this),500)},s.prototype.editorHasFocus=function(){var a;return((a=document.activeElement)===this.dropletElement||a===this.hiddenInput||a===this.copyPasteInput)&&document.hasFocus()},s.prototype.flash=function(){if(null!=this.session)return null!=this.lassoSelection||null!=this.draggingBlock||this.cursorAtSocket()&&this.textInputHighlighted||!this.highlightsCurrentlyShown||!this.editorHasFocus()?this.highlightFlashShow():this.highlightFlashHide()},aa("populate",0,function(){var a,b;return this.highlightsCurrentlyShown=!1,a=function(a){return function(){return a.highlightFlashShow(),a.cursorCtx.style.opacity=f}}(this),this.dropletElement.addEventListener("blur",a),this.hiddenInput.addEventListener("blur",a),this.copyPasteInput.addEventListener("blur",a),b=function(a){return function(){return a.highlightFlashShow(),a.cursorCtx.style.transition="",a.cursorCtx.style.opacity=1}}(this),this.dropletElement.addEventListener("focus",b),this.hiddenInput.addEventListener("focus",b),this.copyPasteInput.addEventListener("focus",b),this.flashTimeout=setTimeout(function(a){return function(){return a.flash()}}(this),0)}),s.prototype.viewOrChildrenContains=function(a,b,c){var d,e,f,g,h;if(null==c&&(c=this.session.view),g=c.getViewNodeFor(a),g.path.contains(b))return!0;for(h=g.children,e=0,f=h.length;e<f;e++)if(d=h[e],this.session.viewOrChildrenContains(d.child,b,c))return!0;return!1},aa("populate",0,function(){return this.gutter=document.createElement("div"),this.gutter.className="droplet-gutter",this.lineNumberWrapper=document.createElement("div"),this.gutter.appendChild(this.lineNumberWrapper),this.gutterVersion=-1,this.lastGutterWidth=null,this.lineNumberTags={},this.mainScroller.appendChild(this.gutter),this.annotations={},this.breakpoints={},this.tooltipElement=document.createElement("div"),this.tooltipElement.className="droplet-tooltip",this.dropletElement.appendChild(this.tooltipElement),this.aceEditor.on("guttermousedown",function(a){return function(b){var c,d;if(d=b.domEvent.target,-1!==d.className.indexOf("ace_gutter-cell"))return c=b.getDocumentPosition().row,b.stop(),a.fireEvent("guttermousedown",[{line:c,event:b.domEvent}])}}(this))}),aa("mousedown",11,function(a,b,c){var d,e;if(this.trackerPointIsInGutter(a))return e=this.trackerPointToMain(a),this.session.view.getViewNodeFor(this.session.tree),d=this.findLineNumberAtCoordinate(e.y),this.fireEvent("guttermousedown",[{line:d,event:b}]),!0}),s.prototype.setBreakpoint=function(a){return this.aceEditor.session.setBreakpoint(a),this.breakpoints[a]=!0,this.redrawGutter(!1)},s.prototype.clearBreakpoint=function(a){return this.aceEditor.session.clearBreakpoint(a),this.breakpoints[a]=!1,this.redrawGutter(!1)},s.prototype.clearBreakpoints=function(a){return this.aceEditor.session.clearBreakpoints(),this.breakpoints={},this.redrawGutter(!1)},s.prototype.getBreakpoints=function(a){return this.aceEditor.session.getBreakpoints()},s.prototype.setAnnotations=function(a){var b,c,d,e,f,g;for(this.aceEditor.session.setAnnotations(a),this.annotations={},d=e=0,f=a.length;e<f;d=++e)c=a[d],null==(b=this.annotations)[g=c.row]&&(b[g]=[]),this.annotations[c.row].push(c);return this.redrawGutter(!1)},s.prototype.resizeGutter=function(){var a;return this.lastGutterWidth!==this.aceEditor.renderer.$gutterLayer.gutterWidth?(this.lastGutterWidth=this.aceEditor.renderer.$gutterLayer.gutterWidth,this.gutter.style.width=this.lastGutterWidth+"px",this.resize()):(a=Math.max(this.dropletElement.clientHeight,this.computeMainCanvasHeight()),this.lastGutterHeight!==a?(this.lastGutterHeight=a,this.gutter.style.height=this.lastGutterHeight+"px"):void 0)},s.prototype.addLineNumberForLine=function(a){var b,c,d;return d=this.session.view.getViewNodeFor(this.session.tree),a in this.lineNumberTags?b=this.lineNumberTags[a].tag:(b=document.createElement("div"),b.innerText=b.textContent=a+1,this.lineNumberTags[a]={tag:b,lastPosition:null}),b.className="droplet-gutter-line",null!=this.annotations[a]&&(b.className+=" droplet_"+Y(this.annotations[a]),c=this.annotations[a].map(function(a){return a.text}).join("\n"),b.addEventListener("mouseover",function(a){return function(){return a.tooltipElement.innerText=a.tooltipElement.textContent=c,a.tooltipElement.style.display="block"}}(this)),b.addEventListener("mousemove",function(a){return function(b){return a.tooltipElement.style.left=b.pageX+"px",a.tooltipElement.style.top=b.pageY+"px"}}(this)),b.addEventListener("mouseout",function(a){return function(){return a.tooltipElement.style.display="none"}}(this))),this.breakpoints[a]&&(b.className+=" droplet_breakpoint"),b.style.top=d.bounds[a].y+"px",b.style.paddingTop=d.distanceToBase[a].above-this.session.view.opts.textHeight-this.session.fontAscent+"px",b.style.paddingBottom=""+(d.distanceToBase[a].below-this.session.fontDescent),b.style.height=d.bounds[a].height+"px",b.style.fontSize=this.session.fontSize+"px",this.lineNumberWrapper.appendChild(b),this.lineNumberTags[a].lastPosition=d.bounds[a].y},P={error:2,warning:1,info:0},O=["info","warning","error"],Y=function(a){return O[Math.max.apply(this,a.map(function(a){return P[a.type]}))]},s.prototype.findLineNumberAtCoordinate=function(a){var b,c,d,e;for(e=this.session.view.getViewNodeFor(this.session.tree),d=0,b=e.bounds.length,c=Math.floor((d+b)/2);e.bounds[c].y!==a&&d<b;){if(d===c||b===c)return c;if(e.bounds[c].y>a?b=c:d=c,b<0)return 0;if(d>=e.bounds.length)return e.bounds.length-1;c=Math.floor((d+b)/2)}return c},aa("redraw_main",0,function(a){return this.redrawGutter(a)}),s.prototype.redrawGutter=function(a){var b,c,d,e,f,g,h;if(null==a&&(a=!0),null!=this.session){for(this.session.view.getViewNodeFor(this.session.tree),h=this.findLineNumberAtCoordinate(this.session.viewports.main.y),b=this.findLineNumberAtCoordinate(this.session.viewports.main.bottom()),d=c=e=h,f=b;e<=f?c<=f:c>=f;d=e<=f?++c:--c)this.addLineNumberForLine(d);g=this.lineNumberTags;for(d in g)g[d],(d<h||d>b)&&(this.lineNumberTags[d].tag.parentNode.removeChild(this.lineNumberTags[d].tag),delete this.lineNumberTags[d]);return a?this.resizeGutter():void 0}},s.prototype.setPaletteWidth=function(a){return this.paletteWrapper.style.width=a+"px",this.resizeBlockMode()},aa("populate",1,function(){var a,b;return this.copyPasteInput=document.createElement("textarea"),this.copyPasteInput.style.position="absolute",this.copyPasteInput.style.left=this.copyPasteInput.style.top="-9999px",this.dropletElement.appendChild(this.copyPasteInput),a=!1,b=!1,this.copyPasteInput.addEventListener("keydown",function(c){return a=b=!1,86===c.keyCode?a=!0:88===c.keyCode?b=!0:void 0}),this.copyPasteInput.addEventListener("input",function(c){return function(){var d,e,f,g;if(null!=c.session&&!c.session.readOnly){if(a&&!c.cursorAtSocket()){g=c.copyPasteInput.value,e=g.split("\n"),f=e.map(function(a){return a.length-a.trimLeft().length}).reduce(function(a,b){return Math.min(a,b)}),g=e.map(function(a){return a.slice(f)}).join("\n"),g=g.replace(/^\n*|\n*$/g,"");try{d=c.session.mode.parse(g,{context:c.getCursor().parent.parseContext}),d=new ga.List(d.start.next,d.end.prev)}catch(a){a,d=null}if(null==d)return;return c.undoCapture(),c.spliceIn(d,c.getCursor()),c.setCursor(d.end),c.redrawMain(),c.copyPasteInput.setSelectionRange(0,c.copyPasteInput.value.length)}return b&&null!=c.lassoSelection?(c.spliceOut(c.lassoSelection),c.lassoSelection=null,c.redrawMain()):void 0}}}(this))}),aa("keydown",0,function(a,b){var c,d,e;if(c=a.which,pa.call(U,c)>=0&&!this.cursorAtSocket())return d=document.body.scrollLeft,e=document.body.scrollTop,this.copyPasteInput.focus(),window.scrollTo(d,e),null!=this.lassoSelection&&(this.copyPasteInput.value=this.lassoSelection.stringifyInPlace()),this.copyPasteInput.setSelectionRange(0,this.copyPasteInput.value.length)}),aa("keyup",0,function(a,b,c){var d;if(d=b.which,pa.call(U,d)>=0)return this.cursorAtSocket()?this.hiddenInput.focus():this.dropletElement.focus()}),s.prototype.overflowsX=function(){return this.documentDimensions().width>this.session.viewportDimensions().width},s.prototype.overflowsY=function(){return this.documentDimensions().height>this.session.viewportDimensions().height},s.prototype.documentDimensions=function(){var a;return a=this.session.view.getViewNodeFor(this.session.tree).totalBounds,{width:a.width,height:a.height}},s.prototype.viewportDimensions=function(){return this.session.viewports.main},s.prototype.getLineMetrics=function(a){var b,c;return c=this.session.view.getViewNodeFor(this.session.tree),b=(new this.session.view.draw.Rectangle).copy(c.bounds[a]),b.x+=this.mainCanvas.offsetLeft+this.mainCanvas.offsetParent.offsetLeft,{bounds:b,distanceToBase:{above:c.distanceToBase[a].above,below:c.distanceToBase[a].below}}},s.prototype.dumpNodeForDebug=function(a,b){return console.log("Model node:"),console.log(a.serialize()),console.log("View node:"),console.log(this.session.view.getViewNodeFor(a).serialize(b))};for(da in la)for(la[da].sort(function(a,b){return a.priority>b.priority?-1:1}),X[da]=[],ka=la[da],ca=0,fa=ka.length;ca<fa;ca++)T=ka[ca],X[da].push(T.fn)},{"../vendor/quadtree.js":36,"./draw.coffee":27,"./helper.coffee":28,"./model.coffee":31,"./modes.coffee":32,"./view.coffee":34}],27:[function(a,b,c){var d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w=function(a,b){function c(){this.constructor=a}for(var d in b)x.call(b,d)&&(a[d]=b[d]);return c.prototype=b.prototype,a.prototype=new c,a.__super__=b.prototype,a},x={}.hasOwnProperty,y=function(a,b){return(+a%(b=+b)+b)%b};d=1.5,e=1e-5,o=a("./helper.coffee"),h=o.SVG_STANDARD,k=function(a,b,c){return(b.x-a.x)*(c.y-a.y)-(c.x-a.x)*(b.y-a.y)},m=function(a,b,c,d){return k(a,b,c)>0!=k(a,b,d)>0&&k(c,d,a)>0!=k(c,d,b)>0},l=function(a,b,c,d){var e,f,g,h;return null==d&&(d=1),a.equals(b)||b.equals(c)?null:(f=a.from(b).normalize(),e=f.plus(g=c.from(b).normalize()),e.almostEquals(j)?null:f.almostEquals(g)?null:(e=e.normalize(),h=d/Math.sqrt(1-Math.pow(e.dot(f),2)),e.x*=h,e.y*=h,k(a,b,c)<0&&(e.x*=-1,e.y*=-1),e))},p=function(a,b){return a>b?a:b},r=function(a,b){return b>a?a:b},t=function(a){var b,c,d,e;return 4===a.length&&(a=function(){var b,d,e;for(e=[],b=0,d=a.length;b<d;b++)c=a[b],e.push(c+c);return e}().join("").slice(1)),e=parseInt(a.slice(1,3),16),d=parseInt(a.slice(3,5),16),b=parseInt(a.slice(5,7),16),[e,d,b]},v=function(a,b){return a.length<b?function(){var c,d,e,f;for(f=[],c=d=a.length,e=b;d<=e?c<e:c>e;d<=e?c++:c--)f.push("0");return f}().join("")+a:a},u=function(a){return v(Math.round(a).toString(16),2)},s=function(a){var b;return"#"+function(){var c,d,e;for(e=[],c=0,d=a.length;c<d;c++)b=a[c],e.push(u(b));return e}().join("")},q={},n=function(a,b,c){var d,e,f,g;return(d=a+","+b+","+c)in q?q[d]:(a=t(a),c=t(c),g=function(){var d,g,h;for(h=[],e=d=0,g=a.length;d<g;e=++d)f=a[e],h.push(a[e]*b+c[e]*(1-b));return h}(),q[d]=s(g))},c.Draw=function(){function a(a){var b,c,e,j;this.ctx=a,e=document.createElement("canvas"),this.measureCtx=e.getContext("2d"),this.fontSize=15,this.fontFamily="Courier New, monospace",this.fontAscent=-2,this.fontBaseline=10,this.measureCtx.font=this.fontSize+"px "+this.fontFamily,this.ctx.style.fontFamily=this.fontFamily,this.ctx.style.fontSize=this.fontSize,j=this,this.Point=f,this.Size=i,this.Rectangle=g,this.NoRectangle=c=function(a){function b(){b.__super__.constructor.call(this,null,null,0,0)}return w(b,a),b}(g),this.ElementWrapper=b=function(){function a(a){var b,c;this.element=a,null!=this.element&&(this.element.style.display="none"),this.active=!1,this.parent=null!=(b=null!=(c=this.element)?c.parentNode:void 0)?b:j.ctx}return a.prototype.manifest=function(){if(null==this.element){if(this.element=this.makeElement(),this.getParentElement().appendChild(this.element),!this.active)return this.element.style.display="none"}else if(null==this.element.parentNode)return this.getParentElement().appendChild(this.element)},a.prototype.deactivate=function(){var a,b;if(this.active)return this.active=!1,null!=(a=this.element)&&null!=(b=a.style)?b.display="none":void 0},a.prototype.activate=function(){var a,b;if(this.manifest(),!this.active)return this.active=!0,null!=(a=this.element)&&null!=(b=a.style)?b.display="":void 0},a.prototype.focus=function(){return this.activate(),this.getParentElement().appendChild(this.element)},a.prototype.getParentElement=function(){return this.parent instanceof a?(this.parent.manifest(),this.parent.element):this.parent},a.prototype.setParent=function(a){if(this.parent=a,null!=this.element&&(a=this.getParentElement())!==this.element.parentNode)return a.appendChild(this.element)},a.prototype.destroy=function(){if(null!=this.element&&null!=this.element.parentNode)return this.element.parentNode.removeChild(this.element)},a}(),this.Group=function(a){function b(){b.__super__.constructor.call(this)}return w(b,a),b.prototype.makeElement=function(){return document.createElementNS(h,"g")},b}(b),this.Path=function(a){function b(a,d,e){this._points=null!=a?a:[],this.bevel=null!=d&&d,this.style=e,this._cachedTranslation=new f(0,0),this._cacheFlag=!0,this._bounds=new c,this._clearCache(),this.style=o.extend({strokeColor:"none",lineWidth:1,fillColor:"none",dotted:""},this.style),b.__super__.constructor.call(this)}return w(b,a),b.prototype._clearCache=function(){var a,b,e,f,g,h,i,j,k,l,m,n,o,q,s,t,u,v,w;if(this._cacheFlag){if(0===this._points.length)return this._bounds=new c,this._lightBevelPath=this._darkBevelPath="";for(m=n=Infinity,k=l=0,t=this._points,f=0,g=t.length;f<g;f++)s=t[f],m=r(m,s.x),k=p(k,s.x),n=r(n,s.y),l=p(l,s.y);for(this._bounds.x=m,this._bounds.y=n,this._bounds.width=k-m,this._bounds.height=l-n,w=[],q=[],e=[],u=this._points.slice(1),a=j=0,h=u.length;j<h;a=++j)s=u[a],s.x>this._points[a].x&&s.y<=this._points[a].y||s.y<this._points[a].y&&s.x>=this._points[a].x?(0===q.length&&null!=(b=this.getInsetCoordinate(a,d))&&(q.push(this._points[a]),e.push(b)),null!=(b=this.getInsetCoordinate(a+1,d))&&(q.push(s),e.push(b))):s.equals(this._points[a])||0===q.length||(w.push("M"+q.concat(e.reverse()).map(function(a){return a.x+" "+a.y}).join(" L")+" Z"),q.length=e.length=0);for((this._points[0].x>this._points[this._points.length-1].x||this._points[0].y<this._points[this._points.length-1].y)&&(0===q.length&&null!=(b=this.getInsetCoordinate(this._points.length-1,d))&&(q.push(this._points[this._points.length-1]),e.push(b)),null!=(b=this.getInsetCoordinate(0,d))&&(q.push(this._points[0]),e.push(b))),q.length>0&&w.push("M"+q.concat(e.reverse()).map(function(a){return a.x+" "+a.y}).join(" L")+" Z"),this._lightBevelPath=w.join(" "),w=[],q=[],e=[],v=this._points.slice(1),a=o=0,i=v.length;o<i;a=++o)s=v[a],s.x<this._points[a].x&&s.y>=this._points[a].y||s.y>this._points[a].y&&s.x<=this._points[a].x?(0===q.length&&null!=(b=this.getInsetCoordinate(a,d))&&(q.push(this._points[a]),e.push(b)),null!=(b=this.getInsetCoordinate(a+1,d))&&(q.push(s),e.push(b))):s.equals(this._points[a])||0===q.length||(w.push("M"+q.concat(e.reverse()).map(function(a){return a.x+" "+a.y}).join(" L")+" Z"),q.length=e.length=0);return(this._points[0].x<this._points[this._points.length-1].x||this._points[0].y>this._points[this._points.length-1].y)&&(0===q.length&&null!=(b=this.getInsetCoordinate(this._points.length-1,d))&&(q.push(this._points[this._points.length-1]),e.push(b)),null!=(b=this.getInsetCoordinate(0,d))&&(q.push(this._points[0]),e.push(b))),q.length>0&&w.push("M"+q.concat(e.reverse()).map(function(a){return a.x+" "+a.y}).join(" L")+" Z"),this._darkBevelPath=w.join(" "),this._cacheFlag=!1}},b.prototype._setPoints_raw=function(a){return this._points=a,this._cacheFlag=!0,this._updateFlag=!0},b.prototype.setMarkStyle=function(a){return null!=a&&a.color!==(null!=this.markColor)?(this.markColor=a.color,this._markFlag=!0):null!=this.markColor?(this.markColor=null,this._markFlag=!0):void 0},b.prototype.setPoints=function(a){var b,c,d,e;if(a.length!==this._points.length)return void this._setPoints_raw(a);for(c=d=0,e=a.length;d<e;c=++d)if(b=a[c],!this._points[c].equals(b))return void this._setPoints_raw(a)},b.prototype.push=function(a){return this._points.push(a),this._cacheFlag=!0,this._updateFlag=!0},b.prototype.unshift=function(a){return this._points.unshift(a),this._cacheFlag=!0,this._updateFlag=!0},b.prototype.reverse=function(){return this._points.reverse(),this},b.prototype.contains=function(a){var b,c,d,e,g,h,i;if(this._clearCache(),0===this._points.length)return!1;if(!this._bounds.contains(a))return!1;for(c=new f(this._bounds.x-10,a.y),b=0,g=this._points[this._points.length-1],i=this._points,e=0,h=i.length;e<h;e++)d=i[e],m(g,d,a,c)&&(b+=1),g=d;return b%2==1},b.prototype.equals=function(a){var c,d,e,f,g;if(!(a instanceof b))return!1;if(a._points.length!==this._points.length)return!1;for(g=a._points,d=e=0,f=g.length;e<f;d=++e)if(c=g[d],!this._points[d].equals(c))return!1;return!0},b.prototype.intersects=function(a){var b,c,d,e,g,h,i,j,k,l;if(this._clearCache(),0===this._points.length)return!1;if(a.overlap(this._bounds)){for(d=this._points[this._points.length-1],j=[new f(a.x,a.y),new f(a.right(),a.y),new f(a.right(),a.bottom()),new f(a.x,a.bottom())],k=this._points,c=0,g=k.length;c<g;c++){for(b=k[c],e=j[j.length-1],i=0,h=j.length;i<h;i++){if(l=j[i],m(d,b,e,l))return!0;e=l}d=b}return!!this.contains(j[0])||!!a.contains(this._points[0])}return!1},b.prototype.bounds=function(){return this._clearCache(),this._bounds},b.prototype.translate=function(a){return this._cachedTranslation.translate(a),this._cacheFlag=!0},b.prototype.getCommandString=function(){var a,b,c,d,e;if(0===this._points.length)return"";for(c=[],c.push("M"+Math.round(this._points[0].x)+" "+Math.round(this._points[0].y)),e=this._points,a=0,b=e.length;a<b;a++)d=e[a],c.push("L"+Math.round(d.x)+" "+Math.round(d.y));return c.push("L"+Math.round(this._points[0].x)+" "+Math.round(this._points[0].y)),c.push("Z"),c.join(" ")},b.prototype.getInsetCoordinate=function(a,b){var c,d,e,f,g;for(c=a,f=this._points[a];f.equals(this._points[a])&&c>a-this._points.length;)c--,f=this._points[y(c,this._points.length)];for(d=a,e=this._points[a];e.equals(this._points[a])&&d<a+this._points.length;)d++,e=this._points[y(d,this._points.length)];return null==(g=l(f,this._points[a],e,b))?null:this._points[a].plus(g)},b.prototype.getLightBevelPath=function(){return this._clearCache(),this._lightBevelPath},b.prototype.getDarkBevelPath=function(){return this._clearCache(),this._darkBevelPath,this._darkBevelPath},b.prototype.makeElement=function(){var a,b,c,d;return this._clearCache(),a=document.createElementNS(h,"path"),null!=this.style.fillColor&&a.setAttribute("fill",this.style.fillColor),this.__lastFillColor=this.style.fillColor,this.__lastStrokeColor=this.style.strokeColor,this.__lastLineWidth=this.style.lineWidth,this.__lastDotted=this.style.dotted,this.__lastCssClass=this.style.cssClass,this.__lastTransform=this.style.transform,b=this.getCommandString(),b.length>0&&a.setAttribute("d",b),this.bevel?(this.backgroundPathElement=a,this.backgroundPathElement.setAttribute("class","droplet-background-path"),a=document.createElementNS(h,"g"),this.lightPathElement=document.createElementNS(h,"path"),this.lightPathElement.setAttribute("fill",n(this.style.fillColor,.7,"#FFF")),b.length>0&&this.lightPathElement.setAttribute("d",this.getLightBevelPath()),this.lightPathElement.setAttribute("class","droplet-light-bevel-path"),this.darkPathElement=document.createElementNS(h,"path"),this.darkPathElement.setAttribute("fill",n(this.style.fillColor,.7,"#000")),b.length>0&&this.darkPathElement.setAttribute("d",this.getDarkBevelPath()),this.darkPathElement.setAttribute("class","droplet-dark-bevel-path"),a.appendChild(this.backgroundPathElement),a.appendChild(this.lightPathElement),a.appendChild(this.darkPathElement)):(a.setAttribute("stroke",this.style.strokeColor),a.setAttribute("stroke-width",this.style.lineWidth),(null!=(c=null!=(d=this.style.dotted)?d.length:void 0)?c:0)>0&&a.setAttribute("stroke-dasharray",this.style.dotted)),null!=this.style.cssClass&&a.setAttribute("class",this.style.cssClass),null!=this.style.transform&&a.setAttribute("transform",this.style.transform),a},b.prototype.update=function(){var a;if(null!=this.element)return this.style.fillColor!==this.__lastFillColor&&(this.__lastFillColor=this.style.fillColor,this.bevel?(this.backgroundPathElement.setAttribute("fill",this.style.fillColor),this.lightPathElement.setAttribute("fill",n(this.style.fillColor,.7,"#FFF")),this.darkPathElement.setAttribute("fill",n(this.style.fillColor,.7,"#000"))):this.element.setAttribute("fill",this.style.fillColor)),this.bevel||this.style.strokeColor===this.__lastStrokeColor||(this.__lastStrokeColor=this.style.strokeColor,this.element.setAttribute("stroke",this.style.strokeColor)),this.bevel||this.style.dotted===this.__lastDotted||(this.__lastDotted=this.style.dotted,this.element.setAttribute("stroke-dasharray",this.style.dotted)),this.bevel||this.style.lineWidth===this.__lastLineWidth||(this.__lastLineWidth=this.style.lineWidth,this.element.setAttribute("stroke-width",this.style.lineWidth)),null!=this.style.cssClass&&this.style.cssClass!==this._lastCssClass&&(this._lastCssClass=this.style.cssClass,this.element.setAttribute("class",this.style.cssClass)),null!=this.style.transform&&this.style.transform!==this._lastTransform&&(this._lastTransform=this.style.transform,this.element.setAttribute("transform",this.style.transform)),this._markFlag&&(null!=this.markColor?this.bevel?(this.backgroundPathElement.setAttribute("stroke",this.markColor),this.backgroundPathElement.setAttribute("stroke-width","2"),this.lightPathElement.setAttribute("visibility","hidden"),this.darkPathElement.setAttribute("visibility","hidden")):(this.element.setAttribute("stroke",this.markColor),this.element.setAttribute("stroke-width","2")):this.bevel?(this.backgroundPathElement.setAttribute("stroke","none"),this.lightPathElement.setAttribute("visibility","visible"),this.darkPathElement.setAttribute("visibility","visible")):(this.element.setAttribute("stroke",this.style.strokeColor),this.element.setAttribute("stroke-width",this.style.lineWidth))),this._updateFlag&&(this._updateFlag=!1,a=this.getCommandString(),a.length>0)?this.bevel?(this.backgroundPathElement.setAttribute("d",a),this.lightPathElement.setAttribute("d",this.getLightBevelPath()),this.darkPathElement.setAttribute("d",this.getDarkBevelPath())):this.element.setAttribute("d",a):void 0},b.prototype.clone=function(){var a;return a=new b(this._points.slice(0),this.bevel,{
lineWidth:this.style.lineWidth,fillColor:this.style.fillColor,strokeColor:this.style.strokeColor,dotted:this.style.dotted,cssClass:this.style.cssClass}),a._clearCache(),a.update(),a},b}(b),this.Text=function(a){function b(a,c){this.point=a,this.value=c,this.__lastValue=this.value,this.__lastPoint=this.point.clone(),this._bounds=new g(this.point.x,this.point.y,j.measureCtx.measureText(this.value).width,j.fontSize),b.__super__.constructor.call(this)}return w(b,a),b.prototype.clone=function(){return new b(this.point,this.value)},b.prototype.equals=function(a){return null!=a&&this.point.equals(a.point)&&this.value===a.value},b.prototype.bounds=function(){return this._bounds},b.prototype.contains=function(a){return this._bounds.contains(a)},b.prototype.setPosition=function(a){return this.translate(a.from(this.point))},b.prototype.makeElement=function(){var a,b;return a=document.createElementNS(h,"text"),a.setAttribute("x",this.point.x),a.setAttribute("y",this.point.y+j.fontBaseline-j.fontAscent/2),a.setAttribute("dominant-baseline","alphabetic"),b=document.createTextNode(this.value.replace(/ /g,"")),a.appendChild(b),a},b.prototype.update=function(){var a;if(null!=this.element)return this.point.equals(this.__lastPoint)||(this.__lastPoint=this.point.clone(),this.element.setAttribute("x",this.point.x),this.element.setAttribute("y",this.point.y+j.fontBaseline-j.fontAscent/2)),this.value!==this.__lastValue?(this.__lastValue=this.value,this.element.removeChild(this.element.lastChild),a=document.createTextNode(this.value.replace(/ /g,"")),this.element.appendChild(a)):void 0},b}(b)}return a.prototype.refreshFontCapital=function(){var a;return a=o.fontMetrics(this.fontFamily,this.fontSize),this.fontAscent=a.prettytop,this.fontBaseline=a.baseline},a.prototype.setGlobalFontSize=function(a){return this.fontSize=a,this.ctx.style.fontSize=a,this.measureCtx.font=this.fontSize+"px "+this.fontFamily,this.refreshFontCapital()},a.prototype.setGlobalFontFamily=function(a){return this.fontFamily=a,this.ctx.style.fontFamily=a,this.measureCtx.font=this.fontSize+"px "+this.fontFamily,this.refreshFontCapital()},a.prototype.getGlobalFontSize=function(){return this.fontSize},a}(),c.Point=f=function(){function a(a,b){this.x=a,this.y=b}return a.prototype.clone=function(){return new a(this.x,this.y)},a.prototype.magnitude=function(){return Math.sqrt(this.x*this.x+this.y*this.y)},a.prototype.times=function(b){return new a(this.x*b,this.y*b)},a.prototype.normalize=function(){return this.times(1/this.magnitude())},a.prototype.translate=function(a){return this.x+=a.x,this.y+=a.y},a.prototype.add=function(a,b){return this.x+=a,this.y+=b},a.prototype.dot=function(a){return this.x*a.x+this.y*a.y},a.prototype.plus=function(b){var c,d;return c=b.x,d=b.y,new a(this.x+c,this.y+d)},a.prototype.toMagnitude=function(b){var c;return c=b/this.magnitude(),new a(this.x*c,this.y*c)},a.prototype.copy=function(a){return this.x=a.x,this.y=a.y,this},a.prototype.from=function(b){return new a(this.x-b.x,this.y-b.y)},a.prototype.clear=function(){return this.x=this.y=0},a.prototype.equals=function(a){return a.x===this.x&&a.y===this.y},a.prototype.almostEquals=function(a){return Math.abs(a.x-this.x)<e&&Math.abs(a.y-this.y)<e},a}(),j=new f(0,0),c.Size=i=function(){function a(a,b){this.width=a,this.height=b}return a.prototype.equals=function(a){return this.width===a.width&&this.height===a.height},a.copy=function(b){return new a(b.width,b.height)},a}(),c.Rectangle=g=function(){function a(a,b,c,d){this.x=a,this.y=b,this.width=c,this.height=d}return a.prototype.contains=function(a){return null!=this.x&&null!=this.y&&!(a.x<this.x||a.x>this.x+this.width||a.y<this.y||a.y>this.y+this.height)},a.prototype.equals=function(b){return b instanceof a&&(this.x===b.x&&this.y===b.y&&this.width===b.width&&this.height===b.height)},a.prototype.copy=function(a){return this.x=a.x,this.y=a.y,this.width=a.width,this.height=a.height,this},a.prototype.clone=function(){var b;return b=new a(0,0,0,0),b.copy(this),b},a.prototype.clear=function(){return this.width=this.height=0,this.x=this.y=null},a.prototype.bottom=function(){return this.y+this.height},a.prototype.right=function(){return this.x+this.width},a.prototype.unite=function(a){return null==this.x||null==this.y?this.copy(a):null!=a.x&&null!=a.y?(this.width=p(this.right(),a.right())-(this.x=r(this.x,a.x)),this.height=p(this.bottom(),a.bottom())-(this.y=r(this.y,a.y))):void 0},a.prototype.swallow=function(b){return null==this.x||null==this.y?this.copy(new a(b.x,b.y,0,0)):(this.width=p(this.right(),b.x)-(this.x=r(this.x,b.x)),this.height=p(this.bottom(),b.y)-(this.y=r(this.y,b.y)))},a.prototype.overlap=function(a){return null!=this.x&&null!=this.y&&!(a.right()<this.x||a.bottom()<this.y||a.x>this.right()||a.y>this.bottom())},a.prototype.translate=function(a){return this.x+=a.x,this.y+=a.y},a.prototype.upperLeftCorner=function(){return new f(this.x,this.y)},a.prototype.toPath=function(){var a,b,c,d,e;for(c=new Path,e=[[this.x,this.y],[this.x,this.bottom()],[this.right(),this.bottom()],[this.right(),this.y]],a=0,b=e.length;a<b;a++)d=e[a],c.push(new f(d[0],d[1]));return c},a}(),c._collinear=function(a,b,c){var d,e;return d=b.from(a).normalize(),e=c.from(b).normalize(),d.almostEquals(e)||d.almostEquals(e.times(-1))}},{"./helper.coffee":28}],28:[function(a,b,c){var d,e,f,g,h,i,j,k,l={}.hasOwnProperty;k=a("sax"),c.ANY_DROP=0,c.BLOCK_ONLY=1,c.MOSTLY_BLOCK=2,c.MOSTLY_VALUE=3,c.VALUE_ONLY=4,c.SVG_STANDARD="http://www.w3.org/2000/svg",c.ENCOURAGE=1,c.DISCOURAGE=0,c.FORBID=-1,c.DROPDOWN_ARROW_WIDTH=15,c.DROPDOWN_ARROW_PADDING=3,"undefined"!=typeof window&&null!==window&&(window.String.prototype.trimLeft=function(){return this.replace(/^\s+/,"")},window.String.prototype.trimRight=function(){return this.replace(/\s+$/,"")}),c.extend=function(a){var b;return b=[].slice.call(arguments,1),b.forEach(function(b){if(b)return Object.getOwnPropertyNames(b).forEach(function(c){return Object.defineProperty(a,c,Object.getOwnPropertyDescriptor(b,c))})}),a},c.xmlPrettyPrint=function(a){var b,d;return b="",d=k.parser(!0),d.ontext=function(a){return b+=c.escapeXMLText(a)},d.onopentag=function(a){var c,d,e;b+="<"+a.name,d=a.attributes;for(c in d)e=d[c],b+="\n  "+c+"="+JSON.stringify(e);return b+=">"},d.onclosetag=function(a){return b+="</"+a+">"},d.write(a).close(),b},h={},c.fontMetrics=g=function(a,b){var c,d,e,f,g,i,j,k,l,m,n,o;return g=b+"px "+a,m=h[g],n=function(a){var b,c,d,f,g,h,i,k,l,m,n;for(e.fillStyle="black",e.fillRect(0,0,o,j),e.textBaseline="top",e.fillStyle="white",e.fillText(a,0,0),m=Math.ceil(e.measureText(a).width),i=e.getImageData(0,0,o,j).data,c=-1,h=j,n=f=0,k=j;0<=k?f<k:f>k;n=0<=k?++f:--f){for(b=g=1,l=m;1<=l?g<l:g>l;b=1<=l?++g:--g)if(d=4*(n*o+b),0!==i[d]){c<0&&(c=n);break}if(c>=0&&b>=m){h=n;break}}return{top:c,bottom:h}},m||(c=document.createElement("canvas"),e=c.getContext("2d"),e.font=g,l=e.measureText("Hg"),(c.height<2*b||c.width<l.width)&&(c.width=Math.ceil(l.width),c.height=2*b,e=c.getContext("2d"),e.font=g),o=c.width,j=c.height,d=n("H"),f=n("x"),k=n("lf"),i=n("g"),d.bottom,m={ascent:k.top,capital:d.top,ex:f.top,baseline:d.bottom,descent:i.bottom},m.prettytop=Math.max(0,Math.min(m.ascent,m.ex-(m.descent-m.baseline))),h[g]=m),m},c.clipLines=function(a,b,c){return b.line!==c.line?a[b.line].slice(b.column)+a.slice(b.line+1,c.line).join("\n")+a[c.line].slice(0,c.column):a[b.line].slice(b.column,c.column)},c.getFontHeight=function(a,b){var c;return c=g(a,b),c.descent-c.prettytop},c.escapeXMLText=function(a){return a.replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/'/g,"&apos;")},c.serializeShallowDict=function(a){var b,c,d;c=[];for(b in a)d=a[b],c.push(b+":"+d);return c.join(";")},c.deserializeShallowDict=function(a){var b,c,d,e,f,g,h,i;if(null!=a){for(b={},g=a.split(";"),c=0,e=g.length;c<e;c++)f=g[c],h=f.split(":"),d=h[0],i=h[1],b[d]=i;return b}},c.connect=function(a,b){return null!=a&&(a.next=b),null!=b&&(b.prev=a),b},c.string=function(a){var b,d,e,f,g;for(f=a[0],d=e=0,g=a.length;e<g;d=++e)b=a[d],d>0&&(f=c.connect(f,b));return f},c.deepCopy=e=function(a){var b,c,d;if(a instanceof Array)return a.map(function(a){return e(a)});if(a instanceof Object){c={};for(b in a)d=a[b],d instanceof Function?c[b]=d:c[b]=e(d);return c}return a},c.deepEquals=f=function(a,b){var c,d;if(a instanceof Object&&b instanceof Object){for(c in a)if(l.call(a,c)&&(d=a[c],!f(b[c],d)))return!1;for(c in b)if(l.call(b,c)&&(d=b[c],!c in a&&!f(a[c],d)))return!1;return!0}return a===b},d=0,c.generateGUID=function(){return(d++).toString(16)},c.fixQuotedString=function(a){var b,c;return b=a[0],c=/^"|"$/.test(b)?'"':"'",b.charAt(0)===c&&(b=b.substr(1)),b.charAt(b.length-1)===c&&(b=b.substr(0,b.length-1)),a[0]=j(i(b),c)},c.looseCUnescape=i=function(a){var b;return b={"\\b":"\b","\\t":"\t","\\n":"\n","\\f":"\f",'\\"':'"',"\\'":"'","\\\\":"\\","\\0":"\0"},a.replace(/\\[btnf'"\\0]|\\x[0-9a-fA-F]{2}|\\u[0-9a-fA-F]{4}/g,function(a){return 2===a.length?b[a]:String.fromCharCode(parseInt(a.substr(1),16))})},c.quoteAndCEscape=j=function(a,b){var c;return c=JSON.stringify(a),"'"===b?b+c.substr(1,c.length-2).replace(/((?:^|[^\\])(?:\\\\)*)\\"/g,'$1"').replace(/'/g,"\\'")+b:c},c.PairDict=function(){function a(a){this.pairs=a}return a.prototype.get=function(a){var b,c,d,e,f;for(f=this.pairs,c=d=0,e=f.length;d<e;c=++d)if(b=f[c],b[0]===a)return b[1]},a.prototype.contains=function(a){return this.pairs.some(function(b){return b[0]===a})},a.prototype.set=function(a,b){var c,d,e,f,g;for(g=this.pairs,d=e=0,f=g.length;e<f;d=++e)if(c=g[d],c[0]===a)return c[1]=a,!0;return this.pairs.push([a,b]),!1},a}()},{sax:23}],29:[function(a,b,c){var d,e,f,g,h,i,j,k,l,m,n,o,p,q,r=function(a,b){function c(){this.constructor=a}for(var d in b)s.call(b,d)&&(a[d]=b[d]);return c.prototype=b.prototype,a.prototype=new c,a.__super__=b.prototype,a},s={}.hasOwnProperty,t=[].indexOf||function(a){for(var b=0,c=this.length;b<c;b++)if(b in this&&this[b]===a)return b;return-1};o=a("../helper.coffee"),a("../model.coffee"),q=a("../parser.coffee"),n=a("../../vendor/acorn"),m=["ExpressionStatement","ReturnStatement","BreakStatement","ThrowStatement"],j=100,h={alert:{},prompt:{},"console.log":{},"*.toString":{value:!0},"Math.abs":{value:!0},"Math.acos":{value:!0},"Math.asin":{value:!0},"Math.atan":{value:!0},"Math.atan2":{value:!0},"Math.cos":{value:!0},"Math.sin":{value:!0},"Math.tan":{value:!0},"Math.ceil":{value:!0},"Math.floor":{value:!0},"Math.round":{value:!0},"Math.exp":{value:!0},"Math.ln":{value:!0},"Math.log10":{value:!0},"Math.pow":{value:!0},"Math.sqrt":{value:!0},"Math.max":{value:!0},"Math.min":{value:!0},"Math.random":{value:!0}},d={functions:{color:"purple"},returns:{color:"yellow"},comments:{color:"gray"},arithmetic:{color:"green"},logic:{color:"cyan"},containers:{color:"teal"},assignments:{color:"blue"},loops:{color:"orange"},conditionals:{color:"orange"},value:{color:"green"},command:{color:"blue"},errors:{color:"#f00"}},i={"==":!0,"!=":!0,"===":!0,"!==":!0,"<":!0,"<=":!0,">":!0,">=":!0,in:!0,instanceof:!0,"||":!0,"&&":!0,"!":!0},k={BinaryExpression:"arithmetic",UnaryExpression:"arithmetic",ConditionalExpression:"arithmetic",LogicalExpression:"logic",FunctionExpression:"functions",FunctionDeclaration:"functions",AssignmentExpression:"assignments",UpdateExpression:"arithmetic",VariableDeclaration:"assignments",ReturnStatement:"returns",IfStatement:"conditionals",SwitchStatement:"conditionals",ForStatement:"loops",ForInStatement:"loops",WhileStatement:"loops",DoWhileStatement:"loops",NewExpression:"containers",ObjectExpression:"containers",ArrayExpression:"containers",MemberExpression:"containers",BreakStatement:"returns",ThrowStatement:"returns",TryStatement:"returns",CallExpression:"command",SequenceExpression:"command",Identifier:"value"},l={"++":3,"--":3,"!":4,"~":4,"*":5,"/":5,"%":5,"+":6,"-":6,"<<":7,">>":7,">>>":7,"<":8,">":8,">=":8,in:8,instanceof:8,"==":9,"!=":9,"===":9,"!==":9,"&":10,"^":11,"|":12,"&&":13,"||":14},e={ForStatement:["ends-with-brace","block-only"],FunctionDeclaration:["ends-with-brace","block-only"],IfStatement:["ends-with-brace","block-only"],WhileStatement:["ends-with-brace","block-only"],DoWhileStatement:["ends-with-brace","block-only"],SwitchStatement:["ends-with-brace","block-only"],AssignmentExpression:["mostly-block"]},f="  ",c.JavaScriptParser=g=function(a){function b(a,c){var e;this.text=a,b.__super__.constructor.apply(this,arguments),null==(e=this.opts).functions&&(e.functions=h),this.opts.categories=o.extend({},d,this.opts.categories),this.lines=this.text.split("\n")}return r(b,a),b.prototype.markRoot=function(){var a;return"{"===this.text[0]&&(this.text="("+this.text+")"),a=n.parse(this.text,{locations:!0,line:0,allowReturnOutsideFunction:!0}),this.mark(0,a,0,null)},b.prototype.fullNameArray=function(a){var b;for(b=[];"MemberExpression"===a.type;)b.unshift(a.property.name),a=a.object;return"Identifier"===a.type?b.unshift(a.name):b.unshift("*"),b},b.prototype.lookupKnownName=function(a){var b,c,d,e,f,g;if("CallExpression"===a.type||"NewExpression"===a.type)e=!1;else{if("Identifier"!==a.type&&"MemberExpression"!==a.type)throw new Error;e=!0}return c=this.fullNameArray(e?a:a.callee),d=c.join("."),(b=this.opts.functions[d])&&(e&&b.property||!e&&!b.property)?{name:d,anyobj:!1,fn:this.opts.functions[d]}:(f=c[c.length-1],c.length>1&&!((g="*."+f)in this.opts.functions)&&(g=null),g||(g="?."+f)in this.opts.functions||(g=null),null!==g&&(b=this.opts.functions[g])&&(e&&b.property||!e&&!b.property)?{name:f,anyobj:!0,fn:this.opts.functions[g]}:null)},b.prototype.getAcceptsRule=function(a){return{default:o.NORMAL}},b.prototype.getClasses=function(a){var b;return a.type in e?e[a.type].concat([a.type]):"CallExpression"===a.type||"NewExpression"===a.type||"Identifier"===a.type?(b=this.lookupKnownName(a),!b||b.fn.value&&b.fn.command?[a.type,"any-drop"]:b.fn.value?[a.type,"mostly-value"]:[a.type,"mostly-block"]):"FunctionExpression"===a.type?[a.type,"mostly-value","function-value"]:"UpdateExpression"===a.type?[a.type,"any-drop"]:null!=a.type.match(/Expression$/)?[a.type,"mostly-value"]:null!=a.type.match(/Declaration$/)?[a.type,"block-only"]:null!=a.type.match(/Statement$/)?[a.type,"mostly-block"]:[a.type,"any-drop"]},b.prototype.getPrecedence=function(a){var b,c;switch(a.type){case"BinaryExpression":case"LogicalExpression":return l[a.operator];case"AssignStatement":return 16;case"UnaryExpression":return a.prefix?null!=(b=l[a.operator])?b:4:null!=(c=l[a.operator])?c:3;case"CallExpression":case"NewExpression":return 2;case"MemberExpression":return 1;case"ExpressionStatement":return this.getPrecedence(a.expression);default:return 0}},b.prototype.lookupCategory=function(a){var b;switch(a.type){case"BinaryExpression":case"UnaryExpression":b=i.hasOwnProperty(a.operator)?"logic":"arithmetic";break;default:b=k[a.type]}return this.opts.categories[b]},b.prototype.getColor=function(a){var b,c;switch(a.type){case"ExpressionStatement":return this.getColor(a.expression);case"CallExpression":case"NewExpression":case"MemberExpression":case"Identifier":if(c=this.lookupKnownName(a)){if(c.fn.color)return c.fn.color;if(c.fn.value&&!c.fn.command)return this.opts.categories.value.color}}return b=this.lookupCategory(a),(null!=b?b.color:void 0)||"command"},b.prototype.getSocketLevel=function(a){return o.ANY_DROP},b.prototype.getBounds=function(a){var b,c,d,e,f;return"BlockStatement"===a.type?(b={start:{line:a.loc.start.line,column:a.loc.start.column+1},end:{line:a.loc.end.line,column:a.loc.end.column-1}},b.start.column+=(null!=(c=this.lines[b.start.line].slice(b.start.column).match(/^\s*/))?c:[""])[0].length,0===this.lines[b.end.line].slice(0,b.end.column).trim().length&&(b.end.line-=1,b.end.column=this.lines[b.end.line].length),b):(d=a.type,t.call(m,d)>=0&&(this.lines[a.loc.end.line],(e=this.lines[a.loc.end.line].slice(a.loc.end.column-1).indexOf(";"))>=0)?(f=this.lines[a.loc.end.line].slice(a.loc.end.column-1).match(/;\s*/)[0].length,{start:{line:a.loc.start.line,column:a.loc.start.column},end:{line:a.loc.end.line,column:a.loc.end.column+e+f-1}}):{start:{line:a.loc.start.line,column:a.loc.start.column},end:{line:a.loc.end.line,column:a.loc.end.column}})},b.prototype.getCaseIndentBounds=function(a){var b;return b={start:this.getBounds(a.consequent[0]).start,end:this.getBounds(a.consequent[a.consequent.length-1]).end},0===this.lines[b.start.line].slice(0,b.start.column).trim().length&&(b.start.line-=1,b.start.column=this.lines[b.start.line].length),0===this.lines[b.end.line].slice(0,b.end.column).trim().length&&(b.end.line-=1,b.end.column=this.lines[b.end.line].length),b},b.prototype.getIndentPrefix=function(a,b){var c;return a.end.line-a.start.line<1?f:(c=this.lines[a.start.line+1],c.slice(b,c.length-c.trimLeft().length))},b.prototype.isComment=function(a){return null!=a.match(/^\s*\/\/.*$/)},b.prototype.parseComment=function(a){return{sockets:[[a.match(/^\s*\/\//)[0].length,a.length]]}},b.prototype.handleButton=function(a,b,c){var d,e,f,g,h,i,j,k,l,m,o,p,q,r,s,u,v;if(t.call(c.classes,"IfStatement")>=0){for(u=n.parse(a,{locations:!0,line:0,allowReturnOutsideFunction:!0}).body[0],e=u,g=null;;){if("IfStatement"!==e.type)break;if(null==e.alternate){g=null;break}g={line:e.alternate.loc.start.line,column:e.alternate.loc.start.column},e=e.alternate}if(l=a.split("\n"),"add-button"===b)return null!=g?(g=l.slice(0,g.line).join("\n").length+g.column+1,a.slice(0,g).trimRight()+" if (__) "+a.slice(g).trimLeft()+" else {\n  __\n}"):a+" else {\n  __\n}";if("subtract-button"===b&&(null!=g?g=l.slice(0,g.line).join("\n").length+g.column+1:null!=e.loc.start&&(g=l.slice(0,e.loc.start.line).join("\n").length+e.loc.start.column+1),null!=g))return a.slice(0,g).trimRight().replace(/(\s*)else(\s*)+$/,"")}else if(t.call(c.classes,"CallExpression")>=0){if(u=n.parse(a,{line:0,allowReturnOutsideFunction:!0}).body[0],h=this.lookupKnownName(u.expression),d=u.expression.arguments.length,"add-button"===b){if(o=null!=h?h.fn.maxArgs:void 0,null==o&&(o=Infinity),d>=o)return;return d?(i=u.expression.arguments[d-1].end,a.slice(0,i).trimRight()+", __"+a.slice(i).trimLeft()):(i=u.expression.end-1,a.slice(0,i).trimRight()+"__"+a.slice(i).trimLeft())}if("subtract-button"===b){if(p=null!=h?h.fn.minArgs:void 0,null==p&&(p=0),d<=p)return;if(d>0)return i=u.expression.arguments[d-1].end,q=1===d?u.expression.arguments[0].start:u.expression.arguments[d-2].end,a.slice(0,q).trimRight()+a.slice(i).trimLeft()}}else if(t.call(c.classes,"FunctionDeclaration")>=0){if(u=n.parse(a,{line:0,allowReturnOutsideFunction:!0}).body[0],v=u.params.length,"add-button"===b){if(v)return k=u.params[v-1].end,a.slice(0,k).trimRight()+", __"+a.slice(k).trimLeft();if(null!=(m=a.match(/\((\s*)\)/)))return k=m.index+1,a.slice(0,k).trimRight()+"__"+a.slice(k).trimLeft()}else if("subtract-button"===b&&v>0)return k=u.params[v-1].end,s=1===v?u.params[0].start:u.params[v-2].end,a.slice(0,s).trimRight()+a.slice(k).trimLeft()}else if(t.call(c.classes,"ArrayExpression")>=0){if(u=n.parse(a,{line:0,allowReturnOutsideFunction:!0}).body[0],f=u.expression.elements.length,"add-button"===b)return f?(j=u.expression.elements[f-1].end,a.slice(0,j).trimRight()+", __"+a.slice(j).trimLeft()):(j=u.expression.end-1,a.slice(0,j).trimRight()+"__"+a.slice(j).trimLeft());if("subtract-button"===b&&f>0)return j=u.expression.elements[f-1].end,r=1===f?u.expression.elements[0].start:u.expression.elements[f-2].end,a.slice(0,r).trimRight()+a.slice(j).trimLeft()}},b.prototype.mark=function(a,b,c,d){var e,f,g,h,i,k,m,n,o,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H,I,J,K,L,M,N,O,P,Q,R,S,T,U,V,W,X,Y,Z,$,_,aa,ba,ca,da,ea,fa,ga,ha,ia,ja,ka,la,ma,na,oa,pa,qa,ra,sa,ta,ua,va,wa,xa,ya,za,Aa,Ba;switch(b.type){case"Program":for(V=b.body,ma=[],s=0,w=V.length;s<w;s++)za=V[s],ma.push(this.mark(a,za,c+1,null));return ma;case"Function":return this.jsBlock(b,c,d),this.mark(a,b.body,c+1,null);case"SequenceExpression":for(this.jsBlock(b,c,d),W=b.expressions,na=[],t=0,x=W.length;t<x;t++)q=W[t],na.push(this.jsSocketAndMark(a,q,c+1,null));return na;case"FunctionDeclaration":for(h={onFirstLine:!0},this.opts.lockZeroParamFunctions&&0===b.params.length||(h.addButton=""),b.params.length>0&&(h.subtractButton=""),this.jsBlock(b,c,d,h),this.mark(a,b.body,c+1,null),this.jsSocketAndMark(a,b.id,c+1,null,null,["no-drop"]),ea=b.params,oa=[],v=0,y=ea.length;v<y;v++)P=ea[v],oa.push(this.jsSocketAndMark(a,P,c+1,j));return oa;case"FunctionExpression":if(this.jsBlock(b,c,d),this.mark(a,b.body,c+1,null),null!=b.id&&this.jsSocketAndMark(a,b.id,c+1,null,null,["no-drop"]),b.params.length>0)return this.addSocket({bounds:{start:this.getBounds(b.params[0]).start,end:this.getBounds(b.params[b.params.length-1]).end},depth:c+1,precedence:0,dropdown:null,classes:["no-drop"],empty:""});if(!this.opts.lockZeroParamFunctions&&(null!=b.id?(M=this.getBounds(b.id).end,H=this.lines[M.line].slice(M.column).match(/^(\s*\()(\s*)\)/)):(M=this.getBounds(b).start,H=this.lines[M.line].slice(M.column).match(/^(\s*function\s*\()(\s*)\)/)),null!=H))return Q=this.addSocket({bounds:{start:{line:M.line,column:M.column+H[1].length},end:{line:M.line,column:M.column+H[1].length+H[2].length}},depth:c,precedence:0,dropdown:null,classes:["forbid-all","__function_param__"],empty:""});break;case"AssignmentExpression":return this.jsBlock(b,c,d),this.jsSocketAndMark(a,b.left,c+1,j),this.jsSocketAndMark(a,b.right,c+1,j);case"ReturnStatement":if(this.jsBlock(b,c,d),null!=b.argument)return this.jsSocketAndMark(a,b.argument,c+1,null);break;case"IfStatement":case"ConditionalExpression":for(h={addButton:"+"},b.alternate&&(h.subtractButton="-"),this.jsBlock(b,c,d,h),this.jsSocketAndMark(a,b.test,c+1,j),this.jsSocketAndMark(a,b.consequent,c+1,null),k=b.alternate,pa=[];null!=k;)"IfStatement"===k.type?(this.jsSocketAndMark(a,k.test,c+1,null),this.jsSocketAndMark(a,k.consequent,c+1,null),pa.push(k=k.alternate)):(this.jsSocketAndMark(a,k,c+1,10),pa.push(k=null));return pa;case"ForInStatement":return this.jsBlock(b,c,d),null!=b.left&&this.jsSocketAndMark(a,b.left,c+1,j,null,["foreach-lhs"]),null!=b.right&&this.jsSocketAndMark(a,b.right,c+1,10),this.mark(a,b.body,c+1);case"BreakStatement":case"ContinueStatement":if(this.jsBlock(b,c,d),null!=b.label)return this.jsSocketAndMark(a,b.label,c+1,null);break;case"ThrowStatement":return this.jsBlock(b,c,d),this.jsSocketAndMark(a,b.argument,c+1,null);case"ForStatement":return this.jsBlock(b,c,d),this.opts.categories.loops.beginner&&p(b)?this.jsSocketAndMark(a,b.test.right):(null!=b.init&&this.jsSocketAndMark(a,b.init,c+1,j,null,["for-statement-init"]),null!=b.test&&this.jsSocketAndMark(a,b.test,c+1,10),null!=b.update&&this.jsSocketAndMark(a,b.update,c+1,10,null,["for-statement-update"])),this.mark(a,b.body,c+1);case"BlockStatement":for(R=this.getIndentPrefix(this.getBounds(b),a),a+=R.length,this.addIndent({bounds:this.getBounds(b),depth:c,prefix:R}),fa=b.body,qa=[],G=0,z=fa.length;G<z;G++)za=fa[G],qa.push(this.mark(a,za,c+1,null));return qa;case"BinaryExpression":return this.jsBlock(b,c,d),this.jsSocketAndMark(a,b.left,c+1,l[b.operator]),this.jsSocketAndMark(a,b.right,c+1,l[b.operator]);case"UnaryExpression":if("-"!==(ga=b.operator)&&"+"!==ga||"Identifier"!==(ha=b.argument.type)&&"Literal"!==ha)return this.jsBlock(b,c,d),this.jsSocketAndMark(a,b.argument,c+1,this.getPrecedence(b));break;case"ExpressionStatement":return this.mark(a,b.expression,c+1,this.getBounds(b));case"Identifier":if("__"===b.name)return g=this.jsBlock(b,c,d),g.flagToRemove=!0;if(this.lookupKnownName(b))return this.jsBlock(b,c,d);break;case"CallExpression":case"NewExpression":for(u=this.lookupKnownName(b),h={},e=b.arguments.length,(null!=u?u.fn:void 0)?(xa=null!=u.fn.minArgs||null!=u.fn.maxArgs,J=null!=(ia=u.fn.minArgs)?ia:0,I=null!=(ja=u.fn.maxArgs)?ja:Infinity):(xa=this.opts.paramButtonsForUnknownFunctions&&(0!==e||!this.opts.lockZeroParamFunctions),J=0,I=Infinity),xa&&(e<I&&(h.addButton=""),e>J&&(h.subtractButton="")),this.jsBlock(b,c,d,h),u?u.anyobj&&"MemberExpression"===b.callee.type&&this.jsSocketAndMark(a,b.callee.object,c+1,j,null,null,null!=u&&null!=(ka=u.fn)?ka.objectDropdown:void 0):this.jsSocketAndMark(a,b.callee,c+1,j),la=b.arguments,r=K=0,A=la.length;K<A;r=++K)f=la[r],L=this.opts.lockFunctionDropIntoKnownParams&&(null!=u?u.fn:void 0)&&!(null!=u&&null!=(X=u.fn)&&null!=(Y=X.allowFunctionDrop)?Y[r]:void 0),i=L?["no-function-drop"]:null,this.jsSocketAndMark(a,f,c+1,j,null,i,null!=u&&null!=(Z=u.fn)&&null!=($=Z.dropdown)?$[r]:void 0);if(!u&&0===e&&!this.opts.lockZeroParamFunctions)return Q={line:b.callee.loc.end.line,column:b.callee.loc.end.column},Aa=this.lines[Q.line].slice(Q.column).match(/^\s*\(/)[0],Q.column+=Aa.length,o={line:Q.line,column:Q.column},ya=this.lines[Q.line].slice(Q.column).match(/^(\s*)\)/),null!=ya&&(o.column+=ya[1].length),this.addSocket({bounds:{start:Q,end:o},depth:c+1,precedence:j,dropdown:null,classes:["mostly-value"],empty:""});break;case"MemberExpression":if(this.jsBlock(b,c,d),u=this.lookupKnownName(b),u||this.jsSocketAndMark(a,b.property,c+1),!u||u.anyobj)return this.jsSocketAndMark(a,b.object,c+1);break;case"UpdateExpression":return this.jsBlock(b,c,d),this.jsSocketAndMark(a,b.argument,c+1);case"VariableDeclaration":for(this.jsBlock(b,c,d),_=b.declarations,ra=[],N=0,B=_.length;N<B;N++)m=_[N],ra.push(this.mark(a,m,c+1));return ra;case"VariableDeclarator":if(this.jsSocketAndMark(a,b.id,c),null!=b.init)return this.jsSocketAndMark(a,b.init,c,j);break;case"LogicalExpression":return this.jsBlock(b,c,d),this.jsSocketAndMark(a,b.left,c+1,this.getPrecedence(b)),this.jsSocketAndMark(a,b.right,c+1,this.getPrecedence(b));case"WhileStatement":case"DoWhileStatement":return this.jsBlock(b,c,d),this.jsSocketAndMark(a,b.body,c+1),this.jsSocketAndMark(a,b.test,c+1);case"ObjectExpression":for(this.jsBlock(b,c,d),aa=b.properties,sa=[],O=0,C=aa.length;O<C;O++)S=aa[O],this.jsSocketAndMark(a,S.key,c+1),sa.push(this.jsSocketAndMark(a,S.value,c+1));return sa;case"SwitchStatement":for(this.jsBlock(b,c,d),this.jsSocketAndMark(a,b.discriminant,c+1),ba=b.cases,ta=[],T=0,D=ba.length;T<D;T++)Ba=ba[T],ta.push(this.mark(a,Ba,c+1,null));return ta;case"SwitchCase":if(null!=b.test&&this.jsSocketAndMark(a,b.test,c+1),b.consequent.length>0){for(d=this.getCaseIndentBounds(b),R=this.getIndentPrefix(this.getBounds(b),a),a+=R.length,this.addIndent({bounds:d,depth:c+1,prefix:R}),ca=b.consequent,ua=[],U=0,E=ca.length;U<E;U++)za=ca[U],ua.push(this.mark(a,za,c+2));return ua}break;case"TryStatement":if(this.jsBlock(b,c,d),this.jsSocketAndMark(a,b.block,c+1,null),null!=b.handler&&(null!=b.handler.guard&&this.jsSocketAndMark(a,b.handler.guard,c+1,null),null!=b.handler.param&&this.jsSocketAndMark(a,b.handler.param,c+1,null),this.jsSocketAndMark(a,b.handler.body,c+1,null)),null!=b.finalizer)return this.jsSocketAndMark(a,b.finalizer,c+1,null);break;case"ArrayExpression":for(h={addButton:""},b.elements.length>0&&(h.subtractButton=""),this.jsBlock(b,c,d,h),da=b.elements,va=[],wa=0,F=da.length;wa<F;wa++)n=da[wa],null!=n?va.push(this.jsSocketAndMark(a,n,c+1,null)):va.push(void 0);return va;case"Literal":return null;default:return console.log("Unrecognized",b)}},b.prototype.jsBlock=function(a,b,c,d){return this.addBlock({bounds:null!=c?c:this.getBounds(a),depth:b,precedence:this.getPrecedence(a),color:this.getColor(a),classes:this.getClasses(a),socketLevel:this.getSocketLevel(a),buttons:d})},b.prototype.jsSocketAndMark=function(a,b,c,d,e,f,g,h){return"BlockStatement"!==b.type&&this.addSocket({bounds:null!=e?e:this.getBounds(b),depth:c,precedence:d,classes:null!=f?f:[],dropdown:g,empty:h}),this.mark(a,b,c+1,e)},b}(q.Parser),g.parens=function(a,b,c,d){if(!(t.call(c.classes,"__comment__")>=0)){for(b("socket"===(null!=d?d.type:void 0)||null==d&&t.call(c.classes,"mostly-value")>=0||t.call(c.classes,"value-only")>=0||t.call(c.classes,"ends-with-brace")>=0||"document"===c.type?b().replace(/;?\s*$/,""):b().replace(/;?\s*$/,";"));;){if(null==a().match(/^\s*\(/)||null==b().match(/\)\s*/))break;a(a().replace(/^\s*\(\s*/,"")),b(b().replace(/\s*\)\s*$/,""))}return null===d||"socket"!==d.type||d.precedence>c.precedence?void 0:(a("("+a()),b(b()+")"))}},g.drop=function(a,b,c){var d,e;if("socket"===b.type){if(t.call(b.classes,"lvalue")>=0)return t.call(a.classes,"Value")>=0&&(null!=(d=a.properties)?d.length:void 0)>0?o.ENCOURAGE:o.FORBID;if(t.call(b.classes,"no-drop")>=0)return o.FORBID;if(t.call(b.classes,"no-function-drop")>=0&&t.call(a.classes,"function-value")>=0)return o.FORBID;if(t.call(b.classes,"property-access")>=0)return t.call(a.classes,"works-as-method-call")>=0?o.ENCOURAGE:o.FORBID;if(t.call(a.classes,"value-only")>=0||t.call(a.classes,"mostly-value")>=0||t.call(a.classes,"any-drop")>=0||t.call(b.classes,"for-statement-init")>=0||t.call(a.classes,"mostly-block")>=0&&t.call(b.classes,"for-statement-update")>=0)return o.ENCOURAGE;if(t.call(a.classes,"mostly-block")>=0)return o.DISCOURAGE}else if("indent"===(e=b.type)||"document"===e){if(t.call(a.classes,"block-only")>=0||t.call(a.classes,"mostly-block")>=0||t.call(a.classes,"any-drop")>=0||"document"===a.type)return o.ENCOURAGE;if(t.call(a.classes,"mostly-value")>=0)return o.DISCOURAGE}return o.DISCOURAGE},p=function(a){var b,c;if(null==a.init||null==a.test||null==a.update)return!1;if("VariableDeclaration"===a.init.type)c=a.init.declarations[0].id.name;else{if("AssignmentExpression"!==a.init.type||"="!==a.operator||"Identifier"!==a.left.type)return!1;c=a.left.name}return"BinaryExpression"===a.test.type&&"<"===a.test.operator&&"Identifier"===a.test.left.type&&a.test.left.name===c&&("Literal"===(b=a.test.right.type)||"Identifier"===b)&&"UpdateExpression"===a.update.type&&"++"===a.update.operator&&"Identifier"===a.update.argument.type&&a.update.argument.name===c},g.empty="__",g.emptyIndent="",g.startComment="/*",g.endComment="*/",g.startSingleLineComment="//",g.getDefaultSelectionRange=function(a){var b,c,d;return d=0,b=a.length,a[0]!==a[a.length-1]||'"'!==(c=a[0])&&"'"!==c&&"/"!==c||(d+=1,b-=1),{start:d,end:b}},b.exports=q.wrapParser(g)},{"../../vendor/acorn":35,"../helper.coffee":28,"../model.coffee":31,"../parser.coffee":33}],30:[function(a,b,c){b.exports={Editor:a("./controller.coffee").Editor}},{"./controller.coffee":26}],31:[function(a,b,c){var d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B=function(a,b){function c(){this.constructor=a}for(var d in b)C.call(b,d)&&(a[d]=b[d]);return c.prototype=b.prototype,a.prototype=new c,a.__super__=b.prototype,a},C={}.hasOwnProperty;z=a("./helper.coffee"),z.NORMAL,z.FORBID,g={preserveEmpty:!0},y=0,Function.prototype.trigger=function(a,b,c){return Object.defineProperty(this.prototype,a,{get:b,set:c})},c.isTreeValid=function(a){var b,c,d,e,f,g,h,i,j;for(j=b=a.start.next,i=[];;){if(j=j.next,d=b,null==(b=b.next))throw window._droplet_debug_lastHare=d,new Error("Ran off the end of the document before EOF");if(d!==b.prev)throw new Error("Linked list is not properly bidirectional");if(b===a.end){if(i.length>0)throw new Error("Document ended before: "+function(){var a,b,d;for(d=[],a=0,b=i.length;a<b;a++)c=i[a],d.push(c.type);return d}().join(","));break}if(b instanceof u)i.push(b.container);else if(b instanceof k){if(i[i.length-1]!==b.container)throw new Error("Stack does not align "+(null!=(e=i[i.length-1])?e.type:void 0)+" != "+(null!=(f=b.container)?f.type:void 0));i.pop()}if(d=b,null==(b=b.next))throw window._droplet_debug_lastHare=d,new Error("Ran off the end of the document before EOF");if(d!==b.prev)throw new Error("Linked list is not properly bidirectional");if(b===a.end){if(i.length>0)throw new Error("Document ended before: "+function(){var a,b,d;for(d=[],a=0,b=i.length;a<b;a++)c=i[a],d.push(c.type);return d}().join(","));break}if(b instanceof u)i.push(b.container);else if(b instanceof k){if(i[i.length-1]!==b.container)throw new Error("Stack does not align "+(null!=(g=i[i.length-1])?g.type:void 0)+" != "+(null!=(h=b.container)?h.type:void 0));i.pop()}if(j===b)throw new Error("Linked list loops")}return!0},q=function(){function a(a,b){this.type=a,this.location=null,this.list=b.clone(),
this.start=b.start.getLocation(),this.end=b.end.getLocation()}return a.prototype.toString=function(){return JSON.stringify({location:this.location.toString(),list:this.list.stringify(),start:this.start.toString(),end:this.end.toString(),type:this.type})},a}(),r=function(){function a(a,b,c,d,e,f){this.beforeStart=a,this.before=b,this.beforeEnd=c,this.afterStart=d,this.after=e,this.afterEnd=f,this.type="replace"}return a.prototype.toString=function(){return JSON.stringify({beforeStart:this.beforeStart.toString(),before:this.before.stringify(),beforeEnd:this.beforeEnd.toString(),afterStart:this.afterStart.toString(),after:this.after.stringify(),afterEnd:this.afterEnd.toString(),type:this.type})},a}(),c.List=n=function(){function a(a,b){this.start=a,this.end=b,this.id=++y,this.type="list"}return a.prototype.hasParent=function(a){return!1},a.prototype.contains=function(a){var b;for(a instanceof f&&(a=a.start),b=this.start;b!==this.end;){if(b===a)return!0;b=b.next}return a===this.end},a.prototype.getDocument=function(){return this.start.getDocument()},a.prototype.insert=function(b,c,d){var e,f,g,h,i,j,k,l;switch(null==d&&(d=[]),k=[c.start,c.end],f=k[0],h=k[1],l=d.map(function(a){return function(b){return a.getFromLocation(b)}}(this)),b.type){case"indentStart":g=b.container.end.prev,"newline"===g.type?b=b.next:(f=new p,z.connect(f,c.start));break;case"blockEnd":f=new p,z.connect(f,c.start);break;case"documentStart":b.next!==b.container.end&&(h=new p,z.connect(c.end,h))}return i=b.getLocation(),c=new a(f,h),e=b.next,z.connect(b,c.start),b instanceof u?c.setParent(b.container):c.setParent(b.parent),z.connect(c.end,e),c.notifyChange(),null!=i?(j=new q("insert",c),j.location=i,d.forEach(function(a,b){return a.set(l[b].getLocation())})):j=null,j},a.prototype.remove=function(b,c){var d,e,f,g,h,i,j,k,l;for(null==c&&(c=[]),d=b.start.prev,e=b.end.next;!("newline"!==(null!=d?d.type:void 0)||void 0!==(h=null!=e?e.type:void 0)&&"newline"!==h&&"indentEnd"!==h&&"documentEnd"!==h||"indentStart"===(null!=(i=d.prev)?i.type:void 0)&&d.prev.container.end===e);)d=d.prev;for(;"newline"===(null!=e?e.type:void 0)&&("newline"===(null!=e&&null!=(j=e.next)?j.type:void 0)||void 0===(k=null!=d?d.type:void 0)||"documentStart"===k);)e=e.next;return d=d.next,e=e.prev,b=new a(d,e),b.notifyChange(),l=c.map(function(a){return function(b){return a.getFromLocation(b)}}(this)).map(function(a){return function(a){return b.contains(a)?b.start.prev:a}}()),g=new q("remove",b),f=b.start.prev,z.connect(b.start.prev,b.end.next),b.start.prev=b.end.next=null,b.setParent(null),g.location=f.getLocation(),c.forEach(function(a){return function(a,b){return a.set(l[b].getLocation())}}()),g},a.prototype.replace=function(a,b,c){var d,e,f,g,h,i;return null==c&&(c=[]),i=c.map(function(a){return function(b){return a.getFromLocation(b).getTextLocation()}}(this)),g=a.start.getLocation(),f=a.end.getLocation(),a.stringify().length,h=a.start.parent,z.connect(a.start.prev,b.start),z.connect(b.end,a.end.next),a.setParent(null),b.setParent(h),b.notifyChange(),e=b.start.getLocation(),d=b.end.getLocation(),c.forEach(function(a){return function(b,c){return b.set(a.getFromTextLocation(i[c]).getLocation())}}(this)),new r(g,a.clone(),f,e,b.clone(),d)},a.prototype.perform=function(b,c,d){var e,f,g,h,i,j;if(null==d&&(d=[]),b instanceof q){if("insert"===b.type!=("forward"===c))return g=new a(this.getFromLocation(b.start),this.getFromLocation(b.end)),g.notifyChange(),j=d.map(function(a){return function(b){return a.getFromLocation(b)}}(this)).map(function(a){return function(a){return g.contains(a)?g.start.prev:a}}()),z.connect(g.start.prev,g.end.next),d.forEach(function(a,b){return a.set(j[b].getLocation())}),b;if("remove"===b.type!=("forward"===c))return j=d.map(function(a){return function(b){return a.getFromLocation(b)}}(this)),g=b.list.clone(),f=this.getFromLocation(b.location),e=f.next,z.connect(f,g.start),z.connect(g.end,e),f instanceof u?g.setParent(f.container):g.setParent(f.parent),g.notifyChange(),d.forEach(function(a,b){return a.set(j[b].getLocation())}),b}else if("replace"===b.type)return i=d.map(function(a){return function(b){return a.getFromLocation(b).getTextLocation()}}(this)),"forward"===c?(f=new a(this.getFromLocation(b.beforeStart),this.getFromLocation(b.beforeEnd)),e=b.after.clone()):(f=new a(this.getFromLocation(b.afterStart),this.getFromLocation(b.afterEnd)),e=b.before.clone()),h=f.start.parent,z.connect(f.start.prev,e.start),z.connect(e.end,f.end.next),e.setParent(h),f.setParent(null),e.notifyChange(),d.forEach(function(a){return function(b,c){return b.set(a.getFromTextLocation(i[c]).getLocation())}}(this)),null},a.prototype.notifyChange=function(){return this.traverseOneLevel(function(a){return a.notifyChange()})},a.prototype.traverseOneLevel=function(a){return A(this.start,a,this.end)},a.prototype.isFirstOnLine=function(){var a,b,c,d,e;return(a=this.start.prev)===(null!=(b=this.parent)?b.start:void 0)||a===(null!=(c=this.parent)&&null!=(d=c.parent)?d.start:void 0)||null===a||"newline"===(null!=(e=this.start.prev)?e.type:void 0)},a.prototype.isLastOnLine=function(){var a,b,c,d,e,f;return(a=this.end.next)===(null!=(b=this.parent)?b.end:void 0)||a===(null!=(c=this.parent)&&null!=(d=c.parent)?d.end:void 0)||null===a||"newline"===(e=null!=(f=this.end.next)?f.type:void 0)||"indentStart"===e||"indentEnd"===e},a.prototype.getReader=function(){return{type:"document",classes:[]}},a.prototype.setParent=function(a){return A(this.start,function(b){return b.setParent(a)},this.end)},a.prototype.clone=function(){var b,c,d;return b=d={},this.traverseOneLevel(function(a){return function(a){var c;return a instanceof f?(c=a.clone(),z.connect(b,c.start),b=c.end):b=z.connect(b,a.clone())}}()),d=d.next,d.prev=null,c=new a(d,b),c.correctParentTree(),c},a.prototype.correctParentTree=function(){return this.traverseOneLevel(function(a){return function(b){if(b.parent=a,b instanceof f)return b.start.parent=b.end.parent=a,b.correctParentTree()}}(this))},a.prototype.stringify=function(a){var b,c;for(null==a&&(a=g),b=this.start,c=b.stringify(a);b!==this.end;)b=b.next,c+=b.stringify(a);return c},a.prototype.stringifyInPlace=function(){var a,b,c,d;for(d="",b=[],a=this.start;;){if(a instanceof m?b.push(a.container.prefix):a instanceof l&&b.pop(),d+=a instanceof p?"\n"+(null!=(c=a.specialIndent)?c:b.join("")):a.stringify(),a===this.end)break;a=a.next}return d},a}(),c.Container=f=function(a){function b(){null==this.start&&null==this.end&&(this.start=new u(this),this.end=new k(this),this.type="container"),this.id=++y,this.parent=null,this.version=0,z.connect(this.start,this.end),this.ephemeral=!1,this.lineMarkStyles=[]}return B(b,a),b.prototype.getLocation=function(){var a;return a=this.start.getLocation(),a.type=this.type,a},b.prototype.getTextLocation=function(){var a;return a=this.start.getTextLocation(),a.type=this.type,a},b.prototype._cloneEmpty=function(){return new b},b.prototype._firstChild=function(){var a;for(a=this.start.next;a!==this.end;){if(a instanceof u)return a.container;a=a.next}return null},b.prototype.getReader=function(){return{id:this.id,type:this.type,precedence:this.precedence,classes:this.classes,parseContext:this.parseContext}},b.prototype.setParent=function(a){return this.parent=this.start.parent=this.end.parent=a},b.prototype.hasParent=function(a){var b;for(b=this;b!==a&&null!==b;)b=b.parent;return b===a},b.prototype.getLinesToParent=function(){var a,b;for(a=this.start,b=0;a!==this.parent.start;)"newline"===a.type&&b++,a=a.prev;return b},b.prototype.clone=function(){var a,c;return c=this._cloneEmpty(),a=c.start,this.traverseOneLevel(function(c){return function(c){var d;return c instanceof b?(d=c.clone(),z.connect(a,d.start),a=d.end):a=z.connect(a,c.clone())}}()),z.connect(a,c.end),c.correctParentTree(),c},b.prototype.rawReplace=function(a){return null!=a.start.prev&&z.connect(a.start.prev,this.start),null!=a.end.next&&z.connect(this.end,a.end.next),this.start.parent=this.end.parent=this.parent=a.parent,a.parent=a.start.parent=a.end.parent=null,a.start.prev=a.end.next=null,this.notifyChange()},b.prototype.getNewlineBefore=function(a){var b,c;for(b=this.start,c=0;c!==a&&b!==this.end;)b=b.next,"newline"===b.type&&c++;return b},b.prototype.getNewlineAfter=function(a){var b;for(b=this.getNewlineBefore(a).next;"newline"!==start.type&&b!==this.end;)b=b.next;return b},b.prototype.getLeadingText=function(){return"text"===this.start.next.type?this.start.next.value:""},b.prototype.getTrailingText=function(){return"text"===this.end.prev.type?this.end.prev.value:""},b.prototype.setLeadingText=function(a){if(null!=a){if("text"===this.start.next.type)return 0===a.length?this.start.next.remove():this.start.next.value=a;if(0!==a.length)return this.start.insert(new w(a))}},b.prototype.setTrailingText=function(a){if(null!=a){if("text"===this.end.prev.type)return 0===a.length?this.end.prev.remove():this.end.prev.value=a;if(0!==a.length)return this.end.prev.insert(new w(a))}},b.prototype.serialize=function(){var a;return a=this._serialize_header(),this.traverseOneLevel(function(b){return a+=b.serialize()}),a+=this._serialize_footer()},b.prototype._serialize_header="<container>",b.prototype._serialize_header="</container>",b.prototype.contents=function(){var a;return a=this.clone(),a.start.next===a.end?null:(a.start.next.prev=null,a.end.prev.next=null,a.start.next)},b.prototype.notifyChange=function(){var a,b;for(a=this,b=[];null!=a;)a.version++,b.push(a=a.parent);return b},b.prototype.getBlockOnLine=function(a){var b,c,d;for(b=this.start,c=0,d=[];c!==a&&null!=b;){switch(b.type){case"newline":c++;break;case"blockStart":d.push(b.container);break;case"blockEnd":d.pop()}b=b.next}for(;"newline"===(null!=b?b.type:void 0)||b instanceof u&&"blockStart"!==b.type;)b=b.next;return"blockStart"===(null!=b?b.type:void 0)&&d.push(b.container),d[d.length-1]},b.prototype.traverseOneLevel=function(a){if(this.start.next!==this.end)return A(this.start.next,a,this.end.prev)},b.prototype.addLineMark=function(a){return this.lineMarkStyles.push(a)},b.prototype.removeLineMark=function(a){var b;return this.lineMarkStyles=function(){var c,d,e,f;for(e=this.lineMarkStyles,f=[],c=0,d=e.length;c<d;c++)b=e[c],b.tag!==a&&f.push(b);return f}.call(this)},b.prototype.clearLineMarks=function(){return this.lineMarkStyles=[]},b.prototype.getFromLocation=function(a){var b,c,d;for(b=this.start,c=0,d=a.count;0<=d?c<d:c>d;0<=d?c++:c--)b=b.next;if(a.type===b.type)return b;if(a.type===b.container.type)return b.container;throw new Error("Could not retrieve location "+a)},b.prototype.getFromTextLocation=function(a){var b,c,d,e,f,g,h;for(d=this.start.next,b=d,h=0;null!=d&&h!==a.row;)(d=d.next)instanceof p&&(h+=1);if(null==d)return this.end;for(b=d,d instanceof p?(c=d.stringify().length-1,d=d.next):c=d.stringify().length;!(null==d||d instanceof p||c>=a.col);)c+=d.stringify().length,d=d.next;if(c<a.col)return null!=d?d:this.end;if(b=d,null!=a.length){for(;!(null==d||d.stringify().length>0||(null!=(e=d.container)?e:d).stringify().length===a.length);)d=d.next;null!=d&&(null!=(f=d.container)?f:d).stringify().length===a.length?b=d:d=b}if(null!=a.type){for(;!(null==d||d.stringify().length>0||d.type===a.type||d.container.type===a.type);)d=d.next;(null!=d&&null!=(g=d.container)?g.type:void 0)===a.type&&(d=d.container),(null!=d?d.type:void 0)===a.type&&(b=d)}return b},b}(n),c.Token=x=function(){function a(){this.id=++y,this.prev=this.next=this.parent=null,this.version=0}return a.prototype.getLinesToParent=function(){var a,b;for(a=this,b=0;a!==this.parent.start;)"newline"===a.type&&b++,a=a.prev;return b},a.prototype.setParent=function(a){this.parent=a},a.prototype.hasParent=function(a){var b;for(b=this;b!==a&&null!==b;)b=b.parent;return b===a},a.prototype.insert=function(a){return a.next=this.next,a.prev=this,this.next.prev=a,this.next=a,a.parent=this instanceof u?this.container:parent,a},a.prototype.remove=function(){return null!=this.prev?z.connect(this.prev,this.next):null!=this.next&&(this.next.prev=null),this.prev=this.next=this.parent=null},a.prototype.notifyChange=function(){var a;for(a=this;null!=a;)a.version++,a=a.parent;return null},a.prototype.isFirstOnLine=function(){var a,b;return this.prev===(null!=(a=this.parent)?a.start:void 0)||"newline"===(null!=(b=this.prev)?b.type:void 0)},a.prototype.isLastOnLine=function(){var a,b,c;return this.next===(null!=(a=this.parent)?a.end:void 0)||"newline"===(b=null!=(c=this.next)?c.type:void 0)||"indentEnd"===b},a.prototype.clone=function(){return new a},a.prototype.getSerializedLocation=function(){var a,b;for(b=this,a=0;null!==b;)a++,b=b.prev;return a},a.prototype.getIndent=function(){var a,b;for(a=this,b="";null!=a;)"indent"===a.type&&(b=a.prefix+b),a=a.parent;return b},a.prototype.getTextLocation=function(){var a,b;for(b=new v,a=this.prev,b.type=this.type,b.length=this instanceof u||this instanceof k?this.container.stringify().length:this.stringify().length;!(null==a||a instanceof p);)b.col+=a.stringify().length,a=a.prev;for(null!=a&&(b.col+=a.stringify().length-1);null!=a;)a instanceof p&&(b.row+=1),a=a.prev;return b},a.prototype.getDocument=function(){var a,b;for(a=null!=(b=this.container)?b:this;!(null==a||a instanceof h);)a=a.parent;return a},a.prototype.getLocation=function(){var a,b,c;if(a=0,c=this,null==(b=this.getDocument()))return null;for(;c!==b.start;)c=c.prev,a+=1;return new o(a,this.type)},a.prototype.stringify=function(){return""},a.prototype.serialize=function(){return""},a}(),c.Location=o=function(){function a(a,b){this.count=a,this.type=b}return a.prototype.toString=function(){return this.count+", "+this.type},a.prototype.set=function(a){return this.count=a.count,this.type=a.type},a.prototype.is=function(b){return b instanceof a||(b=b.getLocation()),b.count===this.count&&b.type===this.type},a.prototype.clone=function(){return new a(this.count,this.type)},a}(),c.TextLocation=v=function(){function a(a,b,c,d){this.row=null!=a?a:0,this.col=null!=b?b:0,this.type=null!=c?c:null,this.length=null!=d?d:null}return a.prototype.toString=function(){return"("+this.row+", "+this.col+", "+this.type+", "+this.length+")"},a.prototype.set=function(a){return this.row=a.row,this.col=a.col,this.type=a.type,this.length=a.length},a.prototype.is=function(b){var c;return b instanceof a||(b=b.getLocation()),c=b.row===this.row&&b.col===this.col&&(null!=this.type&&null!=b.type?c=c&&this.type===b.type:void 0),null!=this.length&&null!=b.length&&(c=c&&this.length===b.length),c},a}(),c.StartToken=u=function(a){function b(a){this.container=a,b.__super__.constructor.apply(this,arguments),this.markup="begin"}return B(b,a),b.prototype.insert=function(a){return(a instanceof b||a instanceof k)&&console.warn('"insert"-ing a container can cause problems'),a.next=this.next,a.prev=this,this.next.prev=a,this.next=a,a.parent=this.container,a},b.prototype.serialize=function(){return"<container>"},b}(x),c.EndToken=k=function(a){function b(a){this.container=a,b.__super__.constructor.apply(this,arguments),this.markup="end"}return B(b,a),b.prototype.insert=function(a){return(a instanceof u||a instanceof b)&&console.warn('"insert"-ing a container can cause problems'),a.next=this.next,a.prev=this,this.next.prev=a,this.next=a,a.parent=this.container.parent,a},b.prototype.serialize=function(){return"</container>"},b}(x),c.BlockStartToken=e=function(a){function b(a){this.container=a,b.__super__.constructor.apply(this,arguments),this.type="blockStart"}return B(b,a),b}(u),c.BlockEndToken=d=function(a){function b(a){this.container=a,b.__super__.constructor.apply(this,arguments),this.type="blockEnd"}return B(b,a),b.prototype.serialize=function(){return"</block>"},b}(k),c.Block=function(a){function b(a,c,f,g,h,i){this.precedence=null!=a?a:0,this.color=null!=c?c:"blank",this.socketLevel=null!=f?f:z.ANY_DROP,this.classes=null!=g?g:[],this.parseContext=h,this.buttons=null!=i?i:{},this.start=new e(this),this.end=new d(this),this.type="block",b.__super__.constructor.apply(this,arguments)}return B(b,a),b.prototype.nextSibling=function(){var a,b;for(a=this.end.next,b=a.parent;a&&a.container!==b;){if(a instanceof u)return a.container;a=a.next}return null},b.prototype._cloneEmpty=function(){var a;return a=new b(this.precedence,this.color,this.socketLevel,this.classes,this.parseContext,this.buttons),a.currentlyParenWrapped=this.currentlyParenWrapped,a},b.prototype._serialize_header=function(){var a,b;return'<block precedence="'+this.precedence+'" color="'+this.color+'" socketLevel="'+this.socketLevel+'" classes="'+(null!=(a=null!=(b=this.classes)&&"function"==typeof b.join?b.join(" "):void 0)?a:"")+'" >'},b.prototype._serialize_footer=function(){return"</block>"},b}(f),c.SocketStartToken=t=function(a){function b(a){this.container=a,b.__super__.constructor.apply(this,arguments),this.type="socketStart"}return B(b,a),b}(u),c.SocketEndToken=s=function(a){function b(a){this.container=a,b.__super__.constructor.apply(this,arguments),this.type="socketEnd"}return B(b,a),b.prototype.stringify=function(a){return null==a&&(a=g),a.preserveEmpty&&this.prev===this.container.start||"text"===this.prev.type&&""===this.prev.value?this.container.emptyString:""},b}(k),c.Socket=function(a){function b(a,c,d,e,f,g){this.emptyString=a,this.precedence=null!=c?c:0,this.handwritten=null!=d&&d,this.classes=null!=e?e:[],this.dropdown=null!=f?f:null,this.parseContext=null!=g?g:null,this.start=new t(this),this.end=new s(this),this.type="socket",b.__super__.constructor.apply(this,arguments)}return B(b,a),b.prototype.textContent=function(){var a,b;for(a=this.start.next,b="";a!==this.end;)b+=a.stringify(),a=a.next;return b},b.prototype.hasDropdown=function(){return null!=this.dropdown&&this.isDroppable()},b.prototype.editable=function(){return!(null!=this.dropdown&&this.dropdown.dropdownOnly)&&this.isDroppable()},b.prototype.isDroppable=function(){return this.start.next===this.end||"text"===this.start.next.type},b.prototype._cloneEmpty=function(){return new b(this.emptyString,this.precedence,this.handwritten,this.classes,this.dropdown,this.parseContext)},b.prototype._serialize_header=function(){var a,b,c,d;return'<socket precedence="'+this.precedence+'" handwritten="'+this.handwritten+'" classes="'+(null!=(a=null!=(b=this.classes)&&"function"==typeof b.join?b.join(" "):void 0)?a:"")+'"'+(null!=this.dropdown?' dropdown="'+(null!=(c=null!=(d=this.dropdown)&&"function"==typeof d.join?d.join(" "):void 0)?c:"")+'"':"")+">"},b.prototype._serialize_footer=function(){return"</socket>"},b}(f),c.IndentStartToken=m=function(a){function b(a){this.container=a,b.__super__.constructor.apply(this,arguments),this.type="indentStart"}return B(b,a),b}(u),c.IndentEndToken=l=function(a){function b(a){this.container=a,b.__super__.constructor.apply(this,arguments),this.type="indentEnd"}return B(b,a),b.prototype.stringify=function(a){return null==a&&(a=g),a.preserveEmpty&&this.prev.prev===this.container.start?this.container.emptyString:""},b.prototype.serialize=function(){return"</indent>"},b}(k),c.Indent=function(a){function b(a,c,d,e){this.emptyString=a,this.prefix=null!=c?c:"",this.classes=null!=d?d:[],this.parseContext=null!=e?e:null,this.start=new m(this),this.end=new l(this),this.type="indent",this.depth=this.prefix.length,b.__super__.constructor.apply(this,arguments)}return B(b,a),b.prototype._cloneEmpty=function(){return new b(this.emptyString,this.prefix,this.classes,this.parseContext)},b.prototype.firstChild=function(){return this._firstChild()},b.prototype._serialize_header=function(){var a,b;return'<indent prefix="'+this.prefix+'" classes="'+(null!=(a=null!=(b=this.classes)&&"function"==typeof b.join?b.join(" "):void 0)?a:"")+'">'},b.prototype._serialize_footer=function(){return"</indent>"},b}(f),c.DocumentStartToken=j=function(a){function b(a){this.container=a,b.__super__.constructor.apply(this,arguments),this.type="documentStart"}return B(b,a),b.prototype.serialize=function(){return"<document>"},b}(u),c.DocumentEndToken=i=function(a){function b(a){this.container=a,b.__super__.constructor.apply(this,arguments),this.type="documentEnd"}return B(b,a),b.prototype.serialize=function(){return"</document>"},b}(k),c.Document=h=function(a){function b(a,c){this.parseContext=a,this.opts=null!=c?c:{},this.start=new j(this),this.end=new i(this),this.classes=["__document__"],this.type="document",b.__super__.constructor.apply(this,arguments)}return B(b,a),b.prototype._cloneEmpty=function(){return new b(this.parseContext,this.opts)},b.prototype.firstChild=function(){return this._firstChild()},b.prototype._serialize_header=function(){return"<document>"},b.prototype._serialize_footer=function(){return"</document>"},b}(f),c.TextToken=w=function(a){function b(a){this._value=a,b.__super__.constructor.apply(this,arguments),this.type="text"}return B(b,a),b.trigger("value",function(){return this._value},function(a){return this._value=a,this.notifyChange()}),b.prototype.stringify=function(){return this._value},b.prototype.serialize=function(){return z.escapeXMLText(this._value)},b.prototype.clone=function(){return new b(this._value)},b}(x),c.NewlineToken=p=function(a){function b(a){this.specialIndent=a,b.__super__.constructor.apply(this,arguments),this.type="newline"}return B(b,a),b.prototype.stringify=function(){var a;return"\n"+(null!=(a=this.specialIndent)?a:this.getIndent())},b.prototype.serialize=function(){return"\n"},b.prototype.clone=function(){return new b(this.specialIndent)},b}(x),A=function(a,b,c){for(;;){if(a instanceof u?(b(a.container),a=a.container.end):b(a),a===c)return;a=a.next}}},{"./helper.coffee":28}],32:[function(a,b,c){var d,e,f,g,h,i;h=a("./languages/javascript.coffee"),e=a("./languages/coffee.coffee"),d=a("./languages/c.coffee"),g=a("./languages/java.coffee"),i=a("./languages/python.coffee"),f=a("./languages/html.coffee"),b.exports={javascript:h,coffee:e,coffeescript:e,c:d,c_cpp:d,java:g,python:i,html:f}},{"./languages/c.coffee":3,"./languages/coffee.coffee":3,"./languages/html.coffee":3,"./languages/java.coffee":3,"./languages/javascript.coffee":29,"./languages/python.coffee":3}],33:[function(a,b,c){var d,e,f,g,h,i,j,k,l,m,n=function(a,b){function c(){this.constructor=a}for(var d in b)o.call(b,d)&&(a[d]=b[d]);return c.prototype=b.prototype,a.prototype=new c,a.__super__=b.prototype,a},o={}.hasOwnProperty;i=a("./helper.coffee"),k=a("./model.coffee"),l=a("sax"),f=function(a,b){var c,d;if(null==a)return b;for(c in b)d=b[c],c in a||(a[c]=d);return a},j=function(a,b){return a.slice(0,b.length)===b},c.ParserFactory=e=function(){function a(a){this.opts=null!=a?a:{}}return a.prototype.createParser=function(a){return new d(a,this.opts)},a}(),c.Parser=d=function(){function a(a,b){this.text=a,this.opts=null!=b?b:{},this.originalText=this.text,this.markup=[]}return a.prototype._parse=function(a){var b;return a=f(a,{wrapAtRoot:!0,preserveEmpty:!0}),this.markRoot(a.context),this.sortMarkup(),b=this.applyMarkup(a),this.detectParenWrap(b),b.correctParentTree(),a.preserveEmpty&&m(b),b},a.prototype.markRoot=function(){},a.prototype.isParenWrapped=function(a){return"text"===a.start.next.type&&"("===a.start.next.value[0]&&"text"===a.end.prev.type&&")"===a.end.prev.value[a.end.prev.value.length-1]},a.prototype.detectParenWrap=function(a){var b;for(b=a.start;b!==a.end;)b=b.next,"blockStart"===b.type&&this.isParenWrapped(b.container)&&(b.container.currentlyParenWrapped=!0);return a},a.prototype.addBlock=function(a){var b;return b=new k.Block(a.precedence,a.color,a.socketLevel,a.classes,a.parseContext,a.buttons),this.addMarkup(b,a.bounds,a.depth)},a.prototype.flagToRemove=function(a,b){var c;return c=new k.Block,c.flagToRemove=!0,this.addMarkup(c,a,b)},a.prototype.addSocket=function(a){var b,c;return c=new k.Socket(null!=(b=a.empty)?b:this.empty,a.precedence,!1,a.classes,a.dropdown,a.parseContext),this.addMarkup(c,a.bounds,a.depth)},a.prototype.addIndent=function(a){var b;return b=new k.Indent(this.emptyIndent,a.prefix,a.classes,a.parseContext),this.addMarkup(b,a.bounds,a.depth)},a.prototype.checkBounds=function(a){var b,c,d,e;if(null==(null!=a&&null!=(b=a.start)?b.line:void 0)||null==(null!=a&&null!=(c=a.start)?c.column:void 0)||null==(null!=a&&null!=(d=a.end)?d.line:void 0)||null==(null!=a&&null!=(e=a.end)?e.column:void 0))throw new IllegalArgumentException("bad bounds object")},a.prototype.addMarkup=function(a,b,c){return this.checkBounds(b),this.markup.push({token:a.start,location:b.start,depth:c,start:!0}),this.markup.push({token:a.end,location:b.end,depth:c,start:!1}),a},a.prototype.sortMarkup=function(){return this.markup.sort(function(a,b){var c;return a.location.line>b.location.line?1:b.location.line>a.location.line?-1:a.location.column>b.location.column?1:b.location.column>a.location.column?-1:(c=1,a.token.container===b.token.container&&(c=-1),a.start&&!b.start?c:b.start&&!a.start?-c:a.start&&b.start?a.depth>b.depth?1:-1:a.start||b.start?void 0:a.depth>b.depth?-1:1)})},a.prototype.constructHandwrittenBlock=function(a){var b,c,d,e,f,g,h,j,l,m,n,o,p,q,r;if(b=new k.Block(0,"comment",i.ANY_DROP),this.isComment(a)){if(b.socketLevel=i.BLOCK_ONLY,b.classes=["__comment__","block-only"],f=b.start,n=this.parseComment(a),q=n.sockets,c=n.color,null!=c&&(b.color=c),h=0,null!=q)for(g=0,j=q.length;g<j;g++)p=q[g],o=new k.Socket("",0,!0),o.setParent(b),o.classes=["__comment__"],l=a.slice(h,p[0]),l.length>0&&(m=new k.TextToken(l),m.setParent(b),i.connect(f,m),f=m),r=new k.TextToken(a.slice(p[0],p[1])),r.setParent(b),i.connect(f,o.start),i.connect(o.start,r),i.connect(r,o.end),f=o.end,h=p[1];d=a.slice(h,a.length),d.length>0&&(e=new k.TextToken(d),e.setParent(b),i.connect(f,e),f=e),i.connect(f,b.end)}else o=new k.Socket("",0,!0),r=new k.TextToken(a),r.setParent(o),b.classes=["__handwritten__","block-only"],i.connect(b.start,o.start),i.connect(o.start,r),i.connect(r,o.end),i.connect(o.end,b.end);return b},a.prototype.handleButton=function(a,b,c){return a},a.prototype.applyMarkup=function(a){var b,c,d,e,f,g,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H,I,J,K;for(v={},y=this.markup,l=0,p=y.length;l<p;l++)u=y[l],null==v[w=u.location.line]&&(v[w]=[]),v[u.location.line].push(u);for(t=this.text.split("\n"),g=0,K=[],d=new k.Document(null!=(z=a.context)?z:this.rootContext),e=d.start,c=!1,f=m=0,q=t.length;m<q;f=++m)if(s=t[f],f in v){for(g>s.length||s.slice(0,g).trim().length>0?(o=s.length-s.trimLeft().length,e.specialIndent=s.slice(0,o)):o=g,F=v[f],n=0,r=F.length;n<r;n++)if(u=F[n],null==u.token.container||!u.token.container.flagToRemove||a.preserveEmpty){switch(o>=u.location.column||o>=s.length||(!c&&a.wrapAtRoot&&0===K.length||"indent"===(null!=(G=K[K.length-1])?G.type:void 0)?(b=this.constructHandwrittenBlock(s.slice(o,u.location.column)),i.connect(e,b.start),e=b.end):e=i.connect(e,new k.TextToken(s.slice(o,u.location.column))),c&&(e=i.connect(e,K.pop().end),c=!1)),u.token.type){case"indentStart":if("block"!==(null!=K&&null!=(H=K[K.length-1])?H.type:void 0))throw new Error("Improper parser: indent must be inside block, but is inside "+(null!=K&&null!=(I=K[K.length-1])?I.type:void 0));g+=u.token.container.prefix.length;break;case"blockStart":if("block"===(null!=(J=K[K.length-1])?J.type:void 0))throw new Error("Improper parser: block cannot nest immediately inside another block.");break;case"socketStart":if("block"!==(null!=(A=K[K.length-1])?A.type:void 0))throw new Error("Improper parser: socket must be immediately inside a block.");break;case"indentEnd":g-=u.token.container.prefix.length}if(u.token instanceof k.StartToken)K.push(u.token.container);else if(u.token instanceof k.EndToken){if(u.token.container!==K[K.length-1])throw new Error("Improper parser: "+e.container.type+" ended too early.");K.pop()}e=i.connect(e,u.token),o=u.location.column}for(;!(o>=s.length);)c&&s.slice(o).indexOf(this.endComment)>-1&&(e=i.connect(e,new k.TextToken(s.slice(o,o+s.slice(o).indexOf(this.endComment)+this.endComment.length))),o+=s.slice(o).indexOf(this.endComment)+this.endComment.length,e=i.connect(e,K.pop().end),c=!1),!c&&(a.wrapAtRoot&&0===K.length||"indent"===(null!=(B=K[K.length-1])?B.type:void 0))&&s.length>0?j(s.slice(o).trimLeft(),this.startComment)?(c=!0,b=new k.Block(0,"comment",i.ANY_DROP),K.push(b),i.connect(e,b.start),e=b.start):(b=this.constructHandwrittenBlock(s.slice(o)),i.connect(e,b.start),e=b.end,o=s.length):o<s.length&&(e=i.connect(e,new k.TextToken(s.slice(o))),o=s.length);e=i.connect(e,new k.NewlineToken)}else{for(g>s.length||s.slice(0,g).trim().length>0?(e.specialIndent=function(){var a,b,c;for(c=[],a=0,b=s.length-s.trimLeft().length;0<=b?a<b:a>b;0<=b?a++:a--)c.push(" ");return c}().join(""),s=s.trimLeft()):s=s.slice(g),x=!1;s.length>0;)c&&(x=!0,s.indexOf(this.endComment)>-1&&(e=i.connect(e,new k.TextToken(s.slice(0,s.indexOf(this.endComment)+this.endComment.length))),s=s.slice(s.indexOf(this.endComment)+this.endComment.length),e=i.connect(e,K.pop().end),c=!1)),!c&&(a.wrapAtRoot&&0===K.length||"indent"===(null!=(C=K[K.length-1])?C.type:void 0))&&s.length>0?(x=!0,j(s.trimLeft(),this.startComment)?(c=!0,b=new k.Block(0,"comment",i.ANY_DROP),K.push(b),i.connect(e,b.start),e=b.start):(b=this.constructHandwrittenBlock(s),i.connect(e,b.start),e=b.end,s="")):s.length>0&&(x=!0,e=i.connect(e,new k.TextToken(s)),s="");0!==s.length||x||"indent"!==(D=null!=(E=K[K.length-1])?E.type:void 0)&&"document"!==D&&void 0!==D||!h(t,f)||(b=new k.Block(0,this.opts.emptyLineColor,i.BLOCK_ONLY),b.classes=["__comment__","any-drop"],e=i.connect(e,b.start),e=i.connect(e,b.end)),e=i.connect(e,new k.NewlineToken)}return e=e.prev,e.next.remove(),e=i.connect(e,d.end),d},a}(),c.parseXML=function(a){var b,c,d,e;return d=new k.Document,b=d.start,e=[],c=l.parser(!0),c.ontext=function(a){var c,d,e,f,g,h;for(h=a.split("\n"),f=[],c=d=0,e=h.length;d<e;c=++d)g=h[c],0!==g.length&&(b=i.connect(b,new k.TextToken(g))),c!==h.length-1?f.push(b=i.connect(b,new k.NewlineToken)):f.push(void 0);return f},c.onopentag=function(a){var c,d,f,g,h;switch(c=a.attributes,a.name){case"block":d=new k.Block(c.precedence,c.color,c.socketLevel,null!=(f=c.classes)&&"function"==typeof f.split?f.split(" "):void 0);break;case"socket":d=new k.Socket("",c.precedence,c.handritten,null!=(g=c.classes)&&"function"==typeof g.split?g.split(" "):void 0);break;case"indent":d=new k.Indent("",c.prefix,null!=(h=c.classes)&&"function"==typeof h.split?h.split(" "):void 0);break;case"document":0!==e.length&&(d=new k.Document);break;case"br":return b=i.connect(b,new k.NewlineToken),null}if(null!=d)return e.push({node:a,container:d}),b=i.connect(b,d.start)},c.onclosetag=function(a){if(e.length>0&&a===e[e.length-1].node.name)return b=i.connect(b,e[e.length-1].container.end),e.pop()},c.onerror=function(a){throw a},c.write(a).close(),b=i.connect(b,d.end),d.correctParentTree(),d},h=function(a,b){for(;b!==a.length;){if(a[b].length>0)return!0;b+=1}return!1},m=function(a){var b,c,d,e,f;for(c=a.start,e=[];c!==a.end;)c instanceof k.StartToken&&c.container.flagToRemove?(b=c.container,c=b.end.next,e.push(a.remove(b))):c instanceof k.StartToken&&c.container.flagToStrip?(null!=(d=c.container.parent)&&(d.color="error"),f=c.next,f.value=f.value.substring(c.container.flagToStrip.left,f.value.length-c.container.flagToStrip.right),e.push(c=f.next)):e.push(c=c.next);return e},d.parens=function(a,b,c,d){var e;if(null===d||"socket"!==d.type||(null!=d?d.precedence:void 0)<c.precedence){for(e=[];;){if(null==a().match(/^\s*\(/)||null==b().match(/\)\s*/))break;a(a().replace(/^\s*\(\s*/,"")),e.push(b(b().replace(/^\s*\)\s*/,"")))}return e}return a("("+a()),b(b()+")")},d.drop=function(a,b,c,d){return"document"===a.type&&"socket"===b.type?i.FORBID:i.ENCOURAGE},d.empty="",d.emptyIndent="",g=function(a){return{start:0,end:a.length}},c.wrapParser=function(a){return function(b){function c(b){var c,d,e;this.opts=null!=b?b:{},this.empty=a.empty,this.emptyIndent=a.emptyIndent,this.startComment=null!=(c=a.startComment)?c:"/*",this.endComment=null!=(d=a.endComment)?d:"*/",this.startSingleLineComment=a.startSingleLineComment,this.getDefaultSelectionRange=null!=(e=a.getDefaultSelectionRange)?e:g,this.rootContext=a.rootContext}
return n(c,b),c.prototype.createParser=function(b){var c;return c=new a(b,this.opts),c.startComment=this.startComment,c.endComment=this.endComment,c.empty=this.empty,c.emptyIndent=this.emptyIndent,c},c.prototype.stringFixer=function(b){return null!=a.stringFixer?a.stringFixer.apply(this,arguments):b},c.prototype.parse=function(a,b){return this.opts.parseOptions=b,null==b&&(b={wrapAtRoot:!0}),this.createParser(a)._parse(b)},c.prototype.parens=function(b,c,d,e){var f,g;return f=function(a){return null!=a&&(b=a),b},g=null!=c?function(a){return null!=a&&(c=a),c}:f,a.parens(f,g,d,e),[b,c]},c.prototype.drop=function(b,c,d,e){return a.drop(b,c,d,e)},c.prototype.handleButton=function(a,b,c){var d;return d=this.createParser(a),d.handleButton(a,b,c)},c}(e)}},{"./helper.coffee":28,"./model.coffee":31,sax:23}],34:[function(a,b,c){var d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C=[].indexOf||function(a){for(var b=0,c=this.length;b<c;b++)if(b in this&&this[b]===a)return b;return-1},D=function(a,b){function c(){this.constructor=a}for(var d in b)E.call(b,d)&&(a[d]=b[d]);return c.prototype=b.prototype,a.prototype=new c,a.__super__=b.prototype,a},E={}.hasOwnProperty,F=function(a,b){return(+a%(b=+b)+b)%b};w=a("./helper.coffee"),v=a("./draw.coffee"),x=a("./model.coffee"),q=0,o=1,n=2,l=3,m=4,w.ANY_DROP,w.BLOCK_ONLY,w.MOSTLY_BLOCK,w.MOSTLY_VALUE,w.VALUE_ONLY,g=0,e=1,f=2,h=3,j=8,k="#555",r=w.SVG_STANDARD,i={buttonWidth:15,buttonHeight:15,buttonPadding:6,minIndentTongueWidth:150,showDropdowns:!0,padding:5,indentWidth:20,indentTongueHeight:20,tabOffset:10,tabWidth:15,tabHeight:5,tabSideWidth:.125,dropAreaHeight:20,indentDropAreaMinWidth:50,minSocketWidth:10,invisibleSocketWidth:5,textHeight:15,textPadding:1,emptyLineWidth:50,highlightAreaHeight:10,bevelClip:3,shadowBlur:5,colors:{error:"#ff0000",comment:"#c0c0c0",return:"#fff59d",control:"#ffcc80",value:"#a5d6a7",command:"#90caf9",red:"#ef9a9a",pink:"#f48fb1",purple:"#ce93d8",deeppurple:"#b39ddb",indigo:"#9fa8da",blue:"#90caf9",lightblue:"#81d4fa",cyan:"#80deea",teal:"#80cbc4",green:"#a5d6a7",lightgreen:"#c5e1a5",lime:"#e6ee9c",yellow:"#fff59d",amber:"#ffe082",orange:"#ffcc80",deeporange:"#ffab91",brown:"#bcaaa4",grey:"#eeeeee",bluegrey:"#b0bec5"}},d={"+":-1,"-":-1,"":-3,"":-3},p=function(){return!1},s=function(a,b){var c,d;return a.length===b.length&&!function(){var e,f,g;for(g=[],c=e=0,f=a.length;e<f;c=++e)d=a[c],g.push(d!==b[c]);return g}()},c.View=function(){function a(a,b){var c,d;this.ctx=a,this.opts=null!=b?b:{},null==this.ctx&&(this.ctx=document.createElementNS(r,"svg")),this.map={},this.oldRoots={},this.newRoots={},this.auxiliaryMap={},this.flaggedToDelete={},this.unflaggedToDelete={},this.marks={},this.draw=new v.Draw(this.ctx);for(d in i)d in this.opts||(this.opts[d]=i[d]);for(c in i.colors)c in this.opts.colors||(this.opts.colors[c]=i.colors[c])}var b,c,y,z,A,B,E,G,H;return a.prototype.clearCache=function(){return this.beginDraw(),this.garbageCollect()},a.prototype.clearFromCanvas=function(){return this.beginDraw(),this.cleanupDraw()},a.prototype.getViewNodeFor=function(a){return a.id in this.map?this.map[a.id]:this.createView(a)},a.prototype.registerMark=function(a){return this.marks[a]=!0},a.prototype.clearMarks=function(){var a,b;b=this.marks;for(a in b)b[a],this.map[a].unmark();return this.marks={}},a.prototype.beginDraw=function(){return this.newRoots={}},a.prototype.hasViewNodeFor=function(a){return null!=a&&a.id in this.map},a.prototype.getAuxiliaryNode=function(a){return a.id in this.auxiliaryMap?this.auxiliaryMap[a.id]:this.auxiliaryMap[a.id]=new b(this,a)},a.prototype.registerRoot=function(a){var b,c,d;if(a instanceof x.List&&!(a instanceof x.Container))return void a.traverseOneLevel(function(a){return function(b){if(!(b instanceof x.NewlineToken))return a.registerRoot(b)}}(this));d=this.newRoots;for(c in d)if(b=d[c],b.model.hasParent(a))delete this.newRoots[c];else if(a.hasParent(b.model))return;return this.newRoots[a.id]=this.getAuxiliaryNode(a)},a.prototype.cleanupDraw=function(){var a,b,c,d,e,f,g;this.flaggedToDelete={},this.unflaggedToDelete={},c=this.oldRoots;for(b in c)a=c[b],b in this.newRoots||this.flag(a);d=this.newRoots;for(b in d)a=d[b],a.cleanup();e=this.flaggedToDelete;for(b in e)a=e[b],b in this.unflaggedToDelete&&delete this.flaggedToDelete[b];f=this.flaggedToDelete,g=[];for(b in f)a=f[b],b in this.map&&g.push(this.map[b].hide());return g},a.prototype.flag=function(a){return this.flaggedToDelete[a.model.id]=a},a.prototype.unflag=function(a){return this.unflaggedToDelete[a.model.id]=a},a.prototype.garbageCollect=function(){var a,b,c,d;this.cleanupDraw(),c=this.flaggedToDelete;for(b in c)a=c[b],b in this.map&&(this.map[b].destroy(),this.destroy(b));d=this.newRoots;for(b in d)a=d[b],a.update();return this.oldRoots=this.newRoots},a.prototype.destroy=function(a){var b,c,d,e;for(e=this.map[a].children,c=0,d=e.length;c<d;c++)b=e[c],null==this.map[b.child.id]||this.unflaggedToDelete[b.child.id]||this.destroy(b.child.id);return delete this.map[a],delete this.auxiliaryMap[a],delete this.flaggedToDelete[a]},a.prototype.hasViewNodeFor=function(a){return null!=a&&a.id in this.map},a.prototype.createView=function(a){if(a instanceof x.List&&!(a instanceof x.Container))return new E(a,this);switch(a.type){case"text":return new H(a,this);case"block":return new c(a,this);case"indent":return new B(a,this);case"socket":return new G(a,this);case"document":return new z(a,this)}},a.prototype.getColor=function(a){var b;return a&&"#"===a.charAt(0)?a:null!=(b=this.opts.colors[a])?b:"#ffffff"},b=function(){function a(a,b){this.view=a,this.model=b,this.children={},this.computedVersion=-1}return a.prototype.cleanup=function(){var a,b,c,d,e;if(this.view.unflag(this),this.model.version!==this.computedVersion){b={},this.model instanceof x.Container&&this.model.traverseOneLevel(function(a){return function(c){if(!(c instanceof x.NewlineToken))return b[c.id]=a.view.getAuxiliaryNode(c)}}(this)),d=this.children;for(c in d)a=d[c],c in b||this.view.flag(a);e=[];for(c in b)a=b[c],this.children[c]=a,e.push(a.cleanup());return e}},a.prototype.update=function(){var a,b,c,d;if(this.view.unflag(this),this.model.version!==this.computedVersion){b={},this.model instanceof x.Container&&this.model.traverseOneLevel(function(a){return function(c){if(!(c instanceof x.NewlineToken))return b[c.id]=a.view.getAuxiliaryNode(c)}}(this)),this.children=b,d=this.children;for(c in d)a=d[c],a.update();return this.computedVersion=this.model.version}},a}(),A=function(){function a(a,b){this.model=a,this.view=b,this.view.map[this.model.id]=this,this.view.registerRoot(this.model),this.lastCoordinate=new this.view.draw.Point(0,0),this.invalidate=!1,this.lineLength=0,this.children=[],this.oldChildren=[],this.lineChildren=[],this.multilineChildrenData=[],this.margins={left:0,right:0,top:0,bottom:0},this.topLineSticksToBottom=!1,this.bottomLineSticksToTop=!1,this.minDimensions=[],this.minDistanceToBase=[],this.dimensions=[],this.distanceToBase=[],this.carriageArrow=f,this.bevels={top:!1,bottom:!1},this.bounds=[],this.changedBoundingBox=!0,this.glue={},this.elements=[],this.activeElements=[],this.computedVersion=-1}return a.prototype.draw=function(a,b,c){return null==b&&(b={}),null==c&&(c=null),this.drawSelf(b,c)},a.prototype.root=function(){var a,b,c,d,e;for(d=this.elements,e=[],b=0,c=d.length;b<c;b++)a=d[b],e.push(a.setParent(this.view.draw.ctx));return e},a.prototype.serialize=function(a){var b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y;for(x=[],q=["lineLength","margins","topLineSticksToBottom","bottomLineSticksToTop","changedBoundingBox","path","highlightArea","computedVersion","carriageArrow","bevels"],d=0,f=q.length;d<f;d++)o=q[d],x.push(o+": "+JSON.stringify(this[o]));for(r=this.children,c=e=0,g=r.length;e<g;c=++e)b=r[c],x.push("child "+c+": {startLine: "+b.startLine+", endLine: "+b.endLine+"}");if(null!=a){for(s=["multilineChildrenData","minDimensions","minDistanceToBase","dimensions","distanceToBase","bounds","glue"],l=0,h=s.length;l<h;l++)o=s[l],x.push(o+" "+a+": "+JSON.stringify(this[o][a]));for(t=this.lineChildren[a],c=m=0,i=t.length;m<i;c=++m)b=t[c],x.push("line "+a+" child "+c+": {startLine: "+b.startLine+", endLine: "+b.endLine+"}}")}else for(a=n=0,u=this.lineLength;0<=u?n<u:n>u;a=0<=u?++n:--n){for(v=["multilineChildrenData","minDimensions","minDistanceToBase","dimensions","distanceToBase","bounds","glue"],p=0,j=v.length;p<j;p++)o=v[p],x.push(o+" "+a+": "+JSON.stringify(this[o][a]));for(w=this.lineChildren[a],c=y=0,k=w.length;y<k;c=++y)b=w[c],x.push("line "+a+" child "+c+": {startLine: "+b.startLine+", endLine: "+b.endLine+"}}")}return x.join("\n")},a.prototype.computeChildren=function(){return this.lineLength},a.prototype.focusAll=function(){return this.group.focus()},a.prototype.computeCarriageArrow=function(){var a,b,c,d;for(d=this.children,b=0,c=d.length;b<c;b++)a=d[b],this.view.getViewNodeFor(a.child).computeCarriageArrow();return this.carriageArrow},a.prototype.computeMargins=function(){var a,b,c,d,e,f,g,h,i,j,k,l,m,n,o;if(this.computedVersion===this.model.version&&(null==this.model.parent||!this.view.hasViewNodeFor(this.model.parent)||this.model.parent.version===this.view.getViewNodeFor(this.model.parent).computedVersion))return this.margins;for(f=null!=(g=this.model.parent)?g.type:void 0,e=this.view.opts.padding,c=this.model.isFirstOnLine()||this.lineLength>1?e:0,n=this.model.isLastOnLine()||this.lineLength>1?e:0,"block"===f&&"indent"===this.model.type?this.margins={top:0,bottom:this.lineLength>1?this.view.opts.indentTongueHeight:e,firstLeft:0,midLeft:this.view.opts.indentWidth,lastLeft:this.view.opts.indentWidth,firstRight:0,midRight:0,lastRight:e}:"text"===this.model.type&&"socket"===f?this.margins={top:this.view.opts.textPadding,bottom:this.view.opts.textPadding,firstLeft:this.view.opts.textPadding,midLeft:this.view.opts.textPadding,lastLeft:this.view.opts.textPadding,firstRight:this.view.opts.textPadding,midRight:this.view.opts.textPadding,lastRight:this.view.opts.textPadding}:"text"===this.model.type&&"block"===f?(o="newline"===(null!=(h=this.model.prev)?h.type:void 0)&&("newline"===(i=null!=(j=this.model.next)?j.type:void 0)||"indentStart"===i)||"indentEnd"===(null!=(k=this.model.prev)&&null!=(l=k.prev)?l.type:void 0)?e/2:e,this.margins={top:o,bottom:o,firstLeft:c,midLeft:c,lastLeft:c,firstRight:n,midRight:n,lastRight:n}):this.margins="block"===f?{top:e,bottom:e,firstLeft:c,midLeft:e,lastLeft:e,firstRight:n,midRight:0,lastRight:n}:{firstLeft:0,midLeft:0,lastLeft:0,firstRight:0,midRight:0,lastRight:0,top:0,bottom:0},this.firstMargins={left:this.margins.firstLeft,right:this.margins.firstRight,top:this.margins.top,bottom:1===this.lineLength?this.margins.bottom:0},this.midMargins={left:this.margins.midLeft,right:this.margins.midRight,top:0,bottom:0},this.lastMargins={left:this.margins.lastLeft,right:this.margins.lastRight,top:1===this.lineLength?this.margins.top:0,bottom:this.margins.bottom},m=this.children,b=0,d=m.length;b<d;b++)a=m[b],this.view.getViewNodeFor(a.child).computeMargins();return null},a.prototype.getMargins=function(a){return 0===a?this.firstMargins:a===this.lineLength-1?this.lastMargins:this.midMargins},a.prototype.computeBevels=function(){var a,b,c,d;for(d=this.children,b=0,c=d.length;b<c;b++)a=d[b],this.view.getViewNodeFor(a.child).computeBevels();return this.bevels},a.prototype.computeMinDimensions=function(){var a,b,c;if(this.minDimensions.length>this.lineLength)this.minDimensions.length=this.minDistanceToBase.length=this.lineLength;else for(;this.minDimensions.length!==this.lineLength;)this.minDimensions.push(new this.view.draw.Size(0,0)),this.minDistanceToBase.push({above:0,below:0});for(a=b=0,c=this.lineLength;0<=c?b<c:b>c;a=0<=c?++b:--b)this.minDimensions[a].width=this.minDimensions[a].height=0,this.minDistanceToBase[a].above=this.minDistanceToBase[a].below=0;return null},a.prototype.computeDimensions=function(a,b){var c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u;if(null==b&&(b=!1),this.computedVersion!==this.model.version||a||this.invalidate){for(n=this.dimensions,o=this.distanceToBase,this.dimensions=function(){var a,b,c;for(c=[],a=0,b=this.lineLength;0<=b?a<b:a>b;0<=b?a++:a--)c.push(new this.view.draw.Size(0,0));return c}.call(this),this.distanceToBase=function(){var a,b,c;for(c=[],a=0,b=this.lineLength;0<=b?a<b:a>b;0<=b?a++:a--)c.push({above:0,below:0});return c}.call(this),q=this.minDimensions,f=g=0,i=q.length;g<i;f=++g)t=q[f],this.dimensions[f].width=t.width,this.dimensions[f].height=t.height,this.distanceToBase[f].above=this.minDistanceToBase[f].above,this.distanceToBase[f].below=this.minDistanceToBase[f].below;if(null!=this.model.parent&&this.view.hasViewNodeFor(this.model.parent)&&!b&&(this.topLineSticksToBottom||this.bottomLineSticksToTop||this.lineLength>1&&!this.model.isLastOnLine())&&(p=this.view.getViewNodeFor(this.model.parent),u=this.model.getLinesToParent(),this.topLineSticksToBottom&&(e=this.distanceToBase[0],e.below=Math.max(e.below,p.distanceToBase[u].below),this.dimensions[0]=new this.view.draw.Size(this.dimensions[0].width,e.below+e.above)),this.bottomLineSticksToTop&&(l=this.distanceToBase.length,e=this.distanceToBase[l-1],e.above=Math.max(e.above,p.distanceToBase[u+l-1].above),this.dimensions[l-1]=new this.view.draw.Size(this.dimensions[l-1].width,e.below+e.above)),this.lineLength>1&&!this.model.isLastOnLine()&&"block"===this.model.type&&(e=this.distanceToBase[this.lineLength-1],e.below=p.distanceToBase[u+this.lineLength-1].below,this.dimensions[l-1]=new this.view.draw.Size(this.dimensions[l-1].width,e.below+e.above))),!(c=n.length!==this.lineLength))for(k=h=0,r=this.lineLength;0<=r?h<r:h>r;k=0<=r?++h:--h)if(!n[k].equals(this.dimensions[k])||o[k].above!==this.distanceToBase[k].above||o[k].below!==this.distanceToBase[k].below){c=!0;break}for(this.changedBoundingBox||(this.changedBoundingBox=c),s=this.children,m=0,j=s.length;m<j;m++)d=s[m],C.call(this.lineChildren[0],d)>=0||C.call(this.lineChildren[this.lineLength-1],d)>=0?this.view.getViewNodeFor(d.child).computeDimensions(c,!(this.model instanceof x.Container)):this.view.getViewNodeFor(d.child).computeDimensions(!1,!(this.model instanceof x.Container));return null}},a.prototype.computeBoundingBoxX=function(a,b){var c,d,e;return this.computedVersion===this.model.version&&a===(null!=(c=this.bounds[b])?c.x:void 0)&&!this.changedBoundingBox||(null!=(d=this.bounds[b])?d.x:void 0)===a&&(null!=(e=this.bounds[b])?e.width:void 0)===this.dimensions[b].width?this.bounds[b]:(this.changedBoundingBox=!0,null!=this.bounds[b]?(this.bounds[b].x=a,this.bounds[b].width=this.dimensions[b].width):this.bounds[b]=new this.view.draw.Rectangle(a,0,this.dimensions[b].width,0),this.bounds[b])},a.prototype.computeAllBoundingBoxX=function(a){var b,c,d,e;for(null==a&&(a=0),e=this.dimensions,d=b=0,c=e.length;b<c;d=++b)e[d],this.computeBoundingBoxX(a,d);return this.bounds},a.prototype.computeGlue=function(){return this.glue={}},a.prototype.computeBoundingBoxY=function(a,b){var c;return this.computedVersion===this.model.version&&a===(null!=(c=this.bounds[b])?c.y:void 0)&&!this.changedBoundingBox||this.bounds[b].y===a&&this.bounds[b].height===this.dimensions[b].height?this.bounds[b]:(this.changedBoundingBox=!0,this.bounds[b].y=a,this.bounds[b].height=this.dimensions[b].height,this.bounds[b])},a.prototype.computeAllBoundingBoxY=function(a){var b,c,d,e,f;for(null==a&&(a=0),e=this.dimensions,d=b=0,c=e.length;b<c;d=++b)f=e[d],this.computeBoundingBoxY(a,d),a+=f.height,d in this.glue&&(a+=this.glue[d].height);return this.bounds},a.prototype.getBounds=function(){return this.totalBounds},a.prototype.computeOwnPath=function(){},a.prototype.computePath=function(){var a,b,c,d,e,f,g,h,i,j,k,l,m;if(this.computedVersion===this.model.version&&this.model.isLastOnLine()===this.lastComputedLinePredicate&&!this.changedBoundingBox)return null;for(k=this.children,d=0,f=k.length;d<f;d++)c=k[d],this.view.getViewNodeFor(c.child).computePath();if(this.changedBoundingBox||this.model.isLastOnLine()!==this.lastComputedLinePredicate){if(this.computeOwnPath(),this.totalBounds=new this.view.draw.NoRectangle,this.bounds.length>0&&(this.totalBounds.unite(this.bounds[0]),this.totalBounds.unite(this.bounds[this.bounds.length-1])),this.bounds.length>this.children.length)for(l=this.children,e=0,g=l.length;e<g;e++)b=l[e],this.totalBounds.unite(this.view.getViewNodeFor(b.child).totalBounds);else{for(j=this.totalBounds.right(),m=this.bounds,i=0,h=m.length;i<h;i++)a=m[i],this.totalBounds.x=Math.min(this.totalBounds.x,a.x),j=Math.max(j,a.right());this.totalBounds.width=j-this.totalBounds.x}null!=this.path&&this.totalBounds.unite(this.path.bounds())}return this.lastComputedLinePredicate=this.model.isLastOnLine(),null},a.prototype.computeOwnDropArea=function(){},a.prototype.computeDropAreas=function(){var a,b,c,d;if(this.computedVersion===this.model.version&&!this.changedBoundingBox)return null;for(this.computeOwnDropArea(),d=this.children,b=0,c=d.length;b<c;b++)a=d[b],this.view.getViewNodeFor(a.child).computeDropAreas();return null},a.prototype.computeNewVersionNumber=function(){var a,b,c,d;if(this.computedVersion===this.model.version&&!this.changedBoundingBox)return null;for(this.changedBoundingBox=!1,this.invalidate=!1,this.computedVersion=this.model.version,d=this.children,b=0,c=d.length;b<c;b++)a=d[b],this.view.getViewNodeFor(a.child).computeNewVersionNumber();return null},a.prototype.drawSelf=function(a){null==a&&(a={})},a.prototype.hide=function(){var a,b,c,d;for(d=this.elements,b=0,c=d.length;b<c;b++)null!=(a=d[b])&&"function"==typeof a.deactivate&&a.deactivate();return this.activeElements=[]},a.prototype.destroy=function(a){var b,c,d,e,f,g,h,i,j;if(null==a&&(a=!0),a)for(h=this.elements,d=0,f=h.length;d<f;d++)null!=(c=h[d])&&"function"==typeof c.destroy&&c.destroy();else null!=this.highlightArea&&this.highlightArea.destroy();for(this.activeElements=[],i=this.children,j=[],e=0,g=i.length;e<g;e++)b=i[e],j.push(this.view.getViewNodeFor(b.child).destroy(!1));return j},a}(),E=function(a){function b(a,c){this.model=a,this.view=c,b.__super__.constructor.apply(this,arguments)}return D(b,a),b.prototype.draw=function(a,c,d){var e,f,g,h,i;for(null==c&&(c={}),null==d&&(d=null),b.__super__.draw.apply(this,arguments),h=this.children,i=[],f=0,g=h.length;f<g;f++)e=h[f],i.push(this.view.getViewNodeFor(e.child).draw(a,c,this.group));return i},b.prototype.root=function(){var a,b,c,d,e;for(d=this.children,e=[],b=0,c=d.length;b<c;b++)a=d[b],e.push(this.view.getViewNodeFor(a.child).root());return e},b.prototype.destroy=function(a){var b,c,d,e,f;for(null==a&&(a=!0),e=this.children,f=[],c=0,d=e.length;c<d;c++)b=e[c],f.push(this.view.getViewNodeFor(b.child).destroy());return f},b.prototype.computeChildren=function(){var a,b,c,d,e;if(this.computedVersion===this.model.version)return this.lineLength;for(this.lineLength=0,this.lineChildren=[[]],this.children=[],this.multilineChildrenData=[],this.topLineSticksToBottom=!1,this.bottomLineSticksToTop=!1,d=0,this.model.traverseOneLevel(function(a){return function(b){var c,e,f,g,h,i,j,k,p,q,r,s;if("newline"===b.type)return d+=1,null!=(c=a.lineChildren)[d]?c[d]:c[d]=[];for(s=a.view.getViewNodeFor(b),f=s.computeChildren(),g={child:b,startLine:d,endLine:d+f-1},a.children.push(g),h=i=k=d,p=d+f;k<=p?i<p:i>p;h=k<=p?++i:--i)null==(e=a.lineChildren)[h]&&(e[h]=[]),"cursor"!==b.type&&a.lineChildren[h].push(g);if(s.lineLength>1){for(a.multilineChildrenData[d]===l?a.multilineChildrenData[d]=m:a.multilineChildrenData[d]=o,h=j=q=d+1,r=d+f-1;q<=r?j<r:j>r;h=q<=r?++j:--j)a.multilineChildrenData[h]=n;a.multilineChildrenData[d+f-1]=l}return d+=f-1}}(this)),this.lineLength=d+1,this.bounds.length!==this.lineLength&&(this.changedBoundingBox=!0,this.bounds=this.bounds.slice(0,this.lineLength)),b=c=0,e=this.lineLength;0<=e?c<e:c>e;b=0<=e?++c:--c)null==(a=this.multilineChildrenData)[b]&&(a[b]=q);return this.lineLength>1&&(this.topLineSticksToBottom=!0,this.bottomLineSticksToTop=!0),this.lineLength},b.prototype.computeMinDimensions=function(){var a,c,d,e,g,h,i,j,k,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H,I,J;if(this.computedVersion===this.model.version)return null;for(b.__super__.computeMinDimensions.apply(this,arguments),t=[],B=[],D=this.children,h=0,j=D.length;h<j;h++)for(e=D[h],d=this.view.getViewNodeFor(e.child),d.computeMinDimensions(),x=d.minDimensions,y=d.minDistanceToBase,q=i=0,k=x.length;i<k;q=++i)J=x[q],g=q+e.startLine,v=d.getMargins(q),this.minDimensions[g].width+=J.width+v.left+v.right,"indent"===e.child.type&&q===x.length-1&&g<this.lineLength-1?(a=0,t.push(g+1)):"indent"===e.child.type&&0===q?(B.push(g),a=v.bottom):a=v.bottom,this.minDistanceToBase[g].above=Math.max(this.minDistanceToBase[g].above,y[q].above+v.top),this.minDistanceToBase[g].below=Math.max(this.minDistanceToBase[g].below,y[q].below+Math.max(a,(c=(null!=(E=this.model.buttons)?E.onFirstLine:void 0)?0:this.lineLength-1,((null!=(F=this.model.buttons)?F.addButton:void 0)||(null!=(G=this.model.buttons)?G.subtractButton:void 0))&&g===c&&this.multilineChildrenData[q]===l&&1===this.lineChildren[q].length?this.view.opts.buttonPadding+this.view.opts.buttonHeight:0)));for(H=this.minDimensions,q=u=0,m=H.length;u<m;q=++u)w=H[q],0===this.lineChildren[q].length&&("socket"===this.model.type?(this.minDistanceToBase[q].above=this.view.opts.textHeight+this.view.opts.textPadding,this.minDistanceToBase[q].below=this.view.opts.textPadding):"text"===this.model.type?(this.minDistanceToBase[q].above=this.view.opts.textHeight,this.minDistanceToBase[q].below=0):"indent"===this.model.type&&0===q?(this.minDistanceToBase[q].above=0,this.minDistanceToBase[q].below=0):(this.minDistanceToBase[q].above=this.view.opts.textHeight+this.view.opts.padding,this.minDistanceToBase[q].below=this.view.opts.padding)),w.height=this.minDistanceToBase[q].above+this.minDistanceToBase[q].below;for(z=0,n=t.length;z<n;z++)q=t[z],this.minDimensions[q].width=Math.max(this.minDimensions[q].width,Math.max(this.view.opts.minIndentTongueWidth,this.view.opts.indentWidth+this.view.opts.tabWidth+this.view.opts.tabOffset+this.view.opts.bevelClip));for(A=0,o=B.length;A<o;A++)q=B[A],this.minDimensions[q].width=Math.max(this.minDimensions[q].width,Math.max(this.view.opts.minIndentTongueWidth,this.view.opts.indentWidth+this.view.opts.tabWidth+this.view.opts.tabOffset+this.view.opts.bevelClip));for(I=this.lineChildren[this.lineLength-1],C=0,p=I.length;C<p;C++)if(r=I[C],s=this.view.getViewNodeFor(r.child),s.carriageArrow!==f){this.minDistanceToBase[this.lineLength-1].below+=this.view.opts.padding,this.minDimensions[this.lineLength-1].height=this.minDistanceToBase[this.lineLength-1].above+this.minDistanceToBase[this.lineLength-1].below;break}return null},b.prototype.computeBoundingBoxX=function(a,b,c){var d,e,f,g,h,i,j,k,l,m,n,o;if(null==c&&(c=0),this.computedVersion===this.model.version&&a===(null!=(l=this.bounds[b])?l.x:void 0)&&!this.changedBoundingBox)return this.bounds[b];for((null!=(m=this.bounds[b])?m.x:void 0)===a&&(null!=(n=this.bounds[b])?n.width:void 0)===this.dimensions[b].width||(null!=this.bounds[b]?(this.bounds[b].x=a,this.bounds[b].width=this.dimensions[b].width):this.bounds[b]=new this.view.draw.Rectangle(a,0,this.dimensions[b].width,0),this.changedBoundingBox=!0),d=a+c,o=this.lineChildren[b],h=i=0,j=o.length;i<j;h=++i)k=o[h],g=this.view.getViewNodeFor(k.child),e=b-k.startLine,f=g.getMargins(e),d+=f.left,g.computeBoundingBoxX(d,e),d+=g.dimensions[e].width+f.right;return this.bounds[b]},b.prototype.computeBoundingBoxY=function(a,b){var c,d,e,f,g,h,i,j,k,l,m,n;if(this.computedVersion===this.model.version&&a===(null!=(k=this.bounds[b])?k.y:void 0)&&!this.changedBoundingBox)return this.bounds[b];for((null!=(l=this.bounds[b])?l.y:void 0)===a&&(null!=(m=this.bounds[b])?m.height:void 0)===this.dimensions[b].height||(this.bounds[b].y=a,this.bounds[b].height=this.dimensions[b].height,this.changedBoundingBox=!0),c=this.distanceToBase[b].above,n=this.lineChildren[b],g=h=0,i=n.length;h<i;g=++h)j=n[g],f=this.view.getViewNodeFor(j.child),e=b-j.startLine,d=f.distanceToBase[e].above,f.computeBoundingBoxY(a+c-d,e);return this.bounds[b]},b.prototype.layout=function(a,b){var c;return null==a&&(a=this.lastCoordinate.x),null==b&&(b=this.lastCoordinate.y),this.view.registerRoot(this.model),this.lastCoordinate=new this.view.draw.Point(a,b),this.computeChildren(),this.computeCarriageArrow(!0),this.computeMargins(),this.computeBevels(),this.computeMinDimensions(),this.computeDimensions(0,!0),this.computeAllBoundingBoxX(a),this.computeGlue(),this.computeAllBoundingBoxY(b),this.computePath(),this.computeDropAreas(),c=this.changedBoundingBox,this.computeNewVersionNumber(),c},b.prototype.absorbCache=function(){var a,b,c,d,e,f,g,h,i,j,k,l,m,n;for(this.view.registerRoot(this.model),this.computeChildren(),this.computeCarriageArrow(!0),this.computeMargins(),this.computeBevels(),this.computeMinDimensions(),k=this.minDimensions,i=c=0,f=k.length;c<f;i=++c)k[i],this.distanceToBase[i]={above:this.lineChildren[i].map(function(a){return function(b){return a.view.getViewNodeFor(b.child).distanceToBase[i-b.startLine].above}}(this)).reduce(function(a,b){return Math.max(a,b)}),below:this.lineChildren[i].map(function(a){return function(b){return a.view.getViewNodeFor(b.child).distanceToBase[i-b.startLine].below}}(this)).reduce(function(a,b){return Math.max(a,b)})},this.dimensions[i]=new v.Size(this.minDimensions[i].width,this.minDimensions[i].height);for(l=this.dimensions,i=d=0,g=l.length;d<g;i=++d)l[i],a=this.lineChildren[i][0],b=this.view.getViewNodeFor(a.child),e=b.bounds[i-a.startLine].x,this.computeBoundingBoxX(e,i);for(this.computeGlue(),m=this.dimensions,i=j=0,h=m.length;j<h;i=++j)m[i],a=this.lineChildren[i][0],b=this.view.getViewNodeFor(a.child),b.bounds[i-a.startLine].y,n=b.bounds[i-a.startLine].y+b.distanceToBase[i-a.startLine].above-this.distanceToBase[i].above,this.computeBoundingBoxY(n,i);return this.computePath(),this.computeDropAreas(),!0},b.prototype.computeGlue=function(){var a,b,c,d,e,g,h,i,j,k,l,m,n,o;if(this.computedVersion===this.model.version&&!this.changedBoundingBox)return this.glue;for(m=this.children,d=0,g=m.length;d<g;d++)b=m[d],this.view.getViewNodeFor(b.child).computeGlue();for(this.glue={},n=this.bounds,j=e=0,h=n.length;e<h;j=++e)if(n[j],j<this.bounds.length-1)for(this.glue[j]={type:"normal",height:0,draw:!1},o=this.lineChildren[j],l=0,i=o.length;l<i;l++)k=o[l],c=this.view.getViewNodeFor(k.child),a=j-k.startLine,a in c.glue&&(this.glue[j].height=Math.max(this.glue[j].height,c.glue[a].height)),c.carriageArrow!==f&&(this.glue[j].height=Math.max(this.glue[j].height,this.view.opts.padding));return this.glue},b}(A),y=function(a){function b(a,c){this.model=a,this.view=c,b.__super__.constructor.apply(this,arguments),this.group=new this.view.draw.Group("droplet-container-group"),"block"===this.model.type?this.path=new this.view.draw.Path([],!0,{cssClass:"droplet-block-path"}):this.path=new this.view.draw.Path([],!1,{cssClass:"droplet-"+this.model.type+"-path"}),this.totalBounds=new this.view.draw.NoRectangle,this.path.setParent(this.group),this.dropArea=null,this.highlightArea=new this.view.draw.Path([],!1,{fillColor:"#FF0",strokeColor:"#FF0",lineWidth:1}),this.highlightArea.deactivate(),this.elements.push(this.group),this.elements.push(this.path),this.elements.push(this.highlightArea)}return D(b,a),b.prototype.destroy=function(a){var b,c,d,e,f,g,h,i,j;if(null==a&&(a=!0),a)for(h=this.elements,d=0,f=h.length;d<f;d++)null!=(c=h[d])&&"function"==typeof c.destroy&&c.destroy();else null!=this.highlightArea&&this.highlightArea.destroy();for(i=this.children,j=[],e=0,g=i.length;e<g;e++)b=i[e],j.push(this.view.getViewNodeFor(b.child).destroy(!1));return j},b.prototype.root=function(){return this.group.setParent(this.view.draw.ctx)},b.prototype.draw=function(a,b,c){var d,e,f,g,h,i,j,k,l;if(null==b&&(b={}),null==c&&(c=null),null==a||this.totalBounds.overlap(a)){for(this.drawSelf(b,c),this.group.activate(),this.path.activate(),j=this.activeElements,f=0,h=j.length;f<h;f++)e=j[f],e.activate();for(null!=this.highlightArea&&this.highlightArea.setParent(this.view.draw.ctx),null!=c&&this.group.setParent(c),k=this.children,l=[],g=0,i=k.length;g<i;g++)d=k[g],l.push(this.view.getViewNodeFor(d.child).draw(a,b,this.group));return l}if(this.group.destroy(),null!=this.highlightArea)return this.highlightArea.destroy()},b.prototype.computeCarriageArrow=function(a){var c,d,i;if(null==a&&(a=!1),d=this.carriageArrow,this.carriageArrow=f,i=this.model.parent,!a&&"indent"===(null!=i?i.type:void 0)&&this.view.hasViewNodeFor(i)&&this.view.getViewNodeFor(i).lineLength>1&&1===this.lineLength){for(c=this.model.start;c!==i.start&&"newline"!==c.type;)c=c.prev;c===i.start?this.model.isLastOnLine()?this.carriageArrow=e:this.carriageArrow=h:this.model.isFirstOnLine()||(this.carriageArrow=g)}return this.carriageArrow!==d&&(this.changedBoundingBox=!0),this.computedVersion!==this.model.version||null!=this.model.parent&&this.view.hasViewNodeFor(this.model.parent)&&this.model.parent.version!==this.view.getViewNodeFor(this.model.parent).computedVersion?b.__super__.computeCarriageArrow.apply(this,arguments):null},b.prototype.computeGlue=function(){var a,c,d,e,f,g;if(this.computedVersion===this.model.version&&!this.changedBoundingBox)return this.glue;for(b.__super__.computeGlue.apply(this,arguments),f=this.bounds,d=a=0,c=f.length;a<c;d=++a)f[d],d<this.bounds.length-1&&this.multilineChildrenData[d]!==n&&(e=Math.min(this.bounds[d].right()-this.bounds[d+1].x,this.bounds[d+1].right()-this.bounds[d].x),(g=this.multilineChildrenData[d])!==o&&g!==m||(e=Math.min(e,this.bounds[d+1].x+this.view.opts.indentWidth-this.bounds[d].x)),e<this.view.opts.padding&&"indent"!==this.model.type&&(this.glue[d].height+=this.view.opts.padding,this.glue[d].draw=!0));return this.glue},b.prototype.computeBevels=function(){var a,c,d,e,f,g,h,i;return a=this.bevels,this.bevels={top:!0,bottom:!0},"indent"!==(c=null!=(d=this.model.parent)?d.type:void 0)&&"document"!==c||"newline"!==(null!=(e=this.model.start.prev)?e.type:void 0)||(null!=(f=this.model.start.prev)?f.prev:void 0)===this.model.parent.start||(this.bevels.top=!1),"indent"!==(g=null!=(h=this.model.parent)?h.type:void 0)&&"document"!==g||"newline"!==(null!=(i=this.model.end.next)?i.type:void 0)||(this.bevels.bottom=!1),a.top===this.bevels.top&&a.bottom===this.bevels.bottom||(this.changedBoundingBox=!0),this.computedVersion===this.model.version?null:b.__super__.computeBevels.apply(this,arguments)},b.prototype.computeOwnPath=function(){var a,b,c,d,i,j,k,p,r,s,t,v,w,x,y,z,A,B,C,D,E,G,H,I,J,K,L,M,N,O,P,Q,R,S,T,U,V,W,X,Y,Z,$,_,aa,ba,ca,da;for(A=[],_=[],this.shouldAddTab()&&this.model.isFirstOnLine()&&this.carriageArrow!==g&&this.addTabReverse(_,new this.view.draw.Point(this.bounds[0].x+this.view.opts.tabOffset,this.bounds[0].y)),Q=this.bounds,E=w=0,C=Q.length;w<C;E=++w)a=Q[E],this.multilineChildrenData[E]===q&&(A.push(new this.view.draw.Point(a.x,a.y)),A.push(new this.view.draw.Point(a.x,a.bottom())),_.push(new this.view.draw.Point(a.right(),a.y)),_.push(new this.view.draw.Point(a.right(),a.bottom()))),this.multilineChildrenData[E]===o&&(A.push(new this.view.draw.Point(a.x,a.y)),A.push(new this.view.draw.Point(a.x,a.bottom())),H=this.lineChildren[E][this.lineChildren[E].length-1],J=this.view.getViewNodeFor(H.child),G=J.bounds[E-H.startLine],0===G.width?_.push(new this.view.draw.Point(a.right(),a.y)):(_.push(new this.view.draw.Point(a.right(),a.y)),_.push(new this.view.draw.Point(a.right(),G.y)),"indent"===H.child.type&&this.addTab(_,new this.view.draw.Point(G.x+this.view.opts.tabOffset,G.y)),_.push(new this.view.draw.Point(G.x,G.y)),_.push(new this.view.draw.Point(G.x,G.bottom())))),this.multilineChildrenData[E]===n&&(H=this.lineChildren[E][0],G=this.view.getViewNodeFor(H.child).bounds[E-H.startLine],A.push(new this.view.draw.Point(a.x,a.y)),A.push(new this.view.draw.Point(a.x,a.bottom())),((R=this.multilineChildrenData[E-1])!==o&&R!==m||"indent"!==H.child.type)&&_.push(new this.view.draw.Point(G.x,a.y)),_.push(new this.view.draw.Point(G.x,a.bottom()))),
(T=this.multilineChildrenData[E])!==l&&T!==m||(A.push(new this.view.draw.Point(a.x,a.y)),A.push(new this.view.draw.Point(a.x,a.bottom())),H=this.lineChildren[E][0],G=this.view.getViewNodeFor(H.child).bounds[E-H.startLine],((U=this.multilineChildrenData[E-1])!==o&&U!==m||"indent"!==H.child.type)&&_.push(new this.view.draw.Point(G.x,G.y)),_.push(new this.view.draw.Point(G.x,G.bottom())),"indent"===H.child.type&&this.addTabReverse(_,new this.view.draw.Point(G.x+this.view.opts.tabOffset,G.bottom())),_.push(new this.view.draw.Point(G.right(),G.bottom())),this.lineChildren[E].length>1?(_.push(new this.view.draw.Point(G.right(),G.y)),this.multilineChildrenData[E]===l?(_.push(new this.view.draw.Point(a.right(),a.y)),_.push(new this.view.draw.Point(a.right(),a.bottom()))):(H=this.lineChildren[E][this.lineChildren[E].length-1],J=this.view.getViewNodeFor(H.child),G=J.bounds[E-H.startLine],_.push(new this.view.draw.Point(a.right(),a.y)),0===G.width?(_.push(new this.view.draw.Point(a.right(),a.y)),_.push(new this.view.draw.Point(a.right(),a.bottom()))):(_.push(new this.view.draw.Point(a.right(),G.y)),_.push(new this.view.draw.Point(G.x,G.y)),_.push(new this.view.draw.Point(G.x,G.bottom()))))):(_.push(new this.view.draw.Point(a.right(),G.bottom())),_.push(new this.view.draw.Point(a.right(),a.bottom())))),E<this.lineLength-1&&E in this.glue&&this.glue[E].draw?(p=this.bounds[E+1].y-this.glue[E].height,B=Math.min(this.bounds[E+1].x,this.bounds[E].x),aa=Math.max(this.bounds[E+1].right(),this.bounds[E].right()),A.push(new this.view.draw.Point(this.bounds[E].x,p)),A.push(new this.view.draw.Point(B,p)),A.push(new this.view.draw.Point(B,p+this.view.opts.padding)),this.multilineChildrenData[E]!==o&&(_.push(new this.view.draw.Point(this.bounds[E].right(),p)),_.push(new this.view.draw.Point(aa,p)),_.push(new this.view.draw.Point(aa,p+this.view.opts.padding)))):null!=this.bounds[E+1]&&this.multilineChildrenData[E]!==n?(t=Math.max(this.bounds[E+1].x,this.bounds[E].x),v=Math.min(this.bounds[E+1].right(),this.bounds[E].right()),A.push(new this.view.draw.Point(t,this.bounds[E].bottom())),A.push(new this.view.draw.Point(t,this.bounds[E+1].y)),(V=this.multilineChildrenData[E])!==o&&V!==m&&(_.push(new this.view.draw.Point(v,this.bounds[E].bottom())),_.push(new this.view.draw.Point(v,this.bounds[E+1].y)))):this.carriageArrow===h?(M=this.view.getViewNodeFor(this.model.parent),d=M.bounds[1],_.push(new this.view.draw.Point(this.bounds[E].right(),d.y-this.view.opts.padding)),A.push(new this.view.draw.Point(this.bounds[E].x,d.y-this.view.opts.padding))):this.carriageArrow===e?(M=this.view.getViewNodeFor(this.model.parent),d=M.bounds[1],_.push(new this.view.draw.Point(this.bounds[E].right(),d.y)),_.push(new this.view.draw.Point(d.x+this.view.opts.tabOffset+this.view.opts.tabWidth,d.y)),A.push(new this.view.draw.Point(this.bounds[E].x,d.y-this.view.opts.padding)),A.push(new this.view.draw.Point(d.x,d.y-this.view.opts.padding)),A.push(new this.view.draw.Point(d.x,d.y)),this.addTab(_,new this.view.draw.Point(d.x+this.view.opts.tabOffset,d.y))):this.carriageArrow===g&&this.model.isLastOnLine()&&(M=this.view.getViewNodeFor(this.model.parent),d=M.bounds[this.model.getLinesToParent()],_.push(new this.view.draw.Point(this.bounds[E].right(),d.bottom()+this.view.opts.padding)),_.push(new this.view.draw.Point(d.x+this.view.opts.tabOffset+this.view.opts.tabWidth,d.bottom()+this.view.opts.padding)),A.push(new this.view.draw.Point(this.bounds[E].x,d.bottom())),A.push(new this.view.draw.Point(d.x,d.bottom())),A.push(new this.view.draw.Point(d.x,d.bottom()+this.view.opts.padding)),this.addTab(_,new this.view.draw.Point(d.x+this.view.opts.tabOffset,d.bottom()+this.view.opts.padding))),(W=this.multilineChildrenData[E])!==o&&W!==m||(H=this.lineChildren[E][this.lineChildren[E].length-1],I=this.view.getViewNodeFor(H.child),G=I.bounds[E-H.startLine],p=(null!=(X=this.glue[E])?X.draw:void 0)?this.bounds[E+1].y-this.glue[E].height+this.view.opts.padding:this.bounds[E].bottom(),"indent"===H.child.type&&"newline"===H.child.start.next.type?(_.push(new this.view.draw.Point(this.bounds[E].right(),p)),this.addTab(_,new this.view.draw.Point(this.bounds[E+1].x+this.view.opts.indentWidth+this.view.opts.tabOffset,p),!0)):_.push(new this.view.draw.Point(G.x,p)),p!==this.bounds[E+1].y&&_.push(new this.view.draw.Point(I.bounds[E-H.startLine+1].x,p)),_.push(new this.view.draw.Point(I.bounds[E-H.startLine+1].x,this.bounds[E+1].y)));for(this.shouldAddTab()&&this.model.isLastOnLine()&&this.carriageArrow===f&&this.addTab(_,new this.view.draw.Point(this.bounds[this.lineLength-1].x+this.view.opts.tabOffset,this.bounds[this.lineLength-1].bottom())),da=A[0],N=u(A.reverse().concat(_)),K=[],s=x=0,D=N.length;x<D;s=++x)O=N[s],(0!==s||this.bevels.bottom)&&(this.bevels.top||!O.almostEquals(da))?(L=N[F(s+1,N.length)],P=N[F(s-1,N.length)],O.x===L.x!=(O.y===L.y)&&O.x===P.x!=(O.y===P.y)&&O.from(P).magnitude()>=2*this.view.opts.bevelClip&&O.from(L).magnitude()>=2*this.view.opts.bevelClip?(K.push(O.plus(O.from(P).toMagnitude(-this.view.opts.bevelClip))),K.push(O.plus(O.from(L).toMagnitude(-this.view.opts.bevelClip)))):K.push(O)):K.push(O);return this.path.setPoints(K),"block"===this.model.type&&(this.path.style.fillColor=this.view.getColor(this.model.color)),((null!=(Y=this.model.buttons)?Y.addButton:void 0)||(null!=(Z=this.model.buttons)?Z.subtractButton:void 0))&&(i=this.bounds[0],j=i.x+i.width-this.extraWidth,k=i.y+i.height/2-this.view.opts.buttonHeight/2,y=this.bounds.length-1,z=this.bounds[y],ba=z.x+z.width-this.extraWidth,ca=z.y+z.height/2-this.view.opts.buttonHeight/2,this.multilineChildrenData[y]===l&&(H=this.lineChildren[y][0],G=this.view.getViewNodeFor(H.child).bounds[y-H.startLine],this.lineChildren[y].length>1?(r=G.bottom()-z.y,ca=z.y+r/2-this.view.opts.buttonHeight/2):(r=z.bottom()-G.bottom(),ca=G.bottom()+r/2-this.view.opts.buttonHeight/2)),b=this.model.buttons.onFirstLine?j:ba,c=this.model.buttons.onFirstLine?k:ca,(null!=($=this.model.buttons)?$.subtractButton:void 0)&&(this.subtractButtonPath.style.transform="translate("+b+", "+c+")",this.subtractButtonPath.update(),this.subtractButtonRect=new this.view.draw.Rectangle(b,c,this.view.opts.buttonWidth,this.view.opts.buttonHeight),this.elements.push(this.subtractButtonPath),b+=this.view.opts.buttonWidth+this.view.opts.buttonPadding),(null!=(S=this.model.buttons)?S.addButton:void 0)&&(this.addButtonPath.style.transform="translate("+b+", "+c+")",this.addButtonPath.update(),this.addButtonRect=new this.view.draw.Rectangle(b,c,this.view.opts.buttonWidth,this.view.opts.buttonHeight),this.elements.push(this.addButtonPath))),this.path},b.prototype.addTab=function(a,b){return a.push(new this.view.draw.Point(b.x+this.view.opts.tabWidth,b.y)),a.push(new this.view.draw.Point(b.x+this.view.opts.tabWidth*(1-this.view.opts.tabSideWidth),b.y+this.view.opts.tabHeight)),a.push(new this.view.draw.Point(b.x+this.view.opts.tabWidth*this.view.opts.tabSideWidth,b.y+this.view.opts.tabHeight)),a.push(new this.view.draw.Point(b.x,b.y)),a.push(b)},b.prototype.addTabReverse=function(a,b){return a.push(b),a.push(new this.view.draw.Point(b.x,b.y)),a.push(new this.view.draw.Point(b.x+this.view.opts.tabWidth*this.view.opts.tabSideWidth,b.y+this.view.opts.tabHeight)),a.push(new this.view.draw.Point(b.x+this.view.opts.tabWidth*(1-this.view.opts.tabSideWidth),b.y+this.view.opts.tabHeight)),a.push(new this.view.draw.Point(b.x+this.view.opts.tabWidth,b.y))},b.prototype.mark=function(a){return this.view.registerMark(this.model.id),this.markStyle=a,this.focusAll()},b.prototype.unmark=function(){return this.markStyle=null},b.prototype.drawSelf=function(a){var b,c;return null==a&&(a={}),b=this.path.style.fillColor,c=this.path.style.strokeColor,a.grayscale&&("none"!==this.path.style.fillColor&&(this.path.style.fillColor=t(this.path.style.fillColor,.5,"#888")),"none"!==this.path.style.strokeColor&&(this.path.style.strokeColor=t(this.path.style.strokeColor,.5,"#888"))),a.selected&&("none"!==this.path.style.fillColor&&(this.path.style.fillColor=t(this.path.style.fillColor,.7,"#00F")),"none"!==this.path.style.strokeColor&&(this.path.style.strokeColor=t(this.path.style.strokeColor,.7,"#00F"))),this.path.setMarkStyle(this.markStyle),this.path.update(),this.path.style.fillColor=b,this.path.style.strokeColor=c,null},b.prototype.computeOwnDropArea=function(){if(this.dropArea=null,null!=this.highlightArea)return this.elements=this.elements.filter(function(a){return a!==this.highlightArea}),this.highlightArea.destroy(),this.highlightArea=null},b.prototype.shouldAddTab=p,b}(E),c=function(a){function b(){var a,c,e,f,g,h,i;b.__super__.constructor.apply(this,arguments),(null!=(a=this.model.buttons)?a.addButton:void 0)&&(this.addButtonPath=new this.view.draw.Path([new this.view.draw.Point(0,0),new this.view.draw.Point(0+this.view.opts.buttonWidth,0),new this.view.draw.Point(0+this.view.opts.buttonWidth,0+this.view.opts.buttonHeight),new this.view.draw.Point(0,0+this.view.opts.buttonHeight)],!0,{fillColor:this.view.getColor(this.model.color),cssClass:"droplet-button-path"}),i=new this.view.draw.Text(new this.view.draw.Point((this.view.opts.buttonWidth-this.view.draw.measureCtx.measureText(null!=(c=this.model.buttons)?c.addButton:void 0).width)/2,this.view.opts.buttonHeight-this.view.opts.textHeight+d[this.model.buttons.addButton]),null!=(e=this.model.buttons)?e.addButton:void 0),i.setParent(this.addButtonPath),this.addButtonPath.setParent(this.group),this.elements.push(this.addButtonPath),this.activeElements.push(i),this.activeElements.push(this.addButtonPath)),(null!=(f=this.model.buttons)?f.subtractButton:void 0)&&(this.subtractButtonPath=new this.view.draw.Path([new this.view.draw.Point(0,0),new this.view.draw.Point(0+this.view.opts.buttonWidth,0),new this.view.draw.Point(0+this.view.opts.buttonWidth,0+this.view.opts.buttonHeight),new this.view.draw.Point(0,0+this.view.opts.buttonHeight)],!0,{fillColor:this.view.getColor(this.model.color),cssClass:"droplet-button-path"}),i=new this.view.draw.Text(new this.view.draw.Point((this.view.opts.buttonWidth-this.view.draw.measureCtx.measureText(null!=(g=this.model.buttons)?g.subtractButton:void 0).width)/2,this.view.opts.buttonHeight-this.view.opts.textHeight+d[this.model.buttons.subtractButton]),null!=(h=this.model.buttons)?h.subtractButton:void 0),i.setParent(this.subtractButtonPath),this.subtractButtonPath.setParent(this.group),this.elements.push(this.subtractButtonPath),this.activeElements.push(i),this.activeElements.push(this.subtractButtonPath))}return D(b,a),b.prototype.computeMinDimensions=function(){var a,c,d,e,f,g,h;if(this.computedVersion===this.model.version)return null;for(b.__super__.computeMinDimensions.apply(this,arguments),this.extraWidth=0,this.model.buttons.addButton&&(this.extraWidth+=this.view.opts.buttonWidth+this.view.opts.buttonPadding),this.model.buttons.subtractButton&&(this.extraWidth+=this.view.opts.buttonWidth+this.view.opts.buttonPadding),f=this.minDimensions,c=d=0,e=f.length;d<e;c=++d)h=f[c],h.width=Math.max(h.width,this.view.opts.tabWidth+this.view.opts.tabOffset);return a=(null!=(g=this.model.buttons)?g.onFirstLine:void 0)?0:this.minDimensions.length-1,this.minDimensions[a].width+=this.extraWidth,null},b.prototype.shouldAddTab=function(){var a;return null==this.model.parent||!this.view.hasViewNodeFor(this.model.parent)||"document"===this.model.parent.type&&this.model.parent.opts.roundedSingletons&&this.model.start.prev===this.model.parent.start&&this.model.end.next===this.model.parent.end?!(C.call(this.model.classes,"mostly-value")>=0||C.call(this.model.classes,"value-only")>=0):"socket"!==(null!=(a=this.model.parent)?a.type:void 0)},b.prototype.computeOwnDropArea=function(){var a,b,c,d,f,h,i;if("indent"===(h=null!=(i=this.model.parent)?i.type:void 0)||"document"===h)return this.carriageArrow===e?(f=this.view.getViewNodeFor(this.model.parent),a=f.bounds[1],this.dropPoint=new this.view.draw.Point(a.x,a.y),c=a.x,d=a.right()):this.carriageArrow===g?(f=this.view.getViewNodeFor(this.model.parent),a=f.bounds[1],this.dropPoint=new this.view.draw.Point(a.x,this.bounds[this.lineLength-1].bottom()+this.view.opts.padding),c=a.x,d=this.bounds[this.lineLength-1].right()):(this.dropPoint=new this.view.draw.Point(this.bounds[this.lineLength-1].x,this.bounds[this.lineLength-1].bottom()),c=this.bounds[this.lineLength-1].x,d=this.bounds[this.lineLength-1].right()),b=[],b.push(new this.view.draw.Point(c,this.dropPoint.y-this.view.opts.highlightAreaHeight/2+this.view.opts.bevelClip)),b.push(new this.view.draw.Point(c+this.view.opts.bevelClip,this.dropPoint.y-this.view.opts.highlightAreaHeight/2)),this.addTabReverse(b,new this.view.draw.Point(c+this.view.opts.tabOffset,this.dropPoint.y-this.view.opts.highlightAreaHeight/2)),b.push(new this.view.draw.Point(d-this.view.opts.bevelClip,this.dropPoint.y-this.view.opts.highlightAreaHeight/2)),b.push(new this.view.draw.Point(d,this.dropPoint.y-this.view.opts.highlightAreaHeight/2+this.view.opts.bevelClip)),b.push(new this.view.draw.Point(d,this.dropPoint.y+this.view.opts.highlightAreaHeight/2-this.view.opts.bevelClip)),b.push(new this.view.draw.Point(d-this.view.opts.bevelClip,this.dropPoint.y+this.view.opts.highlightAreaHeight/2)),this.addTab(b,new this.view.draw.Point(c+this.view.opts.tabOffset,this.dropPoint.y+this.view.opts.highlightAreaHeight/2)),b.push(new this.view.draw.Point(c+this.view.opts.bevelClip,this.dropPoint.y+this.view.opts.highlightAreaHeight/2)),b.push(new this.view.draw.Point(c,this.dropPoint.y+this.view.opts.highlightAreaHeight/2-this.view.opts.bevelClip)),this.highlightArea.setPoints(b),this.highlightArea.deactivate()},b}(y),G=function(a){function b(){b.__super__.constructor.apply(this,arguments),this.view.opts.showDropdowns&&null!=this.model.dropdown&&(null==this.dropdownElement&&(this.dropdownElement=new this.view.draw.Path([],!1,{fillColor:k,cssClass:"droplet-dropdown-arrow"})),this.dropdownElement.deactivate(),this.dropdownElement.setParent(this.group),this.elements.push(this.dropdownElement))}return D(b,a),b.prototype.shouldAddTab=p,b.prototype.isInvisibleSocket=function(){var a;return""===this.model.emptyString&&(null!=(a=this.model.start)?a.next:void 0)===this.model.end},b.prototype.computeMinDimensions=function(){var a,c,d,e;if(this.computedVersion===this.model.version)return null;for(b.__super__.computeMinDimensions.apply(this,arguments),this.minDistanceToBase[0].above=Math.max(this.minDistanceToBase[0].above,this.view.opts.textHeight+this.view.opts.textPadding),this.minDistanceToBase[0].below=Math.max(this.minDistanceToBase[0].below,this.view.opts.textPadding),this.minDimensions[0].height=this.minDistanceToBase[0].above+this.minDistanceToBase[0].below,e=this.minDimensions,c=0,d=e.length;c<d;c++)a=e[c],a.width=Math.max(a.width,this.isInvisibleSocket()?this.view.opts.invisibleSocketWidth:this.view.opts.minSocketWidth),this.model.hasDropdown()&&this.view.opts.showDropdowns&&(a.width+=w.DROPDOWN_ARROW_WIDTH);return null},b.prototype.computeBoundingBoxX=function(a,c){return b.__super__.computeBoundingBoxX.call(this,a,c,this.model.hasDropdown()&&this.view.opts.showDropdowns?w.DROPDOWN_ARROW_WIDTH:0)},b.prototype.computeGlue=function(){var a;return this.computedVersion!==this.model.version||this.changedBoundingBox?"blockStart"===this.model.start.next.type?(a=this.view.getViewNodeFor(this.model.start.next.container),this.glue=a.computeGlue()):b.__super__.computeGlue.apply(this,arguments):this.glue},b.prototype.computeOwnPath=function(){var a;return this.computedVersion!==this.model.version||this.changedBoundingBox?("blockStart"===this.model.start.next.type?this.path.style.fill="none":b.__super__.computeOwnPath.apply(this,arguments),""===this.model.emptyString&&(null!=(a=this.model.start)?a.next:void 0)===this.model.end?(this.path.style.cssClass="droplet-socket-path droplet-empty-socket-path",this.path.style.fillColor="none"):(this.path.style.cssClass="droplet-socket-path",this.path.style.fillColor="#FFF"),this.path):this.path},b.prototype.drawSelf=function(a){return null==a&&(a={}),b.__super__.drawSelf.apply(this,arguments),this.model.hasDropdown()&&this.view.opts.showDropdowns?(this.dropdownElement.setPoints([new this.view.draw.Point(this.bounds[0].x+w.DROPDOWN_ARROW_PADDING,this.bounds[0].y+(this.bounds[0].height-j)/2),new this.view.draw.Point(this.bounds[0].x+w.DROPDOWN_ARROW_WIDTH-w.DROPDOWN_ARROW_PADDING,this.bounds[0].y+(this.bounds[0].height-j)/2),new this.view.draw.Point(this.bounds[0].x+w.DROPDOWN_ARROW_WIDTH/2,this.bounds[0].y+(this.bounds[0].height+j)/2)]),this.dropdownElement.update(),this.activeElements.push(this.dropdownElement)):null!=this.dropdownElement?(this.activeElements=this.activeElements.filter(function(a){return a!==this.dropdownElement}),this.dropdownElement.deactivate()):void 0},b.prototype.computeOwnDropArea=function(){return"blockStart"===this.model.start.next.type?(this.dropArea=null,this.highlightArea.deactivate()):(this.dropPoint=this.bounds[0].upperLeftCorner(),this.highlightArea.setPoints(this.path._points),this.highlightArea.style.strokeColor="#FF0",this.highlightArea.style.fillColor="none",this.highlightArea.style.lineWidth=this.view.opts.highlightAreaHeight/2,this.highlightArea.update(),this.highlightArea.deactivate())},b}(y),B=function(a){function b(){b.__super__.constructor.apply(this,arguments),this.lastFirstChildren=[],this.lastLastChildren=[]}return D(b,a),b.prototype.computeOwnPath=function(){},b.prototype.computeChildren=function(){var a,c,d,e,f,g,h,i,j,k,l,m;if(b.__super__.computeChildren.apply(this,arguments),!s(this.lineChildren[0],this.lastFirstChildren)||!s(this.lineChildren[this.lineLength-1],this.lastLastChildren))for(k=this.children,e=0,g=k.length;e<g;e++)a=k[e],d=this.view.getViewNodeFor(a.child),(d.topLineSticksToBottom||d.bottomLineSticksToTop)&&(d.invalidate=!0),1===d.lineLength&&(d.topLineSticksToBottom=d.bottomLineSticksToTop=!1);for(l=this.lineChildren[0],f=0,h=l.length;f<h;f++)c=l[f],d=this.view.getViewNodeFor(c.child),d.topLineSticksToBottom||(d.invalidate=!0),d.topLineSticksToBottom=!0;for(m=this.lineChildren[this.lineChildren.length-1],j=0,i=m.length;j<i;j++)c=m[j],d=this.view.getViewNodeFor(c.child),d.bottomLineSticksToTop||(d.invalidate=!0),d.bottomLineSticksToTop=!0;return this.lineLength},b.prototype.computeMinDimensions=function(){var a,c,d,e,f,g;for(b.__super__.computeMinDimensions.apply(this,arguments),e=this.minDimensions.slice(1),f=[],d=a=0,c=e.length;a<c;d=++a)g=e[d],0===g.width&&f.push(g.width=this.view.opts.emptyLineWidth);return f},b.prototype.drawSelf=function(){},b.prototype.computeOwnDropArea=function(){var a,b;return b=new this.view.draw.NoRectangle,"newline"===this.model.start.next.type?(this.dropPoint=this.bounds[1].upperLeftCorner(),b.copy(this.bounds[1])):(this.dropPoint=this.bounds[0].upperLeftCorner(),b.copy(this.bounds[0])),b.width=Math.max(b.width,this.view.opts.indentDropAreaMinWidth),a=[],a.push(new this.view.draw.Point(b.x,b.y-this.view.opts.highlightAreaHeight/2+this.view.opts.bevelClip)),a.push(new this.view.draw.Point(b.x+this.view.opts.bevelClip,b.y-this.view.opts.highlightAreaHeight/2)),this.addTabReverse(a,new this.view.draw.Point(b.x+this.view.opts.tabOffset,b.y-this.view.opts.highlightAreaHeight/2)),a.push(new this.view.draw.Point(b.right()-this.view.opts.bevelClip,b.y-this.view.opts.highlightAreaHeight/2)),a.push(new this.view.draw.Point(b.right(),b.y-this.view.opts.highlightAreaHeight/2+this.view.opts.bevelClip)),a.push(new this.view.draw.Point(b.right(),b.y+this.view.opts.highlightAreaHeight/2-this.view.opts.bevelClip)),a.push(new this.view.draw.Point(b.right()-this.view.opts.bevelClip,b.y+this.view.opts.highlightAreaHeight/2)),this.addTab(a,new this.view.draw.Point(b.x+this.view.opts.tabOffset,b.y+this.view.opts.highlightAreaHeight/2)),a.push(new this.view.draw.Point(b.x+this.view.opts.bevelClip,b.y+this.view.opts.highlightAreaHeight/2)),a.push(new this.view.draw.Point(b.x,b.y+this.view.opts.highlightAreaHeight/2-this.view.opts.bevelClip)),this.highlightArea.setPoints(a),this.highlightArea.deactivate()},b}(y),z=function(a){function b(){b.__super__.constructor.apply(this,arguments)}return D(b,a),b.prototype.computeOwnPath=function(){},b.prototype.computeOwnDropArea=function(){var a,b;return this.dropPoint=this.bounds[0].upperLeftCorner(),a=[],b=new this.view.draw.NoRectangle,b.copy(this.bounds[0]),b.width=Math.max(b.width,this.view.opts.indentDropAreaMinWidth),a.push(new this.view.draw.Point(b.x,b.y-this.view.opts.highlightAreaHeight/2+this.view.opts.bevelClip)),a.push(new this.view.draw.Point(b.x+this.view.opts.bevelClip,b.y-this.view.opts.highlightAreaHeight/2)),this.addTabReverse(a,new this.view.draw.Point(b.x+this.view.opts.tabOffset,b.y-this.view.opts.highlightAreaHeight/2)),a.push(new this.view.draw.Point(b.right()-this.view.opts.bevelClip,b.y-this.view.opts.highlightAreaHeight/2)),a.push(new this.view.draw.Point(b.right(),b.y-this.view.opts.highlightAreaHeight/2+this.view.opts.bevelClip)),a.push(new this.view.draw.Point(b.right(),b.y+this.view.opts.highlightAreaHeight/2-this.view.opts.bevelClip)),a.push(new this.view.draw.Point(b.right()-this.view.opts.bevelClip,b.y+this.view.opts.highlightAreaHeight/2)),this.addTab(a,new this.view.draw.Point(b.x+this.view.opts.tabOffset,b.y+this.view.opts.highlightAreaHeight/2)),a.push(new this.view.draw.Point(b.x+this.view.opts.bevelClip,b.y+this.view.opts.highlightAreaHeight/2)),a.push(new this.view.draw.Point(b.x,b.y+this.view.opts.highlightAreaHeight/2-this.view.opts.bevelClip)),this.highlightArea.setPoints(a),this.highlightArea.deactivate(),null},b}(y),H=function(a){function b(a,c){this.model=a,this.view=c,b.__super__.constructor.apply(this,arguments),this.textElement=new this.view.draw.Text(new this.view.draw.Point(0,0),this.model.value),this.textElement.destroy(),this.elements.push(this.textElement)}return D(b,a),b.prototype.computeChildren=function(){return this.multilineChildrenData=[q],this.lineLength=1},b.prototype.computeMinDimensions=function(){var a;return this.computedVersion===this.model.version?null:(this.textElement.point=new this.view.draw.Point(0,0),this.textElement.value=this.model.value,a=this.view.opts.textHeight,this.minDimensions[0]=new this.view.draw.Size(this.textElement.bounds().width,a),this.minDistanceToBase[0]={above:a,below:0},null)},b.prototype.computeBoundingBoxX=function(a,c){return this.textElement.point.x=a,b.__super__.computeBoundingBoxX.apply(this,arguments)},b.prototype.computeBoundingBoxY=function(a,c){return this.textElement.point.y=a,b.__super__.computeBoundingBoxY.apply(this,arguments)},b.prototype.drawSelf=function(a,b){if(null==a&&(a={}),null==b&&(b=null),this.textElement.update(),a.noText?this.textElement.deactivate():this.textElement.activate(),null!=b)return this.textElement.setParent(b)},b}(A),a}(),z=function(a){var b,c,d,e;return 4===a.length&&(a=function(){var b,d,e;for(e=[],b=0,d=a.length;b<d;b++)c=a[b],e.push(c+c);return e}().join("").slice(1)),e=parseInt(a.slice(1,3),16),d=parseInt(a.slice(3,5),16),b=parseInt(a.slice(5,7),16),[e,d,b]},B=function(a,b){return a.length<b?function(){var c,d,e,f;for(f=[],c=d=a.length,e=b;d<=e?c<e:c>e;d<=e?c++:c--)f.push("0");return f}().join("")+a:a},A=function(a){return B(Math.round(a).toString(16),2)},y=function(a){var b;return"#"+function(){var c,d,e;for(e=[],c=0,d=a.length;c<d;c++)b=a[c],e.push(A(b));return e}().join("")},t=function(a,b,c){var d,e,f;return a=z(a),c=z(c),f=function(){var f,g,h;for(h=[],d=f=0,g=a.length;f<g;d=++f)e=a[d],h.push(a[d]*b+c[d]*(1-b));return h}(),y(f)},u=function(a){return a=a.filter(function(b,c){return!b.equals(a[F(c-1,a.length)])}),a=a.filter(function(b,c){return!v._collinear(a[F(c-1,a.length)],b,a[F(c+1,a.length)])})}},{"./draw.coffee":27,"./helper.coffee":28,"./model.coffee":31}],35:[function(b,c,d){!function(b,e){"object"==typeof d&&"object"==typeof c?e(d):"function"==typeof a&&a.amd?a(["exports"],e):e(b.acorn||(b.acorn={}))}(this,function(a){"use strict";function b(a){Ya=a||{};for(var b in ab)U(Ya,b)||(Ya[b]=ab[b]);_a=Ya.sourceFile||null,Vc=Ya.ecmaVersion>=6?Uc:Tc}function c(a,b){var c=bb(Za,a);b+=" ("+c.line+":"+c.column+")";var d=new SyntaxError(b);throw d.pos=a,d.loc=c,d.raisedAt=db,d}function d(a){function b(a){if(1==a.length)return c+="return str === "+JSON.stringify(a[0])+";";c+="switch(str){";for(var b=0;b<a.length;++b)c+="case "+JSON.stringify(a[b])+":";c+="return true}return false;"}a=a.split(" ");var c="",d=[];a:for(var e=0;e<a.length;++e){for(var f=0;f<d.length;++f)if(d[f][0].length==a[e].length){d[f].push(a[e]);continue a}d.push([a[e]])}if(d.length>3){d.sort(function(a,b){return b.length-a.length}),c+="switch(str.length){";for(var e=0;e<d.length;++e){var g=d[e];c+="case "+g[0].length+":",b(g)}c+="}"}else b(a);return new Function("str",c)}function e(){this.line=lb,this.column=db-mb}function f(){lb=Ya.line,db=mb=0,kb=!0,ub=0,vb=!1,j()}function g(a,b,c){fb=db,Ya.locations&&(hb=new e),ib=a,!1!==c&&j(),jb=b,kb=a.beforeExpr,Ya.onToken&&Ya.onToken(cb())}function h(){var a=Ya.onComment&&Ya.locations&&new e,b=db,d=Za.indexOf("*/",db+=2);if(-1===d&&c(db-2,"Unterminated comment"),db=d+2,Ya.locations){_c.lastIndex=b;for(var f;(f=_c.exec(Za))&&f.index<db;)++lb,mb=f.index+f[0].length}Ya.onComment&&Ya.onComment(!0,Za.slice(b+2,d),b,db,a,Ya.locations&&new e)}function i(){for(var a=db,b=Ya.onComment&&Ya.locations&&new e,c=Za.charCodeAt(db+=2);db<$a&&10!==c&&13!==c&&8232!==c&&8233!==c;)++db,c=Za.charCodeAt(db);Ya.onComment&&Ya.onComment(!1,Za.slice(a+2,db),a,db,b,Ya.locations&&new e)}function j(){for(;db<$a;){var a=Za.charCodeAt(db);if(32===a)++db;else if(13===a){++db;var b=Za.charCodeAt(db);10===b&&++db,Ya.locations&&(++lb,mb=db)}else if(10===a||8232===a||8233===a)++db,Ya.locations&&(++lb,mb=db);else if(a>8&&a<14)++db;else if(47===a){var b=Za.charCodeAt(db+1);if(42===b)h();else{if(47!==b)break;i()}}else if(160===a)++db;else{if(!(a>=5760&&Wc.test(String.fromCharCode(a))))break;++db}}}function k(){var a=Za.charCodeAt(db+1);if(a>=48&&a<=57)return z(!0);var b=Za.charCodeAt(db+2);return Ya.ecmaVersion>=6&&46===a&&46===b?(db+=3,g(rc)):(++db,g(qc))}function l(){var a=Za.charCodeAt(db+1);return kb?(++db,w()):61===a?v(yc,2):v(wc,1)}function m(a){return 61===Za.charCodeAt(db+1)?v(yc,2):v(42===a?Lc:Kc,1)}function n(a){var b=Za.charCodeAt(db+1);return b===a?v(124===a?Bc:Cc,2):61===b?v(yc,2):v(124===a?Dc:Fc,1)}function o(){return 61===Za.charCodeAt(db+1)?v(yc,2):v(Ec,1)}function p(a){var b=Za.charCodeAt(db+1);return b===a?45==b&&62==Za.charCodeAt(db+2)&&$c.test(Za.slice(ob,db))?(db+=3,i(),j(),u()):v(zc,2):61===b?v(yc,2):v(Jc,1)}function q(a){var b=Za.charCodeAt(db+1),c=1;return b===a?(c=62===a&&62===Za.charCodeAt(db+2)?3:2,61===Za.charCodeAt(db+c)?v(yc,c+1):v(Ic,c)):33==b&&60==a&&45==Za.charCodeAt(db+2)&&45==Za.charCodeAt(db+3)?(db+=4,i(),j(),u()):(61===b&&(c=61===Za.charCodeAt(db+2)?3:2),v(Hc,c))}function r(a){var b=Za.charCodeAt(db+1);return 61===b?v(Gc,61===Za.charCodeAt(db+2)?3:2):61===a&&62===b&&Ya.ecmaVersion>=6?(db+=2,g(tc)):v(61===a?xc:Ac,1)}function s(a){if(ib===zb){if(96===a)return++db,g(uc);if(36===a&&123===Za.charCodeAt(db+1))return db+=2,g(vc)}return 125===a?(++db,g(kc,void 0,!1)):C()}function t(a){switch(a){case 46:return k();case 40:return++db,g(lc);case 41:return++db,g(mc);case 59:return++db,g(oc);case 44:return++db,g(nc);case 91:return++db,g(hc);case 93:return++db,g(ic);case 123:return++db,g(jc);case 125:return++db,g(kc);case 58:return++db,g(pc);case 63:return++db,g(sc);case 96:if(Ya.ecmaVersion>=6)return++db,g(uc,void 0,!1);case 48:var b=Za.charCodeAt(db+1);if(120===b||88===b)return y(16);if(Ya.ecmaVersion>=6){if(111===b||79===b)return y(8);if(98===b||66===b)return y(2)}case 49:case 50:case 51:case 52:case 53:case 54:case 55:case 56:case 57:return z(!1);case 34:case 39:return B(a);case 47:return l();case 37:case 42:return m(a);case 124:case 38:return n(a);case 94:return o();case 43:case 45:return p(a);case 60:case 62:return q(a);case 61:case 33:return r(a);case 126:return v(Ac,1)}return!1}function u(a){if(a?db=eb+1:eb=db,Ya.locations&&(gb=new e),a)return w();if(db>=$a)return g(Bb);var b=Za.charCodeAt(db);if(vb)return s(b);if(ad(b)||92===b)return G();var d=t(b);if(!1===d){var f=String.fromCharCode(b);if("\\"===f||Yc.test(f))return G();c(db,"Unexpected character '"+f+"'")}return d}function v(a,b){var c=Za.slice(db,db+b);db+=b,g(a,c)}function w(){for(var a,b,d="",e=db;;){db>=$a&&c(e,"Unterminated regular expression");var f=Za.charAt(db);if($c.test(f)&&c(e,"Unterminated regular expression"),a)a=!1;else{if("["===f)b=!0;else if("]"===f&&b)b=!1;else if("/"===f&&!b)break;a="\\"===f}++db}var d=Za.slice(e,db);++db;var h=F();h&&!/^[gmsiy]*$/.test(h)&&c(e,"Invalid regular expression flag");try{var i=new RegExp(d,h)}catch(a){a instanceof SyntaxError&&c(e,"Error parsing regular expression: "+a.message),c(a)}return g(yb,i)}function x(a,b){for(var c=db,d=0,e=0,f=null==b?1/0:b;e<f;++e){var g,h=Za.charCodeAt(db);if((g=h>=97?h-97+10:h>=65?h-65+10:h>=48&&h<=57?h-48:1/0)>=a)break;++db,d=d*a+g}return db===c||null!=b&&db-c!==b?null:d}function y(a){db+=2;var b=x(a);return null==b&&c(eb+2,"Expected number in radix "+a),ad(Za.charCodeAt(db))&&c(db,"Identifier directly after number"),g(xb,b)}function z(a){var b=db,d=!1,e=48===Za.charCodeAt(db);a||null!==x(10)||c(b,"Invalid number"),46===Za.charCodeAt(db)&&(++db,x(10),d=!0);var f=Za.charCodeAt(db);69!==f&&101!==f||(f=Za.charCodeAt(++db),43!==f&&45!==f||++db,null===x(10)&&c(b,"Invalid number"),d=!0),ad(Za.charCodeAt(db))&&c(db,"Identifier directly after number");var h,i=Za.slice(b,db);return d?h=parseFloat(i):e&&1!==i.length?/[89]/.test(i)||tb?c(b,"Invalid number"):h=parseInt(i,8):h=parseInt(i,10),g(xb,h)}function A(){var a,b=Za.charCodeAt(db);if(123===b?(Ya.ecmaVersion<6&&T(),++db,a=E(Za.indexOf("}",db)-db),++db,a>1114111&&T()):a=E(4),a<=65535)return String.fromCharCode(a);var c=55296+(a-65536>>10),d=56320+(a-65536&1023);return String.fromCharCode(c,d)}function B(a){++db;for(var b="";;){db>=$a&&c(eb,"Unterminated string constant");var d=Za.charCodeAt(db);if(d===a)return++db,g(zb,b);92===d?b+=D():(++db,$c.test(String.fromCharCode(d))&&c(eb,"Unterminated string constant"),b+=String.fromCharCode(d))}}function C(){for(var a="";;){db>=$a&&c(eb,"Unterminated string constant");var b=Za.charCodeAt(db);if(96===b||36===b&&123===Za.charCodeAt(db+1))return g(zb,a);92===b?a+=D():(++db,$c.test(String.fromCharCode(b))&&(13===b&&10===Za.charCodeAt(db)&&(++db,b=10),Ya.locations&&(++lb,mb=db)),a+=String.fromCharCode(b))}}function D(){var a=Za.charCodeAt(++db),b=/^[0-7]+/.exec(Za.slice(db,db+3));for(b&&(b=b[0]);b&&parseInt(b,8)>255;)b=b.slice(0,-1);if("0"===b&&(b=null),++db,b)return tb&&c(db-2,"Octal literal in strict mode"),db+=b.length-1,String.fromCharCode(parseInt(b,8));switch(a){case 110:return"\n";case 114:return"\r";case 120:return String.fromCharCode(E(2));case 117:return A();case 85:return String.fromCharCode(E(8));case 116:return"\t";case 98:return"\b";case 118:return"\v";case 102:return"\f";case 48:return"\0";case 13:10===Za.charCodeAt(db)&&++db;case 10:return Ya.locations&&(mb=db,++lb),"";default:return String.fromCharCode(a)}}function E(a){var b=x(16,a);return null===b&&c(eb,"Bad character escape sequence"),b}function F(){Nc=!1;for(var a,b=!0,d=db;;){var e=Za.charCodeAt(db);if(bd(e))Nc&&(a+=Za.charAt(db)),++db;else{if(92!==e)break;Nc||(a=Za.slice(d,db)),Nc=!0,117!=Za.charCodeAt(++db)&&c(db,"Expecting Unicode escape sequence \\uXXXX"),++db;var f=E(4),g=String.fromCharCode(f);g||c(db-1,"Invalid Unicode escape"),(b?ad(f):bd(f))||c(db-4,"Invalid Unicode escape"),a+=g}b=!1}return Nc?a:Za.slice(d,db)}function G(){var a=F(),b=Ab;return!Nc&&Vc(a)&&(b=gc[a]),g(b,a)}function H(){nb=eb,ob=fb,pb=hb,u()}function I(a){if(tb=a,db=eb,Ya.locations)for(;db<mb;)mb=Za.lastIndexOf("\n",mb-2)+1,--lb;j(),u()}function J(){this.type=null,this.start=eb,this.end=null}function K(){this.start=gb,this.end=null,null!==_a&&(this.source=_a)}function L(){var a=new J;return Ya.locations&&(a.loc=new K),Ya.directSourceFile&&(a.sourceFile=Ya.directSourceFile),Ya.ranges&&(a.range=[eb,0]),a}function M(a){
var b=new J;return b.start=a.start,Ya.locations&&(b.loc=new K,b.loc.start=a.loc.start),Ya.ranges&&(b.range=[a.range[0],0]),b}function N(a,b){return a.type=b,a.end=ob,Ya.locations&&(a.loc.end=pb),Ya.ranges&&(a.range[1]=ob),a}function O(a){return Ya.ecmaVersion>=5&&"ExpressionStatement"===a.type&&"Literal"===a.expression.type&&"use strict"===a.expression.value}function P(a){return ib===a&&(H(),!0)}function Q(){return!Ya.strictSemicolons&&(ib===Bb||ib===kc||$c.test(Za.slice(ob,eb)))}function R(){P(oc)||Q()||T()}function S(a){P(a)||T()}function T(a){c(null!=a?a:eb,"Unexpected token")}function U(a,b){return Object.prototype.hasOwnProperty.call(a,b)}function V(a,b,c){if(Ya.ecmaVersion>=6&&a)switch(a.type){case"Identifier":case"MemberExpression":break;case"ObjectExpression":a.type="ObjectPattern";for(var d=0;d<a.properties.length;d++){var e=a.properties[d];"init"!==e.kind&&T(e.key.start),V(e.value,!1,c)}break;case"ArrayExpression":a.type="ArrayPattern";for(var d=0,f=a.elements.length-1;d<=f;d++)V(a.elements[d],d===f,c);break;case"SpreadElement":b?(V(a.argument,!1,c),W(a.argument)):T(a.start);break;default:c&&T(a.start)}return a}function W(a){"Identifier"!==a.type&&"ArrayPattern"!==a.type&&T(a.start)}function X(a,b){switch(a.type){case"Identifier":(Qc(a.name)||Rc(a.name))&&c(a.start,"Defining '"+a.name+"' in strict mode"),U(b,a.name)&&c(a.start,"Argument name clash in strict mode"),b[a.name]=!0;break;case"ObjectPattern":for(var d=0;d<a.properties.length;d++)X(a.properties[d].value,b);break;case"ArrayPattern":for(var d=0;d<a.elements.length;d++)X(a.elements[d],b)}}function Y(a,b){if(!a.computed){var d,e=a.key;switch(e.type){case"Identifier":d=e.name;break;case"Literal":d=String(e.value);break;default:return}var f,g=a.kind||"init";if(U(b,d)){f=b[d];var h="init"!==g;(!tb&&!h||!f[g])&&h^f.init||c(e.start,"Redefinition of property")}else f=b[d]={init:!1,get:!1,set:!1};f[g]=!0}}function Z(a,b){switch(a.type){case"Identifier":tb&&(Rc(a.name)||Qc(a.name))&&c(a.start,b?"Binding "+a.name+" in strict mode":"Assigning to "+a.name+" in strict mode");break;case"MemberExpression":if(!b)break;case"ObjectPattern":for(var d=0;d<a.properties.length;d++)Z(a.properties[d].value,b);break;case"ArrayPattern":for(var d=0;d<a.elements.length;d++){var e=a.elements[d];e&&Z(e,b)}break;case"SpreadElement":break;default:c(a.start,"Assigning to rvalue")}}function $(a){nb=ob=db,Ya.locations&&(pb=new e),qb=rb=tb=null,sb=[],u();var b=a||L(),c=!0;for(a||(b.body=[]);ib!==Bb;){var d=_();b.body.push(d),c&&O(d)&&I(!0),c=!1}return N(b,"Program")}function _(){(ib===wc||ib===yc&&"/="==jb)&&u(!0);var a=ib,b=L();switch(a){case Cb:case Fb:return aa(b,a.keyword);case Gb:return ba(b);case Ib:return ca(b);case Lb:return da(b);case Mb:return ea(b);case Zb:return Pa(b,!0);case Nb:return fa(b);case Ob:return ga(b);case Pb:return ha(b);case Qb:return ia(b);case Rb:return ja(b);case Sb:case Tb:case Ub:return ka(b,a.keyword);case Vb:return la(b);case Wb:return ma(b);case jc:return ra();case oc:return na(b);case _b:return Sa(b);case ac:return Ua(b);default:var c=jb,d=va();return a===Ab&&"Identifier"===d.type&&P(pc)?oa(b,c,d):pa(b,d)}}function aa(a,b){var d="break"==b;H(),P(oc)||Q()?a.label=null:ib!==Ab?T():(a.label=Ra(),R());for(var e=0;e<sb.length;++e){var f=sb[e];if(null==a.label||f.name===a.label.name){if(null!=f.kind&&(d||"loop"===f.kind))break;if(a.label&&d)break}}return e===sb.length&&c(a.start,"Unsyntactic "+b),N(a,d?"BreakStatement":"ContinueStatement")}function ba(a){return H(),R(),N(a,"DebuggerStatement")}function ca(a){return H(),sb.push(cd),a.body=_(),sb.pop(),S(Vb),a.test=qa(),R(),N(a,"DoWhileStatement")}function da(a){if(H(),sb.push(cd),S(lc),ib===oc)return sa(a,null);if(ib===Sb||ib===Tb){var b=L(),c=ib.keyword,d=ib===Tb;return H(),ua(b,!0,c),N(b,"VariableDeclaration"),ib!==fc&&(ib!==Ab||"of"!==jb)||1!==b.declarations.length||d&&b.declarations[0].init?sa(a,b):ta(a,b)}var b=va(!1,!0);return ib===fc||ib===Ab&&"of"===jb?(Z(b),ta(a,b)):sa(a,b)}function ea(a){return H(),Ka(a,!0)}function fa(a){return H(),a.test=qa(),a.consequent=_(),a.alternate=P(Jb)?_():null,N(a,"IfStatement")}function ga(a){return qb||Ya.allowReturnOutsideFunction||c(eb,"'return' outside of function"),H(),P(oc)||Q()?a.argument=null:(a.argument=va(),R()),N(a,"ReturnStatement")}function ha(a){H(),a.discriminant=qa(),a.cases=[],S(jc),sb.push(dd);for(var b,d;ib!=kc;)if(ib===Db||ib===Hb){var e=ib===Db;b&&N(b,"SwitchCase"),a.cases.push(b=L()),b.consequent=[],H(),e?b.test=va():(d&&c(nb,"Multiple default clauses"),d=!0,b.test=null),S(pc)}else b||T(),b.consequent.push(_());return b&&N(b,"SwitchCase"),H(),sb.pop(),N(a,"SwitchStatement")}function ia(a){return H(),$c.test(Za.slice(ob,eb))&&c(ob,"Illegal newline after throw"),a.argument=va(),R(),N(a,"ThrowStatement")}function ja(a){if(H(),a.block=ra(),a.handler=null,ib===Eb){var b=L();H(),S(lc),b.param=Ra(),tb&&Rc(b.param.name)&&c(b.param.start,"Binding "+b.param.name+" in strict mode"),S(mc),b.guard=null,b.body=ra(),a.handler=N(b,"CatchClause")}return a.guardedHandlers=wb,a.finalizer=P(Kb)?ra():null,a.handler||a.finalizer||c(a.start,"Missing catch or finally clause"),N(a,"TryStatement")}function ka(a,b){return H(),ua(a,!1,b),R(),N(a,"VariableDeclaration")}function la(a){return H(),a.test=qa(),sb.push(cd),a.body=_(),sb.pop(),N(a,"WhileStatement")}function ma(a){return tb&&c(eb,"'with' in strict mode"),H(),a.object=qa(),a.body=_(),N(a,"WithStatement")}function na(a){return H(),N(a,"EmptyStatement")}function oa(a,b,d){for(var e=0;e<sb.length;++e)sb[e].name===b&&c(d.start,"Label '"+b+"' is already declared");var f=ib.isLoop?"loop":ib===Pb?"switch":null;return sb.push({name:b,kind:f}),a.body=_(),sb.pop(),a.label=d,N(a,"LabeledStatement")}function pa(a,b){return a.expression=b,R(),N(a,"ExpressionStatement")}function qa(){S(lc);var a=va();return S(mc),a}function ra(a){var b,c=L(),d=!0,e=!1;for(c.body=[],S(jc);!P(kc);){var f=_();c.body.push(f),d&&a&&O(f)&&(b=e,I(e=!0)),d=!1}return e&&!b&&I(!1),N(c,"BlockStatement")}function sa(a,b){return a.init=b,S(oc),a.test=ib===oc?null:va(),S(oc),a.update=ib===mc?null:va(),S(mc),a.body=_(),sb.pop(),N(a,"ForStatement")}function ta(a,b){var c=ib===fc?"ForInStatement":"ForOfStatement";return H(),a.left=b,a.right=va(),S(mc),a.body=_(),sb.pop(),N(a,c)}function ua(a,b,c){for(a.declarations=[],a.kind=c;;){var d=L();if(d.id=Ya.ecmaVersion>=6?V(Da()):Ra(),Z(d.id,!0),d.init=P(xc)?va(!0,b):c===Ub.keyword?T():null,a.declarations.push(N(d,"VariableDeclarator")),!P(nc))break}return a}function va(a,b){var c=wa(b);if(!a&&ib===nc){var d=M(c);for(d.expressions=[c];P(nc);)d.expressions.push(wa(b));return N(d,"SequenceExpression")}return c}function wa(a){var b=xa(a);if(ib.isAssign){var c=M(b);return c.operator=jb,c.left=ib===xc?V(b):b,Z(b),H(),c.right=wa(a),N(c,"AssignmentExpression")}return b}function xa(a){var b=ya(a);if(P(sc)){var c=M(b);return c.test=b,c.consequent=va(!0),S(pc),c.alternate=va(!0,a),N(c,"ConditionalExpression")}return b}function ya(a){return za(Aa(),-1,a)}function za(a,b,c){var d=ib.binop;if(null!=d&&(!c||ib!==fc)&&d>b){var e=M(a);e.left=a,e.operator=jb;var f=ib;H(),e.right=za(Aa(),d,c);return za(N(e,f===Bc||f===Cc?"LogicalExpression":"BinaryExpression"),b,c)}return a}function Aa(){if(ib.prefix){var a=L(),b=ib.isUpdate;return a.operator=jb,a.prefix=!0,kb=!0,H(),a.argument=Aa(),b?Z(a.argument):tb&&"delete"===a.operator&&"Identifier"===a.argument.type&&c(a.start,"Deleting local variable in strict mode"),N(a,b?"UpdateExpression":"UnaryExpression")}for(var d=Ba();ib.postfix&&!Q();){var a=M(d);a.operator=jb,a.prefix=!1,a.argument=d,Z(d),H(),d=N(a,"UpdateExpression")}return d}function Ba(){return Ca(Da())}function Ca(a,b){if(P(qc)){var c=M(a);return c.object=a,c.property=Ra(!0),c.computed=!1,Ca(N(c,"MemberExpression"),b)}if(P(hc)){var c=M(a);return c.object=a,c.property=va(),c.computed=!0,S(ic),Ca(N(c,"MemberExpression"),b)}if(!b&&P(lc)){var c=M(a);return c.callee=a,c.arguments=Qa(mc,!1),Ca(N(c,"CallExpression"),b)}if(ib===uc){var c=M(a);return c.tag=a,c.quasi=Ga(),Ca(N(c,"TaggedTemplateExpression"),b)}return a}function Da(){switch(ib){case Yb:var a=L();return H(),N(a,"ThisExpression");case bc:if(rb)return Wa();case Ab:var b=Ra(ib!==Ab);return P(tc)?Ma(M(b),[b]):b;case xb:case zb:case yb:var a=L();return a.value=jb,a.raw=Za.slice(eb,fb),H(),N(a,"Literal");case cc:case dc:case ec:var a=L();return a.value=ib.atomValue,a.raw=ib.keyword,H(),N(a,"Literal");case lc:var c,d,e=gb,f=eb;if(H(),Ya.ecmaVersion>=6&&ib===Lb)c=Xa(L(),!0);else{var g=++ub;if(ib!==mc?(c=va(),d="SequenceExpression"===c.type?c.expressions:[c]):d=[],S(mc),ub===g&&P(tc))c=Ma(L(),d);else if(c||T(nb),Ya.ecmaVersion>=6)for(var h=0;h<d.length;h++)"SpreadElement"===d[h].type&&T()}return c.start=f,c.end=ob,Ya.locations&&(c.loc.start=e,c.loc.end=pb),Ya.ranges&&(c.range=[f,ob]),c;case hc:var a=L();return H(),Ya.ecmaVersion>=6&&ib===Lb?Xa(a,!1):(a.elements=Qa(ic,!0,!0),N(a,"ArrayExpression"));case jc:return Ha();case Mb:var a=L();return H(),Ka(a,!1);case Zb:return Pa(L(),!1);case Xb:return Ea();case rc:return Fa();case uc:return Ga();default:T()}}function Ea(){var a=L();return H(),a.callee=Ca(Da(),!0),P(lc)?a.arguments=Qa(mc,!1):a.arguments=wb,N(a,"NewExpression")}function Fa(){var a=L();return H(),a.argument=va(!0),N(a,"SpreadElement")}function Ga(){var a=L();for(a.expressions=[],a.quasis=[],vb=!0,H();;){var b=L();if(b.value={cooked:jb,raw:Za.slice(eb,fb)},b.tail=!1,H(),a.quasis.push(N(b,"TemplateElement")),P(uc)){b.tail=!0;break}vb=!1,S(vc),a.expressions.push(va()),vb=!0,S(kc)}return vb=!1,N(a,"TemplateLiteral")}function Ha(){var a=L(),b=!0,c={};for(a.properties=[],H();!P(kc);){if(b)b=!1;else if(S(nc),Ya.allowTrailingCommas&&P(kc))break;var d,e=L();Ya.ecmaVersion>=6&&(e.method=!1,e.shorthand=!1,d=P(Lc)),Ia(e),P(pc)?(e.value=va(!0),e.kind="init"):Ya.ecmaVersion>=6&&ib===lc?(e.kind="init",e.method=!0,e.value=La(d)):Ya.ecmaVersion>=5&&!e.computed&&"Identifier"===e.key.type&&("get"===e.key.name||"set"===e.key.name)?(d&&T(),e.kind=e.key.name,Ia(e),e.value=La(!1)):Ya.ecmaVersion>=6&&!e.computed&&"Identifier"===e.key.type?(e.kind="init",e.value=e.key,e.shorthand=!0):T(),Y(e,c),a.properties.push(N(e,"Property"))}return N(a,"ObjectExpression")}function Ia(a){if(Ya.ecmaVersion>=6){if(P(hc))return a.computed=!0,a.key=va(),void S(ic);a.computed=!1}a.key=ib===xb||ib===zb?Da():Ra(!0)}function Ja(a){a.id=null,a.params=[],Ya.ecmaVersion>=6&&(a.defaults=[],a.rest=null,a.generator=!1)}function Ka(a,b,c){return Ja(a),Ya.ecmaVersion>=6&&(a.generator=P(Lc)),(b||ib===Ab)&&(a.id=Ra()),Na(a),Oa(a,c),N(a,b?"FunctionDeclaration":"FunctionExpression")}function La(a){var b=L();Ja(b),Na(b);var c;return Ya.ecmaVersion>=6?(b.generator=a,c=!0):c=!1,Oa(b,c),N(b,"FunctionExpression")}function Ma(a,b){Ja(a);for(var c=a.defaults,d=!1,e=0,f=b.length-1;e<=f;e++){var g=b[e];if("AssignmentExpression"===g.type&&"="===g.operator)d=!0,b[e]=g.left,c.push(g.right);else if(V(g,e===f,!0),c.push(null),"SpreadElement"===g.type){b.length--,a.rest=g.argument;break}}return a.params=b,d||(a.defaults=[]),Oa(a,!0),N(a,"ArrowFunctionExpression")}function Na(a){var b=[],c=!1;for(S(lc);!P(mc);){if(Ya.ecmaVersion>=6&&P(rc)){a.rest=V(Da(),!1,!0),W(a.rest),S(mc);break}if(a.params.push(Ya.ecmaVersion>=6?V(Da(),!1,!0):Ra()),Ya.ecmaVersion>=6&&ib===xc&&(H(),c=!0,b.push(va(!0))),!P(nc)){S(mc);break}}c&&(a.defaults=b)}function Oa(a,b){var c=b&&ib!==jc;if(c)a.body=va(!0),a.expression=!0;else{var d=qb,e=rb,f=sb;qb=!0,rb=a.generator,sb=[],a.body=ra(!0),a.expression=!1,qb=d,rb=e,sb=f}if(tb||!c&&a.body.body.length&&O(a.body.body[0])){var g={};a.id&&X(a.id,g);for(var h=0;h<a.params.length;h++)X(a.params[h],g);a.rest&&X(a.rest,g)}}function Pa(a,b){H(),a.id=ib===Ab?Ra():b?T():null,a.superClass=P($b)?va():null;var c=L(),d={},e={};for(c.body=[],S(jc);!P(kc);){var f=L();ib===Ab&&"static"===jb?(H(),f.static=!0):f.static=!1;var g=P(Lc);Ia(f),ib!==Ab||f.computed||"Identifier"!==f.key.type||"get"!==f.key.name&&"set"!==f.key.name?f.kind="":(g&&T(),f.kind=f.key.name,Ia(f)),f.value=La(g),Y(f,f.static?e:d),c.body.push(N(f,"MethodDefinition")),P(oc)}return a.body=N(c,"ClassBody"),N(a,b?"ClassDeclaration":"ClassExpression")}function Qa(a,b,c){for(var d=[],e=!0;!P(a);){if(e)e=!1;else if(S(nc),b&&Ya.allowTrailingCommas&&P(a))break;c&&ib===nc?d.push(null):d.push(va(!0))}return d}function Ra(a){var b=L();return a&&"everywhere"==Ya.forbidReserved&&(a=!1),ib===Ab?(!a&&(Ya.forbidReserved&&(3===Ya.ecmaVersion?Oc:Pc)(jb)||tb&&Qc(jb))&&-1==Za.slice(eb,fb).indexOf("\\")&&c(eb,"The keyword '"+jb+"' is reserved"),b.name=jb):a&&ib.keyword?b.name=ib.keyword:T(),kb=!1,H(),N(b,"Identifier")}function Sa(a){if(H(),ib===Sb||ib===Ub||ib===Tb||ib===Mb||ib===Zb)a.declaration=_(),a.default=!1,a.specifiers=null,a.source=null;else if(P(Hb))a.declaration=va(!0),a.default=!0,a.specifiers=null,a.source=null,R();else{var b=ib===Lc;a.declaration=null,a.default=!1,a.specifiers=Ta(),ib===Ab&&"from"===jb?(H(),a.source=ib===zb?Da():T()):(b&&T(),a.source=null)}return N(a,"ExportDeclaration")}function Ta(){var a=[],b=!0;if(ib===Lc){var c=L();H(),a.push(N(c,"ExportBatchSpecifier"))}else for(S(jc);!P(kc);){if(b)b=!1;else if(S(nc),Ya.allowTrailingCommas&&P(kc))break;var c=L();c.id=Ra(),ib===Ab&&"as"===jb?(H(),c.name=Ra(!0)):c.name=null,a.push(N(c,"ExportSpecifier"))}return a}function Ua(a){return H(),ib===zb?(a.specifiers=[],a.source=Da(),a.kind=""):(a.specifiers=Va(),ib===Ab&&"from"===jb||T(),H(),a.source=ib===zb?Da():T(),a.kind=a.specifiers[0].default?"default":"named"),N(a,"ImportDeclaration")}function Va(){var a=[],b=!0;if(ib===Lc){var c=L();return H(),ib===Ab&&"as"===jb||T(),H(),c.name=Ra(),Z(c.name,!0),a.push(N(c,"ImportBatchSpecifier")),a}if(ib===Ab){var c=L();if(c.id=Ra(),Z(c.id,!0),c.name=null,c.default=!0,a.push(N(c,"ImportSpecifier")),!P(nc))return a}for(S(jc);!P(kc);){if(b)b=!1;else if(S(nc),Ya.allowTrailingCommas&&P(kc))break;var c=L();c.id=Ra(!0),ib===Ab&&"as"===jb?(H(),c.name=Ra()):c.name=null,Z(c.name||c.id,!0),c.default=!1,a.push(N(c,"ImportSpecifier"))}return a}function Wa(){var a=L();return H(),P(oc)||Q()?(a.delegate=!1,a.argument=null):(a.delegate=P(Lc),a.argument=va(!0)),N(a,"YieldExpression")}function Xa(a,b){for(a.blocks=[];ib===Lb;){var c=L();H(),S(lc),c.left=V(Da()),Z(c.left,!0),ib===Ab&&"of"===jb||T(),H(),c.of=!0,c.right=va(),S(mc),a.blocks.push(N(c,"ComprehensionBlock"))}return a.filter=P(Nb)?qa():null,a.body=va(),S(b?mc:ic),a.generator=b,N(a,"ComprehensionExpression")}a.version="0.7.1";var Ya,Za,$a,_a;a.parse=function(a,c){return Za=String(a),$a=Za.length,b(c),f(),$(Ya.program)};var ab=a.defaultOptions={ecmaVersion:5,strictSemicolons:!1,allowTrailingCommas:!0,forbidReserved:!1,allowReturnOutsideFunction:!1,locations:!1,onToken:null,onComment:null,ranges:!1,program:null,sourceFile:null,directSourceFile:null,line:1},bb=a.getLineInfo=function(a,b){for(var c=Ya.line,d=0;;){_c.lastIndex=d;var e=_c.exec(a);if(!(e&&e.index<b))break;++c,d=e.index+e[0].length}return{line:c,column:b-d}},cb=function(){var a={type:ib,value:jb,start:eb,end:fb};return Ya.locations&&(a.startLoc=gb,a.endLoc=hb),a};a.tokenize=function(a,c){function d(a){return ob=fb,u(a),cb()}return Za=String(a),$a=Za.length,b(c),f(),d.jumpTo=function(a,b){if(db=a,Ya.locations){lb=Ya.line,mb=_c.lastIndex=0;for(var c;(c=_c.exec(Za))&&c.index<a;)++lb,mb=c.index+c[0].length}kb=b,j()},d};var db,eb,fb,gb,hb,ib,jb,kb,lb,mb,nb,ob,pb,qb,rb,sb,tb,ub,vb,wb=[],xb={type:"num"},yb={type:"regexp"},zb={type:"string"},Ab={type:"name"},Bb={type:"eof"},Cb={keyword:"break"},Db={keyword:"case",beforeExpr:!0},Eb={keyword:"catch"},Fb={keyword:"continue"},Gb={keyword:"debugger"},Hb={keyword:"default"},Ib={keyword:"do",isLoop:!0},Jb={keyword:"else",beforeExpr:!0},Kb={keyword:"finally"},Lb={keyword:"for",isLoop:!0},Mb={keyword:"function"},Nb={keyword:"if"},Ob={keyword:"return",beforeExpr:!0},Pb={keyword:"switch"},Qb={keyword:"throw",beforeExpr:!0},Rb={keyword:"try"},Sb={keyword:"var"},Tb={keyword:"let"},Ub={keyword:"const"},Vb={keyword:"while",isLoop:!0},Wb={keyword:"with"},Xb={keyword:"new",beforeExpr:!0},Yb={keyword:"this"},Zb={keyword:"class"},$b={keyword:"extends",beforeExpr:!0},_b={keyword:"export"},ac={keyword:"import"},bc={keyword:"yield",beforeExpr:!0},cc={keyword:"null",atomValue:null},dc={keyword:"true",atomValue:!0},ec={keyword:"false",atomValue:!1},fc={keyword:"in",binop:7,beforeExpr:!0},gc={break:Cb,case:Db,catch:Eb,continue:Fb,debugger:Gb,default:Hb,do:Ib,else:Jb,finally:Kb,for:Lb,function:Mb,if:Nb,return:Ob,switch:Pb,throw:Qb,try:Rb,var:Sb,let:Tb,const:Ub,while:Vb,with:Wb,null:cc,true:dc,false:ec,new:Xb,in:fc,instanceof:{keyword:"instanceof",binop:7,beforeExpr:!0},this:Yb,typeof:{keyword:"typeof",prefix:!0,beforeExpr:!0},void:{keyword:"void",prefix:!0,beforeExpr:!0},delete:{keyword:"delete",prefix:!0,beforeExpr:!0},class:Zb,extends:$b,export:_b,import:ac,yield:bc},hc={type:"[",beforeExpr:!0},ic={type:"]"},jc={type:"{",beforeExpr:!0},kc={type:"}"},lc={type:"(",beforeExpr:!0},mc={type:")"},nc={type:",",beforeExpr:!0},oc={type:";",beforeExpr:!0},pc={type:":",beforeExpr:!0},qc={type:"."},rc={type:"..."},sc={type:"?",beforeExpr:!0},tc={type:"=>",beforeExpr:!0},uc={type:"`"},vc={type:"${",beforeExpr:!0},wc={binop:10,beforeExpr:!0},xc={isAssign:!0,beforeExpr:!0},yc={isAssign:!0,beforeExpr:!0},zc={postfix:!0,prefix:!0,isUpdate:!0},Ac={prefix:!0,beforeExpr:!0},Bc={binop:1,beforeExpr:!0},Cc={binop:2,beforeExpr:!0},Dc={binop:3,beforeExpr:!0},Ec={binop:4,beforeExpr:!0},Fc={binop:5,beforeExpr:!0},Gc={binop:6,beforeExpr:!0},Hc={binop:7,beforeExpr:!0},Ic={binop:8,beforeExpr:!0},Jc={binop:9,prefix:!0,beforeExpr:!0},Kc={binop:10,beforeExpr:!0},Lc={binop:10,beforeExpr:!0};a.tokTypes={bracketL:hc,bracketR:ic,braceL:jc,braceR:kc,parenL:lc,parenR:mc,comma:nc,semi:oc,colon:pc,dot:qc,ellipsis:rc,question:sc,slash:wc,eq:xc,name:Ab,eof:Bb,num:xb,regexp:yb,string:zb,arrow:tc,bquote:uc,dollarBraceL:vc};for(var Mc in gc)a.tokTypes["_"+Mc]=gc[Mc];var Nc,Oc=d("abstract boolean byte char class double enum export extends final float goto implements import int interface long native package private protected public short static super synchronized throws transient volatile"),Pc=d("class enum extends super const export import"),Qc=d("implements interface let package private protected public static yield"),Rc=d("eval arguments"),Sc="break case catch continue debugger default do else finally for function if return switch throw try var while with null true false instanceof typeof void delete new in this",Tc=d(Sc),Uc=d(Sc+" let const class extends export import yield"),Vc=Tc,Wc=/[\u1680\u180e\u2000-\u200a\u202f\u205f\u3000\ufeff]/,Xc="--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------",Yc=new RegExp("["+Xc+"]"),Zc=new RegExp("["+Xc+"------------------------------------------------------------------------------------------------------------------------------------------------]"),$c=/[\n\r\u2028\u2029]/,_c=/\r\n|[\n\r\u2028\u2029]/g,ad=a.isIdentifierStart=function(a){return a<65?36===a:a<91||(a<97?95===a:a<123||a>=170&&Yc.test(String.fromCharCode(a)))},bd=a.isIdentifierChar=function(a){return a<48?36===a:a<58||!(a<65)&&(a<91||(a<97?95===a:a<123||a>=170&&Zc.test(String.fromCharCode(a))))};a.Node=J;var cd={kind:"loop"},dd={kind:"switch"}})},{}],36:[function(a,b,c){(function(a){(function(a,b,c,d,e){var f={};f.init=function(a){var b;return a.maxChildren=a.maxChildren||2,a.maxDepth=a.maxDepth||4,b=function(a,c,d,e,f,g,h){var i=[],j=[];return{x:a,y:c,w:d,h:e,depth:f,retrieve:function(a,b,c){for(var d=0;d<i.length;++d)c?b.call(c,i[d]):b(i[d]);j.length&&this.findOverlappingNodes(a,function(d){j[d].retrieve(a,b,c)})},insert:function(a){var b;j.length?(b=this.findInsertNode(a),4===b?i.push(a):j[b].insert(a)):(i.push(a),i.length>g&&this.depth<h&&this.divide())},findInsertNode:function(b){return b.x+b.w<a+d/2?b.y+b.h<c+e/2?0:b.y>=c+e/2?2:4:b.x>=a+d/2?b.y+b.h<c+e/2?1:b.y>=c+e/2?3:4:4},findOverlappingNodes:function(b,f){b.x<a+d/2&&(b.y<c+e/2&&f(0),b.y+b.h>=c+e/2&&f(2)),b.x+b.w>=a+d/2&&(b.y<c+e/2&&f(1),b.y+b.h>=c+e/2&&f(3))},divide:function(){var a,c,f,k,l=this.depth+1;for(a=d/2,c=e/2,j.push(b(this.x,this.y,a,c,l,g,h)),j.push(b(this.x+a,this.y,a,c,l,g,h)),j.push(b(this.x,this.y+c,a,c,l,g,h)),j.push(b(this.x+a,this.y+c,a,c,l,g,h)),k=i,i=[],f=0;f<k.length;f++)this.insert(k[f])},clear:function(){var a;for(a=0;a<j.length;a++)j[a].clear();i.length=0,j.length=0},getNodes:function(){return!!j.length&&j}}},{root:function(){return b(a.x,a.y,a.w,a.h,0,a.maxChildren,a.maxDepth)}(),insert:function(a){var b,c;if(a instanceof Array)for(b=a.length,c=0;c<b;c++)this.root.insert(a[c]);else this.root.insert(a)},retrieve:function(a,b,c){return this.root.retrieve(a,b,c)},clear:function(){this.root.clear()}}},e(void 0!==f?f:window.QUAD)}).call(a,void 0,void 0,void 0,void 0,function(a){b.exports=a})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}]},{},[30])(30)});
//# sourceMappingURL=droplet-full.min.js.map