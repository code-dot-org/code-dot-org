import {BlockSvg, Workspace, WorkspaceSvg} from 'blockly';
import React, {useEffect, useRef, useState} from 'react';
import moduleStyles from './ai-block-preview.module.scss';

interface AiBlockPreviewProps {
  className: string;
  duration: number;
  generateBlocksFromResult: (
    workspace: Workspace
  ) => [BlockSvg, BlockSvg, BlockSvg];
  onComplete: () => void;
}

/**
 * Previews the blocks generated by the AI block in Dance Party.
 */
const AiBlockPreview: React.FunctionComponent<AiBlockPreviewProps> = ({
  className,
  duration,
  generateBlocksFromResult,
  onComplete,
}) => {
  const blockPreviewContainerRef = useRef<HTMLSpanElement>(null);
  const refTimer = useRef<number | null>(null);

  const [built, setBuilt] = useState<boolean>(false);
  const [done, setDone] = useState<boolean>(false);

  useEffect(() => {
    refTimer.current = window.setTimeout(() => {
      setDone(true);
      onComplete();
      if (refTimer.current) {
        clearTimeout(refTimer.current);
        refTimer.current = null;
      }
    }, duration);

    return () => {
      if (refTimer.current) {
        clearTimeout(refTimer.current);
      }
    };
  }, [onComplete, className, duration]);

  // Build out the blocks.
  useEffect(() => {
    if (!done && !built) {
      const emptyBlockXml = Blockly.utils.xml.textToDom('<xml></xml>');
      const previewWorkspace: Workspace =
        Blockly.BlockSpace.createReadOnlyBlockSpace(
          blockPreviewContainerRef.current,
          emptyBlockXml,
          {}
        );

      const blocksSvg = generateBlocksFromResult(previewWorkspace);
      blocksSvg.forEach((blockSvg: BlockSvg) => {
        blockSvg.initSvg();
        blockSvg.render();
      });
      Blockly.svgResize(previewWorkspace as WorkspaceSvg);

      setBuilt(true);
    }
  }, [blockPreviewContainerRef, generateBlocksFromResult, done, built]);

  return (
    <div className={className}>
      <span ref={blockPreviewContainerRef} className={moduleStyles.container} />
    </div>
  );
};

export default AiBlockPreview;
