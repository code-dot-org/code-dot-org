// Adds the Global Editing sub-path (e.g., "/global/ir/fa") to all CDO link URLs on the page if it is not already present.
document.addEventListener('DOMContentLoaded', () => {
  const gePath = window.location.pathname.match(
    RegExp("<%= Rack::GlobalEdition::PATH_PATTERN.source %>")
  )?.groups['ge_path'];

  if (gePath) {
    const modifyLinks = targetEl => {
      targetEl.querySelectorAll(`a[href]:not([href*="${gePath}"])`).forEach(linkEl =>  {
        const url = new URL(linkEl.href, window.location.origin);
        if ((<%= Rack::GlobalEdition::TARGET_HOSTNAMES.to_a %>).includes(url.hostname) && !url.pathname.startsWith(gePath)) {
          linkEl.href = `${url.origin}${gePath}${url.pathname}${url.search}`;
        }
      });
    };

    new MutationObserver(mutations => {
      mutations.forEach(mutation => {
        mutation.addedNodes.forEach(node => {
          if (node.tagName === 'A') node = node.parentNode;
          node instanceof HTMLElement && modifyLinks(node);
        });
      });
    }).observe(document.body, {childList: true, subtree: true});

    modifyLinks(document.body);
  }
});
