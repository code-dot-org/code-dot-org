- script = @script || (user && user.primary_script) || Script.twenty_hour_script
- script_levels = user ? user.levels_from_script(script) : script.script_levels.includes(:script, :stage, level: :game)
- concept_progress = user ? user.concept_progress : nil

.user-stats-block
  - levels = script_levels.group_by(&:stage_or_game)
  - levels.each_pair do |stage_or_game, sl_group|
    - color = '#eee' # cycle '#ddd', '#d5d5d5'
    - should_show_lesson_plan = script.has_lesson_plan? && current_user && current_user.teacher?
    .game-group{style:"background-color: #{color}"}
      .stage
        %span
          = stage_title(script, stage_or_game)
        - if should_show_lesson_plan
          .stage-lesson-plan-link
            = link_to t('view_lesson_plan'), lesson_plan_html_url(stage_or_game)

      .games
        - sl_group = sl_group.sort_by {|sl| sl.stage_or_game_position}
        - sl_group.each do |sl|
          .level
            - css_class, link = level_info(user, sl)
            - if params[:script_level_id] && params[:script_level_id] == sl.level_id.to_s
              - puzzle_outer_class = 'puzzle_outer_current'
            - elsif sl.assessment
              - puzzle_outer_class = 'puzzle_outer_assessment'
            - else
              - puzzle_outer_class = 'puzzle_outer_level'
            %span{class: puzzle_outer_class}
              %a{ href: link, class: "level_link #{css_class}"}
                - unplugged = sl.level.unplugged?
                - if unplugged
                  %span.puzzle-named
                    =sl.level_display_text
                - elsif css_class == 'passed'
                  = check_mark_html
                - elsif css_class == 'perfect'
                  = check_mark_html
                - else 
                  %span.puzzle-number
                    =sl.level_display_text

            - if false && current_user.try(:admin?)
              - if can? :edit, sl.level
                = link_to(t('crud.edit'), edit_level_path(sl.level), style: 'display: block; width: 30px;', title: sl.level.name)
              - else
                %span{style: 'display: block; width: 30px;'} &nbsp;

-if script.trophies?
  %div{style:"clear:both"}
  #trophies
    =render partial: 'shared/concept_trophy_block', locals: { concept_progress: concept_progress, user: user, added_style: 'padding:10px;' }

