- require 'census_helper'
- homepage_data = {courses: @recent_courses}
- homepage_data[:showuitips] = show_ui_tips
- homepage_data[:initialtipsdismissed] = current_user.ui_tip_dismissed_homepage_header
- homepage_data[:userid] = current_user.id
- homepage_data[:valid_grades] = Section.valid_grades
- homepage_data[:csfScriptIds] = Script.csf_script_ids
- homepage_data[:topCourse] = @top_course
- homepage_data[:isEnglish] = @is_english

- if current_user
  - provider = current_user.provider
  - provider = 'google_classroom' if provider == 'google_oauth2'
  - homepage_data[:provider] = provider
  - if current_user.teacher?
    - homepage_data[:isTeacher] = true
    - homepage_data[:joined_sections] = @student_sections
    - homepage_data[:announcement] = DCDO.get('census_announcement', nil)
    - homepage_data[:hoc_launch] = DCDO.get('hoc_launch', nil)
    - show_census_banner = !!(current_user.show_census_teacher_banner?)
    - homepage_data[:showCensusBanner] = show_census_banner
    - if show_census_banner
      %script{type: "text/javascript", src: "https://maps.googleapis.com/maps/api/js?client=#{CDO.google_maps_client_id}&sensor=true&libraries=places,geometry&v=3.7"}
      - teachers_school = current_user.school_info.school
      - school_stats = SchoolStatsByYear.where(school_id: teachers_school.id).order(school_year: :desc).first
      - homepage_data[:ncesSchoolId] = teachers_school.id
      - homepage_data[:censusQuestion] = school_stats.try(:has_high_school_grades?) ? "how_many_20_hours" : "how_many_10_hours"
      - homepage_data[:teacherName] = current_user.name
      - homepage_data[:teacherId] = current_user.id
      - homepage_data[:teacherEmail] = current_user.email
      - homepage_data[:currentSchoolYear] = current_census_year
  - else
    - homepage_data[:sections] = @student_sections
    - homepage_data[:isTeacher] = false
    - if current_user.teacher_managed_account?
      - homepage_data[:canLeave] = false
    - else
      - homepage_data[:canLeave] = true
  - homepage_data[:canViewAdvancedTools] = !(current_user.under_13? && current_user.terms_version.nil?)

- content_for(:head) do
  %script{src: minifiable_asset_path('js/home/_homepage.js'), data: {homepage: homepage_data.to_json}}

-# Components generated by HAML which might be pulled in and displayed by the React model.
.hiddenComponents{style: "display: none"}
  #flashes
    = show_flashes.html_safe

.clear{style: "clear: both"}

- if current_user
  - if current_user.teacher?
    #terms_reminder
      - unless current_user.accepted_latest_terms?
        = render template: 'api/accept_terms_reminder'
        = render partial: 'layouts/terms_interstitial'

#homepage-container

#workshop-links
  -if can? :read, Pd::Application::ApplicationBase
    %h1
      Application Dashboard
    = link_to pd_application_dashboard_path do
      %h3
        Manage Applications
  -if can? :read, Pd::Workshop
    %h1
      Workshop Dashboard
    %a{href:'/pd/workshop_dashboard'}
      %h3
        Manage PD Workshops
    -if current_user.permission?(UserPermission::WORKSHOP_ADMIN)
      = link_to pd_workshop_admins_path do
        %h3
          Directory for Workshop Admins

:javascript

  $(document).ready(function() {
    window.cleverTakeoverManager = new CleverTakeoverManager({
      cleverLinkFlag: "#{session['clever_link_flag']}",
      userIDToMerge: "#{session['clever_takeover_id']}",
      mergeAuthToken: "#{session['clever_takeover_token']}",
      forceConnect: "#{session['force_clever_takeover']}",
    });
  });
