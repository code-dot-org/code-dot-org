require 'cdo/firehose'

class Api::V1::SchoolsController < ApplicationController
  load_resource :school, only: [:show, :afe_high_needs]

  # GET /api/v1/schools/<school_district_id>/<school_type>
  def index
    schools = School.where(school_district_id: params[:school_district_id], school_type: params[:school_type])
    serialized_schools = schools.map do |school|
      Api::V1::SchoolSerializer.new(school).attributes
    end
    render json: serialized_schools
  end

  # GET /api/v1/schools/:id
  def show
    render json: @school, serializer: Api::V1::SchoolAutocomplete::Serializer
  end

  # GET /api/v1/schools/:id/afe_high_needs
  def afe_high_needs
    render json: @school, serializer: Api::V1::SchoolSerializer
  end

  # GET /dashboardapi/v1/schoolsearch/:q/:limit
  def search
    search_results = Api::V1::SchoolAutocomplete.get_matches(
      params.require(:q),
      params[:limit],
      params[:use_new_search]
    )
    if Gatekeeper.allows('logSchoolSearch')
      FirehoseClient.instance.put_record(
        :analysis,
        {
          study: 'school-search-log',
          # TODO: (suresh) Change this to log request.headers["Referer"] (the URL of the page that the current
          # XMLHTTPRequest was embedded in) so we can identify which page ("yourschool", "account sign up", etc.) was
          # being used.  Currently this header evaluates to nil on the Pegasus yourschool page, perhaps because of the way
          # the Pegasus request is routed to a dashboardapi Dashboard controller.
          event: "school-search",
          # TODO: (suresh) Set this to the session id instead of the unique request id generated by our middleware stack,
          # to anonymously aggregate a sequence of searches.  Currently request.headers["Cookie"] is empty,
          # perhaps due to the same problem as above.
          project_id: request.uuid,
          data_string: params[:q],
          data_json: search_results.to_json
        }
      )
    end
    render json: search_results
  end
end
